/****** Object:  StoredProcedure [dbo].[usp_SaveErrorDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[usp_SaveErrorDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_VatExemptedNationMapping]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_VatExemptedNationMapping]
GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateStudentImage]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_UpdateStudentImage]
GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateSiblingDiscountStatus]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_UpdateSiblingDiscountStatus]
GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateSchoolLogoImage]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_UpdateSchoolLogoImage]
GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateParentImage]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_UpdateParentImage]
GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateOtherDiscountStatus]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_UpdateOtherDiscountStatus]
GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateGenerateSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_UpdateGenerateSiblingDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateGenerateFee]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_UpdateGenerateFee]
GO
/****** Object:  StoredProcedure [dbo].[SP_UniformSalesReport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[SP_UniformSalesReport]
GO
/****** Object:  StoredProcedure [dbo].[SP_TuitionFeeReport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[SP_TuitionFeeReport]
GO
/****** Object:  StoredProcedure [dbo].[SP_TotalRevenueReport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[SP_TotalRevenueReport]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveVat]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveVat]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveUserImage]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveUserImage]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveUser]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveUser]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveUploadDocument]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveUploadDocument]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveStudentStatus]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveStudentStatus]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveStudentFeeDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveStudentFeeDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveStudent]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveStudent]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSiblingDiscountDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveSiblingDiscountDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveSiblingDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSection]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveSection]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSchoolTermAcademic]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveSchoolTermAcademic]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSchoolAccountInfo]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveSchoolAccountInfo]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSchoolAcademic]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveSchoolAcademic]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSchool]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveSchool]
GO
/****** Object:  StoredProcedure [dbo].[sp_SavePaymentMethodCategory]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SavePaymentMethodCategory]
GO
/****** Object:  StoredProcedure [dbo].[sp_SavePaymentMethod]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SavePaymentMethod]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveParentAccount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveParentAccount]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveParent]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveParent]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveOtherDiscountDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveOtherDiscountDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveOpenApply]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveOpenApply]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveNotification]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveNotification]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveInvoiceType]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveInvoiceType]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveInvoiceToStatement]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveInvoiceToStatement]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveInvoiceDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveInvoiceDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveInvoice]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveInvoice]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveGradeWiseFeeStructure]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveGradeWiseFeeStructure]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveGrade]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveGrade]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveGenerateSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveGenerateSiblingDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveGenerateFee]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveGenerateFee]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveGender]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveGender]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveFeeTypeDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveFeeTypeDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveFeeType]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveFeeType]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveFeeStructure]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveFeeStructure]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveFeePlanWithoutGradewise]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveFeePlanWithoutGradewise]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveFeePaymentPlan]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveFeePaymentPlan]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveFeeDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveFeeDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveEmailConfig]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveEmailConfig]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveDocumentType]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveDocumentType]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveCostCenter]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveCostCenter]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveContactInformation]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveContactInformation]
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveBranch]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_SaveBranch]
GO
/****** Object:  StoredProcedure [dbo].[sp_ReportStudentStatement]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_ReportStudentStatement]
GO
/****** Object:  StoredProcedure [dbo].[sp_RejectNotificationById]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_RejectNotificationById]
GO
/****** Object:  StoredProcedure [dbo].[sp_ProcessOpenApplyRecordToNotification_old]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_ProcessOpenApplyRecordToNotification_old]
GO
/****** Object:  StoredProcedure [dbo].[sp_ProcessOpenApplyRecordToNotification]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_ProcessOpenApplyRecordToNotification]
GO
/****** Object:  StoredProcedure [dbo].[sp_ProcessOpenApplyRecord]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_ProcessOpenApplyRecord]
GO
/****** Object:  StoredProcedure [dbo].[sp_processOpenapplyInsertFirstTime]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_processOpenapplyInsertFirstTime]
GO
/****** Object:  StoredProcedure [dbo].[sp_ProcessGP_UniformInvoice]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_ProcessGP_UniformInvoice]
GO
/****** Object:  StoredProcedure [dbo].[SP_MonthlyUniformStatementParentStudent]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[SP_MonthlyUniformStatementParentStudent]
GO
/****** Object:  StoredProcedure [dbo].[SP_MonthlyStatementParentStudent]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[SP_MonthlyStatementParentStudent]
GO
/****** Object:  StoredProcedure [dbo].[SP_ItemCodeRecords]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[SP_ItemCodeRecords]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetVatExemptedNation]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetVatExemptedNation]
GO
/****** Object:  StoredProcedure [dbo].[SP_GetVATDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[SP_GetVATDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetVat]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetVat]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetUsers]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetUsers]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetTotalItemSubtotalsForYear]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetTotalItemSubtotalsForYear]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudentStatus]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetStudentStatus]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudentGrade]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetStudentGrade]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudentFeeTypeAmount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetStudentFeeTypeAmount]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudentFeeDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetStudentFeeDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudentByParentId]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetStudentByParentId]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudentById]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetStudentById]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudent]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetStudent]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSiblingDiscountDetailForCancle]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetSiblingDiscountDetailForCancle]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSiblingDiscountDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetSiblingDiscountDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetSiblingDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSections]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetSections]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSchoolTermAcademic]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetSchoolTermAcademic]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSchoolLogoImage]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetSchoolLogoImage]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSchoolAccountInfo]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetSchoolAccountInfo]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSchoolAcademic]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetSchoolAcademic]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSchool]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetSchool]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetReturnInvoice]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetReturnInvoice]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetPaymentMethodCategory]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetPaymentMethodCategory]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetPaymentMethod]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetPaymentMethod]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetParentLookup]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetParentLookup]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetParentById]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetParentById]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetParent]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetParent]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetOtherDiscountDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetOtherDiscountDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetOpenApply]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetOpenApply]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetNotificationSiblingDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationOtherDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetNotificationOtherDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationList]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetNotificationList]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationGroupDetailById]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetNotificationGroupDetailById]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationGroupDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetNotificationGroupDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationGroup]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetNotificationGroup]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationGenerateSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetNotificationGenerateSiblingDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationGenerateFee]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetNotificationGenerateFee]
GO
/****** Object:  StoredProcedure [dbo].[Sp_GetItemCodeRecord]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[Sp_GetItemCodeRecord]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoiceType]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetInvoiceType]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoiceNo]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetInvoiceNo]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoiceDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetInvoiceDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoiceDataYearly]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetInvoiceDataYearly]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoiceDataMonthly]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetInvoiceDataMonthly]
GO
/****** Object:  StoredProcedure [dbo].[sp_getInvoiceData]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_getInvoiceData]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoiceByInvoiceNo]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetInvoiceByInvoiceNo]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoice]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetInvoice]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetGrades]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetGrades]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetGradeMaxSequenceNo]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetGradeMaxSequenceNo]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetGenerateSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetGenerateSiblingDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetGenerateFee]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetGenerateFee]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetGender]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetGender]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeeTypeNew]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetFeeTypeNew]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeeTypeDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetFeeTypeDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeeType]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetFeeType]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeeStructure]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetFeeStructure]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeePlanWithoutGradewise]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetFeePlanWithoutGradewise]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeePlanWithGradewise]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetFeePlanWithGradewise]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeePaymentPlan]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetFeePaymentPlan]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeeDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetFeeDiscount]
GO
/****** Object:  StoredProcedure [dbo].[SP_GetFeeAmount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[SP_GetFeeAmount]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetEmailConfig]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetEmailConfig]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetDocumentType]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetDocumentType]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetCostCenter]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetCostCenter]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetContactInformation]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetContactInformation]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetBranch]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetBranch]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetAuthDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetAuthDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetAttachmentByDocForId]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetAttachmentByDocForId]
GO
/****** Object:  StoredProcedure [dbo].[sp_GetAppDropdown]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_GetAppDropdown]
GO
/****** Object:  StoredProcedure [dbo].[sp_getAdminDashboardData]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_getAdminDashboardData]
GO
/****** Object:  StoredProcedure [dbo].[SP_FeeStatement]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[SP_FeeStatement]
GO
/****** Object:  StoredProcedure [dbo].[SP_EntranceFeesReport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[SP_EntranceFeesReport]
GO
/****** Object:  StoredProcedure [dbo].[SP_DiscountReport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[SP_DiscountReport]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteVat]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteVat]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteUser]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteUser]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteStudentStatus]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteStudentStatus]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteStudentSiblingDiscountDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteStudentSiblingDiscountDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteStudentOtherDiscountDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteStudentOtherDiscountDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteStudentFeeDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteStudentFeeDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteStudent]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteStudent]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteSiblingDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSection]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteSection]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSchoolTermAcademic]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteSchoolTermAcademic]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSchoolLogoImage]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteSchoolLogoImage]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSchoolAccountInfo]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteSchoolAccountInfo]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSchoolAcademic]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteSchoolAcademic]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSchool]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteSchool]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeletePaymentMethod]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeletePaymentMethod]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteParent]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteParent]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteInvoiceType]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteInvoiceType]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteInvoiceDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteInvoiceDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteInvoice]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteInvoice]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteGrade]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteGrade]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteGender]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteGender]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteFeeTypeDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteFeeTypeDetail]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteFeeType]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteFeeType]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteFeePlanWithoutGradewise]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteFeePlanWithoutGradewise]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteFeePaymentPlan]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteFeePaymentPlan]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteFeeDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteFeeDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteDocumentType]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteDocumentType]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteDiscount]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteCostCenter]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteCostCenter]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteContactInformation]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteContactInformation]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteBranch]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteBranch]
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteAttachements]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_DeleteAttachements]
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVUniformRevenueExport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_CSVUniformRevenueExport]
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVTuitionRevenueExport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_CSVTuitionRevenueExport]
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVTotalRevenueExport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_CSVTotalRevenueExport]
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVStudentStatement]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_CSVStudentStatement]
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVStudent]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_CSVStudent]
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVParent]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_CSVParent]
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVInvoiceExport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_CSVInvoiceExport]
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVEntranceRevenueExport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_CSVEntranceRevenueExport]
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVdiscountreportexport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_CSVdiscountreportexport]
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVallrevenueexport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_CSVallrevenueexport]
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVAdvanceFeeRevenueExport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_CSVAdvanceFeeRevenueExport]
GO
/****** Object:  StoredProcedure [dbo].[sp_CreateGLEntry]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_CreateGLEntry]
GO
/****** Object:  StoredProcedure [dbo].[sp_ClearPreviousOpenApplyNotification]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_ClearPreviousOpenApplyNotification]
GO
/****** Object:  StoredProcedure [dbo].[sp_CleanUpOpenApplyRecord]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_CleanUpOpenApplyRecord]
GO
/****** Object:  StoredProcedure [dbo].[sp_ApproveNotifications]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_ApproveNotifications]
GO
/****** Object:  StoredProcedure [dbo].[sp_ApproveNotificationParent]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_ApproveNotificationParent]
GO
/****** Object:  StoredProcedure [dbo].[sp_ApproveNotificationById]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_ApproveNotificationById]
GO
/****** Object:  StoredProcedure [dbo].[sp_ApproveNotification]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_ApproveNotification]
GO
/****** Object:  StoredProcedure [dbo].[SP_AllRevenueReport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[SP_AllRevenueReport]
GO
/****** Object:  StoredProcedure [dbo].[SP_AdvanceFeeReport]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[SP_AdvanceFeeReport]
GO
/****** Object:  StoredProcedure [dbo].[sp_AdjustGrade]    Script Date: 9/9/2024 9:27:58 PM ******/
DROP PROCEDURE IF EXISTS  [dbo].[sp_AdjustGrade]
GO
/****** Object:  StoredProcedure [dbo].[sp_AdjustGrade]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_AdjustGrade]
	@GradeId int
	,@Value int
	,@SequenceNo int
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF @Value=-1
			BEGIN
				UPDATE tblGradeMaster SET SequenceNo=SequenceNo+1 
					WHERE GradeId =(SELECT GradeId FROM tblGradeMaster 
									WHERE SequenceNo=@SequenceNo-1)
				UPDATE tblGradeMaster SET SequenceNo=SequenceNo-1 
					WHERE GradeId =@GradeId
			END
			ELSE
			BEGIN
				UPDATE tblGradeMaster SET SequenceNo=SequenceNo-1
					WHERE GradeId =(SELECT GradeId FROM tblGradeMaster 
									WHERE SequenceNo=@SequenceNo+1)
				UPDATE tblGradeMaster SET SequenceNo=SequenceNo+1 
					WHERE GradeId =@GradeId
			END
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[SP_AdvanceFeeReport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE proc [dbo].[SP_AdvanceFeeReport]
(
 @ParentId int=0
,@ParentName nvarchar(100)=null
,@FatherIqama nvarchar(100)=null
,@StudentName nvarchar(100)=null
,@AcademicYear int=0
,@InvoiceNo bigint=0
,@StartDate datetime=null
,@EndDate datetime=null
)
as
begin

	select 
	 ParentId
	,ParentName
	,FatherMobile
	,IqamaNumber
	,StudentId
	,StudentName
	,GradeName
	,CostCenter=0
	,AcademicYear
	,IsStaff
	,TaxableAmount=sum(TaxableAmount)
	,TaxAmount=sum(TaxAmount)
	,ItemSubtotal=sum(ItemSubtotal)
	,InvoiceType
	,InvoiceDate
	,InvoiceNo
	,PaymentMethod
	,InvoiceRefNo = PaymentReferenceNumber
	from
	(
		select 
			 ParentId=isnull(invDet.ParentId,0)
             ,invDet.ParentName
			,invDet.FatherMobile
			,StudentId = isnull(invDet.StudentId,0)
			,StudentName=isnull(invDet.StudentName,'')
			,tgm.GradeName     
			,tsa.AcademicYear
			,invDet.IqamaNumber
			,invDet.IsStaff
			,invDet.TaxableAmount	
			,invDet.TaxAmount	
			,invDet.ItemSubtotal
			,invDet.InvoiceType
			,invSum.InvoiceNo
			,invSum.InvoiceDate
			,invPay.PaymentMethod
			,invPay.PaymentReferenceNumber
		from INV_InvoiceSummary invSum
		join INV_InvoiceDetail invDet on invSum.InvoiceNo=invDet.InvoiceNo
		join tblGradeMaster as tgm on invDet.GradeId = tgm.GradeId
		join tblSchoolAcademic as tsa on invDet.AcademicYear = tsa.SchoolAcademicId
		join INV_InvoicePayment as invPay on invDet.InvoiceNo = invPay.InvoiceNo
		where 
		    invDet.InvoiceType = 'Tuition Fee' 
			AND invSum.ParentId = CASE WHEN @ParentId > 0 THEN @ParentId ELSE invSum.ParentId END  
			AND invDet.InvoiceNo = CASE WHEN @InvoiceNo > 0 THEN @InvoiceNo ELSE invDet.InvoiceNo END
			AND invDet.ParentName LIKE '%'+ CASE WHEN len(@ParentName) > 0 THEN @ParentName ELSE invDet.ParentName  END + '%'  
			AND invDet.IqamaNumber LIKE '%'+ CASE WHEN len(@FatherIqama) > 0 THEN @FatherIqama ELSE invDet.IqamaNumber  END + '%'
			AND invDet.StudentName LIKE '%'+ CASE WHEN len(@StudentName) > 0 THEN @StudentName ELSE invDet.StudentName  END + '%'  
			AND invDet.AcademicYear = CASE WHEN @AcademicYear > 0 THEN @AcademicYear ELSE invDet.AcademicYear END   
			AND (@StartDate IS NULL OR cast(invSum.InvoiceDate as date) >= cast(@StartDate as date))              
			AND (@EndDate IS NULL OR cast(invSum.InvoiceDate as date) <= cast(@EndDate as date))  
			
		
	)t
	group by  ParentId,
        ParentName,
        FatherMobile,
        IqamaNumber,
		StudentId,
        StudentName,
        GradeName,
        AcademicYear,
        IsStaff,
         InvoiceType
		,InvoiceDate
		,InvoiceNo
		,PaymentMethod
		,PaymentReferenceNumber
end
GO
/****** Object:  StoredProcedure [dbo].[SP_AllRevenueReport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_AllRevenueReport]
(
  @ParentId int=0
 ,@ParentName nvarchar(250)=null
 ,@FatherIqama nvarchar(250)=null
 ,@StudentName nvarchar(250)=null
 ,@AcademicYear int=0
 ,@InvoiceNo BigInt=0
 ,@StartDate datetime=null
 ,@EndDate datetime=null
)
AS
BEGIN
	SELECT 
		 ParentId
		,ParentName
		,FatherMobile
		,IqamaNumber
		,StudentId
		,StudentName
		,GradeName
		,CostCenter=CostCenterName
		,AcademicYear
		,IsStaff
		,TaxableAmount=SUM(TaxableAmount)
		,TaxAmount=SUM(TaxAmount)
		,ItemSubtotal=SUM(ItemSubtotal)
		,InvoiceType
		,InvoiceDate
		,InvoiceNo
		,PaymentMethod
		,PaymentReferenceNumber
	INTO #AllRevenuTbl
	FROM
	(
		SELECT 
			 ParentId=ISNULL(tp.ParentCode,0)
             ,invDet.ParentName
			,invDet.FatherMobile
			,StudentId = ISNULL(ts.StudentCode,0)
			,StudentName=ISNULL(invDet.StudentName,'')
			,tgm.GradeName     
			,tsa.AcademicYear
			,invDet.IqamaNumber
			,invDet.IsStaff
			,invDet.TaxableAmount	
			,invDet.TaxAmount	
			,invDet.ItemSubtotal
			,invDet.InvoiceType
			,invSum.InvoiceNo
			,invSum.InvoiceDate
			,invPay.PaymentMethod
			,invPay.PaymentReferenceNumber
			,tcc.CostCenterName
		FROM INV_InvoiceSummary invSum
		INNER JOIN INV_InvoiceDetail invDet ON invSum.InvoiceNo=invDet.InvoiceNo
		INNER JOIN INV_InvoicePayment AS invPay ON invDet.InvoiceNo = invPay.InvoiceNo
		LEFT JOIN tblGradeMaster AS tgm ON invDet.GradeId = tgm.GradeId
		LEFT JOIN tblSchoolAcademic AS tsa ON invDet.AcademicYear = tsa.SchoolAcademicId		
		LEFT JOIN tblParent tp ON tp.ParentId=invDet.ParentId
		LEFT JOIN tblStudent ts ON ts.StudentId=invDet.StudentId
		LEFT JOIN tblCostCenterMaster tcc ON tcc.CostCenterId=ts.CostCenterId
		WHERE --invDet.InvoiceType = 'Tuition Fee'
		--AND 
		invSum.ParentId = CASE WHEN @ParentId > 0 THEN @ParentId ELSE invSum.ParentId END  
		AND invDet.ParentName LIKE '%'+ CASE WHEN len(@ParentName) > 0 THEN @ParentName ELSE invDet.ParentName  END + '%'  
		AND invDet.IqamaNumber LIKE '%'+ CASE WHEN len(@FatherIqama) > 0 THEN @FatherIqama ELSE invDet.IqamaNumber  END + '%' 
		AND invDet.StudentName LIKE '%'+ CASE WHEN len(@StudentName) > 0 THEN @StudentName ELSE invDet.StudentName  END + '%' 
		AND invDet.AcademicYear = CASE WHEN @ParentId > 0 THEN @AcademicYear ELSE invDet.AcademicYear END  
		AND invDet.InvoiceNo = CASE WHEN @InvoiceNo > 0 THEN @InvoiceNo ELSE invDet.InvoiceNo END  
		AND (@StartDate IS NULL OR cast(invSum.InvoiceDate as date) >= cast(@StartDate as date))              
		AND (@EndDate IS NULL OR cast(invSum.InvoiceDate as date) <= cast(@EndDate as date))         
	)t
	GROUP BY  ParentId,
        ParentName,
        FatherMobile,
        IqamaNumber,
		StudentId,
        StudentName,
        GradeName,
        AcademicYear,
        IsStaff,
         InvoiceType
		,InvoiceDate
		,InvoiceNo
		,PaymentMethod
		,PaymentReferenceNumber
		,CostCenterName

	SELECT  ParentId
		,ParentName
		,IqamaNumber
		,StudentId
		,StudentName
		,GradeName
		,CostCenter
		,AcademicYear
		,FatherMobile
		,IsStaff
		,InvoiceType
		,InvoiceNo=CAST(InvoiceNo AS NVARCHAR(100)) 
		,InvoiceDate=CONVERT(NVARCHAR(20),InvoiceDate,103) 
		,TaxableAmount=FORMAT(TaxableAmount,'#,0.00')
		,TaxAmount=FORMAT(TaxAmount,'#,0.00')
		,ItemSubtotal=FORMAT(ItemSubtotal,'#,0.00')
		,PaymentMethod
		,PaymentReferenceNumber 
		FROM  #AllRevenuTbl
	UNION ALL
	SELECT   ParentId=' '
		,ParentName=' '
		,IqamaNumber=' '
		,StudentId=' '
		,StudentName=' '
		,GradeName=' '
		,CostCenter=' '
		,AcademicYear=' '
		,FatherMobile=' '
		,IsStaff=' '
		,InvoiceType=' '
		,InvoiceNo=' '
		,InvoiceDate='Total'
		,TaxableAmount=FORMAT(SUM(TaxableAmount),'#,0.00')
		,TaxAmount=FORMAT(SUM(TaxAmount),'#,0.00')
		,ItemSubtotal=FORMAT(SUM(ItemSubtotal),'#,0.00')
		,PaymentMethod=' '
		,PaymentReferenceNumber =' '
		FROM  #AllRevenuTbl
	DROP TABLE IF EXISTS #AllRevenuTbl; 
END
GO
/****** Object:  StoredProcedure [dbo].[sp_ApproveNotification]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[sp_ApproveNotification]    
 @LoginUserId int=1    
 ,@NotificationIds nvarchar(max)    ='ALL'                    
as  
begin        
    
 declare @isUpdate int =1    
 BEGIN TRY    
  select distinct isnull(country,nationality) As country into #OpenApplyCountry from [OpenApplyStudents] z                        
                  
  insert into #OpenApplyCountry                  
  select distinct isnull(country,nationality) from OpenApplyParents z        
        
  delete t                        
  from #OpenApplyCountry t                        
  inner join tblCountryMaster z                        
  on t.country COLLATE SQL_Latin1_General_CP1_CI_AS =z.CountryName                        
                        
  delete from #OpenApplyCountry where country is NULL                        
      
  if exists(select 1 from #OpenApplyCountry)                        
  begin                        
   insert into tblCountryMaster(CountryName,CountryCode,IsActive,IsDeleted,UpdateDate,UpdateBy)                        
   select country, '' , 1,0, getdate(),@LoginUserId from  #OpenApplyCountry                        
  end                        
                         
  ---End: Master Data- Country                      
            
  insert into tblSection (SectionName,IsActive,IsDeleted,UpdateDate,UpdateBy)            
  select             
   distinct status_level,IsActive=1,IsDeleted=0,UpdateDate=getdate(),UpdateBy=1             
  from OpenApplyStudents where status_level IS NOT NULL           
  and status_level collate SQL_Latin1_General_CP1256_CI_AS not in (select SectionName from tblSection)          
                    
  create table #ApprovableNotification              
  (              
   NotificationId bigint,            
   RecordId nvarchar(400),              
   RecordType nvarchar(400)              
  )              
              
  if(@NotificationIds ='ALL')              
  begin              
   insert into #ApprovableNotification                   
   select               
    distinct notific.NotificationId, notific.RecordId,notific.RecordType               
   from                          
   [tblNotification] notific                
  end              
  else              
  begin              
   insert into #ApprovableNotification                   
   select               
   distinct notific.NotificationId,  notific.RecordId,notific.RecordType               
   from                          
   [tblNotification] notific                        
   inner join          tblNotificationGroupDetail tg on notific.NotificationId= tg.TableRecordId   
   inner join   
   (                        
    SELECT     
     cast(value as int)as NotificationGroupDetailId                        
    FROM STRING_SPLIT(@NotificationIds, ',')                        
    WHERE RTRIM(value) <> ''                        
   )t                         
           on tg.NotificationGroupDetailId=t.NotificationGroupDetailId          
  end    
                    
  --Start : Work for Student                        
                        
  select *                         
  into #student    
  from                         
  (                        
  select                        
  distinct                        
  student_id=os.student_id                        
  ,case when gender='Male' then 1 else 2 end GenderId                        
  --,GradeId=gm.GradeId                        
  --,CostCenterId=gm.CostCenterId                        
  ,GradeId=1                        
  ,CostCenterId=1                        
  ,SchoolId=1                        
  ,SectionId=1                        
  ,StudentName = (ltrim(rtrim(os.first_name))+ ' '+ ltrim(rtrim(os.last_name)))                   
  ,StudentArabicName = ltrim(rtrim(os.other_name))                
  ,StudentEmail = ltrim(rtrim( isnull(os.[email],'')))                
  ,DOB = cast(os.birth_date as date)                           
  ,AdmissionDate = cast(os.enrolled_date as date)                        
  ,StudentAddress = os.full_address                        
  ,StudentStatusId =1                   
  ,WithdrawDate = os.withdrawn_date                        
  ,WithdrawYear = datepart(year, cast(os.withdrawn_date as date))                        
  ,AdmissionYear = os.admitted_date                        
  ,IqamaNo=os.IqamaNo  --Update filed when new chnages done                        
  --,NationalityId=isnull(tc.CountryId,1)    --Update filed when new chnages done                        
  ,NationalityId=999999                        
  ,PassportNo=isnull(passport_id,'')  --Update filed when new chnages done                        
  ,PassportExpiry=null  --Update filed when new chnages done                        
  ,Mobile=os.mobile_phone  --Update filed when new chnages done                        
  ,PrinceAccount=os.PrinceAccount  --Update filed when new chnages done                          
                        
  ,os.grade                       
  ,country=isnull(os.country,os.nationality)                  
  ,os.p_id_school_parent_id          
  ,os.status_level        
  ,OpenApplyStudentId=os.id    
  from                         
  [dbo].[OpenApplyStudents] os                         
  inner join  #ApprovableNotification  notific                          
  on os.id=notific.RecordId                     
  where notific.RecordType='Student'                         
  and os.id is not null                         
  and os.[status]='enrolled'                        
  and os.student_id is not null                         
  )t                        
                        
  update os                        
  set                        
  os.GradeId=gm.GradeId                        
  ,os.CostCenterId=gm.CostCenterId                        
  from #student os                        
  inner join tblGradeMaster gm on os.grade COLLATE SQL_Latin1_General_CP1_CI_AS=gm.GradeName                        
                        
  update os                        
  set                        
  os.NationalityId=tc.CountryId                        
  from #student os                        
  inner join tblCountryMaster tc on os.country COLLATE SQL_Latin1_General_CP1_CI_AS=tc.CountryName                        
                 
  declare @SectionIDNew int=0            
  select top 1 @SectionIDNew=SectionId from tblSection             
            
  --If somehow record not available then update first sectionid          
  update os            
  set os.SectionId=ISNULL( tc.SectionId,@SectionIDNew)            
  from #student os            
  left join tblSection tc on ltrim(rtrim(os.status_level)) COLLATE SQL_Latin1_General_CP1_CI_AS=ltrim(rtrim(tc.SectionName  ))    
  --End : Work for Student    
    
  --Work for Parent    
    
  select vw.*     
  into #ParentInfo    
  from vw_GetStudentOpenApplyParentInfo vw    
  join #student os  on vw.OpenApplyStudentId=os.OpenApplyStudentId    
    
  ---IF only parent record come for approval    
  insert into #ParentInfo    
  select vw.*    
  from vw_GetStudentOpenApplyParentInfo vw    
  join #ApprovableNotification os  on (vw.OpenApplyFatherId=os.RecordId OR vw.OpenApplyMotherId=os.RecordId)    
     
  select distinct *     
  into #ParentInfo2    
  from #ParentInfo    
         
  insert into #ApprovableNotification                   
  select               
   distinct notific.NotificationId,  notific.RecordId,notific.RecordType               
  from                          
  [tblNotification] notific        
  WHERE RecordId IN         
  (        
   SELECT     
    stuMap.OpenApplyParentId      
   FROM #student  stu     
   inner join [OpenApplyStudentParentMap] stuMap on stuMap.OpenApplyStudentId=stu.OpenApplyStudentId    
  )    
    
  if(@isUpdate =1)    
  begin     
   print 'parent merge started'    
   delete from #ParentInfo2 where StudentCode=''    
    
   select *    
   into #ParentInfo3    
   from     
   (    
 select ROW_NUMBER() over(partition by ParentCode order by OpenApplyFatherId desc)as RN ,* from #ParentInfo2    
   )t    
   where t.RN=1    
    
   MERGE tblParent AS TARGET                        
   USING #ParentInfo3 AS SOURCE                         
   ON                         
   (                        
   ltrim(rtrim(cast( TARGET.ParentCode as nvarchar(100)))) COLLATE SQL_Latin1_General_CP1_CI_AS= ltrim(rtrim(cast(SOURCE.ParentCode as nvarchar(100))))    
   )                   
                 
   --When records are matched, update the records if there is any change                        
   WHEN MATCHED --AND TARGET.ProductName <> SOURCE.ProductName OR TARGET.Rate <> SOURCE.Rate                         
   THEN UPDATE                         
   SET                         
   TARGET.ParentImage=      isnull(SOURCE.ParentImage,'')    
   ,TARGET.FatherName=   isnull(SOURCE.FatherName,'')    
   ,TARGET.FatherArabicName=    isnull(SOURCE.FatherArabicName,'')    
   ,TARGET.FatherNationalityId=    isnull(SOURCE.FatherNationalityId,99999)                        
   ,TARGET.FatherMobile=     isnull(SOURCE.FatherMobile,'')    
   ,TARGET.FatherEmail=      isnull(SOURCE.FatherEmail,'')    
   ,TARGET.IsFatherStaff=     isnull(SOURCE.IsFatherStaff,0)                        
                                 
   ,TARGET.MotherName=      isnull(SOURCE.MotherName,'')                        
   ,TARGET.MotherArabicName=    isnull(SOURCE.MotherArabicName,'')    
   ,TARGET.MotherNationalityId=    isnull(SOURCE.MotherNationalityId,99999)    
   ,TARGET.MotherMobile=     isnull(SOURCE.MotherMobile,'')    
   ,TARGET.MotherEmail=      isnull(SOURCE.MotherEmail,'')    
   ,TARGET.IsMotherStaff=     isnull(SOURCE.IsMotherStaff,'')    
   ,TARGET.FatherIqamaNo=     isnull(SOURCE.FatherIqamaNo,'')    
   ,TARGET.MotherIqamaNo=     isnull(SOURCE.MotherIqamaNo,'')    
                         
   ,TARGET.OpenApplyFatherId=  cast(isnull(SOURCE.OpenApplyFatherId,0) as bigint)                        
   ,TARGET.OpenApplyMotherId=   cast( isnull(SOURCE.OpenApplyMotherId,0) as bigint)                        
   ,TARGET.OpenApplyStudentId=   cast( isnull(SOURCE.OpenApplyStudentId,0) as bigint)                        
                        
   --When no records are matched, insert the incoming records from source table to target table                        
   WHEN NOT MATCHED BY TARGET                         
                        
   THEN INSERT                         
   (                        
   ParentCode,                        
   ParentImage,FatherName,FatherArabicName,FatherNationalityId,FatherMobile,FatherEmail,IsFatherStaff                        
   ,MotherName,MotherArabicName,MotherNationalityId,MotherMobile,MotherEmail,IsMotherStaff                        
   ,FatherIqamaNo,MotherIqamaNo,OpenApplyFatherId,OpenApplyMotherId,OpenApplyStudentId,                        
   IsActive,IsDeleted,UpdateDate,UpdateBy                   
   )                         
   VALUES                         
   (                         
   SOURCE.ParentCode                        
   ,isnull(SOURCE.ParentImage,'')    
   ,isnull(SOURCE.FatherName,'')    
   ,isnull(SOURCE.FatherArabicName,'')    
   ,isnull(SOURCE.FatherNationalityId,99999)    
   ,isnull(SOURCE.FatherMobile,'')    
   ,isnull(SOURCE.FatherEmail,'')    
   ,isnull(SOURCE.IsFatherStaff  ,0)    
   ,isnull(SOURCE.MotherName,'')    
   ,isnull(SOURCE.MotherArabicName,'')    
   ,isnull(SOURCE.MotherNationalityId,99999)    
   ,isnull(SOURCE.MotherMobile,'')    
   ,isnull(SOURCE.MotherEmail,'')    
   ,isnull(SOURCE.IsMotherStaff  ,0)    
   ,isnull(SOURCE.FatherIqamaNo,'')    
   ,isnull(SOURCE.MotherIqamaNo,'')    
   ,isnull(SOURCE.OpenApplyFatherId,0)    
   ,isnull(SOURCE.OpenApplyMotherId,0)    
   ,isnull(SOURCE.OpenApplyStudentId,0)    
   ,1,0, getdate(),@LoginUserId                        
   );                        
             
        
   -----Start: Student update         
   print 'student merge started'    
    
   MERGE tblStudent AS TARGET                        
   USING #student AS SOURCE                         
   ON (cast( TARGET.StudentCode as nvarchar(100)) COLLATE SQL_Latin1_General_CP1_CI_AS= cast(SOURCE.student_id as nvarchar(100)))                         
   --When records are matched, update the records if there is any change                        
   WHEN MATCHED --AND TARGET.ProductName <> SOURCE.ProductName OR TARGET.Rate <> SOURCE.Rate                         
   THEN UPDATE                         
   SET                         
   TARGET.StudentName = SOURCE.StudentName,                      
   TARGET.StudentArabicName = SOURCE.StudentArabicName,                        
   TARGET.StudentEmail = isnull(SOURCE.StudentEmail,''),                        
   TARGET.DOB = SOURCE.DOB,                        
   TARGET.GenderId = SOURCE.GenderId,                        
   TARGET.AdmissionDate = isnull(SOURCE.AdmissionDate, getdate()),                        
   TARGET.StudentAddress =isnull( SOURCE.StudentAddress,''),                        
   TARGET.StudentStatusId = SOURCE.StudentStatusId,                        
   TARGET.WithdrawDate =SOURCE.WithdrawDate,                        
   TARGET.WithdrawYear = SOURCE.WithdrawYear,                        
   TARGET.AdmissionYear =SOURCE.AdmissionYear,                        
   TARGET.GradeId =SOURCE.GradeId,                        
   TARGET.CostCenterId =SOURCE.CostCenterId,                        
   TARGET.SectionId =SOURCE.SectionId,                        
   TARGET.IqamaNo =SOURCE.IqamaNo,                        
   TARGET.NationalityId =SOURCE.NationalityId,                        
   TARGET.PassportNo =SOURCE.PassportNo,                        
   TARGET.PassportExpiry =SOURCE.PassportExpiry,                        
   TARGET.Mobile =SOURCE.Mobile,                        
   TARGET.PrinceAccount =SOURCE.PrinceAccount,                        
   TARGET.p_id_school_parent_id =SOURCE.p_id_school_parent_id                  
                          
   --When no records are matched, insert the incoming records from source table to target table                        
   WHEN NOT MATCHED BY TARGET                         
                        
   THEN INSERT                         
   (                        
   StudentCode ,StudentName,StudentArabicName,StudentEmail ,DOB ,GenderId ,                        
   AdmissionDate ,StudentAddress ,StudentStatusId ,WithdrawDate ,WithdrawYear,AdmissionYear,                        
   GradeId ,CostCenterId ,SectionId ,IqamaNo ,NationalityId ,PassportNo,PassportExpiry ,                        
   Mobile ,PrinceAccount , p_id_school_parent_id,                       
   IsActive,IsDeleted,UpdateDate,UpdateBy,                        
   IsGPIntegration,TermId                   
   )                         
   VALUES                         
   (                         
   SOURCE.student_id,SOURCE.StudentName,isnull( SOURCE.StudentArabicName,''),isnull(SOURCE.StudentEmail,''),                        
   SOURCE.DOB,SOURCE.GenderId,                        
   isnull(SOURCE.AdmissionDate, getdate()),isnull( SOURCE.StudentAddress,''),SOURCE.StudentStatusId,                        
   SOURCE.WithdrawDate,SOURCE.WithdrawYear,SOURCE.AdmissionYear,                        
   SOURCE.GradeId,SOURCE.CostCenterId,SOURCE.SectionId,SOURCE.IqamaNo,SOURCE.NationalityId,SOURCE.PassportNo,SOURCE.PassportExpiry,           
   SOURCE.Mobile,SOURCE.PrinceAccount,      source.p_id_school_parent_id,                  
   1,0, getdate(),@LoginUserId,                        
   0,1                        
   );                        
   ---End: Student Update                        
             
   ----------UPdate parent Id              
          
   update stu  
   set                        
   stu.ParentId=par.ParentId                        
   from tblStudent stu                        
   inner join tblParent par                        
   on stu.p_id_school_parent_id COLLATE SQL_Latin1_General_CP1_CI_AS=cast(par.ParentCode    as nvarchar(500))    
    
   delete notific                 
   from [tblNotification] notific                        
   inner join #ApprovableNotification app                        
   on notific.NotificationId=app.NotificationId     
       
   delete notific                 
   from tblNotificationGroupDetail notific                        
   inner join #ApprovableNotification app                        
   on notific.TableRecordId=app.NotificationId         
                        
   select   
 notific.NotificationGroupId, NotificationTypeId,NotificationAction,count(1) as NotificationGroupCount      
   into #notificationGroupDetail    
   from tblNotificationGroupDetail notific    
   group by notific.NotificationGroupId       ,NotificationTypeId,NotificationAction    
       
   update t                 
   set                
 t.NotificationCount=isnull(t2.NotificationGroupCount,0)                
   from tblNotificationGroup t                
   left join #notificationGroupDetail t2 on     
   t.NotificationTypeId=t2.NotificationTypeId    
   and t.NotificationAction=t2.NotificationAction    
  
    
  end    
      
  IF OBJECT_ID('tempdb.dbo.#ApprovableNotification', 'U') IS NOT NULL                        
  DROP TABLE #ApprovableNotification;                         
                        
  IF OBJECT_ID('tempdb.dbo.#student', 'U') IS NOT NULL                        
  DROP TABLE #student;                         
                        
  IF OBJECT_ID('tempdb.dbo.#OpenApplyCountry', 'U') IS NOT NULL                        
  DROP TABLE #OpenApplyCountry;                         
                        
  IF OBJECT_ID('tempdb.dbo.#student', 'U') IS NOT NULL                        
  DROP TABLE #student;                         
                        
  IF OBJECT_ID('tempdb.dbo.#ParentInfo', 'U') IS NOT NULL                        
  DROP TABLE #ParentInfo;                         
                        
  IF OBJECT_ID('tempdb.dbo.#ParentFather', 'U') IS NOT NULL                        
  DROP TABLE #ParentFather;                         
                        
  IF OBJECT_ID('tempdb.dbo.#ParentFatherOther', 'U') IS NOT NULL                        
  DROP TABLE #ParentFatherOther;                         
           
  IF OBJECT_ID('tempdb.dbo.#ParentMother', 'U') IS NOT NULL                        
  DROP TABLE #ParentMother;                         
                          
  IF OBJECT_ID('tempdb.dbo.#ParentMotherOther', 'U') IS NOT NULL                        
  DROP TABLE #ParentMotherOther;                         
                       
  IF OBJECT_ID('tempdb.dbo.#ParentInfo2', 'U') IS NOT NULL                        
  DROP TABLE #ParentInfo2;   
    
 IF OBJECT_ID('tempdb.dbo.#ParentInfo3', 'U') IS NOT NULL                        
 DROP TABLE #ParentInfo3;   
       
  IF OBJECT_ID('tempdb.dbo.#notificationGroupDetail', 'U') IS NOT NULL                        
  DROP TABLE #notificationGroupDetail;                         
    
  ---Start: Master Data- Country                   
               
  SELECT 0 AS Result, 'Saved' AS Response  
  END TRY                          
                          
  BEGIN CATCH                          
                     
 DECLARE @ErrorMessage NVARCHAR(4000);                    
 DECLARE @ErrorSeverity INT;                    
 DECLARE @ErrorState INT;                    
                    
 SELECT                     
 @ErrorMessage = ERROR_MESSAGE() + ' occurred at Line_Number: ' + CAST(ERROR_LINE() AS VARCHAR(50)),                    
 @ErrorSeverity = ERROR_SEVERITY(),                  
 @ErrorState = ERROR_STATE();                    
                    
 RAISERROR (@ErrorMessage, -- Message text.                    
 @ErrorSeverity, -- Severity.                    
 @ErrorState -- State.                    
 );                    
                    
 SELECT -1 AS Result, 'Error!' AS Response                          
 EXEC usp_SaveErrorDetail                          
 RETURN                          
  END CATCH                          
END 
GO
/****** Object:  StoredProcedure [dbo].[sp_ApproveNotificationById]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[sp_ApproveNotificationById]  
 @LoginUserId int=0  
 ,@NotificationGroupDetailId int=0  
AS  
BEGIN  
 BEGIN TRY  
 BEGIN TRANSACTION TRANS1  
 DECLARE @TableToBeUpdate NVARCHAR(500)  
 DECLARE @TableRecordId NVARCHAR(200)  
 DECLARE @TableRecordColumnName nvarchar(200)  
 DECLARE @NotificationAction int  
 DECLARE @NotificationGroupId int  
 DECLARE @NewJson NVARCHAR(MAX)  
 SELECT @TableToBeUpdate=nt.ActionTable,@TableRecordColumnName=ngd.TableRecordColumnName  
 ,@TableRecordId=ngd.TableRecordId,@NotificationAction=NotificationAction,@NotificationGroupId=NotificationGroupId  
 ,@NewJson=NewValueJson  
 FROM tblNotificationGroupDetail ngd  
 INNER JOIN tblNotificationTypeMaster nt  
  ON ngd.NotificationTypeId=nt.NotificationTypeId  
 WHERE ngd.NotificationGroupDetailId=@NotificationGroupDetailId   
 DECLARE @Query NVARCHAR(MAX)  
 SET @Query='UPDATE '+@TableToBeUpdate+' SET IsRejected = 0, IsApproved = 1 WHERE '+@TableRecordColumnName+'='+@TableRecordId  
 --PRINT @Query  
 EXEC (@Query)    
 IF @NotificationAction=3  
 BEGIN  
  SET @Query='UPDATE '+@TableToBeUpdate+' SET IsDeleted = 1 WHERE '+@TableRecordColumnName+'='+@TableRecordId  
  --PRINT @Query  
  EXEC (@Query)  
 END  
   
 IF (@NotificationAction=2)  
 BEGIN  
  DECLARE @JsonKeyVal NVARCHAR(MAX);  
  DECLARE @JsonKey NVARCHAR(MAX);  
  DECLARE @Sql NVARCHAR(MAX);  
  DECLARE json_cursor CURSOR FOR  
  SELECT [key], value  
  FROM OPENJSON(@NewJson);  
  
  OPEN json_cursor;  
  FETCH NEXT FROM json_cursor INTO @JsonKey, @JsonKeyVal;  
  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   SET @Sql = 'UPDATE '+@TableToBeUpdate+' SET '+ @JsonKey+ ' = '''+ @JsonKeyVal+ ''' WHERE '+@TableRecordColumnName+'='+@TableRecordId+';'  
   EXEC (@Sql)  
   --PRINT @Sql  
   FETCH NEXT FROM json_cursor INTO @JsonKey, @JsonKeyVal;  
  END  
  
  CLOSE json_cursor;  
  DEALLOCATE json_cursor;  
 END  
 DELETE FROM tblNotificationGroupDetail WHERE NotificationGroupDetailId=@NotificationGroupDetailId  
 UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1  
 WHERE NotificationGroupId=@NotificationGroupId  
 SELECT 0 AS Result, 'Success' AS Response  
 COMMIT TRAN TRANS1  
    
 END TRY  
 BEGIN CATCH  
   ROLLBACK TRAN TRANS1  
   SELECT -1 AS Result, 'Error!' AS Response  
   EXEC usp_SaveErrorDetail  
   RETURN  
 END CATCH  
END  --[sp_ApproveNotificationById] 1,4  
GO
/****** Object:  StoredProcedure [dbo].[sp_ApproveNotificationParent]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[sp_ApproveNotificationParent]    
 @LoginUserId int=1    
 ,@NotificationIds nvarchar(max)    ='ALL'                    
as                      
begin        
    
 declare @isUpdate int =1    
 BEGIN TRY    
  select distinct isnull(country,nationality) As country into #OpenApplyCountry from [OpenApplyStudents] z                        
                  
  insert into #OpenApplyCountry                  
  select distinct isnull(country,nationality) from OpenApplyParents z        
        
  delete t                        
  from #OpenApplyCountry t                        
  inner join tblCountryMaster z                        
  on t.country COLLATE SQL_Latin1_General_CP1_CI_AS =z.CountryName                        
                        
  delete from #OpenApplyCountry where country is NULL  
      
  if exists(select 1 from #OpenApplyCountry)                        
  begin                        
   insert into tblCountryMaster(CountryName,CountryCode,IsActive,IsDeleted,UpdateDate,UpdateBy)  
   select country, '' , 1,0, getdate(),@LoginUserId from  #OpenApplyCountry  
  end                        
                         
  ---End: Master Data- Country  
  
  create table #ApprovableNotification              
  (              
   NotificationId bigint,            
   RecordId nvarchar(400),              
   RecordType nvarchar(400)              
  )              
              
  if(@NotificationIds ='ALL')              
  begin              
   insert into #ApprovableNotification                   
   select               
    distinct notific.NotificationId, notific.RecordId,notific.RecordType               
   from                          
   [tblNotification] notific                
  end              
  else              
  begin              
   insert into #ApprovableNotification                   
   select               
   distinct notific.NotificationId,  notific.RecordId,notific.RecordType               
   from                          
   [tblNotification] notific                        
   inner join          tblNotificationGroupDetail tg on notific.NotificationId= tg.TableRecordId   
   inner join   
   (                        
    SELECT     
     cast(value as int)as NotificationGroupDetailId                        
    FROM STRING_SPLIT(@NotificationIds, ',')                        
    WHERE RTRIM(value) <> ''                        
   )t                         
    on tg.NotificationGroupDetailId=t.NotificationGroupDetailId                   
  end  
  --Work for Parent    
    
  select vw.*     
  into #ParentInfo    
  from vw_GetStudentOpenApplyParentInfo vw    
  join #ApprovableNotification os  on (vw.OpenApplyFatherId=os.RecordId OR vw.OpenApplyMotherId=os.RecordId )  
    
  select distinct *     
  into #ParentInfo2    
  from #ParentInfo    
    
  if(@isUpdate =1)    
  begin     
   print 'parent merge started'    
   delete from #ParentInfo2 where StudentCode=''    
    
   select *    
   into #ParentInfo3    
   from     
   (    
 select ROW_NUMBER() over(partition by ParentCode order by OpenApplyFatherId desc)as RN ,* from #ParentInfo2    
   )t    
   where t.RN=1    
    
   MERGE tblParent AS TARGET                        
   USING #ParentInfo3 AS SOURCE                         
   ON                         
   (                        
   ltrim(rtrim(cast( TARGET.ParentCode as nvarchar(100)))) COLLATE SQL_Latin1_General_CP1_CI_AS= ltrim(rtrim(cast(SOURCE.ParentCode as nvarchar(100))))    
   )                   
                 
   --When records are matched, update the records if there is any change                        
   WHEN MATCHED --AND TARGET.ProductName <> SOURCE.ProductName OR TARGET.Rate <> SOURCE.Rate                         
   THEN UPDATE                         
   SET                         
   TARGET.ParentImage=      isnull(SOURCE.ParentImage,'')    
   ,TARGET.FatherName=   isnull(SOURCE.FatherName,'')    
   ,TARGET.FatherArabicName=  isnull(SOURCE.FatherArabicName,'')    
   ,TARGET.FatherNationalityId=    isnull(SOURCE.FatherNationalityId,99999)                        
   ,TARGET.FatherMobile=     isnull(SOURCE.FatherMobile,'')    
   ,TARGET.FatherEmail=      isnull(SOURCE.FatherEmail,'')    
   ,TARGET.IsFatherStaff=     isnull(SOURCE.IsFatherStaff,0)                        
                                 
   ,TARGET.MotherName=      isnull(SOURCE.MotherName,'')                        
   ,TARGET.MotherArabicName=    isnull(SOURCE.MotherArabicName,'')    
   ,TARGET.MotherNationalityId=    isnull(SOURCE.MotherNationalityId,99999)    
   ,TARGET.MotherMobile=     isnull(SOURCE.MotherMobile,'')    
   ,TARGET.MotherEmail=      isnull(SOURCE.MotherEmail,'')    
   ,TARGET.IsMotherStaff=     isnull(SOURCE.IsMotherStaff,'')    
   ,TARGET.FatherIqamaNo=     isnull(SOURCE.FatherIqamaNo,'')    
   ,TARGET.MotherIqamaNo=     isnull(SOURCE.MotherIqamaNo,'')    
                         
   ,TARGET.OpenApplyFatherId=  cast(isnull(SOURCE.OpenApplyFatherId,0) as bigint)                        
   ,TARGET.OpenApplyMotherId=   cast( isnull(SOURCE.OpenApplyMotherId,0) as bigint)                        
   ,TARGET.OpenApplyStudentId=   cast( isnull(SOURCE.OpenApplyStudentId,0) as bigint)                        
                        
   --When no records are matched, insert the incoming records from source table to target table                        
   WHEN NOT MATCHED BY TARGET                         
                        
   THEN INSERT                         
   (                        
   ParentCode,                        
   ParentImage,FatherName,FatherArabicName,FatherNationalityId,FatherMobile,FatherEmail,IsFatherStaff                        
   ,MotherName,MotherArabicName,MotherNationalityId,MotherMobile,MotherEmail,IsMotherStaff                        
   ,FatherIqamaNo,MotherIqamaNo,OpenApplyFatherId,OpenApplyMotherId,OpenApplyStudentId,                        
   IsActive,IsDeleted,UpdateDate,UpdateBy                   
   )                         
   VALUES                         
   (                         
   SOURCE.ParentCode                        
   ,isnull(SOURCE.ParentImage,'')    
   ,isnull(SOURCE.FatherName,'')    
   ,isnull(SOURCE.FatherArabicName,'')    
   ,isnull(SOURCE.FatherNationalityId,99999)    
   ,isnull(SOURCE.FatherMobile,'')    
   ,isnull(SOURCE.FatherEmail,'')    
   ,isnull(SOURCE.IsFatherStaff  ,0)    
   ,isnull(SOURCE.MotherName,'')    
   ,isnull(SOURCE.MotherArabicName,'')    
   ,isnull(SOURCE.MotherNationalityId,99999)    
   ,isnull(SOURCE.MotherMobile,'')    
   ,isnull(SOURCE.MotherEmail,'')    
   ,isnull(SOURCE.IsMotherStaff  ,0)    
   ,isnull(SOURCE.FatherIqamaNo,'')    
   ,isnull(SOURCE.MotherIqamaNo,'')    
   ,isnull(SOURCE.OpenApplyFatherId,0)    
   ,isnull(SOURCE.OpenApplyMotherId,0)    
   ,isnull(SOURCE.OpenApplyStudentId,0)    
   ,1,0, getdate(),@LoginUserId                        
   );  
     
   delete notific                 
   from [tblNotification] notific                        
   inner join #ApprovableNotification app                        
   on notific.NotificationId=app.NotificationId     
       
   delete notific                 
   from tblNotificationGroupDetail notific                        
   inner join #ApprovableNotification app                        
   on notific.TableRecordId=app.NotificationId         
                        
   select notific.NotificationGroupId, NotificationTypeId,NotificationAction,count(1) as NotificationGroupCount      
   into #notificationGroupDetail    
   from tblNotificationGroupDetail notific    
   group by notific.NotificationGroupId       ,NotificationTypeId,NotificationAction    
       
   update t                 
   set                
   t.NotificationCount=isnull(t2.NotificationGroupCount,0)                
   from tblNotificationGroup t                
   left join #notificationGroupDetail t2 on     
   t.NotificationTypeId=t2.NotificationTypeId    
   and t.NotificationAction=t2.NotificationAction    
    
  end    
      
  IF OBJECT_ID('tempdb.dbo.#ApprovableNotification', 'U') IS NOT NULL                        
  DROP TABLE #ApprovableNotification;      
                        
  IF OBJECT_ID('tempdb.dbo.#OpenApplyCountry', 'U') IS NOT NULL                        
  DROP TABLE #OpenApplyCountry;  
  
  IF OBJECT_ID('tempdb.dbo.#ParentInfo', 'U') IS NOT NULL                        
  DROP TABLE #ParentInfo;  
  
  IF OBJECT_ID('tempdb.dbo.#ParentInfo2', 'U') IS NOT NULL                        
  DROP TABLE #ParentInfo2;                
  
  IF OBJECT_ID('tempdb.dbo.#ParentInfo3', 'U') IS NOT NULL                        
  DROP TABLE #ParentInfo3;  
  
  IF OBJECT_ID('tempdb.dbo.#notificationGroupDetail', 'U') IS NOT NULL                        
  DROP TABLE #notificationGroupDetail;                         
    
  ---Start: Master Data- Country                   
               
  SELECT 0 AS Result, 'Saved' AS Response          
  END TRY                          
                          
  BEGIN CATCH                          
                     
  DECLARE @ErrorMessage NVARCHAR(4000);                    
  DECLARE @ErrorSeverity INT;                    
  DECLARE @ErrorState INT;                    
                    
  SELECT                     
   @ErrorMessage = ERROR_MESSAGE() + ' occurred at Line_Number: ' + CAST(ERROR_LINE() AS VARCHAR(50)),                    
   @ErrorSeverity = ERROR_SEVERITY(),                  
   @ErrorState = ERROR_STATE();                    
                    
  RAISERROR (@ErrorMessage, -- Message text.                    
   @ErrorSeverity, -- Severity.                    
   @ErrorState -- State.                    
  );                    
                    
  SELECT -1 AS Result, 'Error!' AS Response                          
  EXEC usp_SaveErrorDetail                          
  RETURN                          
  END CATCH                          
END 
GO
/****** Object:  StoredProcedure [dbo].[sp_ApproveNotifications]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[sp_ApproveNotifications]        
@LoginUserId int=0        
,@NotificationGroupDetailIds nvarchar(max)=''      
,@NotificationGroupId int= 0      
,@NotificationTypeId int=0      
AS        
BEGIN        
 BEGIN TRY        
 BEGIN TRANSACTION TRANS1        
       
 if(@NotificationGroupDetailIds = '')        
 begin        
  SELECT -1 AS Result, 'Error!' AS Response        
 end        
 else        
 begin        
  if exists( select * from tblNotificationTypeMaster where NotificationTypeId=@NotificationTypeId   
  and NotificationType='OpenApplyRecordProcessing' and ActionTable='tblStudent')  
  begin    
   exec sp_ApproveNotification @LoginUserId,@NotificationGroupDetailIds        
  end  
  else if exists( select * from tblNotificationTypeMaster where NotificationTypeId=@NotificationTypeId   
  and NotificationType='OpenApplyRecordProcessing' and ActionTable='tblParent')  
  begin    
   exec [sp_ApproveNotificationParent] @LoginUserId,@NotificationGroupDetailIds        
  end  
 else      
  begin  
    select         
     ngd.* , nt.NotificationType               
    into #ApprovableNotificationList                 
    from                  
    tblNotificationGroupDetail ngd            
    INNER JOIN tblNotificationTypeMaster nt        
    ON ngd.NotificationTypeId=nt.NotificationTypeId        
    inner join                 
    (                
     SELECT cast(value as int)as NotificationGroupDetailId                
     FROM STRING_SPLIT(@NotificationGroupDetailIds, ',')                
     WHERE RTRIM(value) <> ''                
    )t                 
    on ngd.NotificationGroupDetailId= t.NotificationGroupDetailId      
      
     DECLARE @NotificationGroupDetailId INT, @TableRecordId INT, @NotificationType NVARCHAR(100), @NotificationIds nvarchar(max)        
     set @NotificationIds=''        
        
     --Declare a cursor          
     DECLARE PrintCustomers CURSOR          
     FOR          
   SELECT NotificationGroupDetailId, NotificationType, TableRecordId         
   FROM #ApprovableNotificationList          
        
     --Open cursor          
     OPEN PrintCustomers          
        
     --Fetch the record into the variables.          
     FETCH NEXT FROM PrintCustomers INTO          
     @NotificationGroupDetailId, @NotificationType ,@TableRecordId        
        
     WHILE @@FETCH_STATUS = 0          
     BEGIN          
   IF (@NotificationType = 'OpenApplyRecordProcessing'  )        
   BEGIN        
        
    if(@NotificationIds = '')        
    begin        
     set @NotificationIds =@NotificationIds+ cast(@TableRecordId as nvarchar(50))        
    end        
    else        
    begin        
     set @NotificationIds=@NotificationIds+','+cast(@TableRecordId as nvarchar(50))        
    end        
      
   END          
   else        
   begin         
    exec sp_ApproveNotificationById @LoginUserId,  @NotificationGroupDetailId        
   end        
           
   --Fetch the next record into the variables.          
   FETCH NEXT FROM PrintCustomers INTO          
   @NotificationGroupDetailId, @NotificationType ,@TableRecordId        
     END         
        
     --Close the cursor          
     CLOSE PrintCustomers          
          
     --Deallocate the cursor          
     DEALLOCATE PrintCustomers          
        
    --In the end call- sp_ApproveNotification        
    if(@NotificationIds !='' )        
    begin      
  set @NotificationIds=REVERSE(SUBSTRING(  REVERSE(@NotificationIds),    PATINDEX('%[A-Za-z0-9]%',REVERSE(@NotificationIds)),        
    LEN(@NotificationIds) - (PATINDEX('%[A-Za-z0-9]%',REVERSE(@NotificationIds)) - 1)   ) )           
    print @NotificationIds       
   exec sp_ApproveNotification @LoginUserId,@NotificationIds        
    end      
    else if(@NotificationGroupDetailIds='ALL')      
    begin      
   print @NotificationIds +'ALL'      
   exec sp_ApproveNotification @LoginUserId,'ALL'      
      
    end      
   end      
   end      
  COMMIT TRAN TRANS1                
  SELECT 0 AS Result, 'Saved' AS Response        
 END TRY        
 BEGIN CATCH        
 DECLARE @ErrorMessage NVARCHAR(4000);                  
  DECLARE @ErrorSeverity INT;                  
  DECLARE @ErrorState INT;                  
                  
  SELECT                   
     @ErrorMessage = ERROR_MESSAGE() + ' occurred at Line_Number: ' + CAST(ERROR_LINE() AS VARCHAR(50)),                  
     @ErrorSeverity = ERROR_SEVERITY(),                
     @ErrorState = ERROR_STATE();                  
                  
  RAISERROR (@ErrorMessage, -- Message text.                  
     @ErrorSeverity, -- Severity.                  
    @ErrorState -- State.                  
  );                  
                  
                  
   ROLLBACK TRAN TRANS1                        
   SELECT -1 AS Result, 'Error!' AS Response                        
   EXEC usp_SaveErrorDetail                        
   RETURN                        
      
 END CATCH        
       
END 
GO
/****** Object:  StoredProcedure [dbo].[sp_CleanUpOpenApplyRecord]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[sp_CleanUpOpenApplyRecord]
as
begin
	truncate table OpenApplyParents
	truncate table OpenApplyStudentParentMap
	truncate table openapplystudents
end
GO
/****** Object:  StoredProcedure [dbo].[sp_ClearPreviousOpenApplyNotification]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[sp_ClearPreviousOpenApplyNotification]
as
begin
	delete from [tblNotification]
	where RecordType in ('Father','Student','Mother')

	delete from [OpenApplyStudents]
	delete from [OpenApplyParents]

end

select * from [tblNotification]
GO
/****** Object:  StoredProcedure [dbo].[sp_CreateGLEntry]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[sp_CreateGLEntry]
@GLEntryType nvarchar(50),
@MiscId int
as 
begin
--@GLEntryType = Acedemic year Change
--Then @MiscId - School Id

--@GLEntryType = InvoiceType
--Then @MiscId - Parent Id


	if(@GLEntryType = 'AcedemicYear')
	begin
		select * from [dbo].[tblFeeStructure]
		select * from tblInvoiceTypeMaster

	end

select 1

select * from [dbo].[tblParentAccount]

end


--sp_helptext sp_GetInvoiceType
create table [Temp_GL]
(
BACHNUMB	nvarchar(30) null
,JRNENTRY	int null
,TRXDATE	datetime null
,REFRENCE	nvarchar(62) null
,ACTNUMST	nvarchar(258) null
,ACTINDX	int	 null
,DSCRIPTN	nvarchar(62) null
,DEBITAMT	decimal(19   ,5) 
,CRDTAMNT	decimal(19   ,5) null
,SQNCLINE	decimal(19   ,5) 
,ACCTTYPE	int null
,USERID	nvarchar(30)     	     	null
,RowId	int not null
,ARDSCJVD	nvarchar(1000) null
,InterID	nvarchar(10) null
,DTA_GroupID	char null
,DTA_CodeID	char null
,ICTRX	int null
,PostingDesc	char null
,FUNLCURR_T	char null
,FUNCRIDX_T	bigint null
,XCHGRATE	decimal(18   ,7)    	null
,EXGTBLID	nvarchar(30) null
,EXCHDATE	datetime  null
,RATETPID	nvarchar(30) null
,CorrespondingUnit	nvarchar(30) null
,ORDEBITAMT	decimal(18   ,7)    	null
,ORCRDTAMNT	decimal(18   ,7)    	null

)
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVAdvanceFeeRevenueExport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_CSVAdvanceFeeRevenueExport]    
  @ParentId int=0
 ,@ParentName nvarchar(250)=null
 ,@FatherIqama nvarchar(250)=null
 ,@StudentName nvarchar(250)=null
 ,@AcademicYear int=0
 ,@InvoiceNo BigInt=0
 ,@StartDate datetime=null
 ,@EndDate datetime=null
 AS                            
BEGIN      
EXEC SP_AdvanceFeeReport    
	@ParentId    
	,@ParentName    
	,@FatherIqama    
	,@StudentName    
	,@AcademicYear    
	,@InvoiceNo    
	,@StartDate
	,@EndDate     
END    
    
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVallrevenueexport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_CSVallrevenueexport]    
  @ParentId int=0
 ,@ParentName nvarchar(250)=null
 ,@FatherIqama nvarchar(250)=null
 ,@StudentName nvarchar(250)=null
 ,@AcademicYear int=0
 ,@InvoiceNo BigInt=0
 ,@StartDate datetime=null
 ,@EndDate datetime=null
 AS                            
BEGIN      
EXEC SP_AllRevenueReport
	@ParentId    
	,@ParentName    
	,@FatherIqama    
	,@StudentName    
	,@AcademicYear    
	,@InvoiceNo    
	,@StartDate
	,@EndDate     
END    
    
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVdiscountreportexport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_CSVdiscountreportexport]    
   @ParentId INT=0
 ,@ParentName NVARCHAR(200)=null
 ,@FatherIqama NVARCHAR(200)=null
 ,@StudentName NVARCHAR(100)=null
 ,@AcademicYearId INT=0
 ,@StartDate DATETIME=null
 ,@EndDate DATETIME=null
 AS                            
BEGIN      
	EXEC SP_DiscountReport    
		@ParentId
	   ,@ParentName    
	   ,@FatherIqama    
	   ,@StudentName  
	   ,@AcademicYearId   
	   ,@StartDate
	   ,@EndDate     
END    
    
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVEntranceRevenueExport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_CSVEntranceRevenueExport]    
  @ParentId int=0
 ,@ParentName nvarchar(250)=null
 ,@FatherIqama nvarchar(250)=null
 ,@StudentName nvarchar(250)=null
 ,@AcademicYear int=0
 ,@InvoiceNo BigInt=0
 ,@StartDate datetime=null
 ,@EndDate datetime=null
 AS                            
BEGIN      
EXEC SP_EntranceFeesReport    
	@ParentId    
	,@ParentName    
	,@FatherIqama    
	,@StudentName    
	,@AcademicYear    
	,@InvoiceNo    
	,@StartDate
	,@EndDate     
END    
    
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVInvoiceExport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_CSVInvoiceExport]    
	 @InvoiceId bigint = 0,                
	 @Status nvarchar(50) = NULL,                
	 @InvoiceDateStart date = NULL,                
	 @InvoiceDateEnd date = NULL,                
	 @InvoiceType nvarchar(50) = NULL,                
	 @InvoiceNo nvarchar(50) = NULL,                
	 @ParentCode nvarchar(50) = NUll,                
	 @ParentName nvarchar(400) = NULL,        
	 @FatherMobile nvarchar(200) = NULL      
 AS  
 BEGIN                            
 SET NOCOUNT ON;                             
             
	SELECT                   
		tis.InvoiceId                  
		,tis.InvoiceNo                  
		,InvoiceDate= convert(varchar, tis.InvoiceDate, 103)     
		,tis.Status                  
		,tis.PublishedBy                  
		,tis.CreditNo                  
		,tis.CreditReason                  
		,tis.CustomerName              
		,tis.IqamaNumber  
		,tis.IsDeleted                  
		,tis.UpdateDate                  
		,tis.UpdateBy                 
		,InvoiceType=isnull(tis.InvoiceType,'Invoice')
		,tis.InvoiceRefNo
	into #InvoiceSummary          
	FROM INV_InvoiceSummary tis                         
	--LEFT JOIN tblParent tp ON tis.ParentID = tp.ParentId                     
	WHERE tis.InvoiceId = CASE WHEN @InvoiceId > 0 THEN @InvoiceId ELSE tis.InvoiceId END                  
	AND (@Status IS NULL OR tis.[Status] = @Status)                  
	AND (@InvoiceDateStart IS NULL OR cast(tis.InvoiceDate as date) >= cast(@InvoiceDateStart as date))                  
	AND (@InvoiceDateEnd IS NULL OR cast(tis.InvoiceDate as date) <= cast(@InvoiceDateEnd as date))                  
	AND (@InvoiceType IS NULL OR tis.InvoiceType = @InvoiceType)                  
	AND (@InvoiceNo IS NULL OR tis.InvoiceNo = @InvoiceNo)                  
	AND tis.IsDeleted = 0         
  
	select  
	tis.InvoiceNo     
	,TaxableAmount=sum(tis.TaxableAmount)  
	,TaxAmount=sum(tis.TaxAmount)  
	,ItemSubtotal=sum(tis.ItemSubtotal)  
	into #InvoiceDetail  
	from INV_InvoiceDetail tis  
	join #InvoiceSummary invSum  
	on tis.InvoiceNo=invSum.InvoiceNo  
	group by tis.InvoiceNo  
     
     --select  @ParentCode        
 select       
  t.InvoiceNo, t.ParentID,t.ParentName,t.FatherMobile,t.ParentCode,t.StudentId,t.StudentName,t.StudentCode,t.InvoiceTypeValue,        
  ROW_NUMBER() over(partition by t.InvoiceNo order by  t.InvoiceNo) as RN          
 into #INDMobile          
 from          
 (          
  select distinct           
   ins.InvoiceNo        
   ,ParentID= case when tp.ParentID is null then ind.ParentID  else tp.ParentID end        
   ,ParentName= case when tp.FatherName COLLATE SQL_Latin1_General_CP1256_CI_AS  is null then ind.ParentName  else tp.FatherName COLLATE SQL_Latin1_General_CP1256_CI_AS  end        
   ,FatherMobile= case when tp.FatherMobile is null then ind.FatherMobile  else tp.FatherMobile end        
   ,ParentCode= case when tp.ParentCode is null then ''  else tp.ParentCode end        
              
   ,StudentId= case when ts.StudentId is null then ind.StudentId  else ts.StudentId end        
   ,StudentName=case when ind.InvoiceType like '%Uniform%' then '' else  
  case when ts.StudentName COLLATE SQL_Latin1_General_CP1256_CI_AS  is null then ind.StudentName    
  else ts.StudentName COLLATE SQL_Latin1_General_CP1256_CI_AS   
  end       
 end  
   ,StudentCode= case when ts.StudentCode is null then ''  else ts.StudentCode end          
           
   ,InvoiceTypeValue=    
   (select REPLACE(STUFF(CAST((          
    SELECT   ', ' +CAST(c.InvoiceType AS VARCHAR(MAX))          
     FROM (           
     SELECT distinct scm.InvoiceType              
    FROM INV_InvoiceDetail AS scm                
    WHERE scm.InvoiceNo = ins.InvoiceNo        
       
   ) c          
  FOR XML PATH(''), TYPE) AS VARCHAR(MAX)), 1, 2, ''),' ',' ')  
 )  
 from           
 #InvoiceSummary ins          
 join INV_InvoiceDetail ind on ins.InvoiceNo=ind.InvoiceNo          
 LEFT JOIN tblParent tp ON ind.ParentID = tp.ParentId          
 AND tp.ParentCode=CASE WHEN @ParentCode IS NULL OR @ParentCode='' THEN tp.ParentCode ELSE @ParentCode END      
 AND ind.FatherMobile=CASE WHEN @FatherMobile IS NULL OR @FatherMobile='' THEN ind.FatherMobile ELSE @FatherMobile END      
 AND tp.FatherName like '%' + CASE WHEN @ParentName IS NULL OR @ParentName='' THEN tp.FatherName ELSE @ParentName END +'%'      
 LEFT JOIN tblStudent ts ON ind.StudentId = ts.StudentId        
        
 where ind.FatherMobile is null OR len( ISNULL(ind.FatherMobile,''))>0          
 )t    
    
 delete from #INDMobile where RN>1     

 ----Get Max payemtn info
 select  
 ROW_NUMBER() over(partition by tis.InvoiceNo order by  tis.PaymentAmount desc) as RN          
	,tis.InvoiceNo     
	,tis.PaymentReferenceNumber
	,tis.PaymentMethod
	into #InvoicePayment  
	from INV_InvoicePayment tis  
	join #InvoiceSummary invSum  
	on tis.InvoiceNo=invSum.InvoiceNo  

	 delete from #InvoicePayment where RN>1    
      
 select     
  ins.*  
 
  ,ParentID=cast( isnull(ind.ParentID  ,'') as nvarchar(100))        
  ,ParentName=isnull(ind.ParentName  ,'')        
  ,FatherMobile=isnull(ind.FatherMobile  ,'')        
  ,ParentCode=isnull(ind.ParentCode  ,'')        
  ,StudentId=isnull(ind.StudentId  ,'')        
  ,StudentName=isnull(ind.StudentName  ,'')        
  ,StudentCode=isnull(ind.StudentCode,'')        
  ,InvoiceTypeValue=ind.InvoiceTypeValue
  ,indPay.PaymentMethod
  ,indPay.PaymentReferenceNumber
  ,invDet.TaxableAmount  
  ,invDet.TaxAmount  
  ,invDet.ItemSubtotal  
 from #InvoiceSummary ins   
 join #InvoiceDetail invDet on ins.InvoiceNo=invDet.InvoiceNo  
 left join  #INDMobile ind on ins.InvoiceNo=ind.InvoiceNo  
  left join  #InvoicePayment indPay on ins.InvoiceNo=indPay.InvoiceNo     
 WHERE     
 --isnull(ParentCode,'')=CASE WHEN @ParentCode IS NULL OR @ParentCode='' THEN ParentCode ELSE @ParentCode END    
  (@ParentCode IS NULL OR isnull(ParentCode,'') like '%' + @ParentCode  +'%'   )    
 and (@FatherMobile IS NULL OR isnull(FatherMobile,'') like '%' + @FatherMobile  +'%'   )    
 and (@ParentName IS NULL OR isnull(ParentName,'') like '%' + @ParentName  +'%'   )    
 --AND isnull(FatherMobile,'') like '%' + CASE WHEN @FatherMobile IS NULL OR @FatherMobile='' THEN FatherMobile ELSE @FatherMobile END  +'%'      
 --AND isnull(ParentName,'') like '%' + CASE WHEN @ParentName IS NULL OR @ParentName='' THEN ParentName ELSE @ParentName END +'%'      
  ORDER BY ins.InvoiceNo DESC         
    
    
 drop table #InvoiceSummary        
 drop table #INDMobile  
 drop table #InvoiceDetail  
  
END 
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVParent]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_CSVParent]   
AS  
BEGIN  
 SET NOCOUNT ON;   
 SELECT tp.ParentCode AS [Parent ID]
  ,tp.FatherName AS [Father Name]
  ,tp.FatherArabicName AS [Father Arabic Name]
  ,ftc.CountryName AS [Father Nationality]
  ,tp.FatherMobile  AS [Father Mobile]
  ,tp.FatherEmail  AS [Father Email]
  ,tp.FatherIqamaNo  AS [Father Iqama No]
  ,CASE WHEN tp.IsFatherStaff=1 THEN 'Yes' ELSE 'No' END  [Father Staff]
  ,tp.MotherName  AS [Mother Name]
  ,tp.MotherArabicName  AS [Mother Arabic Name]
  ,mtc.CountryName AS [Mother Nationality]
  ,tp.MotherMobile  AS [Mother Mobile]
  ,tp.MotherEmail  AS [Mother Email]
  ,tp.MotherIqamaNo  AS [Mother Iqama No]
  ,CASE WHEN tp.IsMotherStaff=1 THEN 'Yes' ELSE 'No' END  AS [Mother Staff]
  ,tpa.ReceivableAccount AS [Receivable Account]
  ,tpa.AdvanceAccount AS [Advance Account]
  ,CASE WHEN tp.IsActive=1 THEN 'Active' ELSE 'In-active' END AS [Active]  
 FROM tblParent tp   
 LEFT JOIN tblParentAccount tpa   
  ON tpa.ParentId = tp.ParentId AND tpa.IsDeleted =  0 AND tpa.IsActive = 1 
 LEFT JOIN tblCountryMaster ftc  
  ON ftc.CountryId = tp.FatherNationalityId  
 LEFT JOIN tblCountryMaster mtc  
  ON mtc.CountryId = tp.MotherNationalityId  
 WHERE tp.IsActive =  1  AND tp.IsDeleted =  0  
 ORDER BY tp.ParentCode
END
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVStudent]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_CSVStudent]  
AS    
BEGIN    
 SET NOCOUNT ON;     
 SELECT  stu.StudentCode AS [Student ID]  
  ,tp.ParentCode AS [Parent ID]  
  ,stu.StudentName AS [Student Name]  
  ,stu.StudentArabicName   AS [Student Arabic Name]  
  ,stu.StudentEmail  AS [Student Email   
  ,stu.DOB   AS [Date of Birth]  
  ,stu.IqamaNo   AS [Iqama No]  
  ,tc.CountryName  AS [Nationality]   
  ,tgt.GenderTypeName   AS [Gender]  
  ,stu.AdmissionDate   AS [Admission Date]  
  ,tcc.CostCenterName AS [Cost Center]    
  ,tg.GradeName   AS [Grade]  
  ,ts.SectionName   AS [Section]  
  ,stu.PassportNo   AS [Passport No]  
  ,stu.PassportExpiry  AS [Passport Expiry]   
  ,stu.Mobile   AS [Mobile]  
  ,stu.StudentAddress   AS [Address]  
  ,tss.StatusName   AS [Status]   
  ,CASE WHEN stu.IsGPIntegration=1 THEN 'Yes' ELSE 'No' END  AS [GP Integration]    
  ,tt.TermName   AS [Term]  
  ,stu.AdmissionYear   AS [Admission Year]  
  ,CASE WHEN stu.PrinceAccount=1 THEN 'Yes' ELSE 'No' END  AS [PrinceAccount]   
 FROM tblStudent stu     
 LEFT JOIN tblParent tp    
  ON tp.ParentId = stu.ParentId    
 LEFT JOIN tblCountryMaster tc    
  ON tc.CountryId = stu.NationalityId    
 LEFT JOIN tblGenderTypeMaster tgt    
  ON tgt.GenderTypeId = stu.GenderId    
 LEFT JOIN tblCostCenterMaster tcc    
  ON tcc.CostCenterId = stu.CostCenterId    
 LEFT JOIN tblGradeMaster tg    
  ON tg.GradeId = stu.GradeId    
 LEFT JOIN tblSection ts    
  ON ts.SectionId = stu.SectionId    
 LEFT JOIN tblStudentStatus tss    
  ON tss.StudentStatusId = stu.StudentStatusId    
 LEFT JOIN tblTermMaster tt    
  ON tt.TermId=stu.TermId    
 LEFT JOIN tblTermMaster tt1    
  ON tt1.TermId=stu.WithdrawAt    
 WHERE stu.IsDeleted =  0 AND stu.IsActive = 1    
 ORDER BY CAST(stu.StudentCode AS bigint)   
END
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVStudentStatement]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_CSVStudentStatement]  
	@AcademicYearId int
	,@ParentId int
	,@StudentId int
AS    
BEGIN    
	exec sp_reportStudentStatement @AcademicYearId 	,@ParentId 	,@StudentId 
END
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVTotalRevenueExport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_CSVTotalRevenueExport]    
  @ParentId int=0
 ,@ParentName nvarchar(250)=null
 ,@FatherIqama nvarchar(250)=null
 ,@StudentName nvarchar(250)=null
 ,@AcademicYear int=0
 ,@InvoiceNo BigInt=0
 ,@StartDate datetime=null
 ,@EndDate datetime=null
 AS                            
BEGIN      
EXEC SP_TotalRevenueReport    
	@ParentId    
	,@ParentName    
	,@FatherIqama    
	,@StudentName    
	,@AcademicYear    
	,@InvoiceNo    
	,@StartDate
	,@EndDate     
END    
    
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVTuitionRevenueExport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_CSVTuitionRevenueExport]    
  @ParentId int=0
 ,@ParentName nvarchar(250)=null
 ,@FatherIqama nvarchar(250)=null
 ,@StudentName nvarchar(250)=null
 ,@AcademicYear int=0
 ,@InvoiceNo BigInt=0
 ,@StartDate datetime=null
 ,@EndDate datetime=null
 AS                            
BEGIN      
EXEC SP_TuitionFeeReport    
	@ParentId    
	,@ParentName    
	,@FatherIqama    
	,@StudentName    
	,@AcademicYear    
	,@InvoiceNo    
	,@StartDate
	,@EndDate     
END    
    
GO
/****** Object:  StoredProcedure [dbo].[sp_CSVUniformRevenueExport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_CSVUniformRevenueExport]    
    @ItemCode nvarchar(100)=null
   ,@InvoiceNo bigint = 0
   ,@ParentName nvarchar(100)=null
   ,@FatherMobile nvarchar(100)=null
   ,@PaymentMethod nvarchar(100)=null
   ,@PaymentReferenceNumber nvarchar(100)=null
   ,@StartDate datetime=null
   ,@EndDate datetime=null
 AS                            
BEGIN      
EXEC SP_UniformSalesReport    
    @ItemCode
   ,@InvoiceNo    
   ,@ParentName    
   ,@FatherMobile  
   ,@PaymentMethod   
   ,@PaymentReferenceNumber
   ,@StartDate
   ,@EndDate     
END    
    
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteAttachements]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[sp_DeleteAttachements]
	@LoginUserId int,
	@UploadedDocId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE  tblUploadDocument SET IsActive=0, IsDeleted=1,UpdateBy=@LoginUserId,UpdateDate=GETDATE() WHERE UploadedDocId = @UploadedDocId;
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH	
	
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteBranch]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteBranch] 
	@LoginUserId int
   ,@BranchId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		DELETE FROM tblBranchMaster WHERE BranchId = @BranchId
		--UPDATE tblBranchMaster
		--	SET IsActive = 0
		--		,IsDeleted = 1
		--		,UpdateBy = @LoginUserId
		--		,UpdateDate = GETDATE()
		--WHERE BranchId = @BranchId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT ERROR_NUMBER() AS Result, 'Error!' AS Response
			--SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteContactInformation]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteContactInformation] 
	@LoginUserId int
   ,@ContactId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblContactInformation
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE ContactId = @ContactId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteCostCenter]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteCostCenter] 
	@LoginUserId int
	,@CostCenterId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY	
			BEGIN TRANSACTION TRANS1
			DELETE FROM tblCostCenterMaster WHERE CostCenterId = @CostCenterId
			--UPDATE tblCostCenterMaster
			--	SET IsActive = 0
			--		,IsDeleted = 1
			--		,UpdateBy = @LoginUserId
			--		,UpdateDate = GETDATE()
			--WHERE CostCenterId = @CostCenterId
					
			COMMIT TRAN TRANS1
			SELECT 0 AS Result, 'Saved' AS Response
		
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT ERROR_NUMBER() AS Result, 'Error!' AS Response
			--SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteDiscount] 
	@LoginUserId int
   ,@DiscountId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblDiscountMaster
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE DiscountId = @DiscountId

		UPDATE tblDiscountRuleMapping
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE DiscountId = @DiscountId

		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteDocumentType]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteDocumentType] 
	@LoginUserId int
	,@DocumentTypeId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		DELETE FROM tblDocumentTypeMaster WHERE DocumentTypeId = @DocumentTypeId
		--UPDATE tblDocumentTypeMaster
		--	SET IsActive = 0
		--		,IsDeleted = 1
		--		,UpdateBy = @LoginUserId
		--		,UpdateDate = GETDATE()
		--WHERE DocumentTypeId = @DocumentTypeId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT ERROR_NUMBER() AS Result, 'Error!' AS Response
			--SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteFeeDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteFeeDiscount] 
	@LoginUserId int
   ,@FeeDiscountId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblFeeDiscountMaster
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE FeeDiscountId = @FeeDiscountId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteFeePaymentPlan]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteFeePaymentPlan] 
	@LoginUserId int
   ,@FeePaymentPlanId bigint
AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @OldJsonData NVARCHAR(MAX)
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblFeePaymentPlan
			SET IsApproved=0
				,IsRejected=0
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE FeePaymentPlanId = @FeePaymentPlanId
		SELECT 0 AS Result, 'Saved' AS Response
		SELECT @OldJsonData = '{"PaymentPlanAmount": "'+CAST(PaymentPlanAmount AS nvarchar(20))+'", "DueDate": "'+Convert(VARCHAR(10),DueDate,101)+'"}' FROM tblFeePaymentPlan
		WHERE FeePaymentPlanId = @FeePaymentPlanId;
		EXEC sp_SaveNotification @LoginUserId=@LoginUserId,@ActionTable='tblFeePaymentPlan'
		,@NotificationAction='3',@TableRecordId=@FeePaymentPlanId
		,@OldValueJson=@OldJsonData,@NewValueJson='',@TableRecordColumnName='FeePaymentPlanId'		
		COMMIT TRAN TRANS1
		
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteFeePlanWithoutGradewise]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteFeePlanWithoutGradewise] 
	@LoginUserId int
   ,@FeeStructureId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblFeeStructure
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE FeeStructureId = @FeeStructureId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteFeeType]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteFeeType] 
	@LoginUserId int
   ,@FeeTypeId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblFeeTypeMaster
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE FeeTypeId = @FeeTypeId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteFeeTypeDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteFeeTypeDetail] 
	@LoginUserId int
   ,@FeeTypeDetailId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblFeeTypeDetail
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE FeeTypeDetailId = @FeeTypeDetailId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteGender]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_DeleteGender] 
	@LoginUserId int
	,@GenderTypeId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblGenderTypeMaster
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE GenderTypeId = @GenderTypeId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteGrade]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteGrade] 
	@LoginUserId int
	,@GradeId int
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY	
		BEGIN TRANSACTION TRANS1
		DELETE FROM tblGradeMaster WHERE GradeId = @GradeId
		--UPDATE tblGradeMaster
		--	SET IsActive = 0
		--		,IsDeleted = 1
		--		,UpdateBy = @LoginUserId
		--		,UpdateDate = GETDATE()
		--WHERE GradeId = @GradeId

		update t
		set 
			t.SequenceNo=p.RN
		from tblGradeMaster t
		join 
		(
			select ROW_NUMBER() over(order by SequenceNo ) as RN, * from tblGradeMaster
			WHERE IsDeleted = 0 and  IsActive = 1
		)p
		on t.GradeId=p.GradeId


		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response		
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT ERROR_NUMBER() AS Result, 'Error!' AS Response
			--SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteInvoice]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteInvoice] 
	@LoginUserId int
   ,@InvoiceId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE INV_InvoiceSummary
			SET 
				IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE InvoiceId = @InvoiceId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteInvoiceDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteInvoiceDetail] 
	@LoginUserId int
   ,@InvoiceDetailId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblInvoiceDetail
			SET 
				IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE InvoiceDetailId = @InvoiceDetailId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteInvoiceType]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteInvoiceType] 
	@LoginUserId int
	,@InvoiceTypeId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblInvoiceTypeMaster
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE InvoiceTypeId = @InvoiceTypeId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteParent]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteParent] 
	@LoginUserId int
	,@ParentId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		DELETE FROM tblParent WHERE ParentId = @ParentId
		DELETE FROM tblUser WHERE UserEmail = (Select FatherEmail from tblParent WHERE ParentId = @ParentId)
		--UPDATE tblParent
		--	SET IsActive = 0
		--		,IsDeleted = 1
		--		,UpdateBy = @LoginUserId
		--		,UpdateDate = GETDATE()
		--WHERE ParentId = @ParentId
		
		--UPDATE tblUser 	
		--SET IsActive = 0
		--	,IsDeleted = 1
		--	,UpdateBy = @LoginUserId
		--	,UpdateDate = GETDATE()
		--WHERE UserEmail = (Select FatherEmail from tblParent WHERE ParentId = @ParentId)

		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response	
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT ERROR_NUMBER() AS Result, 'Error!' AS Response
			--SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeletePaymentMethod]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeletePaymentMethod] 
   @PaymentMethodId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		DELETE FROM tblPaymentMethod WHERE PaymentMethodId = @PaymentMethodId
		--UPDATE tblBranchMaster
		--	SET IsActive = 0
		--		,IsDeleted = 1
		--		,UpdateBy = @LoginUserId
		--		,UpdateDate = GETDATE()
		--WHERE BranchId = @BranchId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT ERROR_NUMBER() AS Result, 'Error!' AS Response
			--SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSchool]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteSchool] 
	@LoginUserId int
   ,@SchoolId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		DELETE FROM tblSchoolMaster WHERE SchoolId = @SchoolId
		--UPDATE tblSchoolMaster
		--	SET IsActive = 0
		--		,IsDeleted = 1
		--		,UpdateBy = @LoginUserId
		--		,UpdateDate = GETDATE()
		--WHERE SchoolId = @SchoolId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT ERROR_NUMBER() AS Result, 'Error!' AS Response
			--SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSchoolAcademic]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteSchoolAcademic] 
	@LoginUserId int
   ,@SchoolAcademicId int
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblSchoolAcademic
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE SchoolAcademicId = @SchoolAcademicId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSchoolAccountInfo]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteSchoolAccountInfo] 
	@LoginUserId int
   ,@SchoolAccountIId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblSchoolAccountInfo
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE SchoolAccountIId = @SchoolAccountIId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSchoolLogoImage]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteSchoolLogoImage]
	@SchoolLogoId bigint = 0
AS
BEGIN
	SET NOCOUNT ON;	
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		DELETE FROM tblSchoolLogo	WHERE SchoolLogoId = @SchoolLogoId 	
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1			
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
	
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSchoolTermAcademic]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- *** SqlDbx Personal Edition ***
-- !!! Not licensed for commercial use beyound 90 days evaluation period !!!
-- For version limitations please check http://www.sqldbx.com/personal_edition.htm
-- Number of queries executed: 2, number of rows retrieved: 20

CREATE PROCEDURE [dbo].[sp_DeleteSchoolTermAcademic] 
	@LoginUserId int
   ,@SchoolTermAcademicId int
AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @OldJsonData NVARCHAR(MAX)
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblSchoolTermAcademic
			SET IsApproved=0
				,IsRejected=0
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE SchoolTermAcademicId = @SchoolTermAcademicId
		SELECT 0 AS Result, 'Saved' AS Response
		
		SELECT @OldJsonData = '{"TermName": "'+ TermName +'", "StartDate": "'+Convert(VARCHAR(10),StartDate,101)+'", "EndDate": "'+Convert(VARCHAR(10),EndDate,101)+'"}' 
		FROM tblSchoolTermAcademic
		WHERE SchoolTermAcademicId = @SchoolTermAcademicId;
		EXEC sp_SaveNotification @LoginUserId=@LoginUserId,@ActionTable='tblSchoolTermAcademic'
		,@NotificationAction='3',@TableRecordId=@SchoolTermAcademicId
		,@OldValueJson=@OldJsonData,@NewValueJson='',@TableRecordColumnName='SchoolTermAcademicId'		
		
		COMMIT TRAN TRANS1
		
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSection]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteSection] 
	@LoginUserId int
	,@SectionId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY		
		BEGIN TRANSACTION TRANS1
		DELETE FROM tblSection WHERE  SectionId= @SectionId
		--UPDATE tblSection
		--	SET IsActive = 0
		--		,IsDeleted = 1
		--		,UpdateBy = @LoginUserId
		--		,UpdateDate = GETDATE()
		--WHERE SectionId= @SectionId
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT ERROR_NUMBER() AS Result, 'Error!' AS Response
			--SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[sp_DeleteSiblingDiscount] 
	@LoginUserId int
   ,@DiscountId int
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblSiblingDiscountMaster
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE DiscountId = @DiscountId

		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END

GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteStudent]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteStudent] 
	@LoginUserId int
	,@StudentId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		DELETE FROM tblStudent WHERE StudentId = @StudentId
		--UPDATE tblStudent
		--	SET IsActive = 0
		--		,IsDeleted = 1
		--		,UpdateBy = @LoginUserId
		--		,UpdateDate = GETDATE()
		--WHERE StudentId = @StudentId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT ERROR_NUMBER() AS Result, 'Error!' AS Response
			--SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteStudentFeeDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteStudentFeeDetail] 
	@LoginUserId int
   ,@StudentFeeDetailId int
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblFeeStatement fs 
			INNER JOIN tblStudentFeeDetail sfd
				ON sfd.StudentId=fs.StudentId 
				AND sfd.AcademicYearId=fs.AcademicYearId
				AND sfd.GradeId=fs.GradeId
			WHERE fs.IsActive = 1 AND fs.IsDeleted = 0
				AND fs.FeeStatementType='Discount Applied'
				AND sfd.StudentFeeDetailId = @StudentFeeDetailId)  
	BEGIN  
		SELECT -3 AS Result, 'Discount already applied!' AS Response  
		RETURN;  
	END 
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblStudentFeeDetail
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE StudentFeeDetailId = @StudentFeeDetailId	

		DELETE fs FROM tblFeeStatement  fs
		INNER JOIN tblStudentFeeDetail sfd
			ON sfd.StudentId=fs.StudentId AND sfd.AcademicYearId=fs.AcademicYearId 
		where sfd.StudentFeeDetailId=@StudentFeeDetailId

		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY
	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteStudentOtherDiscountDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteStudentOtherDiscountDetail] 
	@LoginUserId int
   ,@StudentOtherDiscountDetailId int
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblStudentOtherDiscountDetail
			SET DiscountStatus=0
				,IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE StudentOtherDiscountDetailId = @StudentOtherDiscountDetailId		
		
		--DECLARE @DiscountName NVARCHAR(250)
		--DECLARE @DiscountAmount DECIMAL(18,4)
		--SELECT TOP 1 @DiscountName=DiscountName,@DiscountAmount=DiscountAmount from tblStudentOtherDiscountDetail WHERE StudentOtherDiscountDetailId = @StudentOtherDiscountDetailId 	
		----Insert discount cancled entry in statement
		--DECLARE @FeeStatementType NVARCHAR(50)=@DiscountName +' Discount Cancelled'		--INSERT INTO [dbo].[tblFeeStatement]		--(		--	[FeeStatementType],[FeeType],[FeeAmount],[PaidAmount],[StudentId],[ParentId],[StudentName],[ParentName],[AcademicYearId],[GradeId]		--	,[IsActive],[IsDeleted],[UpdateDate],[UpdateBy]		--)		--SELECT top 1		--	FeeStatementType=@FeeStatementType 				--	,FeeType=ssdd.FeeTypeId		--	,FeeAmount=0		--	,PaidAmount=ssdd.DiscountAmount*-1		--	,StudentId=stu.StudentId		--	,ParentId=stu.ParentId		--	,StudentName=stu.StudentName		--	,ParentName=par.ParentId		--	,AcademicYearId=ssdd.AcademicYearId		--	,GradeId=ssdd.GradeId		--	,IsActive=1		--	,IsDeleted=0		--	,UpdateDate=GETDATE()		--	,UpdateBy=0		--FROM tblStudentOtherDiscountDetail ssdd  				--join tblStudent stu on ssdd.StudentId=stu.StudentId		--join tblParent par on stu.ParentId=par.ParentId		--WHERE ssdd.StudentOtherDiscountDetailId = @StudentOtherDiscountDetailId  
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY
	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteStudentSiblingDiscountDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteStudentSiblingDiscountDetail] 
	@LoginUserId int
   ,@StudentSiblingDiscountDetailId int
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblStudentSiblingDiscountDetail
			SET DiscountStatus=0
				,IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE StudentSiblingDiscountDetailId = @StudentSiblingDiscountDetailId	
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY
	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteStudentStatus]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteStudentStatus] 
	@LoginUserId int
	,@StudentStatusId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblStudentStatus
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE StudentStatusId = @StudentStatusId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteUser]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_DeleteUser] 
	@LoginUserId int
	,@UserId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblUser
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE UserId = @UserId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteVat]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_DeleteVat] 
	@LoginUserId int
   ,@VatId bigint
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblVatMaster
			SET IsActive = 0
				,IsDeleted = 1
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE VatId = @VatId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[SP_DiscountReport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_DiscountReport]
(
  @ParentId INT=0
 ,@ParentName NVARCHAR(200)=null
 ,@FatherIqama NVARCHAR(200)=null
 ,@StudentName NVARCHAR(100)=null
 ,@AcademicYearId INT=0
 ,@StartDate DATETIME=null
 ,@EndDate DATETIME=null
)
AS
BEGIN
	SELECT tp.ParentCode
			,tp.FatherName
			,tp.FatherIqamaNo 
			,ts.StudentCode
			,ts.StudentName
			,tgm.GradeName
			,tcc.CostCenterName
			,tsa.AcademicYear
			 ,COALESCE(
				ts.Mobile COLLATE SQL_Latin1_General_CP1_CI_AS, 
				tp.FatherMobile COLLATE SQL_Latin1_General_CP1_CI_AS, 
				tp.MotherMobile COLLATE SQL_Latin1_General_CP1_CI_AS
			) AS Mobile
			,CASE WHEN tp.IsFatherStaff=1 THEN 'Yes' ELSE 'No' END IsFatherStaff
			,fs.FeeStatementType
			,fs.UpdateDate
			,CASE WHEN fs.PaidAmount>0 THEN fs.PaidAmount ELSE NULL END AS 'DiscountApplied'
			,CASE WHEN fs.PaidAmount<0 THEN fs.PaidAmount*-1 ELSE NULL END AS 'DiscountCancelled'
	INTO #DiscountTbl
	FROM tblFeeStatement fs
	INNER JOIN tblStudent ts
		ON ts.StudentId=fs.StudentId
	INNER JOIN tblParent tp
		ON tp.ParentId=fs.ParentId
	INNER JOIN tblGradeMaster tgm 
		ON tgm.GradeId = fs.GradeId
	INNER JOIN tblSchoolAcademic tsa 
		ON tsa.SchoolAcademicId = fs.AcademicYearId
	INNER JOIN tblCostCenterMaster tcc
		ON tcc.CostCenterId=ts.CostCenterId
	WHERE fs.FeeStatementType LIKE '%Discount%'
		AND tp.ParentId= CASE WHEN @ParentId > 0 THEN @ParentId ELSE tp.ParentId END
		AND tp.FatherName LIKE '%'+ CASE WHEN len(@ParentName) > 0 THEN @ParentName ELSE tp.FatherName  END + '%'  
		AND tp.FatherIqamaNo LIKE '%'+ CASE WHEN len(@FatherIqama) > 0 THEN @FatherIqama ELSE tp.FatherIqamaNo  END + '%'  
		AND ts.StudentName LIKE '%'+ CASE WHEN len(@StudentName) > 0 THEN @StudentName ELSE ts.StudentName  END + '%'  
		AND tsa.SchoolAcademicId= CASE WHEN @AcademicYearId > 0 THEN @AcademicYearId ELSE tsa.SchoolAcademicId END
		AND (@StartDate IS NULL OR cast(fs.UpdateDate as date) >= cast(@StartDate as date))              
		AND (@EndDate IS NULL OR cast(fs.UpdateDate as date) <= cast(@EndDate as date))
	ORDER BY StudentName
	SELECT ParentCode
			,FatherName
			,FatherIqamaNo 
			,StudentCode
			,StudentName
			,GradeName
			,CostCenterName
			,AcademicYear
			,Mobile
			,IsFatherStaff
			,FeeStatementType
			,UpdateDate=CONVERT(NVARCHAR(20),UpdateDate,103) 
			,DiscountApplied=FORMAT(DiscountApplied,'#,0.00')
			,DiscountCancelled=FORMAT(DiscountCancelled,'#,0.00')
	FROM #DiscountTbl	
	UNION ALL
	SELECT ParentCode=' '
			,FatherName=' '
			,FatherIqamaNo =' '
			,StudentCode=' '
			,StudentName=' '
			,GradeName=' '
			,CostCenterName=' '
			,AcademicYear=' '
			,Mobile=' '
			,IsFatherStaff=' '
			,FeeStatementType=' '
			,UpdateDate='Total'
			,DiscountApplied=FORMAT(SUM(DiscountApplied),'#,0.00')
			,DiscountCancelled=FORMAT(SUM(DiscountCancelled),'#,0.00')
	FROM #DiscountTbl
	DROP TABLE IF EXISTS #DiscountTbl; 
END
GO
/****** Object:  StoredProcedure [dbo].[SP_EntranceFeesReport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec [SP_EntranceFeesReport]

CREATE proc [dbo].[SP_EntranceFeesReport]
(
  @ParentId int=0
 ,@ParentName nvarchar(100)=null
 ,@FatherIqama nvarchar(100)=null
 ,@StudentName nvarchar(100)=null
 ,@AcademicYear int=0
 ,@InvoiceNo bigint=0
 ,@StartDate datetime=null
 ,@EndDate datetime=null
)
as
begin


	select 
	 ParentName
	,FatherMobile
	,IqamaNumber
	,StudentName
	,GradeName
	,CostCenter = CostCenterName
	,AcademicYear
	,IsStaff
	,TaxableAmount=sum(TaxableAmount)
	,TaxAmount=sum(TaxAmount)
	,ItemSubtotal=sum(ItemSubtotal)
	,InvoiceType
	,InvoiceDate
	,InvoiceNo
	,PaymentMethod
	,InvoiceRefNo = PaymentReferenceNumber
	INTO #EntranceTbl
	from
	(
		select 
             invDet.ParentName
			,invDet.FatherMobile
			,StudentName=isnull(invDet.StudentName,'')
			,tgm.GradeName     
			,tsa.AcademicYear
			,invDet.IqamaNumber
			,IsStaff=CASE WHEN invDet.IsStaff=1 THEN 'Yes' ELSE 'No' END 
			,invDet.TaxableAmount	
			,invDet.TaxAmount	
			,invDet.ItemSubtotal
			,invDet.InvoiceType
			,invSum.InvoiceNo
			,invSum.InvoiceDate
			,invPay.PaymentMethod
			,invPay.PaymentReferenceNumber
			,tcc.CostCenterName
		from INV_InvoiceSummary invSum
		join INV_InvoiceDetail invDet on invSum.InvoiceNo=invDet.InvoiceNo
		join tblGradeMaster as tgm on invDet.GradeId = tgm.GradeId
		join tblSchoolAcademic as tsa on invDet.AcademicYear = tsa.SchoolAcademicId
		join INV_InvoicePayment as invPay on invDet.InvoiceNo = invPay.InvoiceNo
		LEFT JOIN tblStudent ts ON ts.StudentId=invDet.StudentId
		LEFT JOIN tblCostCenterMaster tcc ON tcc.CostCenterId=ts.CostCenterId
		where 
		 invDet.InvoiceType = 'Entrance Fee' 
	    AND invSum.ParentId = CASE WHEN @ParentId > 0 THEN @ParentId ELSE invSum.ParentId END  
		AND invDet.InvoiceNo = CASE WHEN @InvoiceNo > 0 THEN @InvoiceNo ELSE invDet.InvoiceNo END
		AND invDet.ParentName LIKE '%'+ CASE WHEN len(@ParentName) > 0 THEN @ParentName ELSE invDet.ParentName  END + '%'  
		AND invDet.IqamaNumber LIKE '%'+ CASE WHEN len(@FatherIqama) > 0 THEN @FatherIqama ELSE invDet.IqamaNumber  END + '%'
		AND invDet.StudentName LIKE '%'+ CASE WHEN len(@StudentName) > 0 THEN @StudentName ELSE invDet.StudentName  END + '%'  
		AND invDet.AcademicYear = CASE WHEN @AcademicYear > 0 THEN @AcademicYear ELSE invDet.AcademicYear END   
		AND (@StartDate IS NULL OR cast(invSum.InvoiceDate as date) >= cast(@StartDate as date))              
		AND (@EndDate IS NULL OR cast(invSum.InvoiceDate as date) <= cast(@EndDate as date))  
		
	)t
	group by 
        ParentName,
        FatherMobile,
        IqamaNumber,
        StudentName,
        GradeName,
        AcademicYear,
        IsStaff,
         InvoiceType
		,InvoiceDate
		,InvoiceNo
		,PaymentMethod
		,PaymentReferenceNumber
		,CostCenterName
	SELECT  ParentName
			,IqamaNumber
			,FatherMobile
			,StudentName
			,GradeName
			,CostCenter
			,AcademicYear
			,IsStaff=CAST(IsStaff AS NVARCHAR(10)) 
			,InvoiceType
			,InvoiceNo=CAST(InvoiceNo AS NVARCHAR(100)) 
			,InvoiceDate=CONVERT(NVARCHAR(20),InvoiceDate,103) 
			,TaxableAmount=FORMAT(TaxableAmount,'#,0.00')
			,TaxAmount=FORMAT(TaxAmount,'#,0.00')
			,ItemSubtotal=FORMAT(ItemSubtotal,'#,0.00')
			,PaymentMethod
			,InvoiceRefNo
	FROM #EntranceTbl
	UNION ALL
	SELECT ParentName =' '
			,IqamaNumber=' '
			,FatherMobile=' '
			,StudentName=' '
			,GradeName=' '
			,CostCenter=' '
			,AcademicYear=' '
			,IsStaff=' '
			,InvoiceType=' '
			,InvoiceNo=' '
			,InvoiceDate='Total'
			,TaxableAmount=FORMAT(SUM(TaxableAmount),'#,0.00')
			,TaxAmount=FORMAT(SUM(TaxAmount),'#,0.00')
			,ItemSubtotal=FORMAT(SUM(ItemSubtotal),'#,0.00')
			,PaymentMethod=' '
			,InvoiceRefNo=' '
	FROM #EntranceTbl
	DROP TABLE IF EXISTS #EntranceTbl; 
end
GO
/****** Object:  StoredProcedure [dbo].[SP_FeeStatement]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_FeeStatement]
@AcademicYearId bigint
,@StudentId bigint
,@ParentId bigint
as
--declare @AcademicYearId bigint=2008
--declare @StudentId bigint=80
--declare @ParentId bigint=0

--set @AcademicYearId =2008
--set @StudentId =80
--set @ParentId =0

declare @AcademicYear_PeriodFrom	datetime
declare @AcademicYear_PeriodTo datetime
--select * from tblSchoolAcademic

select top 1 @AcademicYear_PeriodFrom=PeriodFrom, @AcademicYear_PeriodTo=PeriodTo from tblSchoolAcademic where SchoolAcademicId=@AcademicYearId

select * into #Previous_tblSchoolAcademic from tblSchoolAcademic where cast(PeriodTo as date)<cast(@AcademicYear_PeriodFrom as date)

--select '#Previous_tblSchoolAcademic ' as AA,  * from #Previous_tblSchoolAcademic 

select StudentId into #StudentTable from tblStudent where (StudentId =@StudentId OR ParentId=@ParentId)

SELECT StudentId,FeeTypeName,RecordDate,sum(FeeAmount) as FeeAmount,sum(OpeningAmount ) as OpeningAmount 
FROM 
(
	--previous academic record
	SELECT StudentId,AcademicYearId,'TUITION FEE -OPENING BALANCE' as FeeTypeName,0 as FeeAmount, FeeAmount  as OpeningAmount,CAST (UpdateDate AS DATE) AS RecordDate 
	from tblStudentFeeDetail where StudentId in (select StudentId from #StudentTable) and AcademicYearId in (select SchoolAcademicId from #Previous_tblSchoolAcademic) and IsActive=1 and IsDeleted=0
	UNION ALL
	SELECT StudentId,AcademicYear as AcademicYearId,'TUITION FEE -OPENING BALANCE ' as FeeTypeName,0 as FeeAmount,(TaxableAmount*-1) as OpeningAmount,CAST (UpdateDate AS DATE) AS RecordDate 
	from INV_InvoiceDetail where StudentId in (select StudentId from #StudentTable) and AcademicYear in (select SchoolAcademicId from #Previous_tblSchoolAcademic)

	UNION ALL
	---Current Academic record
	SELECT StudentId,AcademicYearId,'TUITION FEE ' as FeeTypeName, FeeAmount  as FeeAmount, 0 as OpeningAmount,CAST (UpdateDate AS DATE) AS RecordDate  
	FROM tblStudentFeeDetail 
	WHERE StudentId in (select StudentId from #StudentTable) and AcademicYearId=@AcademicYearId and IsActive=1 and IsDeleted=0
	
	UNION ALL
	
	SELECT StudentId,AcademicYear as AcademicYearId,'TUITION FEE ' as FeeTypeName,(TaxableAmount*-1) as FeeAmount , 0 as OpeningAmount,CAST (UpdateDate AS DATE) AS RecordDate  
	from INV_InvoiceDetail where StudentId in (select StudentId from #StudentTable) and AcademicYear=@AcademicYearId
)t
GROUP BY StudentId,FeeTypeName,RecordDate
order by t.RecordDate

drop table #Previous_tblSchoolAcademic 
drop table #StudentTable

--sp_tables '%fee%'
GO
/****** Object:  StoredProcedure [dbo].[sp_getAdminDashboardData]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE proc [dbo].[sp_getAdminDashboardData]
as
begin
	select  count(1) as TotalStudent
	from tblStudent

	select  count(1) as TotalParent from tblParent

	select 
	case when GenderId=1 then 'Male' else 'Female' end as Gender, GradeName as KeyName, count(1) as KeyValue
	from tblStudent stu
	inner join tblGradeMaster grade
	on stu.GradeId=grade.GradeId

	group by GradeName,GenderId

	select 
	AdmissionYear as KeyName, count(1) as KeyValue
	from tblStudent stu
	group by AdmissionYear

	SELECT 		ISNULL(SUM(CASE WHEN InvoiceType = 'Entrance Fee' THEN ItemSubtotal ELSE 0 END),0) AS MonthlyEntranceRevenue,		ISNULL(SUM(CASE WHEN InvoiceType = 'Uniform Fee' THEN ItemSubtotal ELSE 0 END),0) AS MonthlyUniformRevenue,		ISNULL(SUM(CASE WHEN InvoiceType = 'Tuition Fee' THEN ItemSubtotal ELSE 0 END),0) AS MonthlyTuitionRevenue	FROM INV_InvoiceDetail	WHERE DATEPART(YEAR, CAST(UpdateDate AS DATE)) = DATEPART(YEAR, CAST(GETDATE() AS DATE))		AND DATEPART(MONTH, CAST(UpdateDate AS DATE)) = DATEPART(MONTH, CAST(GETDATE() AS DATE))


	--exec [sp_getInvoiceData]
	--select AdmissionYear, AdmissionDate ,DATEPART(year, cast(AdmissionDate as date)) from tblStudent

	--update tblStudent
	--set AdmissionYear=DATEPART(year, cast(AdmissionDate as date))

end
GO
/****** Object:  StoredProcedure [dbo].[sp_GetAppDropdown]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetAppDropdown]    
 @DropdownType int    
 ,@ReferenceId int    
AS    
BEGIN    
 SET NOCOUNT ON;    
 IF @DropdownType = 1    
 BEGIN    
  SELECT trl.RoleId AS SValue    
   ,trl.RoleName AS SText    
  FROM tblRole trl    
  WHERE trl.IsActive = 1 AND trl.IsDeleted = 0    
  ORDER BY trl.RoleName    
 END    
 IF @DropdownType = 2    
 BEGIN    
  SELECT tcc.CostCenterId AS SValue    
   ,tcc.CostCenterName AS SText    
  FROM tblCostCenterMaster tcc    
  WHERE tcc.IsActive = 1 AND tcc.IsDeleted = 0    
  ORDER BY tcc.CostCenterName    
 END    
 IF @DropdownType = 3    
 BEGIN    
  SELECT tgt.GenderTypeId AS SValue    
   ,tgt.GenderTypeName AS SText    
  FROM tblGenderTypeMaster tgt    
  WHERE tgt.IsActive = 1 AND tgt.IsDeleted = 0    
  ORDER BY tgt.GenderTypeName    
 END    
 IF @DropdownType = 4    
 BEGIN    
  SELECT tg.GradeId AS SValue    
   --,tg.GradeName AS SText    
  -- ,CONCAT_WS(' - ',tg.GradeName, tgt.GenderTypeName)  AS SText    
  ,case when tgt.GenderTypeName is null then  isnull(tg.GradeName,'') else (isnull(tg.GradeName,'') +' - '+isnull(tgt.GenderTypeName,'')) end AS SText    
  FROM tblGradeMaster tg    
  INNER JOIN tblCostCenterMaster tcc    
   ON tcc.CostCenterId = tg.CostCenterId    
  LEFT JOIN tblGenderTypeMaster tgt    
   ON tgt.GenderTypeId = tg.GenderTypeId    
  WHERE tg.IsActive = 1 AND tg.IsDeleted = 0    
   AND tg.CostCenterId = CASE WHEN @ReferenceId > 0 THEN @ReferenceId ELSE tg.CostCenterId END     
  ORDER BY tg.SequenceNo    ASC
 END    
 IF @DropdownType = 5    
 BEGIN    
  SELECT tc.CountryId AS SValue    
   --,CONCAT_WS(' - ',tc.CountryName, tc.CountryCode)  AS SText   
   ,tc.CountryName  AS SText   
  FROM tblCountryMaster tc      
  WHERE tc.IsActive = 1 AND tc.IsDeleted = 0       
  ORDER BY tc.CountryName    
 END    
 IF @DropdownType = 6    
 BEGIN    
  SELECT dt.DocumentTypeId AS SValue    
   ,dt.DocumentTypeName  AS SText    
  FROM tblDocumentTypeMaster dt      
  WHERE dt.IsActive = 1 AND dt.IsDeleted = 0       
  ORDER BY dt.DocumentTypeName    
 END   
 IF @DropdownType = 7    
 BEGIN  
 SELECT SValue,SText FROM(
	  SELECT tp.ParentId AS SValue    
	   ,tp.ParentCode+' - '+tp.FatherName  AS SText 
	   ,CAST(ISNULL(tp.ParentCode,0) AS INT) AS ParentCode 
	  FROM tblParent tp      
	  WHERE tp.IsActive = 1 AND tp.IsDeleted = 0       
  )t
  ORDER BY t.ParentCode
 END   
 IF @DropdownType = 8    
 BEGIN    
  SELECT tgs.SectionId AS SValue    
   ,tgs.SectionName  AS SText    
  FROM tblSection tgs     
  WHERE tgs.IsActive = 1 AND tgs.IsDeleted = 0       
  ORDER BY tgs.SectionName    
 END   
 IF @DropdownType = 9    
 BEGIN    
  SELECT tss.StudentStatusId AS SValue    
   ,tss.StatusName  AS SText    
  FROM tblStudentStatus tss      
  WHERE tss.IsActive = 1 AND tss.IsDeleted = 0       
  ORDER BY tss.StatusName    
 END   
 IF @DropdownType = 10    
 BEGIN    
  SELECT trm.TermId AS SValue    
   ,trm.TermName  AS SText    
  FROM tblTermMaster trm    
  WHERE trm.IsActive = 1 AND trm.IsDeleted = 0       
  ORDER BY trm.TermName    
 END   
 IF @DropdownType = 11    
 BEGIN    
  SELECT trm.BranchId AS SValue    
   ,trm.BranchName  AS SText    
  FROM tblBranchMaster trm    
  WHERE trm.IsActive = 1 AND trm.IsDeleted = 0       
  ORDER BY trm.BranchName    
 END   
 IF @DropdownType = 12    
 BEGIN    
  SELECT trm.SchoolAcademicId AS SValue    
   ,trm.AcademicYear  AS SText    
  FROM tblSchoolAcademic trm    
  WHERE  trm.IsDeleted = 0 and trm.IsActive=1 --AND trm.SchoolId=@ReferenceId     
 END  
 IF @DropdownType = 13    
 BEGIN    
  SELECT FeeTypeId AS SValue    
  ,FeeTypeName  AS SText    
  FROM tblFeeTypeMaster    
  WHERE  IsDeleted = 0 AND IsActive=1    
 END   
 IF @DropdownType = 14    
 BEGIN    
  SELECT DiscountRuleId AS SValue    
  ,DiscountRuleDescription  AS SText    
  FROM tblDiscountRules  
  WHERE  IsDeleted = 0 AND IsActive=1    
 END  
 IF @DropdownType = 15    
 BEGIN    
  SELECT tp.StudentId AS SValue    
   ,tp.StudentCode  AS SText    
  FROM tblStudent tp      
  WHERE tp.IsActive = 1 AND tp.IsDeleted = 0       
  ORDER BY tp.StudentCode    
 END 
  IF @DropdownType = 16  
 BEGIN    
  SELECT tpmc.PaymentMethodCategoryId AS SValue    
   ,tpmc.CategoryName  AS SText    
  FROM tblPaymentMethodCategory tpmc   
  WHERE  tpmc.IsDeleted = 0 and tpmc.IsActive=1    
 END 
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetAttachmentByDocForId]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[sp_GetAttachmentByDocForId]
	@DocForId bigint
	,@DocFor int
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT UploadedDocId
      ,DocFor
      ,DocType
      ,DocForId
      ,DocNo
      ,DocPath
      ,ud.UpdateDate
      ,ud.UpdateBy
	  ,dtm.DocumentTypeName
  FROM tblUploadDocument ud
  inner join tblDocumentTypeMaster dtm on dtm.DocumentTypeId=ud.DocType
WHERE ud.DocForId = @DocForId AND ud.IsDeleted=0 AND ud.IsActive = 1 AND ud.DocFor=@DocFor
ORDER BY  ud.DocNo

	
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetAuthDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetAuthDetail]       
 @UserEmail [nvarchar](200)      
 ,@UserPass [nvarchar](500)      
AS      
BEGIN      
 SET NOCOUNT ON;      
 SELECT tu.UserId      
  ,tu.UserName      
  ,tu.UserArabicName      
  ,tu.UserEmail      
  ,tu.UserPhone      
  ,tr.RoleId      
  ,tr.RoleName      
  ,tu.ProfileImg     
  ,IsApprover=isnull(tu.IsApprover,0)  
 FROM tblUser tu      
 INNER JOIN tblRole tr      
  ON tr.RoleId = tu.RoleId       
 WHERE tu.IsActive = 1 AND tu.IsDeleted = 0 AND tr.IsActive = 1 AND tr.IsDeleted = 0      
  AND tu.UserEmail = @UserEmail AND tu.UserPass = @UserPass      
       
 DECLARE @MenuTable       
 TABLE(MenuId int      
  ,Menu nvarchar(50)      
  ,MenuCtrl nvarchar(100)      
  ,MenuAction nvarchar(100)      
  ,ParentMenuId int      
  ,DisplaySequence int      
  ,FaIcon nvarchar(50)      
  ,AllowAdd bit      
  ,AllowEdit bit      
  ,AllowDelete bit)      
 INSERT INTO @MenuTable (MenuId, Menu, MenuCtrl, MenuAction, ParentMenuId, DisplaySequence,FaIcon,AllowAdd,AllowEdit,AllowDelete)      
 SELECT tm.MenuId      
  ,tm.Menu      
  ,tm.MenuCtrl      
  ,tm.MenuAction      
  ,tm.ParentMenuId      
  ,tm.DisplaySequence      
  ,tm.FaIcon      
  ,trmm.AllowAdd      
  ,trmm.AllowEdit      
  ,trmm.AllowDelete      
 FROM tblMenu tm      
 INNER JOIN tblRoleMenuMapping trmm      
  ON tm.MenuId = trmm.MenuId      
 INNER JOIN tblUser tu      
  ON tu.RoleId = trmm.RoleId      
 WHERE tu.UserEmail = @UserEmail      
  AND tm.IsActive = 1 AND trmm.IsActive = 1      
  AND tm.IsDeleted =0 AND trmm.IsDeleted = 0      
 ;WITH  MenuCTE      
 AS      
 (      
  SELECT tm1.MenuId      
   ,tm1.Menu      
   ,tm1.MenuCtrl      
   ,tm1.MenuAction      
   ,tm1.ParentMenuId      
   ,tm1.DisplaySequence      
   ,tm1.FaIcon      
   ,tm1.AllowAdd      
   ,tm1.AllowEdit      
   ,tm1.AllowDelete      
   ,1 AS [Level]      
   ,CAST((tm1.Menu) AS VARCHAR(MAX)) AS Hierarchy      
  FROM @MenuTable tm1      
  WHERE ParentMenuId = 0      
      
  UNION ALL      
  SELECT tm2.MenuId      
   ,tm2.Menu      
   ,tm2.MenuCtrl      
   ,tm2.MenuAction      
   ,tm2.ParentMenuId      
   ,tm2.DisplaySequence      
   ,tm2.FaIcon      
   ,tm2.AllowAdd      
   ,tm2.AllowEdit      
   ,tm2.AllowDelete      
   ,M.[level] + 1 AS [Level]      
   ,CAST((M.Hierarchy + '->' + tm2.Menu) AS VARCHAR(MAX)) AS Hierarchy      
  FROM @MenuTable AS tm2      
  JOIN MenuCTE AS M ON tm2.ParentMenuId = M.MenuId         
 )      
 SELECT distinct * FROM MenuCTE      
 ORDER BY ParentMenuId,DisplaySequence      
END   
GO
/****** Object:  StoredProcedure [dbo].[sp_GetBranch]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetBranch]
	@BranchId bigint = 0,
	@FilterSearch NVarChar(200)=null,
	@FilterIsActive bit=1
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT tbm.BranchId
		,tbm.BranchName	
		,tbm.IsActive	
	FROM tblBranchMaster tbm	
	WHERE tbm.BranchId = CASE WHEN @BranchId > 0 THEN @BranchId ELSE tbm.BranchId END
		--AND (tbm.BranchName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tbm.BranchName END + '%')
		--AND tbm.IsActive =  CASE WHEN @FilterIsActive=-1 OR @BranchId>0 THEN tbm.IsActive ELSE @FilterIsActive  END
		AND tbm.IsDeleted =  0
	 ORDER BY tbm.IsActive desc , tbm.BranchName asc
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetContactInformation]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetContactInformation]
	@SchoolId bigint = 0,
	@ContactId bigint = 0,
	@FilterSearch NVarChar(200)=null,
	@FilterIsActive int=1
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT tci.ContactId
		,tci.SchoolId
		,tci.ContactPerson
		,tci.ContactPosition
		,tci.ContactTelephone
		,tci.ContactEmail
	  ,tci.IsActive		
	FROM tblContactInformation tci		
	WHERE tci.ContactId = CASE WHEN @ContactId> 0 THEN @ContactId ELSE tci.ContactId END	
		AND tci.IsDeleted =  0 AND IsActive=1
		AND  tci.SchoolId=@SchoolId
	 ORDER BY tci.ContactPerson
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetCostCenter]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetCostCenter]  
 @CostCenterId bigint = 0,  
 @FilterSearch NVarChar(200)=null,  
 @FilterIsActive bit=1  
AS  
BEGIN  
 SET NOCOUNT ON;   
 SELECT tcc.CostCenterId  
	,tcc.CostCenterName  
	,tcc.Remarks  
	,tcc.DebitAccount  
	,tcc.CreditAccount  
	,tcc.IsActive    
 FROM tblCostCenterMaster tcc    
 WHERE tcc.CostCenterId = CASE WHEN @CostCenterId > 0 THEN @CostCenterId ELSE tcc.CostCenterId END  
  AND (tcc.CostCenterName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tcc.CostCenterName END + '%'  
  OR tcc.Remarks LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tcc.Remarks END + '%')  
  AND tcc.IsActive =  CASE WHEN @CostCenterId>0 THEN tcc.IsActive ELSE @FilterIsActive  END  
  AND tcc.IsDeleted =  0  
 ORDER BY tcc.CostCenterName  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetDiscount]
	@DiscountId bigint = 0
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT tdm.DiscountId
		,tdm.DiscountName
		,tdm.DiscountPercent
	FROM tblDiscountMaster tdm		
	WHERE tdm.DiscountId = CASE WHEN @DiscountId > 0 THEN @DiscountId ELSE tdm.DiscountId END
		AND tdm.IsDeleted =  0 AND tdm.IsActive=1
	ORDER BY tdm.DiscountName

	SELECT tdrm.DiscountId 
			,tdr.DiscountRuleId 
			,tdr.DiscountRuleDescription
	FROM tblDiscountRuleMapping tdrm      
	INNER JOIN tblDiscountRules tdr      
		ON tdrm.DiscountRuleId = tdr.DiscountRuleId      
	WHERE tdrm.IsActive = 1 AND tdrm.IsDeleted = 0 
		AND tdr.IsActive = 1 AND tdr.IsDeleted = 0 
		AND tdrm.DiscountId = CASE WHEN @DiscountId > 0 THEN @DiscountId ELSE tdrm.DiscountId END
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetDocumentType]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_GetDocumentType]
	@DocumentTypeId bigint = 0,
	@FilterSearch NVarChar(200)=null,
	@FilterIsActive bit=1
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT tdt.DocumentTypeId
		,tdt.DocumentTypeName
		,tdt.Remarks		
		,tdt.IsActive		
	FROM tblDocumentTypeMaster tdt		
	WHERE tdt.DocumentTypeId = CASE WHEN @DocumentTypeId > 0 THEN @DocumentTypeId ELSE tdt.DocumentTypeId END
		AND (tdt.DocumentTypeName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tdt.DocumentTypeName END + '%'
		OR tdt.Remarks LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tdt.Remarks END + '%')
		AND tdt.IsActive =  CASE WHEN @DocumentTypeId>0 THEN tdt.IsActive ELSE @FilterIsActive  END
		AND tdt.IsDeleted =  0
	ORDER BY tdt.DocumentTypeName
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetEmailConfig]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetEmailConfig]
	@EmailConfigId bigint = 0
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT tec.EmailConfigId
		,tec.Host
		,tec.Port
		,tec.Username
		,tec.Password
		,tec.EnableSSL
		,tec.FromEmail
	FROM tblEmailConfig tec		
	WHERE tec.EmailConfigId = CASE WHEN @EmailConfigId > 0 THEN @EmailConfigId ELSE tec.EmailConfigId END
		AND tec.IsDeleted =  0
	ORDER BY tec.EmailConfigId
END


GO
/****** Object:  StoredProcedure [dbo].[SP_GetFeeAmount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
----exec [SP_GetFeeAmount] 2008,13,'tuition'
--declare
-- @AcademicYearId bigint=2008
-- ,@StudentId bigint=13,
-- @InvoiceTypeName nvarchar(50)='tuition'

CREATE PROCEDURE [dbo].[SP_GetFeeAmount]          
 @AcademicYearId bigint          
 ,@StudentId bigint,          
 @InvoiceTypeName nvarchar(50)          
as          
        
begin          
 declare @IsStaffMember bit=0;          
 declare @GradeId int=0;        
 declare @TotalAcademicYearPaid decimal(18,2)=0      
 declare @InvoiceTypeId bigint=2008
    
  DECLARE @PeriodFrom DATE      
  DECLARE @PeriodTo DATE      
    
  SELECT TOP 1       
   @PeriodFrom=CAST(PeriodFrom AS DATE)      
   ,@PeriodTo=CAST(PeriodTo AS DATE)      
  FROM tblSchoolAcademic       
  WHERE IsActive=1 and IsDeleted=0      
   AND CAST(GETDATE() AS DATE) BETWEEN CAST(PeriodFrom AS DATE)  and CAST(PeriodTo AS DATE)      
    
 if(@studentId>0)          
 begin          
  select top 1            
   @IsStaffMember= case when p.IsFatherStaff=1 OR p.IsMotherStaff=1 then 1 else 0 end          
   ,@GradeId=s.GradeId        
  from          
  [dbo].[tblParent] p          
  join [dbo].[tblStudent] s on p.ParentId=s.ParentId          
  where StudentId= @studentId          
 end    
        
 if(@InvoiceTypeName like '%Tuition%')        
 begin    
 
 
 select      
   @TotalAcademicYearPaid=isnull(sum( UnitPrice),0)         
  from INV_InvoiceDetail        
  where StudentId=@StudentId and AcademicYear=@AcademicYearId        
  and InvoiceType like '%Tuition%'        
  and IsDeleted=0   

  declare @discountPercent decimal(18,2)=0
  declare @ManagementDiscount  decimal(18,2)=0

	select top 
		1 @discountPercent=isnull(sum(DiscountPercent),0) 
	from
	tblStudentSiblingDiscountDetail ssdd    
	where ssdd.StudentId=@StudentId  and ssdd.AcademicYearId=@AcademicYearId     
	and ssdd.IsActive=1 and ssdd.IsDeleted=0 AND DiscountStatus in (3,7)

	select top 
		1 @ManagementDiscount=isnull(sum(DiscountAmount),0) 
	from
	tblStudentOtherDiscountDetail ssdd    
	where ssdd.StudentId=@StudentId  and ssdd.AcademicYearId=@AcademicYearId     
	and ssdd.IsActive=1 and ssdd.IsDeleted=0 AND DiscountStatus in (3,7)
 
  select top 1         
   ftd.FeeTypeDetailId        
   ,ftd.FeeTypeId        
   ,ftd.AcademicYearId        
   ,ftd.GradeId        
   ,inv.FeeAmount as TermFeeAmount        
   ,ftd.IsActive        
   ,ftd.IsDeleted        
   ,ftd.UpdateDate        
   ,ftd.UpdateBy        
   ,inv.FeeAmount as StaffFeeAmount        
   ,IsStaffMember=@IsStaffMember         
   ,FinalFeeAmount=inv.FeeAmount - (inv.FeeAmount*ISNULL(@discountPercent,0)/100 )- ISNULL(@ManagementDiscount,0) -  @TotalAcademicYearPaid
   ,DiscountPercent    =@discountPercent
  from [dbo].[tblFeeTypeDetail] ftd          
  join [dbo].[tblFeeTypeMaster] ftm on ftd.FeeTypeId=ftm.FeeTypeId          
  join  [dbo].[tblStudentFeeDetail] inv on ftm.FeeTypeId=inv.FeeTypeId         
  and inv.StudentId=@StudentId        
  and ftd.AcademicYearId=inv.AcademicYearId
  where ftd.AcademicYearId=@academicYearId          
  and ftm.FeeTypeName like '%'+@InvoiceTypeName+'%'    

 
 end        
 else         
 begin    
  select top 1 ftd.*,IsStaffMember=@IsStaffMember ,    
  FinalFeeAmount=case when @IsStaffMember=1 then StaffFeeAmount else TermFeeAmount end    
  from [dbo].[tblFeeTypeDetail] ftd          
  join [dbo].[tblFeeTypeMaster] ftm on ftd.FeeTypeId=ftm.FeeTypeId          
  where AcademicYearId=@academicYearId          
  and ftm.FeeTypeName like '%'+@InvoiceTypeName+'%'    
 end        
end 
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeeDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetFeeDiscount]
	@FeeDiscountId bigint = 0,
	@FilterSearch NVarChar(200)=null,
	@FilterIsActive bit = 1
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT tfm.FeeDiscountId
		,tfm.FeeDiscountName
		,tfm.[Percent]
		,tfm.[Rule]
		,tfm.Remarks
	  ,tfm.IsActive		
	FROM tblFeeDiscountMaster tfm		
	WHERE tfm.FeeDiscountId = CASE WHEN @FeeDiscountId > 0 THEN @FeeDiscountId ELSE tfm.FeeDiscountId END
		AND (tfm.FeeDiscountName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tfm.FeeDiscountName END + '%')
		AND tfm.IsActive =  CASE WHEN @FeeDiscountId > 0  THEN tfm.IsActive ELSE @FilterIsActive  END
		AND tfm.IsDeleted =  0
	 ORDER BY tfm.FeeDiscountName
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeePaymentPlan]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetFeePaymentPlan]
	@FeeTypeDetailId bigint = 0	
	,@FeePaymentPlanId bigint = 0
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT FeePaymentPlanId
		,FeeTypeDetailId
		,PaymentPlanAmount
		,DueDate
		,IsApproved
		,IsRejected
	FROM tblFeePaymentPlan		
	WHERE FeeTypeDetailId = @FeeTypeDetailId
		AND FeePaymentPlanId = CASE WHEN @FeePaymentPlanId > 0 THEN @FeePaymentPlanId ELSE FeePaymentPlanId END
		AND IsDeleted =  0
	ORDER BY DueDate
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeePlanWithGradewise]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetFeePlanWithGradewise]  
 @FeeTypeId bigint
 ,@AcademicYear nvarchar(20)
AS  
BEGIN  
	SET NOCOUNT ON; 
	INSERT INTO [dbo].[tblFeeStructure] 
			([AcademicYear]
			,[FeeTypeId]
			,[IsGradeWise]
			,[IsActive]
			,[IsDeleted]
			,[UpdateDate]
			,[UpdateBy])    

	SELECT @AcademicYear
		,FeeTypeId
		,IsGradeWise
		,1
		,0
		,GETDATE()
		,-1
	FROM tblFeeTypeMaster WHERE FeeTypeId NOT IN (SELECT FeeTypeId FROM tblFeeStructure WHERE AcademicYear = @AcademicYear)
	AND FeeTypeId=@FeeTypeId 

	DECLARE @FeeStructureId bigint
	SELECT @FeeStructureId=FeeStructureId FROM tblFeeStructure 
		WHERE AcademicYear = @AcademicYear AND IsGradeWise=1 AND FeeTypeId=@FeeTypeId
	
	INSERT INTO [dbo].[tblFeeGradewise]
			([FeeTypeId]
			,[FeeStructureId]
			,[GradeId]			 
			,[IsActive]
			,[IsDeleted]
			,[UpdateDate]
			,[UpdateBy])
	SELECT @FeeTypeId
		,@FeeStructureId
		,GradeId		
		,1
		,0
		,GETDATE()
		,-1 
	FROM tblGradeMaster tgm	
	WHERE @FeeStructureId NOT IN (SELECT FeeStructureId FROM [tblFeeGradewise])
	

	SELECT tfg.FeeGradewiseId  
		,tfg.FeeStructureId 
		,tg.GradeName
		,tfg.GradeId   
		,tfg.FirstAmount  
		,tfg.FirstDueDate  
		,tfg.SecondAmount  
		,tfg.SecondDueDate  
		,tfg.ThirdAmount  
		,tfg.ThirdDueDate  
		,tfg.FirstAmount+tfg.SecondAmount+tfg.ThirdAmount AS Total  
		,(tfg.FirstAmount+tfg.SecondAmount+tfg.ThirdAmount)/3 AS TermAmount  
	FROM tblFeeGradewise tfg  
	INNER JOIN tblFeeStructure tfs  
	ON tfs.FeeStructureId = tfg.FeeStructureId  
	INNER JOIN tblGradeMaster tg  
	ON tg.GradeId=tfg.GradeId  
	WHERE  tfs.IsActive=1 AND tfs.IsDeleted=0 AND tfs.AcademicYear= @AcademicYear AND tfg.FeeTypeId=@FeeTypeId  
	ORDER BY tg.SequenceNo 
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeePlanWithoutGradewise]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetFeePlanWithoutGradewise]  
 @FeeTypeId bigint,
 @FeeStructureId bigint=0
AS  
BEGIN  
	SET NOCOUNT ON; 
	SELECT tft.FeeTypeId  
		,tft.FeeTypeName  
		,tft.IsGradeWise
		,tfs.FeeStructureId  
		,tfs.AcademicYear  
		,tfs.IsGradeWise AS IsGradeWiseFeeStructure  
		,tfs.FeeAmount   
	FROM tblFeeStructure tfs 
	INNER JOIN tblFeeTypeMaster tft 
		ON tft.FeeTypeId = tfs.FeeTypeId  
	WHERE tft.IsActive=1 AND tft.IsDeleted=0 AND tfs.FeeTypeId=@FeeTypeId AND tfs.IsActive=1 AND tfs.IsDeleted=0  
	AND tfs.FeeStructureId = CASE WHEN @FeeStructureId > 0 THEN @FeeStructureId ELSE tfs.FeeStructureId END	
	ORDER BY ISNULL(tfs.IsGradeWise,0),tft.IsGradeWise 
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeeStructure]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetFeeStructure]  
 @AcademicYear nvarchar(20)  
AS  
BEGIN  
	SET NOCOUNT ON;  
	INSERT INTO [dbo].[tblFeeStructure] 
			([AcademicYear]
			,[FeeTypeId]
			--,[FeeAmount]
			,[IsGradeWise]
			,[IsActive]
			,[IsDeleted]
			,[UpdateDate]
			,[UpdateBy])    

	SELECT @AcademicYear
		,FeeTypeId
		--,0
		,IsGradeWise
		,1
		,0
		,GETDATE()
		,-1
	FROM tblFeeTypeMaster WHERE FeeTypeId NOT IN (SELECT FeeTypeId FROM tblFeeStructure WHERE AcademicYear = @AcademicYear);

	DECLARE @FeeStructureId bigint
	DECLARE @FeeTypeId bigint
	DECLARE fetch_cursor CURSOR FOR SELECT FeeStructureId,FeeTypeId FROM tblFeeStructure WHERE AcademicYear = @AcademicYear AND IsGradeWise=1
	OPEN fetch_cursor
	FETCH NEXT FROM fetch_cursor INTO @FeeStructureId,@FeeTypeId
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		INSERT INTO [dbo].[tblFeeGradewise]
			   ([FeeTypeId]
			   ,[FeeStructureId]
			   ,[GradeId]
			   --,[FirstAmount]
			   --,[FirstDueDate]
			   --,[SecondAmount]
			   --,[SecondDueDate]
			   --,[ThirdAmount]
			   --,[ThirdDueDate]
			   ,[IsActive]
			   ,[IsDeleted]
			   ,[UpdateDate]
			   ,[UpdateBy])
		SELECT @FeeTypeId
			,@FeeStructureId
			,GradeId
			--,0
			--,GETDATE()
			--,0
			--,GETDATE()
			--,0
			--,GETDATE()
			,1
			,0
			,GETDATE()
			,-1 
		FROM tblGradeMaster tgm	
		WHERE @FeeStructureId NOT IN (SELECT FeeStructureId FROM [tblFeeGradewise])
		FETCH NEXT FROM fetch_cursor INTO @FeeStructureId,@FeeTypeId
	END
	CLOSE fetch_cursor 
	DEALLOCATE fetch_cursor

	SELECT tft.FeeTypeId  
		,tft.FeeTypeName  
		,tft.IsGradeWise AS IsGradeWiseFeeType  
		,tfs.FeeStructureId  
		,tfs.AcademicYear  
		,tfs.IsGradeWise AS IsGradeWiseFeeStructure  
		,tfs.FeeAmount   
	FROM tblFeeTypeMaster tft  
	INNER JOIN tblFeeStructure tfs  
		ON tft.FeeTypeId = tfs.FeeTypeId  
	WHERE tft.IsActive=1 AND tft.IsDeleted=0 AND tfs.AcademicYear=@AcademicYear AND tfs.IsActive=1 AND tfs.IsDeleted=0  
	ORDER BY ISNULL(tfs.IsGradeWise,0),tft.IsGradeWise 
	
	SELECT tfg.FeeGradewiseId  
		,tfg.FeeStructureId 
		,tg.GradeName
		,tfg.GradeId   
		,tfg.FirstAmount  
		,tfg.FirstDueDate  
		,tfg.SecondAmount  
		,tfg.SecondDueDate  
		,tfg.ThirdAmount  
		,tfg.ThirdDueDate  
		,tfg.FirstAmount+tfg.SecondAmount+tfg.ThirdAmount AS Total  
		,(tfg.FirstAmount+tfg.SecondAmount+tfg.ThirdAmount)/3 AS TermAmount  
	FROM tblFeeGradewise tfg  
	INNER JOIN tblFeeStructure tfs  
	ON tfs.FeeStructureId = tfg.FeeStructureId  
	INNER JOIN tblGradeMaster tg  
	ON tg.GradeId=tfg.GradeId  
	WHERE  tfs.IsActive=1 AND tfs.IsDeleted=0 AND tfs.AcademicYear= @AcademicYear  
	ORDER BY tg.SequenceNo 
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeeType]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetFeeType]        
 @FeeTypeId bigint = 0        
AS        
BEGIN        
 SET NOCOUNT ON;         
 SELECT tfm.FeeTypeId        
 ,tfm.FeeTypeName  
 ,tfm.IsPrimary
 ,tfm.IsGradeWise   
 ,tfm.IsTermPlan        
 ,tfm.IsPaymentPlan        
 ,tfm.IsActive   
 ,tfm.DebitAccount  
 ,tfm.CreditAccount  
 FROM tblFeeTypeMaster tfm          
 WHERE tfm.FeeTypeId = CASE WHEN @FeeTypeId > 0 THEN @FeeTypeId ELSE tfm.FeeTypeId END         
  AND tfm.IsDeleted =  0        
  ORDER BY tfm.FeeTypeName        
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeeTypeDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_GetFeeTypeDetail @FeeTypeId=4  
CREATE PROCEDURE [dbo].[sp_GetFeeTypeDetail]        
 @FeeTypeId bigint = 0        
 ,@FeeTypeDetailId bigint = 0      
AS        
BEGIN        
 SET NOCOUNT ON;         
 SELECT   
  tfm.FeeTypeId        
  ,tfm.FeeTypeName        
    
  ,tfm.IsTermPlan        
  ,tfm.IsPaymentPlan   
  ,tfm.IsGradeWise  
     
  ,isnull(tyd.FeeTypeDetailId,0) as FeeTypeDetailId  
  ,isnull(tyd.AcademicYearId,0) as AcademicYearId  
  ,CAST(isnull(tyd.TermFeeAmount,0) as DECIMAL(10,2))  as TermFeeAmount  
     ,CAST(isnull(tyd.StaffFeeAmount,0) as DECIMAL(10,2))  as StaffFeeAmount  
  ,isnull(tyd.GradeId,0) GradeId  
  ,isnull(tgm.GradeName,'')GradeName  
  
  ,tfm.IsActive    
    
  ,isnull(ac.AcademicYear,'')AcademicYear  
  ,TotalTerm=  
   (  
   select count(1)   
   from   
    [tblSchoolTermAcademic] tac    
   where ac.SchoolAcademicId=tac.SchoolAcademicId  
   and ac.IsActive=1 and ac.IsDeleted=0  
   and tac.IsDeleted=0  
  
   )  
 FROM  tblFeeTypeMaster tfm  
 inner join [tblFeeTypeDetail] tyd ON tfm.FeeTypeId=tyd.FeeTypeId    
 AND tyd.FeeTypeDetailId = CASE WHEN @FeeTypeDetailId > 0 THEN @FeeTypeDetailId ELSE tyd.FeeTypeDetailId END   
 AND tyd.IsDeleted =  0  
 AND tyd.IsActive=1  
 inner join [tblSchoolAcademic] ac ON  ac.SchoolAcademicId=tyd.AcademicYearId  
 left join tblGradeMaster tgm ON tyd.GradeId=tgm.GradeId    
 WHERE   
 tfm.FeeTypeId = CASE WHEN @FeeTypeId > 0 THEN @FeeTypeId ELSE tfm.FeeTypeId END   
   
 AND tfm.IsDeleted =  0    
 AND tfm.IsActive =  1   
   
 ORDER BY tfm.FeeTypeName   , tgm.GradeName   
   
  
 select  distinct sta.*   
 from [dbo].[tblSchoolTermAcademic] sta  
 inner join [tblFeeTypeDetail] ftd   
 on sta.SchoolAcademicId=ftd.AcademicYearId  
 where  sta.IsDeleted=0  
   and ftd.IsActive=1 and ftd.IsDeleted=0  
   and ftd.FeeTypeId=@FeeTypeId  
   order by StartDate  
  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetFeeTypeNew]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[sp_GetFeeTypeNew]  
 @FeeTypeId bigint = 0  
AS  
BEGIN  
 SET NOCOUNT ON;   
 SELECT tfm.FeeTypeId  
  ,tfm.FeeTypeName  
  ,tfm.IsTermPlan  
  ,tfm.IsPaymentPlan  
   ,tfm.IsActive    
 FROM tblFeeTypeMaster tfm    
 WHERE tfm.FeeTypeId = CASE WHEN @FeeTypeId > 0 THEN @FeeTypeId ELSE tfm.FeeTypeId END   
  AND tfm.IsDeleted =  0  
  ORDER BY tfm.FeeTypeName  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetGender]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetGender]
	@GenderTypeId bigint = 0,
	@FilterSearch NVarChar(200)=null,
	@FilterIsActive bit=1
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT tgt.GenderTypeId
		,tgt.GenderTypeName
		,tgt.DebitAccount
		,tgt.CreditAccount
		,tgt.IsActive		
	FROM tblGenderTypeMaster tgt		
	WHERE tgt.GenderTypeId = CASE WHEN @GenderTypeId > 0 THEN @GenderTypeId ELSE tgt.GenderTypeId END
		AND (tgt.GenderTypeName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tgt.GenderTypeName END + '%')
		AND tgt.IsActive =  CASE WHEN @GenderTypeId>0 THEN tgt.IsActive ELSE @FilterIsActive  END
		AND tgt.IsDeleted =  0
	ORDER BY tgt.GenderTypeName
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetGenerateFee]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--5

CREATE PROCEDURE [dbo].[sp_GetGenerateFee]
	@FeeGenerateId int=0
AS
BEGIN
	SET NOCOUNT ON;	
		select 
		FeeGenerateId	,SchoolAcademicId	,
		AcademicYear	,FeeTypeId	,FeeTypeName	,GradeId	,
		GradeName=case when GenderTypeName is null then GradeName  else  (GradeName +' - '+ isnull(GenderTypeName,'')) end 
		,GenerateStatus	
		,UpdateDate	,UpdateBy	,StudentCount
	from 
	(
		SELECT 
			tfg.FeeGenerateId
			,tfg.SchoolAcademicId
			,tsa.AcademicYear
			,tfg.FeeTypeId
			,tf.FeeTypeName
			,tfg.GradeId
			,tg.GradeName
			,tgtm.GenderTypeName
			--,CONCAT_WS(' - ',tg.GradeName, tgtm.GenderTypeName) AS GradeName
			--,GradeName=case when GenderTypeName is null then tg.GradeName  else  (tg.GradeName +' - '+ isnull(tgtm.GenderTypeName,'')) end 
			,tfg.GenerateStatus
			,tfg.UpdateDate
			,tfg.UpdateBy
			,COUNT(tfgd.FeeGenerateDetailId) AS StudentCount
		FROM tblFeeGenerate tfg
		INNER JOIN tblSchoolAcademic tsa
			ON tfg.SchoolAcademicId = tsa.SchoolAcademicId
		INNER JOIN tblFeeTypeMaster tf
			ON tfg.FeeTypeId = tf.FeeTypeId
		INNER JOIN tblGradeMaster tg
			ON tfg.GradeId = tg.GradeId
		LEFT JOIN tblGenderTypeMaster tgtm   
			ON tgtm.GenderTypeId = tg.GenderTypeId  
		LEFT JOIN tblFeeGenerateDetail tfgd 
			ON tfg.FeeGenerateId = tfgd.FeeGenerateId 
		GROUP BY 
			tfg.FeeGenerateId
			,tfg.SchoolAcademicId
			,tsa.AcademicYear
			,tfg.FeeTypeId
			,tf.FeeTypeName
			,tfg.GradeId
			--,CONCAT_WS(' - ',tg.GradeName, tgtm.GenderTypeName) 
			--,(tg.GradeName +' - '+ isnull(tgtm.GenderTypeName,''))
			,tg.GradeName
			,tgtm.GenderTypeName
			,tfg.GenerateStatus
			,tfg.UpdateDate
			,tfg.UpdateBy
		HAVING tfg.FeeGenerateId=CASE WHEN @FeeGenerateId>0 THEN @FeeGenerateId ELSE tfg.FeeGenerateId END
	)t
	
	IF(@FeeGenerateId>0)
	BEGIN
		SELECT tfg.FeeGenerateDetailId
				,tfg.FeeGenerateId
				,tfg.StudentId
				,tstu.StudentName
				,tfg.SchoolAcademicId
				,tsa.AcademicYear
				,tfg.GradeId
				--,CONCAT_WS(' - ',tg.GradeName, tgtm.GenderTypeName) AS GradeName
				--,(tg.GradeName+' - '+ tgtm.GenderTypeName) AS GradeName
				,GradeName=case when GenderTypeName is null then tg.GradeName  else  (tg.GradeName +' - '+ isnull(tgtm.GenderTypeName,'')) end 
				,tfg.FeeTypeId
				,tf.FeeTypeName
				,tfg.FeeAmount
				,tfg.UpdateDate
				,tfg.UpdateBy
		FROM tblFeeGenerateDetail tfg
		INNER JOIN tblStudent tstu
			ON tstu.StudentId = tfg.StudentId
		INNER JOIN tblSchoolAcademic tsa
			ON tfg.SchoolAcademicId = tsa.SchoolAcademicId
		INNER JOIN tblFeeTypeMaster tf
			ON tfg.FeeTypeId = tf.FeeTypeId
		INNER JOIN tblGradeMaster tg
			ON tfg.GradeId = tg.GradeId
		LEFT JOIN tblGenderTypeMaster tgtm   
			ON tgtm.GenderTypeId = tg.GenderTypeId 
		WHERE FeeGenerateId=@FeeGenerateId
	END
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetGenerateSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetGenerateSiblingDiscount]
	@SiblingDiscountId BIGINT=0
AS
BEGIN
	SET NOCOUNT ON;	
		SELECT 
		SiblingDiscountId
		,SchoolAcademicId
		,AcademicYear
		,FeeTypeId
		,FeeTypeName		
		,GenerateStatus	
		,UpdateDate
		,UpdateBy
		,StudentCount
	FROM 
	(
		SELECT 
			tfg.SiblingDiscountId
			,tfg.SchoolAcademicId
			,tsa.AcademicYear
			,tfg.FeeTypeId
			,tf.FeeTypeName
			,tfg.GenerateStatus
			,tfg.UpdateDate
			,tfg.UpdateBy
			,COUNT(tfgd.SiblingDiscountDetailId) AS StudentCount
		FROM tblSiblingDiscount tfg
		INNER JOIN tblSchoolAcademic tsa
			ON tfg.SchoolAcademicId = tsa.SchoolAcademicId
		INNER JOIN tblFeeTypeMaster tf
			ON tfg.FeeTypeId = tf.FeeTypeId	
		LEFT JOIN tblSiblingDiscountDetail tfgd 
			ON tfg.SiblingDiscountId = tfgd.SiblingDiscountId 
		GROUP BY 
			tfg.SiblingDiscountId
			,tfg.SchoolAcademicId
			,tsa.AcademicYear
			,tfg.FeeTypeId
			,tf.FeeTypeName			
			,tfg.GenerateStatus
			,tfg.UpdateDate
			,tfg.UpdateBy
		HAVING tfg.SiblingDiscountId=CASE WHEN @SiblingDiscountId>0 THEN @SiblingDiscountId ELSE tfg.SiblingDiscountId END
	)t
	IF(@SiblingDiscountId>0)
	BEGIN
		SELECT tfg.SiblingDiscountId
				,tfg.StudentId
				,tstu.StudentName
				,tfg.SchoolAcademicId
				,tsa.AcademicYear
				,tfg.GradeId
				,GradeName=case when GenderTypeName is null then tg.GradeName  else  (tg.GradeName +' - '+ isnull(tgtm.GenderTypeName,'')) end 
				,tfg.FeeTypeId
				,tf.FeeTypeName
				,tfg.DiscountPercent
				,tfg.DiscountAmount
				,tfg.UpdateDate
				,tfg.UpdateBy
		FROM tblSiblingDiscountDetail tfg
		INNER JOIN tblStudent tstu
			ON tstu.StudentId = tfg.StudentId
		INNER JOIN tblSchoolAcademic tsa
			ON tfg.SchoolAcademicId = tsa.SchoolAcademicId
		INNER JOIN tblFeeTypeMaster tf
			ON tfg.FeeTypeId = tf.FeeTypeId
		INNER JOIN tblGradeMaster tg
			ON tfg.GradeId = tg.GradeId
		LEFT JOIN tblGenderTypeMaster tgtm   
			ON tgtm.GenderTypeId = tg.GenderTypeId 
		WHERE SiblingDiscountId=@SiblingDiscountId
	END
END

GO
/****** Object:  StoredProcedure [dbo].[sp_GetGradeMaxSequenceNo]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetGradeMaxSequenceNo]
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT ISNULL(MAX(SequenceNo),0) AS SequenceNo
	FROM tblGradeMaster WHERE IsActive=1 AND IsDeleted=0
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetGrades]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetGrades]  
 @GradeId int = 0,  
 @FilterSearch NVarChar(200)=null,  
 @FilterCostCenterId int=0,  
 @FilterGenderTypeId int=0,  
 @FilterIsActive bit=1  
AS  
BEGIN  
 SET NOCOUNT ON;   
 SELECT tg.GradeId  
	,tg.GradeName   
	,tg.SequenceNo   
	,tg.DebitAccount
	,tg.CreditAccount
  ,tcc.CostCenterId  
  ,tcc.CostCenterName   
  ,ISNULL(tgt.GenderTypeId,0) GenderTypeId  
  ,tgt.GenderTypeName  
  ,(SELECT MAX(SequenceNo)+1 FROM tblGradeMaster WHERE IsActive=1 AND IsDeleted=0)  AS MaxSequenceNo   
  ,tg.IsActive    
 FROM tblGradeMaster tg  
 INNER JOIN tblCostCenterMaster tcc  
  ON tcc.CostCenterId = tg.CostCenterId  
 LEFT JOIN tblGenderTypeMaster tgt  
  ON tgt.GenderTypeId = tg.GenderTypeId  
 WHERE tg.GradeId = CASE WHEN @GradeId > 0 THEN @GradeId ELSE tg.GradeId END  
  --AND (tg.GradeName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tg.GradeName END + '%'  
  --OR tcc.CostCenterName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tcc.CostCenterName END + '%'  
  --OR tgt.GenderTypeName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tgt.GenderTypeName END + '%'  
  --)  
  AND tg.CostCenterId = CASE WHEN @FilterCostCenterId > 0 THEN @FilterCostCenterId ELSE tg.CostCenterId END  
  AND tg.GenderTypeId = CASE WHEN @FilterGenderTypeId > 0 THEN @FilterGenderTypeId ELSE tg.GenderTypeId END  
  --AND tg.IsActive =  CASE WHEN @GradeId > 0 THEN tg.IsActive ELSE @FilterIsActive  END  
  AND tg.IsDeleted =0 AND tg.IsActive = 1  
 ORDER BY tg.SequenceNo  
  
   
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoice]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetInvoice]    
 @InvoiceId bigint = 0,                  
 @Status nvarchar(50) = NULL,                  
 @InvoiceDateStart date = NULL,                  
 @InvoiceDateEnd date = NULL,                  
 @InvoiceType nvarchar(50) = NULL,                  
 @InvoiceNo nvarchar(50) = NULL,                  
 @ParentCode nvarchar(50) = NUll,                  
 @ParentName nvarchar(400) = NULL,          
 @FatherMobile nvarchar(200) = NULL          
 AS    
BEGIN                            
 SET NOCOUNT ON;                             
                  
	SELECT                   
		tis.InvoiceId                  
		,tis.InvoiceNo                  
		,tis.InvoiceDate                  
		,tis.Status                  
		,tis.PublishedBy                  
		,tis.CreditNo                  
		,tis.CreditReason                  
		,tis.CustomerName              
		,tis.IqamaNumber  
		,tis.IsDeleted                  
		,tis.UpdateDate                  
		,tis.UpdateBy                 
		,InvoiceType=isnull(tis.InvoiceType,'Invoice')
		,tis.InvoiceRefNo
	into #InvoiceSummary          
	FROM INV_InvoiceSummary tis                         
	--LEFT JOIN tblParent tp ON tis.ParentID = tp.ParentId                     
	WHERE tis.InvoiceId = CASE WHEN @InvoiceId > 0 THEN @InvoiceId ELSE tis.InvoiceId END                  
	AND (@Status IS NULL OR tis.[Status] = @Status)                  
	AND (@InvoiceDateStart IS NULL OR cast(tis.InvoiceDate as date) >= cast(@InvoiceDateStart as date))                  
	AND (@InvoiceDateEnd IS NULL OR cast(tis.InvoiceDate as date) <= cast(@InvoiceDateEnd as date))                  
	AND (@InvoiceType IS NULL OR tis.InvoiceType = @InvoiceType)                  
	AND (@InvoiceNo IS NULL OR tis.InvoiceNo = @InvoiceNo)                  
	AND tis.IsDeleted = 0         
  
	select  
	tis.InvoiceNo     
	,TaxableAmount=sum(tis.TaxableAmount)  
	,TaxAmount=sum(tis.TaxAmount)  
	,ItemSubtotal=sum(tis.ItemSubtotal)  
	into #InvoiceDetail  
	from INV_InvoiceDetail tis  
	join #InvoiceSummary invSum  
	on tis.InvoiceNo=invSum.InvoiceNo  
	group by tis.InvoiceNo  
     
     --select  @ParentCode        
 select       
  t.InvoiceNo, t.ParentID,t.ParentName,t.FatherMobile,t.ParentCode,t.StudentId,t.StudentName,t.StudentCode,t.InvoiceTypeValue,        
  ROW_NUMBER() over(partition by t.InvoiceNo order by  t.InvoiceNo) as RN          
 into #INDMobile          
 from          
 (          
  select distinct           
   ins.InvoiceNo        
   ,ParentID= case when tp.ParentID is null then ind.ParentID  else tp.ParentID end        
   ,ParentName= case when tp.FatherName COLLATE SQL_Latin1_General_CP1256_CI_AS  is null then ind.ParentName  else tp.FatherName COLLATE SQL_Latin1_General_CP1256_CI_AS  end        
   ,FatherMobile= case when tp.FatherMobile is null then ind.FatherMobile  else tp.FatherMobile end        
   ,ParentCode= case when tp.ParentCode is null then ''  else tp.ParentCode end        
              
   ,StudentId= case when ts.StudentId is null then ind.StudentId  else ts.StudentId end        
   ,StudentName=case when ind.InvoiceType like '%Uniform%' then '' else  
  case when ts.StudentName COLLATE SQL_Latin1_General_CP1256_CI_AS  is null then ind.StudentName    
  else ts.StudentName COLLATE SQL_Latin1_General_CP1256_CI_AS   
  end       
 end  
   ,StudentCode= case when ts.StudentCode is null then ''  else ts.StudentCode end          
           
   ,InvoiceTypeValue=    
   (select REPLACE(STUFF(CAST((          
    SELECT   ', ' +CAST(c.InvoiceType AS VARCHAR(MAX))          
     FROM (           
     SELECT distinct scm.InvoiceType              
    FROM INV_InvoiceDetail AS scm                
    WHERE scm.InvoiceNo = ins.InvoiceNo        
       
   ) c          
  FOR XML PATH(''), TYPE) AS VARCHAR(MAX)), 1, 2, ''),' ',' ')  
 )  
 from           
 #InvoiceSummary ins          
 join INV_InvoiceDetail ind on ins.InvoiceNo=ind.InvoiceNo          
 LEFT JOIN tblParent tp ON ind.ParentID = tp.ParentId          
 AND tp.ParentCode=CASE WHEN @ParentCode IS NULL OR @ParentCode='' THEN tp.ParentCode ELSE @ParentCode END      
 AND ind.FatherMobile=CASE WHEN @FatherMobile IS NULL OR @FatherMobile='' THEN ind.FatherMobile ELSE @FatherMobile END      
 AND tp.FatherName like '%' + CASE WHEN @ParentName IS NULL OR @ParentName='' THEN tp.FatherName ELSE @ParentName END +'%'      
 LEFT JOIN tblStudent ts ON ind.StudentId = ts.StudentId        
        
 where ind.FatherMobile is null OR len( ISNULL(ind.FatherMobile,''))>0          
 )t    
    
 delete from #INDMobile where RN>1     

 ----Get Max payemtn info
 select  
 ROW_NUMBER() over(partition by tis.InvoiceNo order by  tis.PaymentAmount desc) as RN          
	,tis.InvoiceNo     
	,tis.PaymentReferenceNumber
	,tis.PaymentMethod
	into #InvoicePayment  
	from INV_InvoicePayment tis  
	join #InvoiceSummary invSum  
	on tis.InvoiceNo=invSum.InvoiceNo  

	 delete from #InvoicePayment where RN>1    
      
 select     
  ins.*  
 
  ,ParentID=cast( isnull(ind.ParentID  ,'') as nvarchar(100))        
  ,ParentName=isnull(ind.ParentName  ,'')        
  ,FatherMobile=isnull(ind.FatherMobile  ,'')        
  ,ParentCode=isnull(ind.ParentCode  ,'')        
  ,StudentId=isnull(ind.StudentId  ,'')        
  ,StudentName=isnull(ind.StudentName  ,'')        
  ,StudentCode=isnull(ind.StudentCode,'')        
  ,InvoiceTypeValue=ind.InvoiceTypeValue
  ,indPay.PaymentMethod
  ,indPay.PaymentReferenceNumber
  ,invDet.TaxableAmount  
  ,invDet.TaxAmount  
  ,invDet.ItemSubtotal  
 from #InvoiceSummary ins   
 join #InvoiceDetail invDet on ins.InvoiceNo=invDet.InvoiceNo  
 left join  #INDMobile ind on ins.InvoiceNo=ind.InvoiceNo  
  left join  #InvoicePayment indPay on ins.InvoiceNo=indPay.InvoiceNo     
 WHERE     
 --isnull(ParentCode,'')=CASE WHEN @ParentCode IS NULL OR @ParentCode='' THEN ParentCode ELSE @ParentCode END    
  (@ParentCode IS NULL OR isnull(ParentCode,'') like '%' + @ParentCode  +'%'   )    
 and (@FatherMobile IS NULL OR isnull(FatherMobile,'') like '%' + @FatherMobile  +'%'   )    
 and (@ParentName IS NULL OR isnull(ParentName,'') like '%' + @ParentName  +'%'   )    
 --AND isnull(FatherMobile,'') like '%' + CASE WHEN @FatherMobile IS NULL OR @FatherMobile='' THEN FatherMobile ELSE @FatherMobile END  +'%'      
 --AND isnull(ParentName,'') like '%' + CASE WHEN @ParentName IS NULL OR @ParentName='' THEN ParentName ELSE @ParentName END +'%'      
  ORDER BY ins.InvoiceNo DESC         
    
    
 drop table #InvoiceSummary        
 drop table #INDMobile  
 drop table #InvoiceDetail  
  
END 
GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoiceByInvoiceNo]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetInvoiceByInvoiceNo]
@InvoiceNo nvarchar(50)
as
begin
	select * from INV_InvoiceSummary where InvoiceNo=@InvoiceNo
	select * from INV_InvoiceDetail where InvoiceNo=@InvoiceNo
	select * from INV_InvoicePayment where InvoiceNo=@InvoiceNo

end
GO
/****** Object:  StoredProcedure [dbo].[sp_getInvoiceData]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_getInvoiceData]
    @StartYear datetime,
    @EndYear datetime
AS
BEGIN
    SELECT
        InvoiceYear,
		InvoiceMonth,
		InvoiceMonthName,
        Discount = SUM(Discount),
        TaxableAmount = SUM(TaxableAmount),
        TaxAmount = SUM(TaxAmount),
        ItemSubtotal = SUM(ItemSubtotal)
    FROM (
       SELECT
			YEAR(ts.InvoiceDate) InvoiceYear,
			Month(ts.InvoiceDate) InvoiceMonth,
			datename(month,ts.InvoiceDate) InvoiceMonthName,

			Discount = CASE WHEN ts.InvoiceType = 'Return' THEN (ISNULL(TD.Discount,0) * -1) ELSE ISNULL(td.Discount,0) END,
			TaxableAmount = CASE WHEN ts.InvoiceType = 'Return' THEN (ISNULL(TD.TaxableAmount,0) * -1) ELSE ISNULL(td.TaxableAmount,0) END,
			TaxAmount = CASE WHEN ts.InvoiceType = 'Return' THEN (ISNULL(TD.TaxAmount,0) * -1) ELSE ISNULL(td.TaxAmount,0) END,
			ItemSubtotal = CASE WHEN ts.InvoiceType = 'Return' THEN (ISNULL(TD.ItemSubtotal,0) * -1) ELSE ISNULL(td.ItemSubtotal,0) END

		FROM INV_InvoiceDetail td
		INNER JOIN INV_InvoiceSummary ts ON td.InvoiceNo = ts.InvoiceNo
		--WHERE Status = 'Posted'
    ) t
    GROUP BY t.InvoiceYear,t.InvoiceMonth,t.InvoiceMonthName;
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoiceDataMonthly]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_GetInvoiceDataMonthly]
AS
BEGIN
    SELECT
        InvoiceYear,
        InvoiceMonth,
        InvoiceMonthName,
        Discount = SUM(Discount),
        TaxableAmount = SUM(TaxableAmount),
        TaxAmount = SUM(TaxAmount),
        ItemSubtotal = SUM(ItemSubtotal)
    FROM (
       SELECT
            YEAR(ts.InvoiceDate) AS InvoiceYear,
            MONTH(ts.InvoiceDate) AS InvoiceMonth,
            DATENAME(month, ts.InvoiceDate) AS InvoiceMonthName,

            Discount = CASE 
                          WHEN ts.InvoiceType = 'Return' THEN (ISNULL(td.Discount, 0) * -1) 
                          ELSE ISNULL(td.Discount, 0) 
                       END,
            TaxableAmount = CASE 
                               WHEN ts.InvoiceType = 'Return' THEN (ISNULL(td.TaxableAmount, 0) * -1) 
                               ELSE ISNULL(td.TaxableAmount, 0) 
                            END,
            TaxAmount = CASE 
                           WHEN ts.InvoiceType = 'Return' THEN (ISNULL(td.TaxAmount, 0) * -1) 
                           ELSE ISNULL(td.TaxAmount, 0) 
                        END,
            ItemSubtotal = CASE 
                              WHEN ts.InvoiceType = 'Return' THEN (ISNULL(td.ItemSubtotal, 0) * -1) 
                              ELSE ISNULL(td.ItemSubtotal, 0) 
                           END
        FROM INV_InvoiceDetail td
        INNER JOIN INV_InvoiceSummary ts ON td.InvoiceNo = ts.InvoiceNo
        --WHERE Status = 'Posted'
    ) t
    GROUP BY t.InvoiceYear, t.InvoiceMonth, t.InvoiceMonthName;
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoiceDataYearly]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetInvoiceDataYearly]
AS
BEGIN

	DECLARE @PeriodFrom DATE
	DECLARE @PeriodTo DATE
	SELECT TOP 1 
		@PeriodFrom=CAST(PeriodFrom AS DATE)
		,@PeriodTo=CAST(PeriodTo AS DATE)
	FROM tblSchoolAcademic 
	WHERE IsActive=1 and IsDeleted=0
		AND CAST(GETDATE() AS DATE) BETWEEN CAST(PeriodFrom AS DATE)  and CAST(PeriodTo AS DATE)

    SELECT 		DATEPART(YEAR, CAST(UpdateDate AS DATE)) AS AYear, 		DATENAME(MONTH, CAST(UpdateDate AS DATE)) AS [MonthName],		SUM(CASE WHEN InvoiceType = 'Entrance Fee' THEN ItemSubtotal ELSE 0 END) AS MonthlyEntranceRevenue,		SUM(CASE WHEN InvoiceType = 'Uniform Fee' THEN ItemSubtotal ELSE 0 END) AS MonthlyUniformRevenue,		SUM(CASE WHEN InvoiceType = 'Tuition Fee' THEN ItemSubtotal ELSE 0 END) AS MonthlyTuitionRevenue	FROM INV_InvoiceDetail	where  CAST(UpdateDate AS DATE) BETWEEN CAST(@PeriodFrom AS DATE) AND CAST(@PeriodTo AS DATE) 	GROUP BY 		DATEPART(YEAR, CAST(UpdateDate AS DATE)), 		DATENAME(MONTH, CAST(UpdateDate AS DATE))
END

GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoiceDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetInvoiceDetail]        
 @InvoiceDetailId bigint = 0        
AS        
BEGIN        
 SET NOCOUNT ON;         
 SELECT tid.InvoiceDetailId        
 ,tid.InvoiceType  
 ,tid.AcademicYear
 ,tid.ParentId   
 ,tid.ParentName
 ,tid.StudentId      
 ,tid.StudentName      
 ,tid.Quantity   
 --,tid.TotalVat  
 ,tid.TaxableAmount  
 ,tid.ItemSubtotal
 FROM INV_InvoiceDetail tid          
 WHERE tid.InvoiceDetailId = CASE WHEN @InvoiceDetailId > 0 THEN @InvoiceDetailId ELSE tid.InvoiceDetailId END         
  AND tid.IsDeleted =  0        
  ORDER BY tid.Description        
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoiceNo]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetInvoiceNo]  
as  
begin  
   
 update [dbo].[Transactions]  
 set TransactionNo=TransactionNo+1  
 where TransactionID=1  
  
 select TransactionNo as Result   
 from [dbo].[Transactions]  
 where TransactionID=1  
  
  
end  
GO
/****** Object:  StoredProcedure [dbo].[sp_GetInvoiceType]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetInvoiceType]
	@InvoiceTypeId bigint = 0,
	@FilterSearch NVarChar(200)=null,
	@FilterIsActive bit=1
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT tit.InvoiceTypeId
		,tit.InvoiceTypeName	
		,tit.ReceivableAccount
		,tit.AdvanceAccount
		,tit.ReceivableAccountRemarks
		,tit.AdvanceAccountRemarks
		,tit.IsActive		
	FROM tblInvoiceTypeMaster tit		
	WHERE tit.InvoiceTypeId = CASE WHEN @InvoiceTypeId > 0 THEN @InvoiceTypeId ELSE tit.InvoiceTypeId END
		AND (tit.InvoiceTypeName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tit.InvoiceTypeName END + '%')
		AND tit.IsActive =  CASE WHEN  @InvoiceTypeId>0 THEN tit.IsActive ELSE @FilterIsActive  END
		AND tit.IsDeleted =  0
	ORDER BY tit.InvoiceTypeName
END
GO
/****** Object:  StoredProcedure [dbo].[Sp_GetItemCodeRecord]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE proc [dbo].[Sp_GetItemCodeRecord]        
@ItemCode nvarchar(200)        
,@nationalId int    
, @UniformDB nvarchar(100)      
as        
begin    
 declare @VatPercent decimal(18,2)=0;      
 declare @VatID int=0;      
 declare @ExcludedCountryCount int=0;      
    
 select top 1     
  @VatPercent=ISNULL(VatTaxPercent,0),    
  @VatID =fd.VatId    
 from [dbo].[tblFeeTypeMaster] fm      
 inner join [dbo].[tblVatMaster] fd on fm.FeeTypeId=fd.FeeTypeId      
 where fm.FeeTypeName like '%uniform%'      
 and fm.IsActive=1 and fm.IsDeleted=0      
 and fd.IsActive=1 and fd.IsDeleted=0        
order by VatId desc

   if(@VatID>0)      
   begin      
 select @ExcludedCountryCount=count(CountryId) from tblVatCountryExclusionMap where VatID=@VatID AND IsActive=1 and IsDeleted=0      
   end    
    
   --select * from tblVatCountryExclusionMap where VatID=@VatID AND IsActive=1 and IsDeleted=0 and CountryId=@nationalId    
    
   ----check if country excempted from tax    
   if exists(select 1 from tblVatCountryExclusionMap where VatID=@VatID AND IsActive=1 and IsDeleted=0 and CountryId=@nationalId)    
   begin    
 set @VatPercent=0    
   end    
    
 DECLARE @Query nvarchar(max)     
 declare @VatPercent2 nvarchar(500)      
 declare @ExcludedCountryCount2 nvarchar(500)      
 DECLARE @VatID2 nvarchar(500)      
      
 SELECT @VatPercent2=cast( @VatPercent as nvarchar(50))      
      
 SELECT @ExcludedCountryCount2=cast( @ExcludedCountryCount as nvarchar(50))      
 SELECT @VatID2=cast( @VatID as nvarchar(50))      
      
  --/* Build the SQL string once */      
  --SET @Query = N'SELECT top 1         
  --A.CURRCOST AS CurrentPrice,        
  --A.ITEMNMBR as ItemCode,        
  --A.ITEMDESC as ItemDescription,        
  --B.QTYONHND as QuantityOnHand,        
  --B.ATYALLOC as QuantityAllocated,        
  --AvailableQuantity= B.QTYONHND-B.ATYALLOC      
      
  --,VatPercent = '+@VatPercent2+'      
  --,ExcludedCountryCount='+@ExcludedCountryCount2+'      
  --,VatID='+@VatID2+'      
      
  --FROM '+@UniformDB+'.[dbo].IV00101 A        
  --join '+@UniformDB+'.[dbo].IV00102 B         
  --on A.ITEMNMBR=b.ITEMNMBR        
  --where A.ITEMNMBR like ''%'+@ItemCode+'%''      
  --and B.LOCNCODE=''''' ;    
    
  
  --Production  
  
    /* Build the SQL string once */      
  SET @Query = N'SELECT top 1         
  A.STNDCOST  AS CurrentPrice,        
  A.ITEMNMBR as ItemCode,        
  A.ITEMDESC as ItemDescription,        
  B.QTYONHND as QuantityOnHand,        
  B.ATYALLOC as QuantityAllocated,        
  AvailableQuantity= B.QTYONHND-B.ATYALLOC      
      
  ,VatPercent = '+@VatPercent2+'      
  ,ExcludedCountryCount='+@ExcludedCountryCount2+'      
  ,VatID='+@VatID2+'      
      
  FROM '+@UniformDB+'.[dbo].IV00101 A        
  join '+@UniformDB+'.[dbo].IV00102 B         
  on A.ITEMNMBR=b.ITEMNMBR        
  where A.ITEMNMBR like ''%'+@ItemCode+'%''      
  and B.LOCNCODE=''''   
  and A.LOCNCODE=''''' ;      
  
  print @query      
  
  EXECUTE sp_executesql @Query;      
    
end
GO

/****** Object:  StoredProcedure [dbo].[sp_GetNotificationGenerateFee]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetNotificationGenerateFee]
	@FeeGenerateId int=0
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT 
		tfg.FeeGenerateId
		,tfg.SchoolAcademicId
		,tsa.AcademicYear
		,tfg.FeeTypeId
		,tf.FeeTypeName
		,tfg.GradeId
		--,CONCAT_WS(' - ',tg.GradeName, tgtm.GenderTypeName) AS GradeName
		,(tg.GradeName+' - '+ tgtm.GenderTypeName) AS GradeName
		,tfg.GenerateStatus
		,tfg.UpdateDate
		,tfg.UpdateBy
		,COUNT(tfgd.FeeGenerateDetailId) AS StudentCount
	FROM tblFeeGenerate tfg
	INNER JOIN tblSchoolAcademic tsa
		ON tfg.SchoolAcademicId = tsa.SchoolAcademicId
	INNER JOIN tblFeeTypeMaster tf
		ON tfg.FeeTypeId = tf.FeeTypeId
	INNER JOIN tblGradeMaster tg
		ON tfg.GradeId = tg.GradeId
	LEFT JOIN tblGenderTypeMaster tgtm   
		ON tgtm.GenderTypeId = tg.GenderTypeId  
	LEFT JOIN tblFeeGenerateDetail tfgd 
		ON tfg.FeeGenerateId = tfgd.FeeGenerateId 
	GROUP BY 
		tfg.FeeGenerateId
		,tfg.SchoolAcademicId
		,tsa.AcademicYear
		,tfg.FeeTypeId
		,tf.FeeTypeName
		,tfg.GradeId
		--,CONCAT_WS(' - ',tg.GradeName, tgtm.GenderTypeName)
		,(tg.GradeName+' - '+ tgtm.GenderTypeName)
		,tfg.GenerateStatus
		,tfg.UpdateDate
		,tfg.UpdateBy
	HAVING tfg.FeeGenerateId=CASE WHEN @FeeGenerateId>0 THEN @FeeGenerateId ELSE tfg.FeeGenerateId END
	AND tfg.GenerateStatus=2

	SELECT tfg.FeeGenerateDetailId
			,tfg.FeeGenerateId
			,tfg.StudentId
			,tfg.SchoolAcademicId
			,tsa.AcademicYear
			,tfg.GradeId
			--,CONCAT_WS(' - ',tg.GradeName, tgtm.GenderTypeName) AS GradeName
			,(tg.GradeName+' - '+ tgtm.GenderTypeName) AS GradeName
			,tfg.FeeTypeId
			,tf.FeeTypeName
			,tfg.FeeAmount
			,tfg.UpdateDate
			,tfg.UpdateBy
	FROM tblFeeGenerateDetail tfg
	INNER JOIN tblSchoolAcademic tsa
		ON tfg.SchoolAcademicId = tsa.SchoolAcademicId
	INNER JOIN tblFeeTypeMaster tf
		ON tfg.FeeTypeId = tf.FeeTypeId
	INNER JOIN tblGradeMaster tg
		ON tfg.GradeId = tg.GradeId
	LEFT JOIN tblGenderTypeMaster tgtm   
		ON tgtm.GenderTypeId = tg.GenderTypeId 
	WHERE FeeGenerateId=CASE WHEN @FeeGenerateId>0 THEN @FeeGenerateId ELSE FeeGenerateId END
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationGenerateSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetNotificationGenerateSiblingDiscount]
	@SiblingDiscountId int=0
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT 
		tfg.SiblingDiscountId
		,tfg.SchoolAcademicId
		,tsa.AcademicYear
		,tfg.FeeTypeId
		,tf.FeeTypeName	 
		,tfg.GenerateStatus
		,tfg.UpdateDate
		,tfg.UpdateBy
		,COUNT(tfgd.SiblingDiscountDetailId) AS StudentCount
	FROM tblSiblingDiscount tfg
	INNER JOIN tblSchoolAcademic tsa
		ON tfg.SchoolAcademicId = tsa.SchoolAcademicId
	INNER JOIN tblFeeTypeMaster tf
		ON tfg.FeeTypeId = tf.FeeTypeId	
	LEFT JOIN tblSiblingDiscountDetail tfgd 
		ON tfg.SiblingDiscountId = tfgd.SiblingDiscountId 
	GROUP BY 
		tfg.SiblingDiscountId
		,tfg.SchoolAcademicId
		,tsa.AcademicYear
		,tfg.FeeTypeId
		,tf.FeeTypeName	
		,tfg.GenerateStatus
		,tfg.UpdateDate
		,tfg.UpdateBy
	HAVING tfg.SiblingDiscountId=CASE WHEN @SiblingDiscountId>0 THEN @SiblingDiscountId ELSE tfg.SiblingDiscountId END
	AND tfg.GenerateStatus=2

	SELECT tfg.SiblingDiscountId
			,tfg.StudentId
			,tfg.SchoolAcademicId
			,tsa.AcademicYear
			,tfg.GradeId
			--,CONCAT_WS(' - ',tg.GradeName, tgtm.GenderTypeName) AS GradeName
			,(tg.GradeName+' - '+ tgtm.GenderTypeName) AS GradeName
			,tfg.FeeTypeId
			,tf.FeeTypeName
			,tfg.DiscountPercent
			,tfg.DiscountAmount
			,tfg.UpdateDate
			,tfg.UpdateBy
	FROM tblSiblingDiscountDetail tfg
	INNER JOIN tblSchoolAcademic tsa
		ON tfg.SchoolAcademicId = tsa.SchoolAcademicId
	INNER JOIN tblFeeTypeMaster tf
		ON tfg.FeeTypeId = tf.FeeTypeId
	INNER JOIN tblGradeMaster tg
		ON tfg.GradeId = tg.GradeId
	LEFT JOIN tblGenderTypeMaster tgtm   
		ON tgtm.GenderTypeId = tg.GenderTypeId 
	WHERE SiblingDiscountId=CASE WHEN @SiblingDiscountId>0 THEN @SiblingDiscountId ELSE SiblingDiscountId END
END

GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationGroup]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[sp_GetNotificationGroup]
	@LoginUserId int=0
AS
BEGIN
	SELECT 
		ng.NotificationGroupId
		,ng.NotificationTypeId
		,ng.NotificationCount
		,ng.NotificationAction
		,nt.NotificationType
		,nt.ActionTable
		,nt.NotificationActionTable
		,REPLACE(REPLACE(nt.NotificationMsg,'#N',ng.NotificationCount),'#Action',CASE WHEN NotificationAction=1 THEN 'Added' WHEN NotificationAction=2 THEN 'Updated' WHEN NotificationAction=3 THEN 'Deleted'  WHEN NotificationAction=4 THEN 'Rejected'  WHEN NotificationAction=5 THEN 'Cancelled' ELSE '' END) AS NotificationMsg
	from tblNotificationGroup ng
	INNER JOIN tblNotificationTypeMaster nt
		ON nt.NotificationTypeId=ng.NotificationTypeId
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationGroupDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[sp_GetNotificationGroupDetail]
	@NotificationGroupId int=0
	,@NotificationTypeId int=0
AS
BEGIN
	SELECT ngd.NotificationGroupDetailId
		,ngd.NotificationGroupId
		,ngd.NotificationTypeId
		,ngd.NotificationAction
		,ngd.TableRecordId
		,ngd.OldValueJson
		,ngd.NewValueJson
		,ngd.CreatedBy 
		,nt.NotificationType
		,nt.ActionTable
		,tu.UserName
		,CASE WHEN ngd.NotificationAction=1 THEN 'Added' WHEN ngd.NotificationAction=2 THEN 'Updated' WHEN ngd.NotificationAction=3 THEN 'Deleted' END AS RecordAction
	FROM tblNotificationGroupDetail ngd
	--INNER JOIN tblNotificationGroup ng
	--	ON ng.NotificationGroupId=ngd.NotificationGroupId
	INNER JOIN tblNotificationTypeMaster nt
		ON nt.NotificationTypeId=ngd.NotificationTypeId
	INNER JOIN tblUser tu
		ON tu.UserId =ngd.CreatedBy
	WHERE ngd.NotificationGroupId=@NotificationGroupId AND ngd.NotificationTypeId=@NotificationTypeId
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationGroupDetailById]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[sp_GetNotificationGroupDetailById]
	@NotificationGroupDetailId bigint
AS
BEGIN
	SELECT ngd.NotificationGroupDetailId
		,ngd.NotificationGroupId
		,ngd.NotificationTypeId
		,ngd.NotificationAction
		,ngd.TableRecordId
		,ngd.OldValueJson
		,ngd.NewValueJson
		,ngd.CreatedBy 
		,nt.NotificationType
		,nt.ActionTable
		,tu.UserName
		,CASE WHEN ngd.NotificationAction=1 THEN 'Added' WHEN ngd.NotificationAction=2 THEN 'Updated' WHEN ngd.NotificationAction=3 THEN 'Deleted' END AS RecordAction
	FROM tblNotificationGroupDetail ngd
	--INNER JOIN tblNotificationGroup ng
	--	ON ng.NotificationGroupId=ngd.NotificationGroupId
	INNER JOIN tblNotificationTypeMaster nt
		ON nt.NotificationTypeId=ngd.NotificationTypeId
	INNER JOIN tblUser tu
		ON tu.UserId =ngd.CreatedBy
	WHERE ngd.NotificationGroupDetailId=@NotificationGroupDetailId
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationList]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[sp_GetNotificationList]
@UserId int=0
as
begin
	select NotificationId
			,RecordId
			,RecordStatus
			,IsApproved
			,RecordType
			,UpdateDate
			,UpdateBy
			,student_id 
	from tblNotification
	where IsApproved=0 and UpdateDate>=getdate()-1
end
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationOtherDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetNotificationOtherDiscount]
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT
	   tsdd.StudentOtherDiscountDetailId
        ,tsdd.StudentId
		,ts.StudentName
        ,tsdd.AcademicYearId
		,tsa.AcademicYear
        ,tsdd.GradeId
		,tgm.GradeName
		,tsdd.DiscountName
        ,tsdd.DiscountAmount
		,tsdd.DiscountStatus
    FROM 
        tblStudentOtherDiscountDetail AS tsdd
    JOIN 
        tblGradeMaster AS tgm ON tsdd.GradeId = tgm.GradeId
    JOIN 
        tblSchoolAcademic AS tsa ON tsdd.AcademicYearId = tsa.SchoolAcademicId
    JOIN 
        tblStudent AS ts ON tsdd.StudentId = ts.StudentId
    WHERE tsdd.IsActive=1 
		AND tsdd.IsDeleted=0
		AND tsdd.DiscountStatus IN (2,5)
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetNotificationSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetNotificationSiblingDiscount]
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT
	   tsdd.StudentSiblingDiscountDetailId
        ,tsdd.StudentId
		,ts.StudentName
        ,tsdd.AcademicYearId
		,tsa.AcademicYear
        ,tsdd.GradeId
		,tgm.GradeName
        ,tsdd.DiscountPercent
		,tsdd.DiscountStatus
    FROM 
        tblStudentSiblingDiscountDetail AS tsdd
    JOIN 
        tblGradeMaster AS tgm ON tsdd.GradeId = tgm.GradeId
    JOIN 
        tblSchoolAcademic AS tsa ON tsdd.AcademicYearId = tsa.SchoolAcademicId
    JOIN 
        tblStudent AS ts ON tsdd.StudentId = ts.StudentId
    WHERE tsdd.IsActive=1 
		AND tsdd.IsDeleted=0
		AND tsdd.DiscountStatus IN (2,5)
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetOpenApply]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetOpenApply]  
 @OpenApplyId bigint = 0,  
 @FilterSearch NVarChar(200)=null,  
 @FilterIsActive bit=1  
AS  
BEGIN  
 SET NOCOUNT ON;   
 SELECT top 1
	tgt.OpenApplyId
	,tgt.GrantType
	,tgt.ClientId
	,tgt.ClientSecret
	,tgt.Audience
	,tgt.OpenApplyJobPath
	,tgt.IsDeleted
	,tgt.IsActive
 FROM [tblOpenApplyMaster] tgt    
 WHERE tgt.OpenApplyId = CASE WHEN @OpenApplyId > 0 THEN @OpenApplyId ELSE tgt.OpenApplyId END   
 and IsDeleted=0 and IsActive=1
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetOtherDiscountDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetOtherDiscountDetail]
    @StudentId bigint
AS
BEGIN
    SELECT
	   tsdd.StudentOtherDiscountDetailId
        ,tsdd.StudentId
		,ts.StudentName
        ,tsdd.AcademicYearId
		,tsa.AcademicYear
        ,tsdd.GradeId
		,tgm.GradeName
		,tsdd.DiscountName
        ,tsdd.DiscountAmount
		,tsdd.DiscountStatus
    FROM 
        tblStudentOtherDiscountDetail AS tsdd
    JOIN 
        tblGradeMaster AS tgm ON tsdd.GradeId = tgm.GradeId
    JOIN 
        tblSchoolAcademic AS tsa ON tsdd.AcademicYearId = tsa.SchoolAcademicId
    JOIN 
        tblStudent AS ts ON tsdd.StudentId = ts.StudentId
    WHERE 
        tsdd.StudentId = @StudentId
		AND tsdd.IsActive=1 AND tsdd.IsDeleted=0
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetParent]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_GetParent
--@ParentId=330,
--@FilterSearch=null,
--@FilterNationalityId=0,
--@FilterIsActive=1
--Go

CREATE PROCEDURE [dbo].[sp_GetParent]    
 @ParentId bigint = 0,    
 @FilterSearch NVarChar(200)=null,    
 @FilterIsActive bit=1,    
 @FilterNationalityId int= 0    
AS    
BEGIN    
 SET NOCOUNT ON;     
 SELECT tp.ParentId    
  ,tp.ParentCode    
  ,tp.ParentImage    
  ,tp.FatherName    
  ,tp.FatherArabicName    
  ,tp.FatherNationalityId    
  ,tp.FatherMobile    
  ,tp.FatherEmail    
  ,tp.FatherIqamaNo    
  ,tp.IsFatherStaff     
   ,ftc.CountryName as FatherCountryName

  ,tp.MotherName    
  ,tp.MotherArabicName    
  ,tp.MotherNationalityId    
  ,tp.MotherMobile    
  ,tp.MotherEmail    
  ,tp.MotherIqamaNo    
  ,tp.IsMotherStaff  
  ,mtc.CountryName as MotherCountryName
  ,tp.IsActive    
  ,tp.IsDeleted    
  ,tp.UpdateDate    
  ,tp.UpdateBy      
 FROM tblParent tp     
 LEFT JOIN tblCountryMaster ftc    
  ON ftc.CountryId = tp.FatherNationalityId    
 LEFT JOIN tblCountryMaster mtc    
  ON mtc.CountryId = tp.MotherNationalityId    
 WHERE tp.ParentId = CASE WHEN @ParentId > 0 THEN @ParentId ELSE tp.ParentId END    
  --AND (tp.ParentCode LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tp.ParentCode END + '%'    
  -- OR tp.FatherName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tp.FatherName END + '%'    
  -- OR tp.FatherArabicName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tp.FatherArabicName END + '%'    
  -- OR ftc.CountryName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE ftc.CountryName END + '%'    
  -- OR tp.FatherMobile LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tp.FatherMobile END + '%'    
  -- OR tp.FatherEmail LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tp.FatherEmail END + '%'    
  -- OR tp.MotherName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tp.MotherName END + '%'    
  -- OR mtc.CountryName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE mtc.CountryName END + '%'    
  -- OR tp.MotherMobile LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tp.MotherMobile END + '%'    
  -- OR tp.MotherEmail LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tp.MotherEmail END + '%'    
  --)    
  AND tp.IsActive =  CASE WHEN  @ParentId > 0 THEN tp.IsActive ELSE @FilterIsActive  END    
  --AND (tp.FatherNationalityId = CASE WHEN @FilterNationalityId > 0 THEN @FilterNationalityId ELSE tp.FatherNationalityId END    
  --OR tp.MotherNationalityId = CASE WHEN @FilterNationalityId > 0 THEN @FilterNationalityId ELSE tp.MotherNationalityId END)    
  AND tp.IsDeleted =  0    
 ORDER BY tp.ParentCode    
 IF @ParentId>0    
 BEGIN    
 SELECT     
  stu.StudentId    
  ,stu.StudentCode    
  ,stu.StudentImage    
  ,stu.ParentId    
  ,tp.ParentCode    
  ,stu.StudentName    
  ,stu.StudentArabicName    
  ,stu.StudentEmail    
  ,stu.DOB    
  ,stu.IqamaNo    
  ,stu.NationalityId    
  ,tc.CountryName    
  ,stu.GenderId    
  ,tgt.GenderTypeName    
  ,stu.AdmissionDate    
  ,stu.CostCenterId    
  ,tcc.CostCenterName    
  ,stu.GradeId    
  ,tg.GradeName    
  ,stu.SectionId    
  ,ts.SectionName    
  ,stu.PassportNo    
  ,stu.PassportExpiry    
  ,stu.Mobile    
  ,stu.StudentAddress    
  ,stu.StudentStatusId    
  ,tss.StatusName    
 ,Fees=isnull(stu.Fees  ,0)    
  ,stu.IsGPIntegration    
  ,stu.WithdrawDate    
  ,WithdrawAt=isnull(stu.WithdrawAt ,0)    
  ,tt1.TermName AS WithdrawAtTermName    
  ,stu.WithdrawYear    
 ,TermId=isnull(stu.TermId  ,0)    
  ,tt.TermName    
  ,stu.AdmissionYear    
   ,PrinceAccount=isnull(stu.PrinceAccount  ,0)    
  ,stu.IsActive     
 FROM tblStudent stu     
 INNER JOIN tblParent tp    
  ON tp.ParentId = stu.ParentId    
 INNER JOIN tblCountryMaster tc    
  ON tc.CountryId = stu.NationalityId    
 INNER JOIN tblGenderTypeMaster tgt    
  ON tgt.GenderTypeId = stu.GenderId    
 LEFT JOIN tblCostCenterMaster tcc    
  ON tcc.CostCenterId = stu.CostCenterId    
 LEFT JOIN tblGradeMaster tg    
  ON tg.GradeId = stu.GradeId    
 LEFT JOIN tblSection ts    
  ON ts.SectionId = stu.SectionId    
 LEFT JOIN tblStudentStatus tss    
  ON tss.StudentStatusId = stu.StudentStatusId    
 LEFT JOIN tblTermMaster tt    
  ON tt.TermId=stu.TermId    
 LEFT JOIN tblTermMaster tt1    
  ON tt1.TermId=stu.WithdrawAt    
 WHERE stu.ParentId=@ParentId     
  AND stu.IsDeleted =  0 AND stu.IsActive = 1    
 ORDER BY stu.StudentName    
 END    
 IF @ParentId>0    
 BEGIN    
 SELECT     
  tpa.ParentId    
  ,tpa.ReceivableAccount    
  ,tpa.AdvanceAccount      
 FROM tblParentAccount tpa      
 WHERE tpa.ParentId=@ParentId     
  AND tpa.IsDeleted =  0 AND tpa.IsActive = 1    
 END    
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetParentById]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetParentById]
@ParentId bigint
as
begin
select * from tblParent where ParentId = @ParentId
end
GO
/****** Object:  StoredProcedure [dbo].[sp_GetParentLookup]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetParentLookup]  
	@LookupParentId NVarChar(200)=null,
	@LookupFatherName NVarChar(400)=null,
	@LookupFatherArabic NVarChar(400)=null,
	@LookupFatherMobileNumber NVarChar(100)=null,
	@LookupFatherIqamaNumber NVarChar(400)=null
AS  
BEGIN  
 SET NOCOUNT ON; 
 SELECT tp.ParentId
		,tp.ParentCode
		,tp.FatherName
		,tp.FatherArabicName
		,tp.FatherIqamaNo
		,tp.IsFatherStaff	
		,tp.FatherMobile
	FROM tblParent tp		
	WHERE  tp.ParentCode LIKE '%'+ CASE WHEN len(@LookupParentId) > 0 THEN @LookupParentId ELSE tp.ParentCode END + '%'
		AND tp.FatherName LIKE '%'+ CASE WHEN len(@LookupFatherName) > 0 THEN @LookupFatherName ELSE tp.FatherName END + '%'
		AND ISNULL(tp.FatherArabicName,0) LIKE '%'+ CASE WHEN len(@LookupFatherArabic) > 0 THEN @LookupFatherArabic ELSE ISNULL(tp.FatherArabicName,0) END + '%'
		AND ISNULL(tp.FatherMobile,0) LIKE '%'+ CASE WHEN len(@LookupFatherMobileNumber) > 0 THEN @LookupFatherMobileNumber ELSE ISNULL(tp.FatherMobile,0) END + '%'
		AND ISNULL(tp.FatherIqamaNo,0) LIKE '%'+ CASE WHEN len(@LookupFatherIqamaNumber) > 0 THEN @LookupFatherIqamaNumber ELSE ISNULL(tp.FatherIqamaNo,0) END + '%'		
		AND tp.IsActive =  1		
		AND tp.IsDeleted =  0
	ORDER BY tp.ParentCode
END

GO
/****** Object:  StoredProcedure [dbo].[sp_GetPaymentMethod]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[sp_GetPaymentMethod]
@PaymentMethodId bigint = 0
AS
BEGIN
	SET NOCOUNT ON;	
	Select PaymentMethodId, tpm.PaymentMethodCategoryId ,tpmc.CategoryName, PaymentMethodName, DebitAccount, CreditAccount, tpm.IsActive
	from tblPaymentMethod as tpm
	Join tblPaymentMethodCategory as tpmc on tpm.PaymentMethodCategoryId = tpmc.PaymentMethodCategoryId 
	WHERE PaymentMethodId = CASE WHEN @PaymentMethodId > 0 THEN @PaymentMethodId ELSE PaymentMethodId END
	END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetPaymentMethodCategory]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[sp_GetPaymentMethodCategory]
@PaymentMethodCategoryId bigint = 0
AS
BEGIN
	SET NOCOUNT ON;	
	Select PaymentMethodCategoryId, CategoryName, IsActive
	from tblPaymentMethodCategory
	WHERE PaymentMethodCategoryId = CASE WHEN @PaymentMethodCategoryId > 0 THEN @PaymentMethodCategoryId ELSE PaymentMethodCategoryId END
	END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetReturnInvoice]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetReturnInvoice]        
	@InvoiceId int = 0        
AS        
BEGIN        
	SET NOCOUNT ON;         
	SELECT tis.InvoiceId
		,tis.InvoiceNo
		,tis.[Status]
		,tis.ParentID
		,tis.PublishedBy
		,tis.InvoiceDate
		,tis.CreditNo
		,tis.CreditReason
		,tis.CustomerName
		,tis.UpdateDate
		,tis.UpdateBy
	FROM INV_InvoiceSummary tis          
	WHERE tis.InvoiceId = CASE WHEN @InvoiceId > 0 THEN @InvoiceId ELSE tis.InvoiceId END         
		AND tis.IsDeleted = 0        
	ORDER BY tis.InvoiceId        
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSchool]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetSchool]
	@SchoolId bigint = 0,
	@FilterSearch NVarChar(200)=null,
	@FilterIsActive bit=1
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT TOP 1 tsm.SchoolId
		,tsm.SchoolNameEnglish
		,tsm.SchoolNameArabic
		,tsm.BranchId
		,tb.BranchName
		,tsm.CountryId
		,tc.CountryName
		,tsm.City
		,tsm.[Address]
		,tsm.Telephone
		,tsm.SchoolEmail
		,tsm.WebsiteUrl
		,tsm.VatNo
		,tsm.Logo
		,tsm.IsActive
	FROM tblSchoolMaster tsm	
	INNER JOIN tblBranchMaster tb
		ON tb.BranchId=tsm.BranchId
	LEFT JOIN tblCountryMaster tc
		ON tc.CountryId=tsm.CountryId
	WHERE tsm.SchoolId =CASE WHEN @SchoolId > 0 THEN @SchoolId ELSE tsm.SchoolId END		
		AND tsm.IsDeleted =  0 AND tsm.IsActive=1
	ORDER BY tsm.SchoolNameEnglish
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSchoolAcademic]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetSchoolAcademic]
	@SchoolAcademicId int = 0
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT tsa.SchoolAcademicId
			,tsa.AcademicYear
			,tsa.PeriodFrom
			,tsa.PeriodTo
			,tsa.DebitAccount
			,tsa.CreditAccount
			,tsa.IsActive
	FROM tblSchoolAcademic tsa		
	WHERE tsa.SchoolAcademicId = CASE WHEN @SchoolAcademicId> 0 THEN @SchoolAcademicId ELSE tsa.SchoolAcademicId END	
		AND tsa.IsDeleted = 0
	 ORDER BY tsa.SchoolAcademicId
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSchoolAccountInfo]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetSchoolAccountInfo]  
 @SchoolId bigint = 0,  
 @SchoolAccountIId bigint = 0  
AS  
BEGIN  
 SET NOCOUNT ON;   
 SELECT  
	tsa.SchoolAccountIId  
	,tsa.SchoolId 
	,tsa.ReceivableAccount
	,tsa.AdvanceAccount
	,tsa.CodeDescription  
	,tsa.IsActive    
 FROM tblSchoolAccountInfo tsa    
 WHERE tsa.SchoolAccountIId = CASE WHEN @SchoolAccountIId> 0 THEN @SchoolAccountIId ELSE tsa.SchoolAccountIId END   
  AND tsa.IsDeleted =  0 AND IsActive=1  
  AND  tsa.SchoolId=@SchoolId  
  ORDER BY tsa.CodeDescription  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSchoolLogoImage]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetSchoolLogoImage]
	@SchoolId bigint = 0
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT [SchoolLogoId]
		,[SchoolId]
		,[LogoName]
		,[LogoPath]
	FROM tblSchoolLogo		
	WHERE SchoolId = @SchoolId AND IsDeleted =  0 AND IsActive=1
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSchoolTermAcademic]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- *** SqlDbx Personal Edition ***
-- !!! Not licensed for commercial use beyound 90 days evaluation period !!!
-- For version limitations please check http://www.sqldbx.com/personal_edition.htm
-- Number of queries executed: 14, number of rows retrieved: 48

CREATE PROCEDURE [dbo].[sp_GetSchoolTermAcademic]  
 @SchoolTermAcademicId int = 0  
AS  
BEGIN  
 SET NOCOUNT ON;   
 SELECT tsa.SchoolTermAcademicId  
   ,tsa.SchoolAcademicId  
   ,sa.AcademicYear     
   ,tsa.TermName  
   ,tsa.StartDate   
   ,tsa.EndDate  
   ,tsa.IsApproved 
   ,tsa.IsRejected
 FROM tblSchoolTermAcademic tsa   
 INNER JOIN tblSchoolAcademic sa  
  ON sa.SchoolAcademicId=tsa.SchoolAcademicId   
 WHERE tsa.SchoolTermAcademicId = CASE WHEN @SchoolTermAcademicId> 0 THEN @SchoolTermAcademicId ELSE tsa.SchoolTermAcademicId END   
  AND tsa.IsDeleted = 0  
  ORDER BY tsa.SchoolTermAcademicId  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSections]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_GetSections]
	@SectionId int = 0,
	@FilterSearch NVarChar(200)=null,
	@FilterIsActive bit=1
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT tgs.SectionId
		,tgs.SectionName	
		,tgs.IsActive		
	FROM tblSection tgs	
	WHERE tgs.SectionId = CASE WHEN @SectionId > 0 THEN @SectionId ELSE tgs.SectionId END
		AND (tgs.SectionName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tgs.SectionName END + '%')	
		AND tgs.IsActive =  CASE WHEN  @SectionId>0 THEN tgs.IsActive ELSE @FilterIsActive  END
		AND tgs.IsDeleted =0 AND tgs.IsDeleted = 0
	ORDER BY tgs.SectionName
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetSiblingDiscount]
	@DiscountId int = 0
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT tdr.DiscountId
		,tdr.ChildrenNo
		,tdr.DiscountPercent
		,tdr.IsActive
		,tdr.IsDeleted
	FROM tblSiblingDiscountMaster tdr		
	WHERE tdr.DiscountId = CASE WHEN @DiscountId > 0 THEN @DiscountId ELSE tdr.DiscountId END
		AND tdr.IsDeleted =  0 AND tdr.IsActive=1
	ORDER BY tdr.ChildrenNo
END

GO
/****** Object:  StoredProcedure [dbo].[sp_GetSiblingDiscountDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetSiblingDiscountDetail]
    @StudentId bigint
AS
BEGIN
    SELECT
		tsdd.StudentSiblingDiscountDetailId
		,tsdd.StudentId
		,ts.StudentName
		,tsdd.AcademicYearId
		,tsa.AcademicYear
		,tsdd.GradeId
		,tgm.GradeName
		,tsdd.DiscountPercent
		,tsdd.DiscountStatus
    FROM 
        tblStudentSiblingDiscountDetail AS tsdd
    JOIN 
        tblGradeMaster AS tgm ON tsdd.GradeId = tgm.GradeId
    JOIN 
        tblSchoolAcademic AS tsa ON tsdd.AcademicYearId = tsa.SchoolAcademicId
    JOIN 
        tblStudent AS ts ON tsdd.StudentId = ts.StudentId
    WHERE 
        tsdd.StudentId = @StudentId
		AND tsdd.IsActive=1 AND tsdd.IsDeleted=0 AND tsdd.DiscountStatus<>0
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetSiblingDiscountDetailForCancle]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_GetSiblingDiscountDetailForCancle 2008
CREATE PROCEDURE [dbo].[sp_GetSiblingDiscountDetailForCancle]
    @AcademicYearId int
AS
BEGIN
	SELECT
		tsdd.StudentSiblingDiscountDetailId,
		tsdd.StudentId,
		ts.StudentName,
		tsdd.AcademicYearId,
		tsa.AcademicYear,
		tsdd.GradeId,
		tgm.GradeName,
		tsdd.DiscountPercent,
		tsdd.DiscountStatus
		--,SUM(fuc.FeeAmount) AS TotalFeeAmount
		--,SUM(fuc.PaidAmount) AS TotalPaidAmount
	FROM 
		tblStudentSiblingDiscountDetail AS tsdd
	JOIN 
		tblGradeMaster AS tgm ON tsdd.GradeId = tgm.GradeId
	JOIN 
		tblSchoolAcademic AS tsa ON tsdd.AcademicYearId = tsa.SchoolAcademicId
	JOIN 
		tblStudent AS ts ON tsdd.StudentId = ts.StudentId
	CROSS APPLY 
		uf_ReportStudentStatement(@AcademicYearId, 0, tsdd.StudentId) AS fuc
	WHERE 
		tsdd.AcademicYearId = @AcademicYearId
		AND tsdd.IsActive = 1
		AND tsdd.IsDeleted = 0
		--AND tsdd.DiscountStatus <> 0
		AND tsdd.DiscountStatus IN (3, 5, 7)
	GROUP BY 
		tsdd.StudentSiblingDiscountDetailId,
		tsdd.StudentId,
		ts.StudentName,
		tsdd.AcademicYearId,
		tsa.AcademicYear,
		tsdd.GradeId,
		tgm.GradeName,
		tsdd.DiscountPercent,
		tsdd.DiscountStatus
	HAVING 
		SUM(ISNULL(fuc.FeeAmount,0)) > SUM(ISNULL(fuc.PaidAmount,0))
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudent]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_GetStudent]      
	@StudentId bigint = 0,      
	@FilterSearch NVarChar(200)=null,      
	@FilterIsActive bit=1,      
	@FilterStatusId int=1,      
	@FilterNationalityId int= 0 ,      
	@FilterGenderId int= 0 ,      
	@FilterGradeId int= 0 ,      
	@FilterCostCenterId int= 0 ,      
	@FilterSectionId int= 0 ,      
	@FilterTermId int= 0  
	,@FilterEmail NvarChar(200)=null 
	,@FilterMobileNumber nvarchar(20) = null
AS      
BEGIN      
	SET NOCOUNT ON;       
	select * from vw_Student stu
	WHERE stu.StudentId= CASE WHEN @StudentId > 0 THEN @StudentId ELSE stu.StudentId END      
		
		--And stu.StudentEmail = CASE WHEN len(@FilterEmail) > 0 THEN @FilterEmail ELSE stu.StudentEmail End
		--And stu.Mobile = CASE WHEN len(@FilterMobileNumber) > 0 THEN @FilterMobileNumber End
		AND stu.IsActive =  CASE WHEN  @StudentId > 0 THEN stu.IsActive ELSE @FilterIsActive  END      
		AND stu.StudentStatusId = CASE WHEN @FilterStatusId > 0 THEN @FilterStatusId ELSE stu.StudentStatusId END     
		AND stu.NationalityId = CASE WHEN @FilterNationalityId > 0 THEN @FilterNationalityId ELSE stu.NationalityId END    
		AND stu.GenderId = CASE WHEN @FilterGenderId > 0 THEN @FilterGenderId ELSE stu.GenderId END    
		AND stu.GradeId = CASE WHEN @FilterGradeId > 0 THEN @FilterGradeId ELSE stu.GradeId END    
		AND stu.CostCenterId = CASE WHEN @FilterCostCenterId > 0 THEN @FilterCostCenterId ELSE stu.CostCenterId END    
		AND stu.SectionId = CASE WHEN @FilterSectionId > 0 THEN @FilterSectionId ELSE stu.SectionId END    
		AND stu.TermId = CASE WHEN @FilterTermId > 0 THEN @FilterTermId ELSE stu.TermId END     
		AND stu.IsDeleted =  0 
		AND stu.IsActive = 1
		
		AND 
		(
			stu.StudentName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE stu.StudentName END + '%'      
			OR ISNULL(stu.StudentArabicName,'') LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE ISNULL(stu.StudentArabicName,'') END + '%'  
			OR stu.IqamaNo LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE stu.IqamaNo END + '%' 
			OR stu.StudentEmail LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE stu.StudentEmail END + '%' 
			OR stu.Mobile LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE stu.Mobile END + '%' 

			----parent search
			OR ISNULL(stu.ParentCode,'') LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE ISNULL(stu.ParentCode,'') END + '%'  
			OR stu.FatherName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE stu.FatherName END + '%' 
			OR stu.FatherArabicName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE stu.FatherArabicName END + '%' 
			OR stu.FatherMobile LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE stu.FatherMobile END + '%' 
			OR stu.FatherEmail LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE stu.FatherEmail END + '%' 
			OR stu.FatherIqamaNo LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE stu.FatherIqamaNo END + '%' 

			----mother search

			OR ISNULL(stu.MotherArabicName,'') LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE ISNULL(stu.MotherArabicName,'') END + '%'  
			OR stu.MotherName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE stu.MotherName END + '%' 
			OR stu.MotherMobile LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE stu.MotherMobile END + '%' 
			OR stu.MotherEmail LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE stu.MotherEmail END + '%' 
			OR stu.MotherIqamaNo LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE stu.MotherIqamaNo END + '%'
		) 

	ORDER BY cast(stu.StudentCode as bigint)
	IF @StudentId>0      
	BEGIN      
		SELECT tp.ParentId      
			,tp.ParentCode      
			,tp.ParentImage      
			,tp.FatherName      
			,tp.FatherArabicName      
			,tp.FatherMobile      
			,tp.FatherEmail      
			,tp.IsFatherStaff       
			,tp.MotherName      
			,tp.MotherArabicName      
			,tp.MotherMobile      
			,tp.MotherEmail      
			,tp.IsMotherStaff      
		FROM tblParent tp       
		INNER JOIN tblStudent stu      
			ON stu.ParentId=tp.ParentId       
		WHERE stu.StudentId = @StudentId       
			AND tp.IsActive =  1 AND tp.IsDeleted =  0  
		
		SELECT       
		stu.StudentId      
		,stu.StudentCode      
		,stu.StudentImage      
		,stu.ParentId      
		,tp.ParentCode      
		,stu.StudentName      
		,stu.StudentArabicName      
		,stu.StudentEmail      
		,stu.DOB      
		,stu.IqamaNo      
		,stu.NationalityId      
		,tc.CountryName      
		,stu.GenderId      
		,tgt.GenderTypeName      
		,stu.AdmissionDate      
		,stu.CostCenterId      
		,tcc.CostCenterName      
		,stu.GradeId      
		,tg.GradeName      
		,stu.SectionId      
		,ts.SectionName      
		,stu.PassportNo      
		,stu.PassportExpiry      
		,stu.Mobile      
		,stu.StudentAddress      
		,stu.StudentStatusId      
		,tss.StatusName      
		,Fees=isnull(stu.Fees  ,0)    
		,stu.IsGPIntegration      
		,stu.WithdrawDate      
		,WithdrawAt=isnull(stu.WithdrawAt ,0)    
		,tt1.TermName AS WithdrawAtTermName      
		,stu.WithdrawYear      
		,TermId=isnull(stu.TermId  ,0)    
		,tt.TermName      
		,stu.AdmissionYear      
		,PrinceAccount=isnull(stu.PrinceAccount  ,0)    
		,stu.IsActive       
	FROM tblStudent stu       
	LEFT JOIN tblParent tp      
		ON tp.ParentId = stu.ParentId      
	LEFT JOIN tblCountryMaster tc      
		ON tc.CountryId = stu.NationalityId      
	LEFT JOIN tblGenderTypeMaster tgt      
		ON tgt.GenderTypeId = stu.GenderId      
	LEFT JOIN tblCostCenterMaster tcc      
		ON tcc.CostCenterId = stu.CostCenterId      
	LEFT JOIN tblGradeMaster tg      
		ON tg.GradeId = stu.GradeId      
	LEFT JOIN tblSection ts      
		ON ts.SectionId = stu.SectionId      
	LEFT JOIN tblStudentStatus tss      
		ON tss.StudentStatusId = stu.StudentStatusId      
	LEFT JOIN tblTermMaster tt      
		ON tt.TermId=stu.TermId      
	LEFT JOIN tblTermMaster tt1      
		ON tt1.TermId=stu.WithdrawAt      
	WHERE stu.ParentId= (SELECT stu1.ParentId FROM tblStudent stu1 WHERE stu1.StudentId=@StudentId)
		AND stu.StudentId<>@StudentId
		AND stu.IsDeleted =  0 AND stu.IsActive = 1  
	ORDER BY cast(stu.StudentCode as bigint)

	END      
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudentById]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
  
CREATE proc [dbo].[sp_GetStudentById]  
@StudentId bigint  
as  
begin  
select * from tblStudent where StudentId = @StudentId  
end
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudentByParentId]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetStudentByParentId]
@ParentId bigint
as
begin
select * from tblStudent where ParentId = @ParentId
end
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudentFeeDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetStudentFeeDetail]  
 @StudentId INT
 ,@StudentFeeDetailId INT=0
AS  
BEGIN  
	SET NOCOUNT ON;   
	SELECT tsfd.StudentFeeDetailId  
		,tsfd.AcademicYearId  
		,tsfd.StudentId  
		,tsfd.GradeId  
		,tsfd.FeeTypeId  
		,ftd.FeeTypeName
		,tsfd.FeeAmount  
		,tsfd.IsActive  
		,tgm.GradeName
		,aca.AcademicYear
	FROM tblStudentFeeDetail tsfd   
	INNER JOIN tblGradeMaster tgm  
		ON tsfd.GradeId=tgm.GradeId
	INNER JOIN [tblSchoolAcademic] aca 
		ON tsfd.AcademicYearId=aca.SchoolAcademicId
	INNER JOIN tblFeeTypeMaster ftd 
		ON ftd.FeeTypeId=tsfd.FeeTypeId
	WHERE tsfd.StudentId = @StudentId
		AND tsfd.IsDeleted = 0  
		AND tsfd.StudentFeeDetailId = CASE WHEN @StudentFeeDetailId>0 THEN @StudentFeeDetailId ELSE tsfd.StudentFeeDetailId END
	ORDER BY tsfd.StudentFeeDetailId  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudentFeeTypeAmount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetStudentFeeTypeAmount] 
	 @StudentId bigint
	,@GradeId bigint
	,@FeeTypeId bigint
	,@AcademicYearId bigint 
AS  
BEGIN  
	SET NOCOUNT ON; 
	DECLARE @IsStaff bit
	SELECT @IsStaff=CASE WHEN tp.IsFatherStaff=1 THEN 1 WHEN tp.IsMotherStaff=1 THEN 1 ELSE 0 END FROM tblStudent st
	INNER JOIN tblParent tp
		ON st.ParentId=tp.ParentId
	WHERE st.StudentId=@StudentId
	
	SELECT CASE WHEN @IsStaff=0 THEN tfd.TermFeeAmount ELSE tfd.StaffFeeAmount END AS FeeAmount
	FROM tblFeeTypeDetail tfd  
	WHERE tfd.FeeTypeId=@FeeTypeId AND tfd.AcademicYearId=@AcademicYearId 
	AND ISNULL(tfd.GradeId,@GradeId)=@GradeId
	AND tfd.IsDeleted = 0  AND tfd.IsActive=1
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudentGrade]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetStudentGrade]  
	@StudentId int = 0  
AS  
BEGIN  
	SET NOCOUNT ON;   
	SELECT st.StudentId  
		,st.StudentCode
		,st.StudentName
		,st.GradeId
		,tgm.GradeName
	FROM tblStudent st   
	INNER JOIN tblGradeMaster tgm  
		ON tgm.GradeId=st.GradeId
	WHERE st.StudentId = @StudentId
		AND st.IsDeleted = 0  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStudentStatus]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetStudentStatus]
	@StudentStatusId bigint = 0,
	@FilterSearch NVarChar(200)=null,
	@FilterIsActive int=1
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT tss.StudentStatusId
		,tss.StatusName		
		,tss.IsActive		
	FROM tblStudentStatus tss		
	WHERE tss.StudentStatusId = CASE WHEN @StudentStatusId > 0 THEN @StudentStatusId ELSE tss.StudentStatusId END
		AND (tss.StatusName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tss.StatusName END + '%')
		AND tss.IsActive =  CASE WHEN  @StudentStatusId>0 THEN tss.IsActive ELSE @FilterIsActive  END
		AND tss.IsDeleted =  0
	ORDER BY tss.StatusName
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetTotalItemSubtotalsForYear]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetTotalItemSubtotalsForYear]
    @Year INT
AS
BEGIN
    SET NOCOUNT ON;

    -- Declare variables to hold the total subtotals
    DECLARE @InvoiceItemSubtotal DECIMAL(18, 2);
    DECLARE @UniformItemSubtotal DECIMAL(18, 2);
    DECLARE @TotalItemSubtotal DECIMAL(18, 2);
    DECLARE @ReturnInvoiceSubtotal DECIMAL(18, 2);

    -- Calculate the total item subtotal from tblInvoiceDetail for the specified year
    SELECT @InvoiceItemSubtotal = SUM(d.ItemSubtotal)
    FROM dbo.tblInvoiceDetail d
    JOIN dbo.tblInvoiceSummary s ON d.InvoiceNo = s.InvoiceNo
    WHERE YEAR(s.InvoiceDate) = @Year;

    -- Calculate the total item subtotal from tblUniformDetails for the specified year
    SELECT @UniformItemSubtotal = SUM(CAST(u.ItemSubtotal AS DECIMAL(18, 2)))
    FROM dbo.tblUniformDetails u
    JOIN dbo.tblInvoiceSummary s ON u.InvoiceNo = s.InvoiceNo
    WHERE YEAR(s.InvoiceDate) = @Year;

	-- Calculate the total item subtotal from tblInvoiceDetail for invoices of type 'Return' within the specified year
    SELECT @ReturnInvoiceSubtotal = SUM(d.ItemSubtotal)
    FROM dbo.tblInvoiceDetail d
    JOIN dbo.tblInvoiceSummary s ON d.InvoiceNo = s.InvoiceNo
    WHERE YEAR(s.InvoiceDate) = @Year
      AND d.InvoiceType = 'Return';


    -- Calculate the total of both subtotals
    SET @TotalItemSubtotal = @InvoiceItemSubtotal + @UniformItemSubtotal;

  

    -- Return the results
    SELECT
        @Year AS [Year],
        --@InvoiceItemSubtotal AS [TotalInvoiceItemSubtotal],
        --@UniformItemSubtotal AS [TotalUniformItemSubtotal],
        SUM(@TotalItemSubtotal) AS [TotalItemSubtotalWithinYear],
	   ISNULL(@ReturnInvoiceSubtotal, 0) AS [TotalReturnInvoiceSubtotal];
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetUsers]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetUsers]
	@UserId int = 0,
	@FilterSearch NVarChar(200)=null,
	@FilterRoleId int=0,
	@FilterIsActive bit=1
AS
BEGIN
	SET NOCOUNT ON;	
	SELECT tu.UserId
		,tu.UserName
		,tu.UserArabicName
		,tu.UserEmail
		,tu.UserPhone
		,tu.UserPass
		,tu.RoleId
		,trl.RoleName
		,tu.ProfileImg				
		,tu.IsActive	
		,IsApprover=isnull(tu.IsApprover,0)
	FROM tblUser tu
	INNER JOIN tblRole trl
		ON trl.RoleId = tu.RoleId	
	WHERE tu.UserId = CASE WHEN @UserId > 0 THEN @UserId ELSE tu.UserId END
		AND (tu.UserName LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tu.UserName END + '%'
		OR tu.UserEmail LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tu.UserEmail END + '%'
		OR tu.UserPhone LIKE '%'+ CASE WHEN len(@FilterSearch) > 0 THEN @FilterSearch ELSE tu.UserPhone END + '%')
		AND tu.RoleId = CASE WHEN @FilterRoleId > 0 THEN @FilterRoleId ELSE tu.RoleId END
		AND tu.IsActive =  CASE WHEN @UserId>0 THEN tu.IsActive ELSE @FilterIsActive  END
		AND tu.IsDeleted =0 AND trl.IsDeleted = 0
	ORDER BY tu.UserName
END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetVat]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetVat]  
 @VatId bigint = 0  
AS  
BEGIN  
 SET NOCOUNT ON;   
 SELECT tvm.VatId  
	,tvm.FeeTypeId  
	,tft.FeeTypeName  
	,tvm.VatTaxPercent  
	,isnull(tvm.DebitAccount,'') as DebitAccount
	,isnull(tvm.CreditAccount,'') as CreditAccount
	,tvm.IsActive
	,CountryExcludeCount=(select isnull(count(VatCountryMapId),0) from [dbo].[tblVatCountryExclusionMap] t where  t.IsActive=1 and  t.IsDeleted=0 and t.VatId=tvm.VatId)
 FROM tblVatMaster tvm   
 INNER JOIN tblFeeTypeMaster tft  
  ON tvm.FeeTypeId=tft.FeeTypeId  
 WHERE tvm.VatId = CASE WHEN @VatId > 0 THEN @VatId ELSE tvm.VatId END  
  AND tvm.IsDeleted =  0 AND tvm.IsActive=1  
  ORDER BY tvm.VatTaxPercent  
END
GO
/****** Object:  StoredProcedure [dbo].[SP_GetVATDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
----select * from tblVatCountryExclusionMap where IsDeleted=0 and IsActive=1
--select * from tblVatMaster
--exec [SP_GetVATDetail] 'unifo',196

CREATE proc [dbo].[SP_GetVATDetail]  
 @InvoiceTypeName nvarchar(50),  
 @NationalityId int=0  
as  
begin  
  
 declare @VatPercent decimal(18,2)=0;  
 select   
 top 1   
  fd.VatId  
  ,fd.FeeTypeId    
  ,fd.IsActive  
  ,fd.IsDeleted  
  ,fd.UpdateDate  
  ,fd.UpdateBy  
  ,fd.DebitAccount  
  ,fd.CreditAccount  
  ,ISNULL(VatTaxPercent,0)VatTaxPercent   
 into #tempVat  
 from [dbo].[tblFeeTypeMaster] fm  
 left join [dbo].[tblVatMaster] fd on fm.FeeTypeId=fd.FeeTypeId  
 where fm.FeeTypeId=1 OR fm.FeeTypeName like '%'+@InvoiceTypeName+'%'  
 and fm.IsActive=1 and fm.IsDeleted=0  
 and fd.IsActive=1 and fd.IsDeleted=0   
order by VatId desc
   
 if exists(select VatId from tblVatCountryExclusionMap where VatId in (select vatid from #tempVat) and CountryId=@NationalityId  
 and IsDeleted=0 and IsActive=1)  
 begin  
  set @VatPercent=0  
 end  
 else  
 begin  
  select @VatPercent=VatTaxPercent from #tempVat  
 end  
   
 select   
  fd.VatId  
  ,fd.FeeTypeId    
  ,fd.IsActive  
  ,fd.IsDeleted  
  ,fd.UpdateDate  
  ,fd.UpdateBy  
  ,fd.DebitAccount  
  ,fd.CreditAccount  
  ,ISNULL(@VatPercent,0)VatTaxPercent   
 from #tempVat fd  
  
 drop table #tempVat  
end  
GO
/****** Object:  StoredProcedure [dbo].[sp_GetVatExemptedNation]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetVatExemptedNation]	@VatId bigintASBEGIN	SET NOCOUNT ON;	SELECT @VatId AS VatId	SELECT tcm.CountryId		,tcm.CountryName	FROM tblCountryMaster tcm	INNER JOIN tblVatCountryExclusionMap tvc		ON tvc.CountryId = tcm.CountryId	INNER JOIN tblVatMaster tv		ON tv.VatId = tvc.VatId	WHERE tcm.IsActive = 1 AND tcm.IsDeleted = 0		AND tvc.IsActive = 1 AND tvc.IsDeleted = 0		AND tv.VatId = @VatId		AND tv.IsActive = 1 AND tv.IsDeleted = 0	ORDER BY tcm.CountryName	SELECT tcm.CountryId		,tcm.CountryName	FROM tblCountryMaster tcm	WHERE tcm.IsActive = 1 AND tcm.IsDeleted = 0							AND tcm.CountryId NOT IN(SELECT tcm1.CountryId	FROM tblCountryMaster tcm1	INNER JOIN tblVatCountryExclusionMap tvc1		ON tvc1.CountryId = tcm1.CountryId	INNER JOIN tblVatMaster tv1		ON tv1.VatId = tvc1.VatId	WHERE tcm1.IsActive = 1 AND tcm1.IsDeleted = 0		AND tvc1.IsActive = 1 AND tvc1.IsDeleted = 0		AND tvc1.VatId = @VatId		AND tv1.IsActive = 1 AND tv1.IsDeleted = 0)	ORDER BY tcm.CountryNameEND
GO
/****** Object:  StoredProcedure [dbo].[SP_ItemCodeRecords]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec [SP_ItemCodeRecords]     'two'  
CREATE PROCEDURE [dbo].[SP_ItemCodeRecords]       
 @UniformDB nvarchar(100)    
as        
begin        
    
 DECLARE @Query nvarchar(max)    
 --DECLARE @ParmDefinition NVARCHAR(500);    
    
 --/* Build the SQL string once */    
 --SET @Query = N'select ltrim(rtrim(ITEMNMBR)) as ItemCode,      
 -- isnull(nullif(ltrim(rtrim(LOCNCODE)),''''),ltrim(rtrim(ITEMNMBR))) as ItemCodeDescription      
 -- from '+@UniformDB+'.[dbo].IV00102 where LOCNCODE=''''' ;    
 ----SET @ParmDefinition = N'@UniformDBinput nvarchar(500)';    
 --/* Execute the string with the first parameter value. */    
  
   --Production   
   SET @Query = N'select ltrim(rtrim(ITEMNMBR)) as ItemCode,      
  isnull(nullif(ltrim(rtrim(ITEMDESC)),''''),ltrim(rtrim(ITEMNMBR))) as ItemCodeDescription      
   ,isnull(nullif(ltrim(rtrim(ITEMDESC)),''''),ltrim(rtrim(ITEMNMBR))) as Description  
  from '+@UniformDB+'.[dbo].IV00101 where LOCNCODE=''''' ;    
                                                                                         
  --select * from two.dbo.IV00101  
 EXECUTE sp_executesql @Query;   
    
end   
GO
/****** Object:  StoredProcedure [dbo].[SP_MonthlyStatementParentStudent]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_MonthlyStatementParentStudent]
(
 @parentId int=0
 ,@parentName nvarchar(100)=null
 ,@StudentId int=0
 ,@StudentName nvarchar(100)=null
 ,@AcademicYearId int=0
 ,@PaymentType nvarchar(100)=null
 ,@StartDate datetime=null
 ,@EndDate datetime=null
)
as
begin
	---student /parent monthly collection
	--declare @parentId int
	--declare @parentName nvarchar(100)
	--declare @StudentId int
	--declare @StudentName nvarchar(100)
	--declare @AcademicYearId int
	--declare @PaymentType nvarchar(100)
	--declare @StartDate datetime=null
	--declare @EndDate datetime=null

	set @parentName='%'+@parentName+'%'
	set @StudentName='%'+@StudentName+'%'

	select 
	ParentId	,ParentName	,NameMonth	,NameYear ,TaxableAmount=sum(TaxableAmount)	,TaxAmount	=sum(TaxAmount),ItemSubtotal	=sum(ItemSubtotal)
	from
	(
		select 
			ParentId=isnull(invDet.ParentId,0)
			,ParentName=isnull(invDet.ParentName,'')
			,invDet.TaxableAmount	
			,invDet.TaxAmount	
			,invDet.ItemSubtotal
			,NameMonth=DATENAME(month, invSum.InvoiceDate)
			,NameYear=DATENAME(year, invSum.InvoiceDate)
		from INV_InvoiceSummary invSum
		join INV_InvoiceDetail invDet 
		on invSum.InvoiceNo=invDet.InvoiceNo
		where 
		(
			(@parentId=0 OR invDet.ParentId=@parentId)
			OR (@parentId=0 OR invDet.StudentId=@parentId)
			OR (@AcademicYearId=0 OR invDet.AcademicYear=@parentId)
			OR ((@parentName is null OR @parentName='' ) OR invDet.ParentName like @parentName)
			OR ((@StudentName is null OR @StudentName='' ) OR invDet.ParentName like @StudentName)
			--OR 
			--(
			--	(
			--		(@StartDate is null OR @StartDate='' )) OR cast(invSum.InvoiceDate as date)>= cast(@StartDate as date)
			--)
		)
	)t
	--order by ParentId	,ParentName	,NameMonth	,NameYear 
	group by ParentId	,ParentName	,NameMonth	,NameYear 


	--select DATENAME(year, getdate())

end
GO
/****** Object:  StoredProcedure [dbo].[SP_MonthlyUniformStatementParentStudent]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[SP_MonthlyUniformStatementParentStudent]
(
 @parentId int=0
 ,@parentName nvarchar(100)=null
 ,@StudentId int=0
 ,@StudentName nvarchar(100)=null
 ,@AcademicYearId int=0
 ,@PaymentType nvarchar(100)=null
 ,@StartDate datetime=null
 ,@EndDate datetime=null
)
as
begin
	---student /parent monthly collection
	--declare @parentId int
	--declare @parentName nvarchar(100)
	--declare @StudentId int
	--declare @StudentName nvarchar(100)
	--declare @AcademicYearId int
	--declare @PaymentType nvarchar(100)
	--declare @StartDate datetime=null
	--declare @EndDate datetime=null

	set @parentName='%'+@parentName+'%'
	set @StudentName='%'+@StudentName+'%'

	select 
	ParentId	,ParentName	,NameMonth	,NameYear ,TaxableAmount=sum(TaxableAmount)	,TaxAmount	=sum(TaxAmount),ItemSubtotal	=sum(ItemSubtotal)
	from
	(
		select 
			ParentId=isnull(invDet.ParentId,0)
			,ParentName=isnull(invDet.ParentName,'')
			,invDet.TaxableAmount	
			,invDet.TaxAmount	
			,invDet.ItemSubtotal
			,NameMonth=DATENAME(month, invSum.InvoiceDate)
			,NameYear=DATENAME(year, invSum.InvoiceDate)
		from INV_InvoiceSummary invSum
		join INV_InvoiceDetail invDet 
		on invSum.InvoiceNo=invDet.InvoiceNo
		where 
		invDet.InvoiceType like '%uniform%'
		and (
			(@parentId=0 OR invDet.ParentId=@parentId)
			OR (@parentId=0 OR invDet.StudentId=@parentId)
			OR (@AcademicYearId=0 OR invDet.AcademicYear=@parentId)
			OR ((@parentName is null OR @parentName='' ) OR invDet.ParentName like @parentName)
			OR ((@StudentName is null OR @StudentName='' ) OR invDet.ParentName like @StudentName)
			--OR 
			--(
			--	(
			--		(@StartDate is null OR @StartDate='' )) OR cast(invSum.InvoiceDate as date)>= cast(@StartDate as date)
			--)
		)
	)t
	--order by ParentId	,ParentName	,NameMonth	,NameYear 
	group by ParentId	,ParentName	,NameMonth	,NameYear 


	--select DATENAME(year, getdate())

end
GO
/****** Object:  StoredProcedure [dbo].[sp_ProcessGP_UniformInvoice]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE proc [dbo].[sp_ProcessGP_UniformInvoice]
(          
  @invoiceno bigint=0   ,      
  @DestinationDB nvarchar(50) = ''      
)          
AS          
BEGIN     
  BEGIN TRY     
    
	IF OBJECT_ID('tempdb..#INT_ALS_SalesInvoiceSourceTable') IS NOT NULL  
	DROP TABLE #INT_ALS_SalesInvoiceSourceTable  
  
	--Update database
	DECLARE @SourceDBName NVARCHAR(50)= 'ALS_LIVE'   
          
	-----------sales detail processing          
	declare @SOPType int=3          
	declare @DocID nvarchar(50)='STDINV'          
	declare @IntegrationStatus int=0          
          
	Declare @InvoiceTypeCount int=0          
	declare @totalPayableAmount decimal(18,4)=0          
          
	select           
		SeqNum=ROW_NUMBER() over(partition by invSum.invoiceno order by InvoiceDetailId)          
		,SOPNumber=invSum.invoiceno          
		,SOPType=@SOPType          
		,DocID=@DocID          
		,DocDate= cast(invSum.InvoiceDate as date)          
		,CustomerNumber='CASH CUSTOMER'          
		,ItemNumber=invDet.ItemCode          
		,Quantity=invDet.Quantity           
		,UnitPrice=invDet.ItemSubtotal-invDet.TaxAmount  
		,ItemSubtotal=invDet.ItemSubtotal          
		,IntegrationStatus=@IntegrationStatus          
		,Error=0          
		,invDet.InvoiceType          
	into #INT_ALS_SalesInvoiceSourceTable          
	from INV_InvoiceDetail invDet          
	join INV_InvoiceSummary invSum          
	on invDet.InvoiceNo=invSum.InvoiceNo          
	where invDet.InvoiceType like '%Uniform%'          
	and invSum.invoiceno=@invoiceno          
          
	insert into INT_SalesInvoiceSourceTable(SeqNum,SOPNumber,SOPType,DocID,DocDate,CustomerNumber,ItemNumber,Quantity,UnitPrice,IntegrationStatus,Error)          
	select           
		SeqNum,SOPNumber,SOPType,DocID,DocDate,CustomerNumber,ItemNumber,Quantity,UnitPrice,IntegrationStatus,Error          
	from #INT_ALS_SalesInvoiceSourceTable          
          
	-----------payment processing          
   
	select @InvoiceTypeCount=count(InvoiceType) from #INT_ALS_SalesInvoiceSourceTable           
	select @totalPayableAmount=sum(isnull(ItemSubtotal,0)) from #INT_ALS_SalesInvoiceSourceTable          
          
	--4 for Cash payment, 5 for Check payment & bank transfer, and 6 for Credit card payment.          
	--Bank Transfer =5          
	--Check=5          
	--Cash=4          
	--Visa=6          
            
	if(@InvoiceTypeCount>1)          
	begin          
		insert into INT_SalesPaymentSourceTable          
		(          
			SeqNum,SOPNumber,SOPType,PaymentType,PaymentAmount,CheckbookID,CardName,CheckNumber,CreditCardNumber,          
			AuthorizationCode,ExpirationDate,IntegrationStatus,Error          
		)          
		select           
			SeqNum          
			,SOPNumber          
			,SOPType          
			,PaymentType          
			,PaymentAmount   
			,CheckbookID  
			,CardName          
			,CheckNumber          
			,CreditCardNumber          
			,AuthorizationCode          
			,ExpirationDate          
			,IntegrationStatus          
			,Error          
		from           
		(          
			select top 1           
				SeqNum=1          
				,SOPNumber=invoiceno          
				,SOPType=3          
				,PaymentType=case when PaymentMethod='Cash' then 4 when PaymentMethod='Visa' then 6 else 5 end          
				,PaymentAmount=@totalPayableAmount          
				,CheckbookID=PaymentMethod  
				,CardName=''       
				,CheckNumber=PaymentReferenceNumber          
				,CreditCardNumber=null          
				,AuthorizationCode=null          
				,ExpirationDate=null          
				,IntegrationStatus=0          
				,Error=null          
			from als_live.dbo.INV_InvoicePayment          
			where invoiceno=@invoiceno          
		)t
	end          
	else          
	begin          
		insert into INT_SalesPaymentSourceTable          
		(          
			SeqNum,SOPNumber,SOPType,PaymentType,PaymentAmount,CheckbookID,CardName,CheckNumber,CreditCardNumber,          
			AuthorizationCode,ExpirationDate,IntegrationStatus,Error          
		)          
		select
			SeqNum          
			,SOPNumber          
			,SOPType          
			,PaymentType          
			,PaymentAmount  
			,CheckbookID  
			,CardName          
			,CheckNumber          
			,CreditCardNumber          
			,AuthorizationCode          
			,ExpirationDate          
			,IntegrationStatus          
			,Error          
		from           
		(          
			select          
				SeqNum=ROW_NUMBER() over(partition by invoiceno order by InvoicePaymentId asc)          
				,SOPNumber=invoiceno          
				,SOPType=3          
				,PaymentType=case when PaymentMethod='Cash' then 4 when PaymentMethod='Visa' then 6 else 5 end          
				,PaymentAmount=@totalPayableAmount          
				,CheckbookID=PaymentMethod  
				,CardName=''          
				,CheckNumber=PaymentReferenceNumber          
				,CreditCardNumber=null          
				,AuthorizationCode=null          
				,ExpirationDate=null          
				,IntegrationStatus=0          
				,Error=null          
			from INV_InvoicePayment          
			where invoiceno=@invoiceno           
		)t     
	end

	--payment information can be multiple with their debit account number and payment amount  
  
	declare @UniformDebitAccount nvarchar(50)=''  
	declare @UniformCreditAccount nvarchar(50)=''  
  
	declare @VATDebitAccount nvarchar(50)=''  
	declare @VATCreditAccount nvarchar(50)=''  
  
	select top 1  
		@VATDebitAccount=vat.DebitAccount,  
		@VATCreditAccount=vat.CreditAccount   
	from tblVatMaster vat  
	inner join tblFeeTypeMaster fee   
	on vat.FeeTypeId=fee.FeeTypeId  
	where vat.IsActive=1 and vat.IsDeleted=0  
	and FeeTypeName like '%UNIFORM%'  
  
	select top 1   
		@UniformDebitAccount=DebitAccount,  
		@UniformCreditAccount=CreditAccount   
	from tblFeeTypeMaster  
	where FeeTypeName like '%UNIFORM%'  
  
	declare @TotalTaxableAmount decimal(18,2)=0  
	declare @TotalTaxAmount decimal(18,2)=0  
	
	select 
		@TotalTaxableAmount =sum(ItemSubtotal), @TotalTaxAmount=sum(TaxAmount) 
	from INV_InvoiceDetail where invoiceno=@invoiceno    
	
	set @TotalTaxableAmount =@TotalTaxableAmount -@TotalTaxAmount -- total payment +tax +taxable amount  
  
	---Add credit side-- taxable amount with uniform credit account  
	insert into INT_SalesDistributionSourceTable  
	(
		SeqNum,SOPNumber,SOPType,DistType,AccountNumber,DebitAmount,CreditAmount,DistributionRef,IntegrationStatus,Error
	)  
	select  
		SeqNum=1 -- only 1 row will push          
		,SOPNumber=@invoiceno  
		,SOPType=3     
		,DistType=1  
		,AccountNumber=@UniformCreditAccount  
		,DebitAmount= 0  
		,CreditAmount=@TotalTaxableAmount  
		,DistributionRef='UNIFORM SALES FOR INV NO '+cast(@invoiceno as nvarchar(50))  
		,IntegrationStatus=0          
		,Error=null     
  
	---Add credit side-- VAT amount with VAT credit account  
	insert into INT_SalesDistributionSourceTable  
	(
		SeqNum,SOPNumber,SOPType,DistType,AccountNumber,DebitAmount,CreditAmount,DistributionRef,IntegrationStatus,Error
	)  
	select  
		SeqNum=2 -- only 1 row will push          
		,SOPNumber=@invoiceno  
		,SOPType=3     
		,DistType=1  
		,AccountNumber=@VATCreditAccount  
		,DebitAmount=0   
		,CreditAmount=@TotalTaxAmount  
		,DistributionRef='UNIFORM SALES FOR INV NO '+cast(@invoiceno as nvarchar(50))  
		,IntegrationStatus=0          
		,Error=null     
   
	-- Debit record will be added for payment method  
	---Add credit side-- from payment method   
	--Multiple record as per payment category  
	insert into INT_SalesDistributionSourceTable  
	(
		SeqNum,SOPNumber,SOPType,DistType,AccountNumber,DebitAmount,CreditAmount,DistributionRef,IntegrationStatus,Error
	)  
	select  
		SeqNum=ROW_NUMBER() over(partition by invoiceno order by InvoicePaymentId asc)      +2    
		,SOPNumber=invoiceno  
		,SOPType=3  
		,DistType=3  
		,AccountNumber=pm.CreditAccount  
		,DebitAmount=PaymentAmount  
		,CreditAmount=0  
		,DistributionRef='UNIFORM SALES FOR INV NO '+cast(invoiceno as nvarchar(50))  
		,IntegrationStatus=0          
		,Error=null  
	from INV_InvoicePayment tp  
	join tblPaymentMethod pm  
	on tp.PaymentMethod=pm.PaymentMethodName OR tp.PaymentMethodId=pm.PaymentMethodId  
	where invoiceno=@invoiceno  
  
	declare @FromDateRange Datetime = '01/01/1900'      
	declare @ToDateRange Datetime = '01/01/1900'          
      
	--exec INT_CreateSalesInvoiceInGP @CallFrom=1, @SourceDB='als_live',@DestDB= @DestinationDB,@FromDate = @FromDateRange ,@ToDate = @ToDateRange      
      
	select   
		@FromDateRange= InvoiceDate,  
		@ToDateRange= InvoiceDate   
	from INV_InvoiceSummary invSum          
	where invSum.invoiceno=@invoiceno  
  
	DECLARE @sql AS NVARCHAR(MAX)      
  
	/*      
	Use sp_executesql to dynamically pass in the db and stored procedure      
	to execute while also defining the values and assigning to local variables.      
	*/      
	SET @sql = N'EXEC ' + @DestinationDB + '.dbo.[INT_CreateSalesInvoiceInGP] @CallFrom , @SourceDB, @DestDB, @FromDate, @ToDate'      
	EXEC sp_executesql @sql      
	, N'@CallFrom AS INT, @SourceDB as CHAR(30), @DestDB as CHAR(30),@FromDate as Datetime ,@ToDate as Datetime  '      
	, @CallFrom = 0      
	, @SourceDB = @SourceDBName      
	, @DestDB = @DestinationDB      
	, @FromDate = @FromDateRange      
	, @ToDate = @ToDateRange      
      
	print @sql     
   
		select 0 result        
	end TRY        
	begin catch
		SELECT -1 AS Result, 'Error!' AS Response    
		EXEC usp_SaveErrorDetail    
		select* from tblErrors        
		end catch
end
GO
/****** Object:  StoredProcedure [dbo].[sp_processOpenapplyInsertFirstTime]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE proc [dbo].[sp_processOpenapplyInsertFirstTime]      
as      
begin      
      
  BEGIN TRY                
 BEGIN TRANSACTION TRANS1            
      
 insert into tblSection (SectionName,IsActive,IsDeleted,UpdateDate,UpdateBy)      
 select       
  distinct status_level,IsActive=1,IsDeleted=0,UpdateDate=getdate(),UpdateBy=1       
 from OpenApplyStudents where status_level IS NOT NULL     
 and status_level collate SQL_Latin1_General_CP1256_CI_AS not in (select SectionName from tblSection)    
  
 --Update Grade test      
 update [OpenApplyStudents]      
 set grade='KG 1'       
 where grade='KG1'       
      
 update [OpenApplyStudents]      
 set grade='KG 2'       
 where grade='KG2'      
      
 declare @SchoolId int      
 select top 1 @SchoolId =SchoolId from tblSchoolMaster where IsActive=1 and IsDeleted=0      
      
 declare       
  @StudentOpenApplyId  int      
  ,@student_id nvarchar(100)        
  ,@GenderId  int      
  ,@grade nvarchar(100)       
  ,@GradeId int      
  ,@CostCenterId int      
  ,@SectionId int      
  ,@StudentName nvarchar(100)       
  ,@StudentArabicName nvarchar(100)       
  ,@StudentEmail nvarchar(100)       
  ,@DOB datetime      
  ,@AdmissionDate datetime      
  ,@StudentAddress nvarchar(500)       
  ,@StudentStatusId int      
  ,@WithdrawDate datetime      
  ,@WithdrawYear datetime      
  ,@AdmissionYear datetime      
      
  ,@IqamaNo nvarchar(100)      
  ,@PassportNo nvarchar(100)      
  ,@PassportExpiry nvarchar(100)      
  ,@Mobile nvarchar(100)      
  ,@PrinceAccount bit      
      
  ,@country nvarchar(100)      
  ,@NationalityId bigint      
  ,@p_id_school_parent_id nvarchar(100)      
      
 SELECT      
  distinct       
   StudentOpenApplyId=os.id          
   ,student_id=os.student_id                      
   ,GenderId=case when gender='Male' then 1 else 2 end      
          
   ,os.grade      
   ,GradeId=0--isnull(gm.GradeId, 0)     --default value, updating in next query                 
   ,CostCenterId=0--isnull(gm.CostCenterId, 0)                 --default value, updating in next query      
   ,SchoolId=@SchoolId                --default value, updating in next query                 
   ,SectionId=1                 --default value, updating in next query                 
       
   ,StudentName = (ltrim(rtrim(os.first_name))+ ' '+ ltrim(rtrim(os.last_name)))                 
   ,StudentArabicName = ltrim(rtrim(os.other_name))              
   ,StudentEmail = ltrim(rtrim( isnull(os.[email],'')))              
   ,DOB =case when os.birth_date is null then  cast( '1/1/1900' as date) else  cast(os.birth_date as date)   end                      
   ,AdmissionDate =case when os.enrolled_date is null then  cast( '1/1/1900' as date) else  cast( os.enrolled_date as date) end      
   ,StudentAddress =ltrim(rtrim( isnull(os.full_address,'')))                    
   ,StudentStatusId =1              
        
   ,WithdrawDate = os.withdrawn_date                      
   ,WithdrawYear = datepart(year, cast(os.withdrawn_date as date))                      
   ,AdmissionYear = os.admitted_date                      
      
   ,IqamaNo=os.IqamaNo  --Update filed when new chnages done      
   ,PassportNo=isnull(passport_id,'')  --Update filed when new chnages done                      
   ,PassportExpiry=null  --Update filed when new chnages done                      
   ,Mobile=os.mobile_phone  --Update filed when new chnages done                      
   ,PrinceAccount=os.PrinceAccount  --Update filed when new chnages done      
        
   ,country=isnull(os.country,os.nationality)         
   ,NationalityId=0--isnull(tc.CountryId, 999999)        
   ,p_id_school_parent_id=os.p_id_school_parent_id      
   ,status_level      
   into #OpenApplyStudentsTemp      
  FROM                        
  [dbo].[OpenApplyStudents] os       
  --left join tblGradeMaster gm on (os.grade COLLATE SQL_Latin1_General_CP1_CI_AS=gm.GradeName )      
  --left join tblCountryMaster tc on os.country COLLATE SQL_Latin1_General_CP1_CI_AS=tc.CountryName        
  where os.student_id  is not null      
      
 --Update Grade Id      
 update os      
 set       
  os.GradeId=ISNULL( gm.GradeId,0)      
  ,os.CostCenterId=ISNULL( gm.CostCenterId,0)      
 from #OpenApplyStudentsTemp os      
 left join tblGradeMaster gm on (ltrim(rtrim(os.grade)) COLLATE SQL_Latin1_General_CP1_CI_AS=ltrim(rtrim(gm.GradeName)) )      
      
 update os      
 set os.NationalityId=ISNULL( tc.CountryId,0)      
 from #OpenApplyStudentsTemp os      
 left join tblCountryMaster tc on ltrim(rtrim(os.country)) COLLATE SQL_Latin1_General_CP1_CI_AS=ltrim(rtrim(tc.CountryName  ))      
      
 declare @SectionIDNew int=0      
 select top 1 @SectionIDNew=SectionId from tblSection       
      
  --If somehow record not available then update first sectionid    
 update os      
 set os.SectionId=ISNULL( tc.SectionId,@SectionIDNew)      
 from #OpenApplyStudentsTemp os      
 left join tblSection tc on ltrim(rtrim(os.status_level)) COLLATE SQL_Latin1_General_CP1_CI_AS=ltrim(rtrim(tc.SectionName  ))      
       
--update tblStudent set IsActive=0, IsDeleted=1  
--update tblParent set IsActive=0, IsDeleted=1  
  
 DECLARE cur_emp CURSOR FOR      
       
  SELECT      
  distinct       
   StudentOpenApplyId=os.StudentOpenApplyId          
   ,student_id=os.student_id                      
   ,GenderId=os.GenderId          
   ,Grade=os.grade      
   ,GradeId=os.GradeId     --default value, updating in next query                 
   ,CostCenterId=os.CostCenterId                --default value, updating in next query      
   ,SchoolId=os.SchoolId                  --default value, updating in next query                 
   ,SectionId=os.SectionId                 --default value, updating in next query                 
       
   ,StudentName = os.StudentName                   
   ,StudentArabicName = os.StudentArabicName             
   ,StudentEmail =os.StudentEmail           
   ,DOB =os.DOB      
   ,AdmissionDate =os.AdmissionDate      
   ,StudentAddress =os.StudentAddress      
   ,StudentStatusId =os.StudentStatusId             
        
   ,WithdrawDate = os.WithdrawDate                 
   ,WithdrawYear = os.WithdrawYear                     
   ,AdmissionYear =os.AdmissionYear                     
      
   ,IqamaNo=os.IqamaNo  --Update filed when new chnages done      
   ,PassportNo=os.PassportNo  --Update filed when new chnages done                      
   ,PassportExpiry=os.PassportExpiry  --Update filed when new chnages done                      
   ,Mobile=os.Mobile  --Update filed when new chnages done                      
   ,PrinceAccount=os.PrinceAccount  --Update filed when new chnages done      
        
   ,country=os.country         
   ,NationalityId=os.NationalityId        
   ,p_id_school_parent_id=os.p_id_school_parent_id      
  FROM                        
  #OpenApplyStudentsTemp os      
      
 OPEN cur_emp      
 IF @@CURSOR_ROWS > 0      
 BEGIN       
  FETCH NEXT FROM cur_emp       
        
  INTO @StudentOpenApplyId,@student_id,@GenderId,@grade,@GradeId ,@CostCenterId ,@SchoolId ,@SectionId      
    ,@StudentName,@StudentArabicName,@StudentEmail,@DOB,@AdmissionDate,@StudentAddress,@StudentStatusId      
    ,@WithdrawDate,@WithdrawYear,@AdmissionYear      
    ,@IqamaNo,@PassportNo,@PassportExpiry,@Mobile,@PrinceAccount      
    ,@country,@NationalityId,@p_id_school_parent_id      
      
  WHILE @@Fetch_status = 0      
  BEGIN      
      
  declare @ParentCode nvarchar(100)=@p_id_school_parent_id;      
    
  --------Start: student Not exists    
    
   ---parent table column      
   declare @ParentId bigint =0;      
       
   declare @ParentImage nvarchar(100)='';      
         
   declare @FatherName nvarchar(100)='';      
   declare @FatherArabicName nvarchar(100)='';      
   declare @FatherNationalityId int=0;      
   declare @FatherMobile nvarchar(100)='';      
   declare @FatherEmail nvarchar(100)='';      
   declare @IsFatherStaff bit=0;      
         
   declare @MotherName nvarchar(100)='';      
   declare @MotherArabicName nvarchar(100)='';      
   declare @MotherNationalityId int=0;      
   declare @MotherMobile nvarchar(100)='';      
   declare @MotherEmail nvarchar(100)='';      
   declare @IsMotherStaff bit=0;      
         
   declare @FatherIqamaNo nvarchar(100)=''      
   declare @MotherIqamaNo nvarchar(100)=''      
         
   declare @OpenApplyFatherId bigint=0      
   declare @OpenApplyMotherId bigint=0      
   declare @OpenApplyStudentId bigint=0    
    
   select top 1      
    @ParentImage =''      
    ,@FatherName =(ltrim(rtrim(isnull([first_name],'')))+' '+ltrim(rtrim(isnull([last_name],''))))      
    ,@FatherArabicName =isnull([other_name],'')      
    ,@FatherNationalityId =isnull(CountryId, 0)        
    ,@FatherMobile =isnull(mobile_phone,'')      
    ,@FatherEmail =ltrim(rtrim(isnull([email],'')))      
    ,@IsFatherStaff =0      
    ,@FatherIqamaNo=IqamaNo      
    ,@OpenApplyFatherId =id                          
    ,@OpenApplyStudentId=isnull(isnull(@OpenApplyStudentId,@student_id),student_id)      
   from      
   (      
    select top 1       
     ROW_NUMBER() over(partition by stuParent.id order by id desc) as FatherRowNo      
     ,stuParent.*,CountryId=isnull(tc.CountryId ,0)      
     from       
     [OpenApplyStudentParentMap] stuMap           
     inner join OpenApplyparents stuParent      
     on stumap.OpenApplyParentId=stuParent.id      
     left join tblCountryMaster tc on stuParent.nationality COLLATE SQL_Latin1_General_CP1_CI_AS=tc.CountryName        
     where stuParent.gender='Male'      
     and stuMap.OpenApplyStudentId=@StudentOpenApplyId      
   )tFather      
      
   select top 1      
    @ParentImage =''      
    ,@MotherName =(ltrim(rtrim([first_name]))+' '+ltrim(rtrim([last_name])))      
    ,@MotherArabicName =[other_name]      
    ,@MotherNationalityId =isnull(CountryId, 0)        
    ,@MotherMobile =mobile_phone      
    ,@MotherEmail =ltrim(rtrim([email]))      
    ,@IsMotherStaff =0      
    ,@MotherIqamaNo=IqamaNo      
    ,@OpenApplyMotherId =id                          
    ,@OpenApplyStudentId=isnull(isnull(@OpenApplyStudentId,@student_id),student_id)      
   from      
   (      
    select top 1       
     ROW_NUMBER() over(partition by stuParent.id order by id desc) as FatherRowNo      
     ,stuParent.*,CountryId=isnull(tc.CountryId ,0)      
     from       
     [OpenApplyStudentParentMap] stuMap       
     inner join OpenApplyparents stuParent on stumap.OpenApplyParentId=stuParent.id      
     left join tblCountryMaster tc on stuParent.nationality COLLATE SQL_Latin1_General_CP1_CI_AS=tc.CountryName        
     where stuParent.gender='Female'      
     and stuMap.OpenApplyStudentId=@StudentOpenApplyId      
   )tMother      
       
 declare @NewParentId bigint=0;      
 select top 1  @NewParentId=isnull(ParentId,0) from tblParent where ParentCode=@ParentCode          
    
 ---Insert if student not exists else update    
 if not exists(select 1 from tblStudent where StudentCode=@student_id)    
 begin    
  if not exists(select 1 from tblParent where ParentCode=@ParentCode)      
  begin      
  insert into tblParent      
  (      
   ParentCode,ParentImage,FatherName,FatherArabicName,FatherNationalityId,FatherMobile,FatherEmail,IsFatherStaff      
   ,MotherName,MotherArabicName,MotherNationalityId,MotherMobile,MotherEmail,IsMotherStaff      
   ,FatherIqamaNo,MotherIqamaNo,OpenApplyFatherId,OpenApplyMotherId,OpenApplyStudentId      
   ,IsActive,IsDeleted,UpdateDate,UpdateBy      
  )      
  select       
   @ParentCode,@ParentImage,@FatherName,@FatherArabicName,@FatherNationalityId,@FatherMobile,@FatherEmail,@IsFatherStaff      
   ,@MotherName,@MotherArabicName,@MotherNationalityId,@MotherMobile,@MotherEmail,@IsMotherStaff       
   ,@FatherIqamaNo,@MotherIqamaNo,@OpenApplyFatherId,@OpenApplyMotherId,@OpenApplyStudentId      
   ,IsActive=1,IsDeleted=0,UpdateDate=getdate(),UpdateBy=1      
      
  select @NewParentId =scope_identity();      
  end      
      
  insert into tblstudent      
 (      
  StudentCode,StudentImage,ParentId,      
  StudentName,StudentArabicName,StudentEmail,      
  DOB,IqamaNo,NationalityId,GenderId,AdmissionDate,GradeId,CostCenterId,SectionId      
  ,PassportNo,PassportExpiry,Mobile      
  ,StudentAddress,StudentStatusId,WithdrawDate      
  ,WithdrawAt,WithdrawYear      
  ,Fees,IsGPIntegration,TermId,AdmissionYear,PrinceAccount,p_id_school_parent_id      
  ,IsActive,IsDeleted,UpdateDate,UpdateBy      
 )      
 select       
  StudentCode=@student_id,StudentImage='' ,ParentId=@NewParentId      
  ,@StudentName,@StudentArabicName,@StudentEmail      
  ,@DOB,@IqamaNo,@NationalityId,@GenderId,@AdmissionDate,@GradeId ,@CostCenterId,@SectionId      
  ,@PassportNo,@PassportExpiry,@Mobile      
  ,@StudentAddress,@StudentStatusId,@WithdrawDate      
  ,WithdrawAt=null,@WithdrawYear      
  ,Fees=0,IsGPIntegration=0,TermId=1      
  ,@AdmissionYear,@PrinceAccount,@p_id_school_parent_id          
  ,IsActive=1,IsDeleted=0,UpdateDate=getdate(),UpdateBy=1      
 end    
 else  if(ltrim(rtrim(@student_id)) !='')  
 begin    
  --update student    
  update tblstudent    
  set    
   StudentImage=''     
   ----,ParentId=@NewParentId  -- parentalready available so no need to update    
   ,StudentName=@StudentName    
   ,StudentArabicName=@StudentArabicName    
   ,StudentEmail=@StudentEmail      
   ,DOB=@DOB    
   ,IqamaNo=@IqamaNo    
   ,NationalityId=@NationalityId    
   ,GenderId=@GenderId    
   ,AdmissionDate=@AdmissionDate    
   ,GradeId=@GradeId     
   ,CostCenterId=@CostCenterId    
   ,SectionId=@SectionId      
   ,PassportNo=@PassportNo    
   ,PassportExpiry=@PassportExpiry    
   ,Mobile=@Mobile      
   ,StudentAddress=@StudentAddress    
   ,StudentStatusId=@StudentStatusId    
   ,WithdrawDate=@WithdrawDate      
   ,WithdrawAt=null    
   ,WithdrawYear=@WithdrawYear      
   ,Fees=0,IsGPIntegration=0,TermId=1      
   ,AdmissionYear=@AdmissionYear    
   ,PrinceAccount=@PrinceAccount    
   ,p_id_school_parent_id=@p_id_school_parent_id          
   ,IsActive=1,IsDeleted=0,UpdateDate=getdate(),UpdateBy=1     
  where StudentCode=@student_id    
      
  update tblParent    
  set    
   ParentImage=@ParentImage    
   ,FatherName=@FatherName    
   ,FatherArabicName=@FatherArabicName    
   ,FatherNationalityId=@FatherNationalityId    
   ,FatherMobile=@FatherMobile    
   ,FatherEmail=@FatherEmail    
   ,IsFatherStaff=@IsFatherStaff    
   ,MotherName=@MotherName    
   ,MotherArabicName=@MotherArabicName    
   ,MotherNationalityId=@MotherNationalityId    
   ,MotherMobile=@MotherMobile    
   ,MotherEmail=@MotherEmail    
   ,IsMotherStaff=@IsMotherStaff    
   ,FatherIqamaNo=@FatherIqamaNo    
   ,MotherIqamaNo=@MotherIqamaNo    
   ,OpenApplyFatherId=@OpenApplyFatherId    
   ,OpenApplyMotherId=@OpenApplyMotherId    
   ,OpenApplyStudentId=@OpenApplyStudentId      
   ,IsActive=1,IsDeleted=0,UpdateDate=getdate(),UpdateBy=1    
  where ParentCode=@p_id_school_parent_id    
 end    
  --------END: Of student Not exists    
    
   FETCH NEXT FROM cur_emp INTO @StudentOpenApplyId,@student_id,@GenderId,@grade,@GradeId ,@CostCenterId ,@SchoolId ,@SectionId      
    ,@StudentName,@StudentArabicName,@StudentEmail,@DOB,@AdmissionDate,@StudentAddress,@StudentStatusId      
    ,@WithdrawDate,@WithdrawYear,@AdmissionYear      
    ,@IqamaNo,@PassportNo,@PassportExpiry,@Mobile,@PrinceAccount      
    ,@country,@NationalityId,@p_id_school_parent_id      
  END      
 END      
       
 CLOSE cur_emp;      
 DEALLOCATE cur_emp;      
  
 --Mark All student Inactive  
 update tSub  
 set tsub.IsActive=0, tsub.IsDeleted=1  
 from tblStudent tSub  
  
 update tSub  
 set tsub.IsActive=1, tsub.IsDeleted=0  
 from tblStudent tSub  
 join  
 (  
 select ROW_NUMBER() over(partition by StudentCode order by UpdateDate asc) as RowNum,  
 StudentCode, StudentId  
 from tblStudent  
 )t  
 on t.StudentCode=tSub.StudentCode and t.StudentId=tSub.StudentId   
 where t.RowNum=1  
      
   drop table #OpenApplyStudentsTemp      
      
    COMMIT TRAN TRANS1                
  SELECT 0 AS Result, 'Saved' AS Response              
  END TRY                
  BEGIN CATCH                
   ROLLBACK TRAN TRANS1                   
   SELECT -1 AS Result, 'Error!' AS Response                
   EXEC usp_SaveErrorDetail                
   RETURN                
  END CATCH                
end 
GO
/****** Object:  StoredProcedure [dbo].[sp_ProcessOpenApplyRecord]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[sp_ProcessOpenApplyRecord]    
as    
begin    
	 --1- added    
	 --2- updated     
	
	-- alter table [tblNotification] add [student_id] nvarchar(100)  
	insert into [tblNotification](RecordId,RecordStatus,IsApproved,RecordType,[UpdateDate],[UpdateBy],student_id)    
	select     
		id as RecordId,    
		case when [StudentCode] is null then 1 else 2 end RecordStatus,      
		0 as IsApproved,    
		'Student' as RecordType,    
		Getdate(),0 ,  
		student_id  
	from     
	(    
		select 
		stu.[StudentCode],
		os.id 	,
		os.[student_id]
		from [dbo].[OpenApplyStudents] os    
		left join [dbo].[tblStudent] stu    
		on os.[student_id] COLLATE SQL_Latin1_General_CP1_CI_AS=stu.[StudentCode]    
   
	AND     
	(    
		(    
			os.[name] COLLATE SQL_Latin1_General_CP1_CI_AS <>stu.[StudentName]   
			OR os.[other_name]  COLLATE SQL_Latin1_General_CP1_CI_AS <>stu.[StudentArabicName]    
			OR os.[email]  COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.[StudentEmail]    
			--OR os.[status] <>stu.[StudentStatusId]    
			--enrolled    
		)    
		OR    
		1=1    
	)   
	)t    
    
	 insert into [tblNotification](RecordId,RecordStatus,IsApproved,RecordType,[UpdateDate],[UpdateBy],student_id)    
	 select     
		id,    
		case when [ParentCode] is null then 1 else 2 end RecordStatus,  --added/updated  
		--cast(0 as bit) as    
		0 as IsApproved,    
		'Mother' as RecordType,    
		Getdate(),0 ,  
		student_id  
	from     
	(    
		select ROW_NUMBER() over(partition by   student_id,gender order by student_id) as RN,
		stu.[ParentCode],
		os.id 	,
		os.[student_id]
		from [dbo].[OpenApplyParents] os    
		left join [dbo].[tblParent] stu    
		on os.[parent_id] COLLATE SQL_Latin1_General_CP1_CI_AS=stu.[ParentCode] --need to check with record    
		and os.gender='Female'  
		AND     
		(    
			(    
				(os.[first_name]+' '+os.[last_name]) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.[FatherName]    
				OR os.[email] COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.[FatherEmail]    
			)    
			OR    
			1=1    
		)
	)t   
	where t.RN=1  
  
	 insert into [tblNotification](RecordId,RecordStatus,IsApproved,RecordType,[UpdateDate],[UpdateBy],student_id)    
	 select     
		id,    
		case when [ParentCode] is null then 1 else 2 end RecordStatus,    
		--cast(0 as bit) as    
		0 as IsApproved,    
		'Father' as RecordType,    
		Getdate(),0  ,  
		student_id  
	from     
	(    
		select ROW_NUMBER() over(partition by   student_id,gender order by student_id) as RN, 
		stu.[ParentCode],
		os.id 	,
		os.[student_id]
		from [dbo].[OpenApplyParents] os    
		left join [dbo].[tblParent] stu    
		on os.[parent_id] COLLATE SQL_Latin1_General_CP1_CI_AS=stu.[ParentCode] --need to check with record    
		and os.gender='male'  
		AND     
		(    
			(    
				(os.[first_name]+' '+os.[last_name]) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.[FatherName]    
				OR os.[email] COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.[FatherEmail]    
			)    
			OR    
			1=1    
		)
	)t   
	where t.RN=1  
  
end
GO
/****** Object:  StoredProcedure [dbo].[sp_ProcessOpenApplyRecordToNotification]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[sp_ProcessOpenApplyRecordToNotification]                    
as                    
begin                    
 --1- added                    
 --2- updated        
   
  ----DELETE previous record              
  DELETE FROM [tblNotification]           
  WHERE RecordType='Student'          
  OR RecordType='Mother'          
  OR RecordType='Father'          
              
  DELETE t              
  FROM tblNotificationGroupDetail t              
  where NotificationTypeId in   
  (  
   select NotificationTypeId from tblNotificationTypeMaster  
   WHERE ActionTable IN ('tblStudent','tblParent')              
  )    
              
  update t              
  set t.NotificationCount=0  
  FROM tblNotificationGroup t  
  where NotificationTypeId in   
  (  
   select NotificationTypeId from tblNotificationTypeMaster  
   WHERE ActionTable IN ('tblStudent','tblParent')              
  )  
  
 BEGIN TRY                  
 BEGIN TRANSACTION TRANS1                  
  --NotificationAction 1- Add, 2-Edit, 3-DELETEd       
  
 create table #ParetnInfoNoDelete  
 (  
  id bigint  
 )  
 insert into #ParetnInfoNoDelete  
 select distinct OpenApplyFatherId from vw_GetStudentOpenApplyParentInfo  
    
 insert into #ParetnInfoNoDelete  
 select distinct OpenApplyMotherId from vw_GetStudentOpenApplyParentInfo  
    
  
 --Delete unwanted parent record from table        
 delete from OpenApplyParents        
 where id not in         
 (        
 select id from #ParetnInfoNoDelete  
 )        
    
 ----Check openapply does not have record in tblstudent then we assume student has withdrawn    
    
 -----Update all student as Inactive    
 declare @StudentStatusId int=2    
 select @StudentStatusId =StudentStatusId  from tblStudentStatus where StatusName='Withdraw'    
      
 update tblStudent    
 set     
  StudentStatusId =@StudentStatusId     
  ,IsActive=0    
  ,IsDeleted=1    
 where LTRIM(RTRIM([StudentCode])) COLLATE SQL_Latin1_General_CP1256_CI_AS    
 not in (select LTRIM(RTRIM([student_id])) from [OpenApplyStudents])    
    
  INSERT INTO [tblNotification]          
  (RecordId,RecordStatus,IsApproved,RecordType,[UpdateDate],[UpdateBy],student_id,OldValueJson ,NewValueJson)                    
  select                     
   id as RecordId,                    
   case when [StudentCode] is null then 1 else 2 end RecordStatus,                      
   0 as IsApproved,                    
   'Student' as RecordType,                    
   Getdate(),              
   0 ,                  
   student_id              
   ,OldValueJson=ISNULL(OldValueJson,'')              
   ,NewValueJson=ISNULL(NewValueJson,'')              
  from                     
  (                    
   select                 
    stu.[StudentCode], os.id, os.[student_id]          
 ,LTRIM(RTRIM(ISNULL(os.[email],''))) as OSEmail        
 ,ltrim(rtrim(isnull( stu.[StudentEmail] ,''))) as StuEmail        
  ,LTRIM(RTRIM(ISNULL(os.IqamaNo,''))) as OsIqamaNo        
  ,ltrim(rtrim(isnull( stu.IqamaNo ,''))) as StuIqamaNo        
    , NewValueJson= (SELECT * FROM [OpenApplyStudents] jc where jc.[student_id] = os.[student_id] FOR JSON PATH, WITHOUT_ARRAY_WRAPPER )              
    , OldValueJson= (SELECT * FROM [tblStudent] jc where jc.[StudentCode] = stu.[StudentCode] FOR JSON PATH,WITHOUT_ARRAY_WRAPPER )              
    ,NameUpdated=CASE               
     WHEN (LTRIM(RTRIM(os.first_name))+ ' '+ ltrim(rtrim(os.last_name))) COLLATE SQL_Latin1_General_CP1256_CI_AS <>ltrim(rtrim(stu.[StudentName]     ))              
     THEN 1 ELSE 0 END          
    ,ArabicNameUpdated=CASE           
     WHEN LTRIM(RTRIM(os.[other_name])) COLLATE SQL_Latin1_General_CP1256_CI_AS <>ltrim(rtrim(stu.[StudentArabicName]   ))               
     THEN 1 ELSE 0 END          
    ,EmailUpdated=CASE           
     WHEN LTRIM(RTRIM(ISNULL(os.[email],''))) COLLATE SQL_Latin1_General_CP1256_CI_AS<>ltrim(rtrim(isnull( stu.[StudentEmail] ,'')))              
     THEN 1 ELSE 0 END          
    ,IqamaNoUpdated=CASE WHEN LTRIM(RTRIM(ISNULL(os.IqamaNo,''))) COLLATE SQL_Latin1_General_CP1256_CI_AS<>ltrim(rtrim(isnull( stu.IqamaNo ,'')))              
     THEN 1 ELSE 0 END          
   FROM [dbo].[OpenApplyStudents] os                    
   LEFT JOIN [dbo].[tblStudent] stu                    
   ON LTRIM(RTRIM(os.[student_id])) COLLATE SQL_Latin1_General_CP1256_CI_AS=LTRIM(RTRIM(stu.[StudentCode]))          
   and LTRIM(RTRIM(os.custom_id))<>''    
    and LTRIM(RTRIM(os.[student_id]))<>''    
           
  )t                
  WHERE t.NameUpdated=1 OR t.ArabicNameUpdated=1 OR t.EmailUpdated=1 OR t.IqamaNoUpdated=1            
                    
  INSERT INTO [tblNotification]          
  (RecordId,RecordStatus,IsApproved,RecordType,[UpdateDate],[UpdateBy],student_id,OldValueJson ,NewValueJson)                    
  SELECT          
   id, RecordStatus=CASE WHEN [ParentCode] IS NULL THEN 1 ELSE 2 END  --added/updated                  
   ,0 as IsApproved, 'Mother' AS RecordType, GETDATE(),0 , student_id               
   ,OldValueJson=ISNULL(OldValueJson,'')              
   ,NewValueJson=ISNULL(NewValueJson,'')              
  FROM                     
  (        
   SELECT       
    stu.[ParentCode], os.OpenApplyMotherId as id,os.StudentCode as [student_id]              
 ,ltrim(rtrim(os.MotherIqamaNo)) as OSIqamaNo        
 ,stu.MotherIqamaNo as StuIqamaNo        
    ,NameUpdated=CASE           
     WHEN os.MotherName COLLATE SQL_Latin1_General_CP1256_CI_AS<>stu.MotherName                    
     THEN 1 ELSE 0 END          
    ,EmailUpdated=CASE           
     when os.MotherEmail COLLATE SQL_Latin1_General_CP1256_CI_AS<>stu.MotherEmail                    
     THEN 1 ELSE 0 END            
    ,IqamaNoUpdated=CASE WHEN LTRIM(RTRIM(ISNULL(os.MotherIqamaNo,''))) COLLATE SQL_Latin1_General_CP1256_CI_AS<>ltrim(rtrim(isnull( stu.MotherIqamaNo ,'')))              
     THEN 1 ELSE 0 END          
    ,NewValueJson= (SELECT * FROM vw_GetStudentOpenApplyParentInfo jc where jc.[ParentCode] COLLATE SQL_Latin1_General_CP1256_CI_AS= os.[ParentCode] FOR JSON PATH, WITHOUT_ARRAY_WRAPPER )              
    ,OldValueJson= (SELECT * FROM [tblParent] jc where jc.ParentCode = stu.ParentCode FOR JSON PATH,WITHOUT_ARRAY_WRAPPER )              
   FROM [dbo].vw_GetStudentOpenApplyParentInfo os                    
   LEFT JOIN [dbo].[tblParent] stu                    
   ON os.[ParentCode] COLLATE SQL_Latin1_General_CP1256_CI_AS=stu.[ParentCode] --need to check with record                    
   --AND os.gender='Female'                  
   --AND                     
   --(        
   --  (ltrim(rtrim(os.[first_name]))+' '+ltrim(rtrim(os.[last_name]))) COLLATE SQL_Latin1_General_CP1256_CI_AS<>stu.MotherName                    
   --  OR               
   --  ltrim(rtrim(os.[email])) COLLATE SQL_Latin1_General_CP1256_CI_AS<>stu.MotherEmail              
   --  OR               
   --  ltrim(rtrim(os.IqamaNo)) COLLATE SQL_Latin1_General_CP1256_CI_AS<>stu.MotherIqamaNo              
   --)                 
  )t                   
  WHERE t.NameUpdated=1 OR t.EmailUpdated=1  OR t.IqamaNoUpdated=1              
                  
  INSERT INTO [tblNotification](RecordId,RecordStatus,IsApproved,RecordType,[UpdateDate],[UpdateBy],student_id,OldValueJson ,NewValueJson)                    
  SELECT          
   id,                    
   case when [ParentCode] is null then 1 else 2 end RecordStatus,          
   0 as IsApproved,          
   'Father' as RecordType, Getdate(), 0 ,student_id          
  ,OldValueJson=ISNULL(OldValueJson,'')              
  ,NewValueJson=ISNULL(NewValueJson,'')              
  FROM          
  (          
   SELECT          
    stu.[ParentCode], os.OpenApplyFatherId as id , os.StudentCode as [student_id]          
    ,NameUpdated=case when os.[FatherName] COLLATE SQL_Latin1_General_CP1256_CI_AS<>stu.[FatherName]                    
     then 1 else 0 end          
    ,EmailUpdated=case when os.FatherEmail COLLATE SQL_Latin1_General_CP1256_CI_AS<>stu.[FatherEmail]        
    then 1 else 0 end          
    ,IqamaNoUpdated=case when ltrim(rtrim( isnull(os.FatherIqamaNo,'')))  COLLATE SQL_Latin1_General_CP1256_CI_AS<>ltrim(rtrim(isnull( stu.FatherIqamaNo ,'')))              
    then 1 else 0 end              
 ,NewValueJson= (SELECT * FROM vw_GetStudentOpenApplyParentInfo jc where jc.[ParentCode] COLLATE SQL_Latin1_General_CP1256_CI_AS= os.[ParentCode] FOR JSON PATH, WITHOUT_ARRAY_WRAPPER )              
    , OldValueJson= (SELECT * FROM [tblParent] jc where jc.ParentCode = stu.ParentCode FOR JSON PATH,WITHOUT_ARRAY_WRAPPER )          
   FROM [dbo].vw_GetStudentOpenApplyParentInfo os                    
   LEFT JOIN [dbo].[tblParent] stu                    
   ON os.[ParentCode] COLLATE SQL_Latin1_General_CP1256_CI_AS=stu.[ParentCode] --need to check with record                                  
   --AND          
   --(        
   -- (ltrim(rtrim(os.[first_name]))+' '+ltrim(rtrim(os.[last_name]))) COLLATE SQL_Latin1_General_CP1256_CI_AS<>stu.[FatherName]                    
   -- OR ltrim(rtrim(os.[email])) COLLATE SQL_Latin1_General_CP1256_CI_AS<>stu.[FatherEmail]             
   -- OR ltrim(rtrim(os.IqamaNo)) COLLATE SQL_Latin1_General_CP1256_CI_AS<>stu.FatherIqamaNo              
   --)                 
  )t                   
  WHERE t.NameUpdated=1 OR t.EmailUpdated=1  OR t.IqamaNoUpdated=1          
  
 ----Delete from [tblNotification]-- only process   
 delete from [tblNotification]  
 where not RecordId in   
 (  
  select OpenApplyParentId from OpenApplyStudentParentMap   
  where OpenApplyStudentId in   
  (select RecordId from [tblNotification] where RecordType='Student')  
 )  
 and RecordType !='Student'  
  
 ----delete from [tblNotification]where  RecordId in   
 ----(  
 ---- select OpenApplyParentId from OpenApplyStudentParentMap   
 ---- where OpenApplyStudentId in   
 ---- (select RecordId from [tblNotification] where RecordType='Student')  
 ----)and RecordType ='Student'  
  
 ----Process final table to notification table              
  
 ----Add default master record  
 ----insert into master record : tblNotificationTypeMaster  
 IF NOT EXISTS(SELECT TOP 1 * FROM tblNotificationTypeMaster where NotificationType='OpenApplyRecordProcessing' and  ActionTable='tblStudent')              
 BEGIN               
  INSERT INTO tblNotificationTypeMaster(NotificationType ,ActionTable ,NotificationMsg ,IsActive)              
  SELECT  'OpenApplyRecordProcessing', 'tblStudent', 'Student #N record #Action' ,1              
 END  
   
 IF NOT EXISTS(SELECT TOP 1 * FROM tblNotificationTypeMaster where NotificationType='OpenApplyRecordProcessing' and  ActionTable='tblParent')              
 BEGIN               
  INSERT INTO tblNotificationTypeMaster(NotificationType ,ActionTable ,NotificationMsg ,IsActive)              
  SELECT  'OpenApplyRecordProcessing', 'tblParent', 'Parent #N record #Action' ,1              
 END   
  
 ------------------Notification group  
 DECLARE @NotificationTypeIdStudent int=0;             
   
 select top 1 @NotificationTypeIdStudent=NotificationTypeId   
 from tblNotificationTypeMaster   
 where NotificationType='OpenApplyRecordProcessing' and  ActionTable='tblStudent'  
              
 --Add count record for student  
 declare @NotificationAction int =1  
 if not exists(select top 1 * from tblNotificationGroup where NotificationTypeId=@NotificationTypeIdStudent and NotificationAction=@NotificationAction)  
 begin  
  insert into tblNotificationGroup(NotificationTypeId ,NotificationCount ,NotificationAction)              
  select   
  @NotificationTypeIdStudent as NotificationTypeId,0 as NotificationCount, NotificationAction=@NotificationAction  
 end  
  
 set @NotificationAction =2  
 if not exists(select top 1 * from tblNotificationGroup where NotificationTypeId=@NotificationTypeIdStudent and NotificationAction=@NotificationAction)  
 begin  
  insert into tblNotificationGroup(NotificationTypeId ,NotificationCount ,NotificationAction)              
  select   
  @NotificationTypeIdStudent as NotificationTypeId,0 as NotificationCount, NotificationAction=@NotificationAction  
 end  
  --------------Start: Student record    
  
  if exists(select top 1 * from tblNotificationGroup where NotificationTypeId=@NotificationTypeIdStudent)              
  begin  
 declare @NotificationCountAdd int=0  
 declare @NotificationCountUpdate int=0  
   
 declare @NotificationGroupIdAdd int=0;  
 declare @NotificationGroupIdUpdate int=0;  
  
 select @NotificationCountAdd=count(1) from [tblNotification] where RecordType='Student' and RecordStatus=1  
 select @NotificationCountUpdate=count(1) from [tblNotification] where RecordType='Student' and RecordStatus=2  
  
 select top 1 @NotificationGroupIdAdd=NotificationGroupId from tblNotificationGroup   
 where NotificationTypeId=@NotificationTypeIdStudent and NotificationAction=1              
              
 update tblNotificationGroup              
 set NotificationCount=@NotificationCountAdd              
 where  NotificationGroupId=@NotificationGroupIdAdd  
   
 select top 1 @NotificationGroupIdUpdate=NotificationGroupId from tblNotificationGroup   
 where NotificationTypeId=@NotificationTypeIdStudent and NotificationAction=2              
              
 update tblNotificationGroup              
 set NotificationCount=@NotificationCountUpdate              
 where  NotificationGroupId=@NotificationGroupIdUpdate  
  end  
    
  
  ------------parent group   
   ----   add group detail for parent  
   DECLARE @NotificationTypeIdParent int=0;             
  select top 1 @NotificationTypeIdParent=NotificationTypeId   
 from tblNotificationTypeMaster   
 where NotificationType='OpenApplyRecordProcessing' and  ActionTable='tblParent'              
              
 --Add count record for student  
 set @NotificationAction =1  
 if not exists(select top 1 * from tblNotificationGroup where NotificationTypeId=@NotificationTypeIdParent and NotificationAction=@NotificationAction)  
 begin  
  insert into tblNotificationGroup(NotificationTypeId ,NotificationCount ,NotificationAction)              
  select   
  @NotificationTypeIdParent as NotificationTypeId,0 as NotificationCount, NotificationAction=@NotificationAction  
 end  
  
 set @NotificationAction =2  
 if not exists(select top 1 * from tblNotificationGroup where NotificationTypeId=@NotificationTypeIdParent and NotificationAction=@NotificationAction)  
 begin  
  insert into tblNotificationGroup(NotificationTypeId ,NotificationCount ,NotificationAction)              
  select   
  @NotificationTypeIdParent as NotificationTypeId,0 as NotificationCount, NotificationAction=@NotificationAction  
 end  
  
 if exists(select top 1 * from tblNotificationGroup where NotificationTypeId=@NotificationTypeIdParent)              
 begin  
  declare @NotificationCountParentAdd int=0  
  declare @NotificationCountParentUpdate int=0  
   
  declare @NotificationGroupIdParentAdd int=0;  
  declare @NotificationGroupIdParentUpdate int=0;  
  
  select @NotificationCountParentAdd=count(1) from [tblNotification] where RecordType in ('Father','Mother') and RecordStatus=1  
  select @NotificationCountParentUpdate=count(1) from [tblNotification] where RecordType in ('Father','Mother') and RecordStatus=2  
  
  select top 1 @NotificationGroupIdParentAdd=NotificationGroupId from tblNotificationGroup   
  where NotificationTypeId=@NotificationTypeIdParent and NotificationAction=1              
              
  update tblNotificationGroup              
  set NotificationCount=@NotificationCountParentAdd              
  where  NotificationGroupId=@NotificationGroupIdParentAdd  
   
  select top 1 @NotificationGroupIdParentUpdate=NotificationGroupId from tblNotificationGroup   
  where NotificationTypeId=@NotificationTypeIdParent and NotificationAction=2              
              
  update tblNotificationGroup              
  set NotificationCount=@NotificationCountParentUpdate              
  where  NotificationGroupId=@NotificationGroupIdParentUpdate  
 end        
    
 declare @NotificationGroupIdStudentAddNew int  
 declare @NotificationGroupIdStudentUpdateNew int  
 declare @NotificationGroupIdParentAddNew int  
 declare @NotificationGroupIdParentUpdateNew int  
  
 select top 1 @NotificationGroupIdStudentAddNew=NotificationGroupId from tblNotificationGroup   
 where NotificationTypeId=@NotificationTypeIdStudent and NotificationAction=1   
  
 select top 1 @NotificationGroupIdStudentUpdateNew=NotificationGroupId from tblNotificationGroup   
 where NotificationTypeId=@NotificationTypeIdStudent and NotificationAction=2  
  
 select top 1 @NotificationGroupIdParentAddNew=NotificationGroupId from tblNotificationGroup   
 where NotificationTypeId=@NotificationTypeIdParent and NotificationAction=1     
  
 select top 1 @NotificationGroupIdParentUpdateNew=NotificationGroupId from tblNotificationGroup   
 where NotificationTypeId=@NotificationTypeIdParent and NotificationAction=2  
    
  --Add notification group detail for student  
  insert into tblNotificationGroupDetail(NotificationGroupId ,NotificationTypeId, NotificationAction, TableRecordId, OldValueJson, NewValueJson, CreatedBy)              
  select               
   case when RecordStatus=1 then @NotificationGroupIdStudentAddNew else @NotificationGroupIdStudentUpdateNew end   
   ,@NotificationTypeIdStudent as NotificationTypeId,RecordStatus,              
   NotificationId as TableRecordId,OldValueJson,NewValueJson,CreatedBy=1              
  from [tblNotification]              
  where RecordType='Student'  
  --------------End: Student record              
              
  --------------Start: parent record     
             
  insert into tblNotificationGroupDetail(NotificationGroupId ,NotificationTypeId, NotificationAction, TableRecordId, OldValueJson, NewValueJson, CreatedBy)              
  select               
  case when RecordStatus=1 then @NotificationGroupIdParentAddNew else @NotificationGroupIdParentUpdateNew end   
  ,@NotificationTypeIdParent as NotificationTypeId,NotificationAction=1,              
  NotificationId as TableRecordId,OldValueJson,NewValueJson,CreatedBy=1              
  from [tblNotification]              
  where RecordType<>'Student'            
               
          
  --------------End: parent record          
       
      
  COMMIT TRAN TRANS1                  
  SELECT 0 AS Result, 'Saved' AS Response                
  END TRY               
  BEGIN CATCH                  
   ROLLBACK TRAN TRANS1                     
   SELECT -1 AS Result, 'Error!' AS Response                  
   EXEC usp_SaveErrorDetail                  
   RETURN                  
  END CATCH                 
          
END 
GO
/****** Object:  StoredProcedure [dbo].[sp_ProcessOpenApplyRecordToNotification_old]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[sp_ProcessOpenApplyRecordToNotification_old]          
as          
begin          
  --1- added          
  --2- updated           
 BEGIN TRY        
   BEGIN TRANSACTION TRANS1        
   --NotificationAction 1- Add, 2-Edit, 3-deleted    
    
   ----Delete previous record    
   delete from [tblNotification]    
    
   delete t    
 from tblNotificationGroupDetail t    
 inner join tblNotificationTypeMaster  tm on t.NotificationTypeId=tm.NotificationTypeId    
 where tm.ActionTable in ('tblStudent','tblParent')    
    
    delete t    
 from tblNotificationGroup t    
 inner join tblNotificationTypeMaster  tm on t.NotificationTypeId=tm.NotificationTypeId    
 where tm.ActionTable in ('tblStudent','tblParent')    
    
 delete from tblNotificationTypeMaster  where ActionTable in ('tblStudent','tblParent')    
    
-- select * from tblNotificationTypeMaster    
--select * from tblNotificationGroup    
--select * from tblNotificationGroupDetail    
    
 -- alter table [tblNotification] add [student_id] nvarchar(100)        
  --alter table [tblNotification] add OldValueJson nvarchar(max)        
  --alter table [tblNotification] add NewValueJson nvarchar(max)        
    
 insert into [tblNotification](RecordId,RecordStatus,IsApproved,RecordType,[UpdateDate],[UpdateBy],student_id,OldValueJson ,NewValueJson)          
 select           
  id as RecordId,          
  case when [StudentCode] is null then 1 else 2 end RecordStatus,            
  0 as IsApproved,          
  'Student' as RecordType,          
  Getdate(),    
  0 ,        
  student_id    
  ,OldValueJson=ISNULL(OldValueJson,'')    
  ,NewValueJson=ISNULL(NewValueJson,'')    
 from           
 (          
  select       
   stu.[StudentCode],      
   os.id  ,      
   os.[student_id]      
    
   , NewValueJson= (SELECT * FROM [OpenApplyStudents] jc where jc.[student_id] = os.[student_id] FOR JSON PATH, WITHOUT_ARRAY_WRAPPER )    
   , OldValueJson= (SELECT * FROM [tblStudent] jc where jc.[StudentCode] = stu.[StudentCode] FOR JSON PATH,WITHOUT_ARRAY_WRAPPER )    
     
   ,case     
   when ltrim(rtrim(os.[name])) COLLATE SQL_Latin1_General_CP1_CI_AS <>ltrim(rtrim(stu.[StudentName]     ))    
   then 1 else 0 end NameUpdated    
        
   ,case when ltrim(rtrim(os.[other_name]))  COLLATE SQL_Latin1_General_CP1_CI_AS <>ltrim(rtrim(stu.[StudentArabicName]   ))     
   then 1 else 0 end  ArabicNameUpdated    
    
   ,case when ltrim(rtrim( isnull(os.[email],'')))  COLLATE SQL_Latin1_General_CP1_CI_AS<>ltrim(rtrim(isnull( stu.[StudentEmail] ,'')))    
   then 1 else 0 end  EmailUpdated    
  
   ,case when ltrim(rtrim( isnull(os.IqamaNo,'')))  COLLATE SQL_Latin1_General_CP1_CI_AS<>ltrim(rtrim(isnull( stu.IqamaNo ,'')))    
   then 1 else 0 end  IqamaNoUpdated    
    
  from [dbo].[OpenApplyStudents] os          
  left join [dbo].[tblStudent] stu          
  on os.[student_id] COLLATE SQL_Latin1_General_CP1_CI_AS=stu.[StudentCode]          
         
  AND           
  (          
   (          
    (ltrim(rtrim(os.first_name))+ ' '+ ltrim(rtrim(os.last_name))) COLLATE SQL_Latin1_General_CP1_CI_AS <>ltrim(rtrim(stu.[StudentName]     ))    
    OR ltrim(rtrim(os.[other_name]))  COLLATE SQL_Latin1_General_CP1_CI_AS <>ltrim(rtrim(stu.[StudentArabicName]   ))       
    OR ltrim(rtrim( isnull(os.[email],'')))  COLLATE SQL_Latin1_General_CP1_CI_AS<>ltrim(rtrim(isnull( stu.[StudentEmail] ,'')))  
  OR ltrim(rtrim( isnull(os.IqamaNo,'')))  COLLATE SQL_Latin1_General_CP1_CI_AS<>ltrim(rtrim(isnull( stu.IqamaNo ,'')))  
    --OR os.[status] <>stu.[StudentStatusId]          
    --enrolled          
   )          
   OR          
   1=1          
  )    
 )t      
 where t.NameUpdated=1 OR t.ArabicNameUpdated=1 OR t.EmailUpdated=1   OR t.IqamaNoUpdated=1  
          
 insert into [tblNotification](RecordId,RecordStatus,IsApproved,RecordType,[UpdateDate],[UpdateBy],student_id,OldValueJson ,NewValueJson)          
 select           
  id,          
  case when [ParentCode] is null then 1 else 2 end RecordStatus,  --added/updated        
  --cast(0 as bit) as          
  0 as IsApproved,          
  'Mother' as RecordType,          
  Getdate(),0 ,        
  student_id     
  ,OldValueJson=ISNULL(OldValueJson,'')    
  ,NewValueJson=ISNULL(NewValueJson,'')    
 from           
 (          
  select     
   ROW_NUMBER() over(partition by   student_id,gender order by student_id) as RN,      
   stu.[ParentCode],      
   os.id  ,      
   os.[student_id]      
       
   ,case when(os.[first_name]+' '+os.[last_name]) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.MotherName          
   then 1 else 0 end  NameUpdated    
        
   ,case when os.[email] COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.MotherEmail          
   then 1 else 0 end  EmailUpdated    
  
   ,case when ltrim(rtrim( isnull(os.IqamaNo,'')))  COLLATE SQL_Latin1_General_CP1_CI_AS<>ltrim(rtrim(isnull( stu.MotherIqamaNo ,'')))    
   then 1 else 0 end  IqamaNoUpdated    
       
   ,NewValueJson= (SELECT * FROM [OpenApplyParents] jc where jc.[parent_id] = os.[parent_id] FOR JSON PATH, WITHOUT_ARRAY_WRAPPER )    
   , OldValueJson= (SELECT * FROM [tblParent] jc where jc.ParentCode = stu.ParentCode FOR JSON PATH,WITHOUT_ARRAY_WRAPPER )    
     
  from [dbo].[OpenApplyParents] os          
  left join [dbo].[tblParent] stu          
  on os.[parent_id] COLLATE SQL_Latin1_General_CP1_CI_AS=stu.[ParentCode] --need to check with record          
  and os.gender='Female'        
  AND           
  (          
   (          
    (ltrim(rtrim(os.[first_name]))+' '+ltrim(rtrim(os.[last_name]))) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.MotherName          
    OR     
    ltrim(rtrim(os.[email])) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.MotherEmail    
 OR     
    ltrim(rtrim(os.IqamaNo)) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.MotherIqamaNo    
   )          
   OR          
   1=1          
  )       
 )t         
 where t.RN=1   OR t.NameUpdated=1 OR t.EmailUpdated=1  OR t.IqamaNoUpdated=1    
        
 insert into [tblNotification](RecordId,RecordStatus,IsApproved,RecordType,[UpdateDate],[UpdateBy],student_id,OldValueJson ,NewValueJson)          
 select           
  id,          
  case when [ParentCode] is null then 1 else 2 end RecordStatus,          
  --cast(0 as bit) as          
  0 as IsApproved,          
  'Father' as RecordType,          
  Getdate(),    
  0  ,        
  student_id      
  ,OldValueJson=ISNULL(OldValueJson,'')    
  ,NewValueJson=ISNULL(NewValueJson,'')    
 from           
 (          
 select     
  ROW_NUMBER() over(partition by   student_id,gender order by student_id) as RN,       
  stu.[ParentCode],      
  os.id  ,      
  os.[student_id]     
       
  ,case when(os.[first_name]+' '+os.[last_name]) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.[FatherName]          
     then 1 else 0 end  NameUpdated    
        
  ,case when os.[email] COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.[FatherEmail]          
   then 1 else 0 end  EmailUpdated   
     
   ,case when ltrim(rtrim( isnull(os.IqamaNo,'')))  COLLATE SQL_Latin1_General_CP1_CI_AS<>ltrim(rtrim(isnull( stu.FatherIqamaNo ,'')))    
   then 1 else 0 end  IqamaNoUpdated   
    
  ,NewValueJson= (SELECT * FROM [OpenApplyParents] jc where jc.[parent_id] = os.[parent_id] FOR JSON PATH, WITHOUT_ARRAY_WRAPPER )    
  , OldValueJson= (SELECT * FROM [tblParent] jc where jc.ParentCode = stu.ParentCode FOR JSON PATH,WITHOUT_ARRAY_WRAPPER )    
    
 from [dbo].[OpenApplyParents] os          
 left join [dbo].[tblParent] stu          
 on os.[parent_id] COLLATE SQL_Latin1_General_CP1_CI_AS=stu.[ParentCode] --need to check with record          
 and os.gender='male'        
 AND           
  (          
   (          
    (ltrim(rtrim(os.[first_name]))+' '+ltrim(rtrim(os.[last_name]))) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.[FatherName]          
    OR ltrim(rtrim(os.[email])) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.[FatherEmail]   
 OR     
    ltrim(rtrim(os.IqamaNo)) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.FatherIqamaNo    
   )          
   OR          
   1=1          
  )       
 )t         
 where t.RN=1   OR t.NameUpdated=1 OR t.EmailUpdated=1  OR t.IqamaNoUpdated=1       
    
    
 ---Process final table to notification table    
    
 ----insert into master record : tblNotificationTypeMaster    
 if not exists(select top 1 * from tblNotificationTypeMaster where NotificationType='OpenApplyRecordProcessing' and  ActionTable='tblStudent')    
 begin     
  insert into tblNotificationTypeMaster(NotificationType ,ActionTable ,NotificationMsg ,IsActive)    
  select  'OpenApplyRecordProcessing', 'tblStudent', 'Student #N record #Action' ,1    
 end    
    
 if not exists(select top 1 * from tblNotificationTypeMaster where NotificationType='OpenApplyRecordProcessing' and  ActionTable='tblParent')    
 begin     
  insert into tblNotificationTypeMaster(NotificationType ,ActionTable ,NotificationMsg ,IsActive)    
  select  'OpenApplyRecordProcessing', 'tblParent', 'Parent #N record #Action' ,1    
 end    
    
 declare @NotificationTypeId int=0;    
    
 --------------Start: Student record    
     
 select top 1 @NotificationTypeId=NotificationTypeId from tblNotificationTypeMaster where NotificationType='OpenApplyRecordProcessing' and  ActionTable='tblStudent'    
    
 --Added new record    
 if not exists(select top 1 * from tblNotificationGroup where NotificationTypeId=@NotificationTypeId and NotificationAction=1)    
 begin    
  insert into tblNotificationGroup(NotificationTypeId ,NotificationCount ,NotificationAction)    
  select @NotificationTypeId as NotificationTypeId,count(1) as NotificationCount, NotificationAction=1  from [tblNotification]    
  where RecordType='Student' and RecordStatus=1    
 end    
     
     
  declare @NotificationGroupId int=0;    
  select top 1 @NotificationGroupId=NotificationGroupId from tblNotificationGroup where NotificationTypeId=@NotificationTypeId and NotificationAction=1    
    
  declare @NotificationCount int=0    
  select @NotificationCount=count(1)     
  from [tblNotification]    
  where RecordType='Student' and RecordStatus=1     
    
  update tblNotificationGroup    
  set NotificationCount=@NotificationCount    
  where  NotificationGroupId=@NotificationGroupId    
      
  insert into tblNotificationGroupDetail(NotificationGroupId ,NotificationTypeId, NotificationAction, TableRecordId, OldValueJson, NewValueJson, CreatedBy)    
  select     
   @NotificationGroupId,@NotificationTypeId as NotificationTypeId,NotificationAction=1,    
   NotificationId as TableRecordId,OldValueJson,NewValueJson,CreatedBy=1    
  from [tblNotification]    
  where RecordType='Student' and RecordStatus=1    
     
    
 --add updated record    
 if not exists(select top 1 * from tblNotificationGroup where NotificationTypeId=@NotificationTypeId and NotificationAction=2)    
 begin    
  insert into tblNotificationGroup(NotificationTypeId ,NotificationCount ,NotificationAction)    
  select @NotificationTypeId as NotificationTypeId,count(1) as NotificationCount, NotificationAction=2  from [tblNotification]    
  where RecordType='Student' and RecordStatus=2    
 end    
     
     
  declare @NotificationGroupId1 int=0;    
  select top 1 @NotificationGroupId1=NotificationGroupId from tblNotificationGroup where NotificationTypeId=@NotificationTypeId and NotificationAction=2    
      
  declare @NotificationCount1 int=0    
  select @NotificationCount1=count(1)     
  from [tblNotification]    
  where RecordType='Student' and RecordStatus=2    
    
  update tblNotificationGroup    
  set NotificationCount=@NotificationCount1    
  where  NotificationGroupId=@NotificationGroupId1    
    
  insert into tblNotificationGroupDetail(NotificationGroupId ,NotificationTypeId, NotificationAction, TableRecordId, OldValueJson, NewValueJson, CreatedBy)    
  select     
   @NotificationGroupId1,@NotificationTypeId as NotificationTypeId,NotificationAction=2,    
   NotificationId as TableRecordId,OldValueJson,NewValueJson,CreatedBy=1    
  from [tblNotification]    
  where RecordType='Student' and RecordStatus=2    
     
     
 --------------End: Student record    
    
 --------------Start: parent record    
     
 select top 1 @NotificationTypeId=NotificationTypeId from tblNotificationTypeMaster where NotificationType='OpenApplyRecordProcessing' and  ActionTable='tblParent'    
    
 --Added new record    
 if not exists(select top 1 * from tblNotificationGroup where NotificationTypeId=@NotificationTypeId and NotificationAction=1)    
 begin    
  insert into tblNotificationGroup(NotificationTypeId ,NotificationCount ,NotificationAction)    
  select @NotificationTypeId as NotificationTypeId,count(1) as NotificationCount, NotificationAction=1  from [tblNotification]    
  where RecordType<>'Student' and RecordStatus=1    
 end    
     
     
  declare @NotificationGroupId2 int=0;    
  select top 1 @NotificationGroupId2=NotificationGroupId from tblNotificationGroup where NotificationTypeId=@NotificationTypeId and NotificationAction=2    
      
  declare @NotificationCount2 int=0    
  select @NotificationCount2=count(1)     
  from [tblNotification]    
  where RecordType<>'Student' and RecordStatus=1    
    
  update tblNotificationGroup    
  set NotificationCount=@NotificationCount2    
  where  NotificationGroupId=@NotificationGroupId2    
    
  insert into tblNotificationGroupDetail(NotificationGroupId ,NotificationTypeId, NotificationAction, TableRecordId, OldValueJson, NewValueJson, CreatedBy)    
  select     
   @NotificationGroupId2,@NotificationTypeId as NotificationTypeId,NotificationAction=1,    
   NotificationId as TableRecordId,OldValueJson,NewValueJson,CreatedBy=1    
  from [tblNotification]    
  where RecordType<>'Student' and RecordStatus=1    
     
    
 --add updated record    
 if not exists(select top 1 * from tblNotificationGroup where NotificationTypeId=@NotificationTypeId and NotificationAction=2)    
 begin    
  insert into tblNotificationGroup(NotificationTypeId ,NotificationCount ,NotificationAction)    
  select @NotificationTypeId as NotificationTypeId,count(1) as NotificationCount, NotificationAction=2  from [tblNotification]    
  where RecordType<>'Student' and RecordStatus=2    
 end    
     
    
     
  declare @NotificationGroupId3 int=0;    
  select top 1 @NotificationGroupId3=NotificationGroupId from tblNotificationGroup where NotificationTypeId=@NotificationTypeId and NotificationAction=2    
      
  declare @NotificationCount3 int=0    
  select @NotificationCount3=count(1)     
  from [tblNotification]    
  where RecordType<>'Student' and RecordStatus=2    
    
  update tblNotificationGroup    
  set NotificationCount=@NotificationCount3    
  where  NotificationGroupId=@NotificationGroupId3    
    
  insert into tblNotificationGroupDetail(NotificationGroupId ,NotificationTypeId, NotificationAction, TableRecordId, OldValueJson, NewValueJson, CreatedBy)    
  select     
   @NotificationGroupId3,@NotificationTypeId as NotificationTypeId,NotificationAction=2,    
   NotificationId as TableRecordId,OldValueJson,NewValueJson,CreatedBy=1    
  from [tblNotification]    
  where RecordType<>'Student' and RecordStatus=2    
     
     
 --------------End: parent record    
    
          
  COMMIT TRAN TRANS1        
  SELECT 0 AS Result, 'Saved' AS Response      
 END TRY        
 BEGIN CATCH        
     ROLLBACK TRAN TRANS1           
     SELECT -1 AS Result, 'Error!' AS Response        
     EXEC usp_SaveErrorDetail        
     RETURN        
 END CATCH       
     
    
    
    
    
    
    
   --------------Start: Student ------------    
 --select           
 --  --  id as RecordId,          
 --  --  case when [StudentCode] is null then 1 else 2 end RecordStatus,            
 --  --  0 as IsApproved,          
 --  --  'Student' as RecordType,          
--  --  Getdate(),0 ,        
 --  --  student_id  ,    
 --  --NewValueJson,OldValueJson    
 --  LoginUserId=0    
 --  ,ActionTable='tblStudent'    
 --  ,NotificationAction= case when [StudentCode] is null then 1 else 2 end    
 --  ,TableRecordId=isnull(StudentId,0)    
 --  ,OldValueJson=OldValueJson    
 --  ,NewValueJson=NewValueJson    
 --  from           
 --  (          
 -- select       
 --  stu.StudentId,      
 --  stu.[StudentCode],      
 --  os.id  ,      
 --  os.[student_id]  ,    
       
 --  NewValueJson= (SELECT * FROM [OpenApplyStudents] jc where jc.[student_id] = os.[student_id] FOR JSON PATH, WITHOUT_ARRAY_WRAPPER )    
 --  , OldValueJson=     
 --  (    
 --  SELECT     
 --   StudentId    
 --   ,StudentCode    
 --   ,StudentImage    
 --   ,ParentId    
 --   ,StudentName    
 --   ,StudentArabicName    
 --   ,StudentEmail    
 --   ,DOB    
 --   ,IqamaNo    
 --   ,NationalityId    
 --   ,GenderId    
 --   ,AdmissionDate    
 --   ,GradeId    
 --   ,CostCenterId    
 --   ,SectionId    
 --   ,PassportNo    
 --   ,PassportExpiry    
 --   ,Mobile    
 --   ,StudentAddress    
 --   ,StudentStatusId    
 --   ,WithdrawDate    
 --   ,WithdrawAt    
 --   ,WithdrawYear    
 --   ,Fees    
 --   ,IsGPIntegration    
 --   ,TermId    
 --   ,AdmissionYear    
 --   ,PrinceAccount    
 --   ,IsActive    
 --   ,IsDeleted    
 --   ,UpdateDate    
 --   ,UpdateBy    
 --   ,p_id_school_parent_id    
 --  FROM [tblStudent] jc where jc.[StudentCode] = stu.[StudentCode] FOR JSON PATH,WITHOUT_ARRAY_WRAPPER )    
     
 --  ,os.[name] ,stu.[StudentName]         
 --  ,os.[other_name]  ,stu.[StudentArabicName]          
 --  ,os.[email]  ,stu.[StudentEmail]      
     
 --  ,case     
 --  when ltrim(rtrim(os.[name])) COLLATE SQL_Latin1_General_CP1_CI_AS <>ltrim(rtrim(stu.[StudentName]     ))    
 --  then 1 else 0 end NameUpdated    
        
 --  ,case when ltrim(rtrim(os.[other_name]))  COLLATE SQL_Latin1_General_CP1_CI_AS <>ltrim(rtrim(stu.[StudentArabicName]   ))     
 --  then 1 else 0 end  ArabicNameUpdated    
    
 --  ,case when ltrim(rtrim( isnull(os.[email],'')))  COLLATE SQL_Latin1_General_CP1_CI_AS<>ltrim(rtrim(isnull( stu.[StudentEmail] ,'')))    
 --  then 1 else 0 end  EmailUpdated    
    
 --  --,case when   ltrim(rtrim(os.IqamaNo))  COLLATE SQL_Latin1_General_CP1_CI_AS<>ltrim(rtrim(stu.IqamaNo))    
 --  --then 1 else 0 end  IqamaNoUpdated    
    
 -- from [dbo].[OpenApplyStudents] os          
 -- left join [dbo].[tblStudent] stu          
 -- on os.[student_id] COLLATE SQL_Latin1_General_CP1_CI_AS=stu.[StudentCode]          
         
 -- AND           
 -- (          
 --  (          
 --   ltrim(rtrim(os.[name])) COLLATE SQL_Latin1_General_CP1_CI_AS <>ltrim(rtrim(stu.[StudentName]     ))    
 --   OR ltrim(rtrim(os.[other_name]))  COLLATE SQL_Latin1_General_CP1_CI_AS <>ltrim(rtrim(stu.[StudentArabicName]   ))       
 --   OR ltrim(rtrim( isnull(os.[email],'')))  COLLATE SQL_Latin1_General_CP1_CI_AS<>ltrim(rtrim(isnull( stu.[StudentEmail] ,'')))    
 --   --OR  ltrim(rtrim(os.IqamaNo)) COLLATE SQL_Latin1_General_CP1_CI_AS<>ltrim(rtrim(stu.IqamaNo))    
 --   --OR os.[status] <>stu.[StudentStatusId]          
 --   --enrolled          
 --  )          
 --  OR          
 --  1=1    
 -- )         
 --  )t     
 --  where NameUpdated=1 OR ArabicNameUpdated=1 OR EmailUpdated=1 --OR IqamaNoUpdated=1    
 --------------End: Student ------------    
    
 --------------Start: Mother------------    
 --select     
 -- LoginUserId=0    
 -- ,ActionTable='tblParent'    
 -- ,NotificationAction= case when [ParentCode] is null then 1 else 2 end    
 -- ,TableRecordId=isnull(ParentId,0)    
 -- ,OldValueJson=OldValueJson    
 -- ,NewValueJson=NewValueJson    
 -- --id,          
 -- --case when [ParentCode] is null then 1 else 2 end RecordStatus,  --added/updated        
 -- ----cast(0 as bit) as          
 -- --0 as IsApproved,          
 -- --'Mother' as RecordType,          
 -- --Getdate(),0 ,        
 -- --student_id     
 -- --*    
 --from           
 --(          
 -- select     
 --  ROW_NUMBER() over(partition by   student_id,gender order by student_id) as RN    
 --  ,stu.ParentId    
 --  ,stu.[ParentCode]    
 --  ,os.id      
 --  ,os.[student_id]    
       
 --  ,case when(os.[first_name]+' '+os.[last_name]) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.MotherName          
 --   then 1 else 0 end  NameUpdated    
        
 --  ,case when os.[email] COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.MotherEmail          
 --   then 1 else 0 end  EmailUpdated    
       
 --  ,NewValueJson= (SELECT * FROM [OpenApplyParents] jc where jc.[parent_id] = os.[parent_id] FOR JSON PATH, WITHOUT_ARRAY_WRAPPER )    
 --  , OldValueJson= (SELECT * FROM [tblParent] jc where jc.ParentCode = stu.ParentCode FOR JSON PATH,WITHOUT_ARRAY_WRAPPER )    
     
 -- from [dbo].[OpenApplyParents] os          
 -- left join [dbo].[tblParent] stu          
 -- on os.[parent_id] COLLATE SQL_Latin1_General_CP1_CI_AS=stu.[ParentCode] --need to check with record          
 -- and os.gender='Female'        
 -- AND           
 -- (          
 --  (          
 --   (os.[first_name]+' '+os.[last_name]) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.MotherName          
 --   OR     
 --   os.[email] COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.MotherEmail          
 --  )          
 --  OR          
 --  1=1          
 -- )      
 --)t         
 --where t.RN=1   and t.NameUpdated=1 and t.EmailUpdated=1      
 --------------End: Mother------------      
      
 --------------Start: Father------------    
 --select     
 -- LoginUserId=0    
 -- ,ActionTable='tblParent'    
 -- ,NotificationAction= case when [ParentCode] is null then 1 else 2 end    
 -- ,TableRecordId=isnull(ParentId,0)    
 -- ,OldValueJson=OldValueJson    
 -- ,NewValueJson=NewValueJson    
    
 -- --id,          
 -- --case when [ParentCode] is null then 1 else 2 end RecordStatus,          
 -- ----cast(0 as bit) as          
 -- --0 as IsApproved,          
 -- --'Father' as RecordType,          
 -- --Getdate(),0  ,        
 -- --student_id        
 -- --*    
 --from           
 --(          
 -- select     
 --  ROW_NUMBER() over(partition by   student_id,gender order by student_id) as RN    
 --  ,stu.ParentId    
 --  ,stu.[ParentCode]    
 --  ,os.id      
 --  ,os.[student_id]    
       
 --  ,case when(os.[first_name]+' '+os.[last_name]) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.[FatherName]          
 --   then 1 else 0 end  NameUpdated    
        
 --  ,case when os.[email] COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.[FatherEmail]          
 --   then 1 else 0 end  EmailUpdated    
    
 --  ,NewValueJson= (SELECT * FROM [OpenApplyParents] jc where jc.[parent_id] = os.[parent_id] FOR JSON PATH, WITHOUT_ARRAY_WRAPPER )    
 --  , OldValueJson= (SELECT * FROM [tblParent] jc where jc.ParentCode = stu.ParentCode FOR JSON PATH,WITHOUT_ARRAY_WRAPPER )    
     
 -- from [dbo].[OpenApplyParents] os          
 -- left join [dbo].[tblParent] stu          
 -- on os.[parent_id] COLLATE SQL_Latin1_General_CP1_CI_AS=stu.[ParentCode] --need to check with record          
 -- and os.gender='male'        
 -- AND           
 -- (          
 --  (          
 --   (os.[first_name]+' '+os.[last_name]) COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.[FatherName]          
 --   OR os.[email] COLLATE SQL_Latin1_General_CP1_CI_AS<>stu.[FatherEmail]          
 --  )          
 --  OR          
 --  1=1          
 -- )      
 --)t         
 --where t.RN=1   and t.NameUpdated=1 and t.EmailUpdated=1      
 --------------End: Father------------    
    
END
GO
/****** Object:  StoredProcedure [dbo].[sp_RejectNotificationById]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[sp_RejectNotificationById]
	@LoginUserId int=0
	,@NotificationGroupDetailId int=0
AS
BEGIN
	BEGIN TRY
	BEGIN TRANSACTION TRANS1
	DECLARE @TableToBeUpdate NVARCHAR(500)
	DECLARE @TableRecordColumnName nvarchar(200)
	DECLARE @TableRecordId NVARCHAR(200)
	DECLARE @NotificationAction int
	DECLARE @NotificationGroupId int
	SELECT @TableToBeUpdate=nt.ActionTable,@TableRecordColumnName=ngd.TableRecordColumnName
	,@TableRecordId=ngd.TableRecordId,@NotificationAction=NotificationAction,@NotificationGroupId=NotificationGroupId
	FROM tblNotificationGroupDetail ngd
	INNER JOIN tblNotificationTypeMaster nt
		ON ngd.NotificationTypeId=nt.NotificationTypeId
	WHERE ngd.NotificationGroupDetailId=@NotificationGroupDetailId
	DECLARE @Query NVARCHAR(MAX)
	SET @Query='UPDATE '+@TableToBeUpdate+' SET IsRejected = 1, IsApproved = 0 WHERE '+@TableRecordColumnName+'='+@TableRecordId
				
	PRINT @Query
	EXEC (@Query)
	IF @NotificationAction=1
	BEGIN
		SET @Query='UPDATE '+@TableToBeUpdate+' SET IsDeleted = 1 WHERE '+@TableRecordColumnName+'='+@TableRecordId
				
		PRINT @Query
		EXEC (@Query)
	END
	DELETE FROM tblNotificationGroupDetail WHERE NotificationGroupDetailId=@NotificationGroupDetailId
	UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1
	WHERE NotificationGroupId=@NotificationGroupId
	SELECT 0 AS Result, 'Success' AS Response
	COMMIT TRAN TRANS1
		
	END TRY
	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
--sp_RejectNotificationById 1,1
GO
/****** Object:  StoredProcedure [dbo].[sp_ReportStudentStatement]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--EXEC sp_ReportStudentStatement 2008,765,13
CREATE proc [dbo].[sp_ReportStudentStatement]    
	@AcademicYearId int  =0
	,@ParentId int  
	,@StudentId int  
AS    
BEGIN
	DECLARE @AcademicYear_PeriodFrom DATETIME
	DECLARE @AcademicYear NVARCHAR(500)  
	
	SELECT TOP 1 @AcademicYear_PeriodFrom=PeriodFrom 
	FROM tblSchoolAcademic 
	WHERE @AcademicYearId = 0 
		OR SchoolAcademicId=@AcademicYearId
	ORDER BY PeriodFrom ASC

	IF(@AcademicYearId=0)
		SET @AcademicYear_PeriodFrom= CAST('1/1/1990' AS DATETIME)

	SELECT * INTO #Previous_tblSchoolAcademic 
	FROM tblSchoolAcademic 
	WHERE CAST(PeriodTo AS DATE)<CAST(@AcademicYear_PeriodFrom AS DATE) 
		AND IsActive=1 AND IsDeleted=0

	SELECT TOP 1 @AcademicYear=AcademicYear 
	FROM #Previous_tblSchoolAcademic 
	ORDER BY PeriodTo DESC
    
	SELECT StudentId INTO #StudentTable 
	FROM tblStudent 
	WHERE StudentId = @StudentId 
		OR (@StudentId=0 AND ParentId=@ParentId)

	-- Student Opening Fees Balance    
	SELECT StudentId
		,RecordDate
		,FeeTypeName
		,FeeAmount=SUM(ISNULL(FeeAmount,0))
		,PaidAmount=SUM(ISNULL(PaidAmount,0))    
	INTO #StudentOpeningFeesBalance   
	FROM    
	(    
		SELECT StudentId
		,NULL AS RecordDate
		,'TUITION FEE -OPENING BALANCE' AS FeeTypeName
		,ISNULL(FeeAmount,0) AS FeeAmount
		,ISNULL(PaidAmount,0) AS PaidAmount  
		FROM tblFeeStatement  
		WHERE StudentId IN (SELECT StudentId FROM #StudentTable)     
		AND AcademicYearId IN (SELECT SchoolAcademicId FROM #Previous_tblSchoolAcademic)     
		AND IsActive=1 AND IsDeleted=0    
	)t    
	GROUP BY StudentId,RecordDate,FeeTypeName
	 
	DECLARE @OpeningBalance DECIMAL(18,2)=0    
	DECLARE @TotalFeeAmount DECIMAL(18,2)=0    
	DECLARE @TotalPaidAmount DECIMAL(18,2)=0    
    
	SELECT @TotalFeeAmount=SUM(FeeAmount) FROM #StudentOpeningFeesBalance   
	SELECT @TotalPaidAmount=SUM(PaidAmount) FROM #StudentOpeningFeesBalance    
    
	SET @OpeningBalance=@TotalFeeAmount-@TotalPaidAmount    

	DECLARE @StudentName NVARCHAR(100)
	
	SELECT TOP 1 @StudentName= StudentName 
	FROM tblStudent 
	WHERE StudentId= @StudentId
	
	SELECT @StudentId AS StudentId
		,ISNULL(@StudentName,'') AS StudentName
		,'' AS InvoiceNo  
		,'' AS PaymentMethod  
		,@AcademicYear AS AcademicYear  
		,NULL AS RecordDate, 
		'TUITION FEE -OPENING BALANCE' AS FeeTypeName
		,FeeAmount= CASE WHEN @OpeningBalance>0 THEN @OpeningBalance ELSE 0 END
		,PaidAmount= CASE WHEN @OpeningBalance< 0 THEN @OpeningBalance ELSE 0 END
		,BalanceAmount=0
	UNION ALL  
	SELECT StudentId  
		,StudentName  
		,InvoiceNo  
		,PaymentMethod  
		,sa.AcademicYear  
		,fs.UpdateDate AS RecordDate  
		,FeeStatementType AS FeeTypeName  
		,FeeAmount  
		,PaidAmount  
		,0 AS BalanceAmount  
	FROM tblFeeStatement fs  
	INNER JOIN tblSchoolAcademic sa ON sa.SchoolAcademicId=fs.AcademicYearId  
	WHERE StudentId in (SELECT StudentId from #StudentTable)     
	AND (@AcademicYearId=0 OR fs.AcademicYearId IN (@AcademicYearId))
	AND fs.IsActive=1     
	AND fs.IsDeleted=0 

	DROP TABLE #Previous_tblSchoolAcademic    
	DROP TABLE #StudentTable    
	DROP TABLE #StudentOpeningFeesBalance    
END    
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveBranch]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveBranch]
	@LoginUserId int
	,@BranchId bigint
	,@BranchName nvarchar(200)
	,@IsActive	bit
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblBranchMaster WHERE BranchName = @BranchName
			AND BranchId <> @BranchId AND IsActive = 1)
	BEGIN
		SELECT -2 AS Result, 'Branch already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@BranchId = 0)
			BEGIN
				INSERT INTO tblBranchMaster
					   (BranchName						
						,IsActive
						,IsDeleted
						,UpdateDate
						,UpdateBy)
				VALUES
					   (@BranchName											  
					   ,@IsActive	
					   ,0
					   ,GETDATE()
					   ,@LoginUserId)
			END
			ELSE
			BEGIN
				UPDATE tblBranchMaster
						SET BranchName = @BranchName						
							,IsActive = @IsActive						
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE BranchId = @BranchId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveContactInformation]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveContactInformation]
	@LoginUserId int
	,@ContactId bigint
	,@SchoolId bigint
	,@ContactPerson nvarchar(400)
	,@ContactPosition nvarchar(200)
	,@ContactTelephone nvarchar(20)
	,@ContactEmail nvarchar(200)
	,@IsActive bit
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblContactInformation WHERE ContactPerson = @ContactPerson AND SchoolId=@SchoolId
			AND ContactId <> @ContactId AND IsActive = 1)
	BEGIN
		SELECT -2 AS Result, 'Contact Information already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@ContactId = 0)
			BEGIN
				INSERT INTO tblContactInformation
					   (SchoolId
					   ,ContactPerson
					   ,ContactPosition
					   ,ContactTelephone
					   ,ContactEmail
					   ,IsActive
					   ,IsDeleted
					   ,UpdateDate
					   ,UpdateBy)
				VALUES
					   (@SchoolId
					   ,@ContactPerson
					   ,@ContactPosition
					   ,@ContactTelephone
					   ,@ContactEmail								  
					   ,@IsActive	
					   ,0
					   ,GETDATE()
					   ,@LoginUserId)
			END
			ELSE
			BEGIN
				UPDATE tblContactInformation
						SET SchoolId = @SchoolId
							,ContactPerson = @ContactPerson
							,ContactPosition = @ContactPosition 					
							,ContactTelephone = @ContactTelephone
							,ContactEmail = @ContactEmail
							,IsActive = @IsActive						
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE ContactId = @ContactId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveCostCenter]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveCostCenter]  
 @LoginUserId int  
 ,@CostCenterId bigint  
 ,@CostCenterName nvarchar(200)  
 ,@Remarks nvarchar(400)  
	,@DebitAccount nvarchar(200)  
	,@CreditAccount nvarchar(200)  
 ,@IsActive bit  
AS  
BEGIN  
 SET NOCOUNT ON;  
 IF EXISTS(SELECT 1 FROM tblCostCenterMaster WHERE CostCenterName = @CostCenterName  
   AND CostCenterId <> @CostCenterId AND IsActive = 1)  
 BEGIN  
  SELECT -2 AS Result, 'Costcenter already exists!' AS Response  
  RETURN;  
 END  
 BEGIN TRY  
  BEGIN TRANSACTION TRANS1  
   IF(@CostCenterId = 0)  
   BEGIN  
    INSERT INTO tblCostCenterMaster  
        (CostCenterName  
        ,Remarks  
		,DebitAccount
		,CreditAccount
        ,IsActive  
        ,IsDeleted  
        ,UpdateDate  
        ,UpdateBy)  
    VALUES  
        (@CostCenterName  
        ,@Remarks  
		,@DebitAccount
		,@CreditAccount
        ,@IsActive   
        ,0  
        ,GETDATE()  
        ,@LoginUserId)  
   END  
   ELSE  
   BEGIN  
    UPDATE tblCostCenterMaster  
      SET CostCenterName = @CostCenterName  
       ,Remarks = @Remarks   
	   ,DebitAccount = @DebitAccount
		,CreditAccount = @CreditAccount
       ,IsActive = @IsActive  
       ,UpdateDate = GETDATE()  
       ,UpdateBy = @LoginUserId  
    WHERE CostCenterId = @CostCenterId  
   END      
  COMMIT TRAN TRANS1  
  SELECT 0 AS Result, 'Saved' AS Response  
 END TRY  
  
 BEGIN CATCH  
   ROLLBACK TRAN TRANS1  
   SELECT -1 AS Result, 'Error!' AS Response  
   EXEC usp_SaveErrorDetail  
   RETURN  
 END CATCH  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveDiscount]
	@LoginUserId int
	,@DiscountId bigint
	,@DiscountName nvarchar(200)
	,@DiscountPercent decimal(18,2)
	,@DiscountAssignedRule nvarchar(200)=NULL
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblDiscountMaster WHERE DiscountName = @DiscountName AND DiscountPercent=@DiscountPercent
			AND DiscountId <> @DiscountId AND IsActive = 1 AND IsDeleted=0)
	BEGIN
		SELECT -2 AS Result, 'Discount already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF OBJECT_ID('tempdb..#TempAssignedDiscountRule') IS NOT NULL DROP TABLE TempAssignedDiscountRule
			SELECT * INTO #TempAssignedDiscountRule FROM (SELECT ROW_NUMBER() OVER(ORDER BY OutParam) RN, OutParam FROM SplitString(@DiscountAssignedRule,',')) x    
			
			IF(@DiscountId = 0)
			BEGIN
				INSERT INTO tblDiscountMaster
					   (
					   DiscountName
					   ,DiscountPercent
					   ,IsActive
					   ,IsDeleted
					   ,UpdateDate
					   ,UpdateBy)
				VALUES
					   (
					   @DiscountName
					   ,@DiscountPercent
					   ,1
					   ,0
					   ,GETDATE()
					   ,@LoginUserId)

				SET @DiscountId = SCOPE_IDENTITY()      
    
				INSERT INTO tblDiscountRuleMapping   
						(DiscountId    
						,DiscountRuleId 
						,[IsActive]    
						,[IsDeleted]    
						,UpdateDate
						,UpdateBy)    
				SELECT @DiscountId,OutParam,1,0,GETDATE(),@LoginUserId FROM   #TempAssignedDiscountRule 
			END
			ELSE
			BEGIN
				UPDATE tblDiscountMaster
						SET DiscountName = @DiscountName
							,DiscountPercent = @DiscountPercent
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE DiscountId = @DiscountId

				DELETE FROM tblDiscountRuleMapping 
				WHERE DiscountId = @DiscountId AND DiscountRuleId NOT IN (SELECT OutParam FROM #TempAssignedDiscountRule)  

				DELETE FROM #TempAssignedDiscountRule    
				WHERE OutParam     
					IN (SELECT DiscountRuleId FROM tblDiscountRuleMapping     
					WHERE  DiscountId = @DiscountId AND IsActive=1 AND IsDeleted=0) 				  
    
				INSERT INTO tblDiscountRuleMapping    
						(DiscountId    
						,DiscountRuleId 
						,[IsActive]    
						,[IsDeleted]    
						,UpdateDate
						,UpdateBy)      
				SELECT @DiscountId,OutParam,1,0,GETDATE(),@LoginUserId FROM   #TempAssignedDiscountRule    
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveDocumentType]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_SaveDocumentType]
	@LoginUserId int
	,@DocumentTypeId bigint
	,@DocumentTypeName nvarchar(200)
	,@Remarks nvarchar(400)
	,@IsActive bit
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblDocumentTypeMaster WHERE DocumentTypeName = @DocumentTypeName
			AND DocumentTypeId <> @DocumentTypeId AND IsActive = 1)
	BEGIN
		SELECT -2 AS Result, 'DocumentType already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@DocumentTypeId = 0)
			BEGIN
				INSERT INTO tblDocumentTypeMaster
					   (DocumentTypeName
					   ,Remarks							  
					   ,IsActive
					   ,IsDeleted
					   ,UpdateDate
					   ,UpdateBy)
				VALUES
					   (@DocumentTypeName
					   ,@Remarks								  
					   ,@IsActive	
					   ,0
					   ,GETDATE()
					   ,@LoginUserId)
			END
			ELSE
			BEGIN
				UPDATE tblDocumentTypeMaster
						SET DocumentTypeName = @DocumentTypeName
							,Remarks = @Remarks								
							,IsActive = @IsActive						
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE DocumentTypeId = @DocumentTypeId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveEmailConfig]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveEmailConfig]
	@LoginUserId int
	,@EmailConfigId bigint
	,@Host nvarchar(200)
	,@Port int  
    ,@Username nvarchar(200) 
    ,@Password nvarchar(200)
    ,@EnableSSL bit
	,@FromEmail nvarchar(200)
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblEmailConfig WHERE @Host = @Host
			AND EmailConfigId <> @EmailConfigId)
	BEGIN
		SELECT -2 AS Result, 'Email Config already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@EmailConfigId = 0)
			BEGIN
				INSERT INTO tblEmailConfig
					   (Host
					   ,Port
		               ,Username
					   ,Password
					   ,EnableSSL
					   ,FromEmail
					   ,IsDeleted
					   ,UpdateDate
					   ,UpdateBy)
				VALUES
					   (@Host	
					   ,@Port
	                   ,@Username
					   ,@Password
					   ,@EnableSSL
					   ,@FromEmail	
					   ,0
					   ,GETDATE()
					   ,@LoginUserId)
			END
			ELSE
			BEGIN
				UPDATE tblEmailConfig
						SET Host = @Host	
	                         ,Port = @Port
		                     ,Username = @Username
							 ,Password = @Password
							 ,EnableSSL = @EnableSSL
							 ,FromEmail = @FromEmail				
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE EmailConfigId = @EmailConfigId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveFeeDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveFeeDiscount]
	@LoginUserId int
	,@FeeDiscountId bigint
	,@FeeDiscountName nvarchar(200)
	,@Percent nvarchar(200)
	,@Rule nvarchar(200)
	,@Remarks nvarchar(200)
	,@IsActive bit
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblFeeDiscountMaster WHERE FeeDiscountName = @FeeDiscountName
			AND @FeeDiscountId <> @FeeDiscountId AND IsActive = 1)
	BEGIN
		SELECT -2 AS Result, 'Fee Discount already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@FeeDiscountId = 0)
			BEGIN
				INSERT INTO tblFeeDiscountMaster
					   (
					   FeeDiscountName
					   ,[Percent]
					   ,[Rule]
					   ,Remarks
					   ,IsActive
					   ,IsDeleted
					   ,UpdateDate
					   ,UpdateBy)
				VALUES
					   (
					   @FeeDiscountName
					   ,@Percent												  
					   ,@Rule	
					   ,@Remarks
					   ,@IsActive
					   ,0
					   ,GETDATE()
					   ,@LoginUserId)
			END
			ELSE
			BEGIN
				UPDATE tblFeeDiscountMaster
						SET FeeDiscountName = @FeeDiscountName
							,[Percent] = @Percent
							,[Rule]  = @Rule
							, Remarks = @Remarks
							,IsActive = @IsActive						
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE FeeDiscountId = @FeeDiscountId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveFeePaymentPlan]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveFeePaymentPlan]
	@LoginUserId int=1
	,@FeePaymentPlanId bigint=0
	,@FeeTypeDetailId bigint=0
	,@PaymentPlanAmount decimal(18,2)=123
	,@DueDate Datetime='2024-04-20'
AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @NewJsonData NVARCHAR(MAX)
	DECLARE @OldJsonData NVARCHAR(MAX)
	DECLARE @ExistingSum decimal(18,2)
	SELECT @ExistingSum=SUM(PaymentPlanAmount) + @PaymentPlanAmount FROM tblFeePaymentPlan WHERE FeeTypeDetailId = @FeeTypeDetailId
			 AND IsDeleted=0
	
	 
	IF EXISTS(SELECT 1 FROM tblFeeTypeDetail WHERE FeeTypeDetailId = @FeeTypeDetailId 
			AND @ExistingSum>TermFeeAmount AND IsActive = 1 AND IsDeleted=0)
	BEGIN
		SELECT -2 AS Result, 'Amount is greater then Fee amount!' AS Response
		RETURN;
	END	
	IF EXISTS(SELECT 1 FROM tblFeePaymentPlan WHERE FeeTypeDetailId = @FeeTypeDetailId 
			AND Convert(date,DueDate)>Convert(date,@DueDate) AND IsDeleted=0)
	BEGIN
		SELECT -3 AS Result, 'Date should be greater of previous date!' AS Response
		RETURN;
	END	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		IF(@FeePaymentPlanId = 0)
		BEGIN
			INSERT INTO tblFeePaymentPlan
					(
					FeeTypeDetailId
					,PaymentPlanAmount
					,DueDate
					,IsDeleted
					,IsApproved
					,IsRejected
					,UpdateDate
					,UpdateBy)
			VALUES
					(
					@FeeTypeDetailId
					,@PaymentPlanAmount
					,@DueDate
					,0
					,0
					,0
					,GETDATE()
					,@LoginUserId)
					SET @FeePaymentPlanId=SCOPE_IDENTITY();
			SELECT 0 AS Result, 'Saved' AS Response
			SELECT @NewJsonData = '{"PaymentPlanAmount": "'+CAST(@PaymentPlanAmount AS NVARCHAR(18))+'", "DueDate": "'+Convert(VARCHAR(10),@DueDate,101)+'"}';
			--select @NewJsonData
			EXEC sp_SaveNotification @LoginUserId=@LoginUserId,@ActionTable='tblFeePaymentPlan',@NotificationAction='1'
			,@TableRecordId=@FeePaymentPlanId,@OldValueJson='',@NewValueJson=@NewJsonData,@TableRecordColumnName='FeePaymentPlanId'
		END
		ELSE
		BEGIN
  			UPDATE tblFeePaymentPlan
					SET --PaymentPlanAmount = @PaymentPlanAmount						
						--,DueDate = @DueDate	
						IsApproved=0
						,IsRejected=0
						,UpdateDate = GETDATE()
						,UpdateBy = @LoginUserId
			WHERE FeePaymentPlanId = @FeePaymentPlanId
			SELECT 0 AS Result, 'Saved' AS Response
			SELECT @NewJsonData = '{"PaymentPlanAmount": "'+CAST(@PaymentPlanAmount AS NVARCHAR(18))+'", "DueDate": "'+Convert(VARCHAR(10),@DueDate,101)+'"}';
			SELECT @OldJsonData = '{"PaymentPlanAmount": "'+CAST(PaymentPlanAmount AS NVARCHAR(18))+'", "DueDate": "'+Convert(VARCHAR(10),DueDate,101)+'"}' FROM tblFeePaymentPlan
			WHERE FeePaymentPlanId = @FeePaymentPlanId;
			EXEC sp_SaveNotification @LoginUserId=@LoginUserId,@ActionTable='tblFeePaymentPlan'
			,@NotificationAction='2',@TableRecordId=@FeePaymentPlanId
			,@OldValueJson=@OldJsonData,@NewValueJson=@NewJsonData,@TableRecordColumnName='FeePaymentPlanId'
		END
		COMMIT TRAN TRANS1
		
	END TRY
	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveFeePlanWithoutGradewise]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveFeePlanWithoutGradewise]
	@LoginUserId int
	,@FeeTypeId bigint
	,@FeeStructureId bigint
	,@AcademicYear nvarchar(200)
	,@FeeAmount decimal(18,4)
	,@IsGradeWise bit
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblFeeStructure WHERE AcademicYear = @AcademicYear AND FeeTypeId=@FeeTypeId
			AND FeeStructureId <> @FeeStructureId  AND IsActive = 1)
	BEGIN
		SELECT -2 AS Result, 'Fee already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@FeeStructureId = 0)
			BEGIN
				INSERT INTO tblFeeStructure
					  ([AcademicYear]
					   ,[FeeTypeId]
					   ,[IsGradeWise]
					   ,[FeeAmount]
					   ,[IsActive]
					   ,[IsDeleted]
					   ,[UpdateDate]
					   ,[UpdateBy])
				VALUES
					   (@AcademicYear
					   ,@FeeTypeId
					   ,@IsGradeWise
					   ,@FeeAmount
					   ,1
					   ,0
					   ,GETDATE()
					   ,@LoginUserId)
			END
			ELSE
			BEGIN
				UPDATE tblFeeStructure
						SET [AcademicYear] = @AcademicYear
							,[FeeTypeId] = @FeeTypeId
							,IsGradeWise = @IsGradeWise
							,[FeeAmount] = @FeeAmount
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE FeeStructureId = @FeeStructureId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveFeeStructure]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveFeeStructure] 
	@LoginUserId INT
	,@FeeStructureId BIGINT
	,@FeeAmount DECIMAL(18,4)=NULL
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1			
		UPDATE [dbo].[tblFeeStructure]
				SET [FeeAmount] = @FeeAmount					
					,[UpdateDate] = GETDATE()
					,[UpdateBy] = @LoginUserId
		WHERE FeeStructureId = @FeeStructureId
		SELECT 0 AS Result, 'Saved' AS Response						
		COMMIT TRAN TRANS1
		
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveFeeType]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveFeeType]      
	@LoginUserId int      
	,@FeeTypeId bigint      
	,@FeeTypeName nvarchar(200)  
	,@IsPrimary bit  
	,@IsGradeWise bit  
	,@IsTermPlan bit      
	,@IsPaymentPlan bit     
	,@DebitAccount nvarchar(200)    
	,@CreditAccount nvarchar(200)    
AS      
BEGIN      
 SET NOCOUNT ON;      
 IF EXISTS(SELECT 1 FROM tblFeeTypeMaster WHERE FeeTypeName = @FeeTypeName      
   AND @FeeTypeId <> @FeeTypeId AND IsActive = 1)      
 BEGIN      
  SELECT -2 AS Result, 'Fee Type already exists!' AS Response      
  RETURN;      
 END      
 BEGIN TRY      
  BEGIN TRANSACTION TRANS1      
   IF(@FeeTypeId = 0)      
   BEGIN      
    INSERT INTO tblFeeTypeMaster      
        (
			FeeTypeName      
			,IsTermPlan  
			,IsPrimary
			,IsGradeWise
			,IsPaymentPlan    
			,DebitAccount  
			,CreditAccount
  
			,IsActive      
			,IsDeleted      
			,UpdateDate      
			,UpdateBy
		)      
    VALUES      
		(
			@FeeTypeName 
			,@IsPrimary
			,@IsGradeWise
			,@IsTermPlan     
			,@IsPaymentPlan    
			,@DebitAccount  
			,@CreditAccount  
			,1      
			,0      
			,GETDATE()      
			,@LoginUserId
		)      
   END      
   ELSE      
   BEGIN      
 UPDATE tblFeeTypeMaster      
 SET     
  FeeTypeName = @FeeTypeName 
  ,IsPrimary=@IsPrimary
  ,IsGradeWise=@IsGradeWise
  ,IsTermPlan = @IsTermPlan      
  ,IsPaymentPlan = @IsPaymentPlan    
  ,DebitAccount = @DebitAccount  
  ,CreditAccount = @CreditAccount  
  ,UpdateDate = GETDATE()      
  ,UpdateBy = @LoginUserId      
 WHERE FeeTypeId = @FeeTypeId      
   END          
  COMMIT TRAN TRANS1      
  SELECT 0 AS Result, 'Saved' AS Response      
 END TRY      
      
 BEGIN CATCH      
   ROLLBACK TRAN TRANS1      
   SELECT -1 AS Result, 'Error!' AS Response      
   EXEC usp_SaveErrorDetail      
   RETURN      
 END CATCH      
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveFeeTypeDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveFeeTypeDetail]  
	@LoginUserId int  
	,@FeeTypeId bigint  
	,@FeeTypeDetailId bigint  
	,@AcademicYearId bigint  
	,@GradeId bigint 
	,@TermFeeAmount decimal(18,2)
	,@StaffFeeAmount decimal(18,2)
    ,@GradeRules nvarchar(400)=NULL  
AS  
BEGIN  
 SET NOCOUNT ON;  
 
 BEGIN TRY  
  BEGIN TRANSACTION TRANS1  

   SELECT * INTO #TempAssignedDiscountRule2 FROM (SELECT ROW_NUMBER() OVER(ORDER BY OutParam) RN, OutParam FROM SplitString(@GradeRules,',')) x      
     
	SELECT 
		@LoginUserId as LoginUserId
		,@FeeTypeId as FeeTypeId
		,@FeeTypeDetailId as FeeTypeDetailId
		,@AcademicYearId as AcademicYearId
		,@TermFeeAmount as TermFeeAmount
		,@StaffFeeAmount as StaffFeeAmount
		,OutParam as GradeId
	INTO #TempAssignedDiscountRuleWithGradeWise
	FROM 
	#TempAssignedDiscountRule2

	select t.* ,t2.IsGradeWise
	into #TempAssignedDiscountRule
	from #TempAssignedDiscountRuleWithGradeWise t
	inner join tblFeeTypeMaster t2
	on t.FeeTypeId = t2.FeeTypeId

	 --Synchronize the target table with refreshed data from source table
	MERGE [tblFeeTypeDetail] AS TARGET
	USING #TempAssignedDiscountRule AS SOURCE 
	ON (TARGET.FeeTypeId = SOURCE.FeeTypeId AND TARGET.AcademicYearId = SOURCE.AcademicYearId 
	AND ((SOURCE.IsGradeWise=0) OR (SOURCE.IsGradeWise =1 and TARGET.GradeId = SOURCE.GradeId)) )
	--When records are matched, update the records if there is any change
	WHEN MATCHED 
	THEN UPDATE SET 
		TARGET.TermFeeAmount = SOURCE.TermFeeAmount, 
		TARGET.StaffFeeAmount = SOURCE.StaffFeeAmount,
		TARGET.IsActive =1,
		TARGET.IsDeleted =0,
		TARGET.UpdateDate =GETDATE(),
		TARGET.UpdateBy =@LoginUserId
	--When no records are matched, insert the incoming records from source table to target table
	WHEN NOT MATCHED BY TARGET 
	THEN INSERT (	FeeTypeId,	AcademicYearId	,GradeId	, TermFeeAmount	, StaffFeeAmount,
	IsActive	,IsDeleted	,UpdateDate,	UpdateBy) 
	VALUES (SOURCE.FeeTypeId, SOURCE.AcademicYearId,isnull( SOURCE.GradeId,0),	SOURCE.TermFeeAmount,  SOURCE.StaffFeeAmount,
	1,0,GETDATE(),@LoginUserId)
	--When there is a row that exists in target and same record does not exist in source then delete this record target
	--WHEN NOT MATCHED BY SOURCE 
	--THEN DELETE 
	--$action specifies a column of type nvarchar(10) in the OUTPUT clause that returns 
	--one of three values for each row: 'INSERT', 'UPDATE', or 'DELETE' according to the action that was performed on that row
	--OUTPUT $action, 
	--DELETED.ProductID AS TargetProductID, 
	--DELETED.ProductName AS TargetProductName, 
	--DELETED.Rate AS TargetRate, 
	--INSERTED.ProductID AS SourceProductID, 
	--INSERTED.ProductName AS SourceProductName, 
	--INSERTED.Rate AS SourceRate; 
	;

	--SELECT @@ROWCOUNT;

  COMMIT TRAN TRANS1  
  SELECT 0 AS Result, 'Saved' AS Response  

     IF OBJECT_ID('tempdb..#TempAssignedDiscountRule') IS NOT NULL DROP TABLE #TempAssignedDiscountRule  
   IF OBJECT_ID('tempdb..#TempAssignedDiscountRule2') IS NOT NULL DROP TABLE #TempAssignedDiscountRule2  
    IF OBJECT_ID('tempdb..#TempAssignedDiscountRuleWithGradeWise') IS NOT NULL DROP TABLE #TempAssignedDiscountRuleWithGradeWise  



 END TRY  
  
 BEGIN CATCH  
   ROLLBACK TRAN TRANS1  
   SELECT -1 AS Result, 'Error!' AS Response  
   EXEC usp_SaveErrorDetail  
   RETURN  
 END CATCH  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveGender]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveGender]
	@LoginUserId int
	,@GenderTypeId bigint
	,@GenderTypeName nvarchar(200)
	,@DebitAccount nvarchar(200)  
   ,@CreditAccount nvarchar(200) 
	,@IsActive bit
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblGenderTypeMaster WHERE GenderTypeName = @GenderTypeName
			AND GenderTypeId <> @GenderTypeId AND IsActive = 1)
	BEGIN
		SELECT -2 AS Result, 'Gender already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@GenderTypeId = 0)
			BEGIN
				INSERT INTO tblGenderTypeMaster
					   (GenderTypeName
					   ,DebitAccount
		                ,CreditAccount
					   ,IsActive
					   ,IsDeleted
					   ,UpdateDate
					   ,UpdateBy)
				VALUES
					   (@GenderTypeName	
					   ,@DebitAccount
	                	,@CreditAccount
					   ,@IsActive	
					   ,0
					   ,GETDATE()
					   ,@LoginUserId)
			END
			ELSE
			BEGIN
				UPDATE tblGenderTypeMaster
						SET GenderTypeName = @GenderTypeName	
	                         ,DebitAccount = @DebitAccount
		                     ,CreditAccount = @CreditAccount
							,IsActive = @IsActive						
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE GenderTypeId = @GenderTypeId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveGenerateFee]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveGenerateFee]
	@LoginUserId int
	,@FeeGenerateId int
	,@SchoolAcademicId bigint = 0
	,@FeeTypeId bigint  = 0
	,@GradeId bigint  = 0
	,@ActionId int --1 Generate,5 Regenerate 
AS
BEGIN
	--1	Generate
	--2	Applied-Pending for Approval
	--3	Applied
	--4	Rejected
	--5	Regenerate
	IF @ActionId=1 AND EXISTS(SELECT 1 FROM tblFeeGenerate WHERE SchoolAcademicId=@SchoolAcademicId AND FeeTypeId=@FeeTypeId AND GradeId=@GradeId) 
	BEGIN
		SELECT -2 AS Result, 'Fee already generated. Please regenrate from grid' AS Response  
		RETURN;  
	END
	SET NOCOUNT ON;	
	BEGIN TRY
	BEGIN TRANSACTION TRANS1
		IF(@ActionId=1)
		BEGIN			
			INSERT INTO tblFeeGenerate
				(SchoolAcademicId, FeeTypeId, GradeId, GenerateStatus, UpdateDate, UpdateBy)
				VALUES (@SchoolAcademicId, @FeeTypeId, @GradeId, 1, GETDATE(), @LoginUserId)	
			SET @FeeGenerateId=SCOPE_IDENTITY();
		END
		ELSE IF(@ActionId=5)
		BEGIN
			DELETE FROM tblFeeGenerateDetail WHERE FeeGenerateId=@FeeGenerateId
			UPDATE tblFeeGenerate SET GenerateStatus=5 WHERE FeeGenerateId=@FeeGenerateId 
		END
		SELECT @SchoolAcademicId=SchoolAcademicId,@FeeTypeId=FeeTypeId,@GradeId=GradeId FROM tblFeeGenerate WHERE FeeGenerateId=@FeeGenerateId
		INSERT INTO tblFeeGenerateDetail(FeeGenerateId,StudentId,SchoolAcademicId,GradeId,FeeTypeId,FeeAmount,UpdateDate,UpdateBy)		
		SELECT
			FeeGenerateId=@FeeGenerateId
			,st.StudentId
			,t.AcademicYearId
			,t.GradeId
			,t.FeeTypeId
			,FeeAmount= CASE WHEN tp.IsFatherStaff=1 OR tp.IsMotherStaff=1 THEN t.StaffFeeAmount ELSE t.TermFeeAmount END
			,UpdateDate=GETDATE()
			,UpdateBy=@LoginUserId
		FROM tblStudent st
		LEFT JOIN tblParent tp
		ON tp.ParentId = st.ParentId
		INNER JOIN (SELECT tf.GradeId,tf.TermFeeAmount,tf.StaffFeeAmount,tf.AcademicYearId,tf.FeeTypeId 
					FROM tblFeeTypeDetail tf 
					WHERE tf.AcademicYearId=@SchoolAcademicId AND tf.FeeTypeId=@FeeTypeId 
						AND tf.GradeId=@GradeId AND tf.IsActive=1 AND tf.IsDeleted=0
		)t
		ON t.GradeId=st.GradeId
		WHERE st.IsActive=1 and st.IsDeleted=0
	COMMIT TRAN TRANS1
	SELECT 0 AS Result, 'Saved' AS Response
	END TRY
	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveGenerateSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveGenerateSiblingDiscount]
	@LoginUserId int
	,@SiblingDiscountId int
	,@SchoolAcademicId bigint = 0
	,@ActionId int --1 Generate,5 Regenerate 
AS
BEGIN
	--1	Generate
	--2	Applied-Pending for Approval
	--3	Applied
	--4	Rejected
	--5	Regenerate

	DECLARE @FeeTypeId INT =3
	SELECT TOP 1  @FeeTypeId=ISNULL(FeeTypeId,3) FROM tblFeeTypeMaster WHERE  FeeTypeName LIKE '%TUITION%'	

	IF @ActionId=1 AND EXISTS(SELECT 1 FROM tblSiblingDiscount WHERE SchoolAcademicId=@SchoolAcademicId AND FeeTypeId=@FeeTypeId) 
	BEGIN
		SELECT -2 AS Result, 'Sibling Discount already generated. Please regenrate from grid' AS Response  
		RETURN;  
	END
	SET NOCOUNT ON;	
	BEGIN TRY
	BEGIN TRANSACTION TRANS1
		IF(@ActionId=1)
		BEGIN
			INSERT INTO tblSiblingDiscount
				(SchoolAcademicId, FeeTypeId,  GenerateStatus, UpdateDate, UpdateBy)
				VALUES (@SchoolAcademicId, @FeeTypeId, 1, GETDATE(), @LoginUserId)	
			SET @SiblingDiscountId=SCOPE_IDENTITY();
		END
		ELSE IF(@ActionId=5)
		BEGIN
			DELETE FROM tblSiblingDiscountDetail WHERE SiblingDiscountId=@SiblingDiscountId
			UPDATE tblSiblingDiscount SET GenerateStatus=5 WHERE SiblingDiscountId=@SiblingDiscountId
			SELECT @SchoolAcademicId=SchoolAcademicId FROM tblSiblingDiscount WHERE SiblingDiscountId=@SiblingDiscountId
		END
		
		INSERT INTO tblSiblingDiscountDetail(SiblingDiscountId,StudentId,SchoolAcademicId,GradeId,FeeTypeId,DiscountPercent,DiscountAmount,UpdateDate,UpdateBy)		
		
		SELECT 
			SiblingDiscountId=@SiblingDiscountId,
			StudentId,	AcademicYearId,	GradeId,	FeetYpeId,DiscountPercent, 0 as DiscountAmount, getdate() as Updatedate, @LoginUserId as UpdateBy
		FROM 
		(
			SELECT 
				ROW_NUMBER() OVER( PARTITION BY ParentId ORDER BY ParentId, fee.FeeAmount) AS StuentChildNo
				,tbl.StudentId
				,fee.AcademicYearId
				,fee.GradeId
				,FeetYpeId=@FeeTypeId
			FROM tblStudent tbl
			JOIN tblStudentFeeDetail fee 
				ON tbl.StudentId=fee.StudentId 
				AND tbl.GradeId=fee.GradeId
			WHERE fee.AcademicYearId=@SchoolAcademicId
			AND fee.IsActive=1 AND fee.IsDeleted=0
		)t
		LEFT JOIN tblSiblingDiscountMaster mas
			ON t.StuentChildNo =mas.ChildrenNo 
			AND mas.IsActive=1 
			AND mas.IsDeleted=0 --and t.AcademicYearId=mas.AcademicYearId


	COMMIT TRAN TRANS1
	SELECT 0 AS Result, 'Saved' AS Response
	END TRY
	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END

GO
/****** Object:  StoredProcedure [dbo].[sp_SaveGrade]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--alter table tblGradeMaster drop column AdvanceAccountRemarks		

--alter table tblGradeMaster add DebitAccount nvarchar(200)
--alter table tblGradeMaster add CreditAccount nvarchar(200)
--select * from tblGradeMaster

CREATE PROCEDURE [dbo].[sp_SaveGrade]  
 @LoginUserId int  
 ,@GradeId int  
 ,@GradeName nvarchar(200)  
 ,@CostCenterId int  
 ,@GenderTypeId int=0  
  ,@DebitAccount nvarchar(200)  
   ,@CreditAccount nvarchar(200)  
 ,@IsActive bit  
AS  
BEGIN  
 SET NOCOUNT ON;  
   
 IF(@GradeId=0)  
 BEGIN   
  IF EXISTS(SELECT 1 FROM tblGradeMaster WHERE GradeName = @GradeName AND CostCenterId <> @CostCenterId  AND IsActive = 1 AND IsDeleted = 0)  
  BEGIN  
   SELECT -3 AS Result, 'Grade already exist in another Cost Center!' AS Response  
   RETURN;  
  END  
  ELSE IF EXISTS(SELECT 1 FROM tblGradeMaster WHERE GradeName = @GradeName AND CostCenterId = @CostCenterId   
  AND ISNULL(GenderTypeId,0) = ISNULL(@GenderTypeId,0)  AND IsActive = 1 AND IsDeleted = 0)  
  BEGIN  
   SELECT -2 AS Result, 'Grade already exists!' AS Response  
   RETURN;  
  END  
 END   
 ELSE  
 BEGIN  
  IF EXISTS(SELECT 1 FROM tblGradeMaster WHERE GradeName = @GradeName AND CostCenterId = @CostCenterId AND ISNULL(GenderTypeId,0) = ISNULL(@GenderTypeId,0)  
   AND GradeId <> @GradeId AND IsActive = 1 AND IsDeleted = 0)   
  BEGIN  
   SELECT -2 AS Result, 'Grade already exists!' AS Response  
   RETURN;  
  END  
 END  
 BEGIN TRY  
  BEGIN TRANSACTION TRANS1   
    
   IF(@GradeId = 0)  
   BEGIN  
    INSERT INTO tblGradeMaster  
        (GradeName        
        ,CostCenterId        
        ,GenderTypeId   
		,DebitAccount
		,CreditAccount

        ,SequenceNo   
        ,IsActive  
        ,IsDeleted  
        ,UpdateDate  
        ,UpdateBy)  
    VALUES  
        (@GradeName        
        ,@CostCenterId       
        ,@GenderTypeId 
		,@DebitAccount
		,@CreditAccount

        ,(SELECT ISNULL(MAX(SequenceNo),0)+1 FROM tblGradeMaster WHERE IsActive=1 AND IsDeleted=0)  
        ,@IsActive   
        ,0  
        ,GETDATE()  
        ,@LoginUserId)  
  
    SET @GradeId =SCOPE_IDENTITY()  
  
   END  
   ELSE  
   BEGIN  
    UPDATE tblGradeMaster  
      SET GradeName = @GradeName        
       ,CostCenterId = @CostCenterId       
       ,GenderTypeId = @GenderTypeId  

	   ,DebitAccount = @DebitAccount
		,CreditAccount = @CreditAccount

       ,IsActive = @IsActive        
       ,UpdateDate = GETDATE()  
       ,UpdateBy = @LoginUserId  
    WHERE GradeId = @GradeId      
   END  
   COMMIT TRAN TRANS1  
  SELECT 0 AS Result, 'Saved' AS Response  
 END TRY  
  
 BEGIN CATCH  
   ROLLBACK TRAN TRANS1  
   SELECT -1 AS Result, 'Error!' AS Response  
   EXEC usp_SaveErrorDetail  
   RETURN  
 END CATCH  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveGradeWiseFeeStructure]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveGradeWiseFeeStructure]
	@LoginUserId INT
	,@FeeGradewiseId BIGINT
	,@FirstAmount DECIMAL(18,4)=NULL
	,@FirstDueDate DATETIME=NULL
	,@SecondAmount DECIMAL(18,4)=NULL
	,@SecondDueDate DATETIME=NULL
	,@ThirdAmount DECIMAL(18,4)=NULL
	,@ThirdDueDate DATETIME=NULL
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1			
		UPDATE [dbo].[tblFeeGradewise]
				SET [FirstAmount] = @FirstAmount
					,[FirstDueDate] = @FirstDueDate
					,[SecondAmount] = @SecondAmount
					,[SecondDueDate] = @SecondDueDate
					,[ThirdAmount] = @ThirdAmount
					,[ThirdDueDate] = @ThirdDueDate					
					,[UpdateDate] = GETDATE()
					,[UpdateBy] = @LoginUserId
		WHERE FeeGradewiseId = @FeeGradewiseId
		SELECT 0 AS Result, 'Saved' AS Response						
		COMMIT TRAN TRANS1		
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveInvoice]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveInvoice] 
	@LoginUserId int 
	,@PaymentMethod	nvarchar(100)
	,@PaymentReferenceNumber	nvarchar(100)
	,@Status	nvarchar(20)	
	,@ParentID	nvarchar(100)
	,@IqamaNumber	nvarchar(100)	
	,@InvoiceDate	datetime	
AS      
BEGIN      
 SET NOCOUNT ON;      
 --IF EXISTS(SELECT 1 FROM tblInvoiceSummary WHERE @InvoiceNo <> InvoiceNo AND IsDeleted = 1)      
 --BEGIN      
 -- SELECT -2 AS Result, 'Invoice already exists!' AS Response      
 -- RETURN;      
 --END      
 BEGIN TRY      
	BEGIN TRANSACTION TRANS1 
	DECLARE @_InvoiceNo int
	IF (@_InvoiceNo IS NULL)
	BEGIN
		SELECT @_InvoiceNo=COUNT(*)+1 FROM tblInvoiceSummary WHERE IsDeleted=0
	END
    INSERT INTO tblInvoiceSummary	
	(
		InvoiceNo
		,PaymentMethod
		,PaymentReferenceNumber
		,[Status]
		,ParentID
		,IqamaNumber
		,InvoiceDate
		,IsDeleted      
		,UpdateDate      
		,UpdateBy
	)      
	VALUES      
	(          
		@_InvoiceNo
		,@PaymentMethod
		,@PaymentReferenceNumber
		,@Status
		,@ParentID
		,@IqamaNumber
		,@InvoiceDate
		,0      
		,GETDATE()      
		,@LoginUserId
	) 
	COMMIT TRAN TRANS1      
	SELECT 0 AS Result, 'Saved' AS Response ,@_InvoiceNo AS InvoiceNo
	END TRY 
	BEGIN CATCH      
		ROLLBACK TRAN TRANS1      
		SELECT -1 AS Result, 'Error!' AS Response      
		EXEC usp_SaveErrorDetail      
		RETURN      
	END CATCH      
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveInvoiceDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveInvoiceDetail]      
	@LoginUserId int      
	,@InvoiceNo	nvarchar(100)
	,@InvoiceType	nvarchar(100)
	,@Description	nvarchar(300)
	,@Discount	decimal(18,2)
	,@Quantity	decimal(18,2)
	,@UnitPrice	decimal(18,2)
	,@StudentId	nvarchar(100)
	,@Grade	nvarchar(100)
	,@TaxableAmount	decimal(18,2)
	,@TaxRate	decimal(18,2)
	,@TaxAmount	decimal(18,2)
	,@ItemSubtotal	decimal(18,2)
AS      
BEGIN      
	SET NOCOUNT ON;      
	IF EXISTS(SELECT 1 FROM tblInvoiceDetail WHERE @InvoiceNo <> InvoiceNo)      
	BEGIN      
		SELECT -2 AS Result, 'Invoice Detail already exists!' AS Response      
		RETURN;      
	END      
	BEGIN TRY      
		BEGIN TRANSACTION TRANS1 
		INSERT INTO tblInvoiceDetail      
		(
			InvoiceNo
			,InvoiceType
			,[Description]
			,Discount
			,Quantity
			,UnitPrice
			,StudentId
			,Grade
			,TaxableAmount
			,TaxRate
			,TaxAmount
			,ItemSubtotal
			,CreatedOn
			,CreatedBy
		)      
		VALUES      
		(          
			@InvoiceNo
			,@InvoiceType
			,@Description
			,@Discount
			,@Quantity
			,@UnitPrice
			,@StudentId
			,@Grade
			,@TaxableAmount
			,@TaxRate
			,@TaxAmount
			,@ItemSubtotal			 
			,GETDATE()      
			,@LoginUserId
		)  
	  COMMIT TRAN TRANS1      
	  SELECT 0 AS Result, 'Saved' AS Response      
	END TRY 
	BEGIN CATCH      
		ROLLBACK TRAN TRANS1      
		SELECT -1 AS Result, 'Error!' AS Response      
		EXEC usp_SaveErrorDetail      
		RETURN      
	END CATCH      
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveInvoiceToStatement]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[sp_SaveInvoiceToStatement]
  @invoiceno bigint=0   ,      
  @DestinationDB nvarchar(50) = ''           
AS      
BEGIN      
       begin try  
 SET NOCOUNT ON;      
 DECLARE @FeeTypeId INT =3;      
 DECLARE @GradeId int=0;      
 SELECT TOP 1  @FeeTypeId=ISNULL(FeeTypeId,3) FROM tblFeeTypeMaster WHERE  FeeTypeName LIKE '%TUITION%'       
 DECLARE @FeeStatementType NVARCHAR(50)='Fee Paid'        
      
    
 INSERT INTO [dbo].[tblFeeStatement]      
 (      
  [FeeStatementType],[FeeType],[FeeAmount],[PaidAmount],[StudentId],[ParentId],[StudentName],[ParentName],[AcademicYearId],[GradeId],[InvoiceNo],[InvoiceDate],[PaymentMethod]      
  ,[IsActive],[IsDeleted],[UpdateDate],[UpdateBy]      
 )      
 SELECT        
  @FeeStatementType    
  ,FeeTypeName=case when invSum.InvoiceType='Invoice' then 'TUITION FEE' else 'TUITION FEE REFUND' end      
  ,[FeeAmount]=0  
  ,[PaidAmount]=case when invSum.InvoiceType='Invoice' then invDet.TaxableAmount else invDet.TaxableAmount*-1 end    
  ,invDet.StudentId,invDet.[ParentId],invDet.StudentName ,invDet.ParentName    
  ,invDet.AcademicYear,invDet.GradeId   
  ,invSum.InvoiceNo  
  ,invSum.InvoiceDate  
  ,invpay.PaymentMethod  
  ,IsActive=1      
  ,IsDeleted=0      
  ,UpdateDate=GETDATE()      
  ,UpdateBy=0     
 from INV_InvoiceDetail invDet    
 join INV_InvoiceSummary invSum on invDet.InvoiceNo=invSum.InvoiceNo    
 join INV_InvoicePayment invpay on invpay.InvoiceNo=invSum.InvoiceNo    
 where invSum.invoiceno=@InvoiceNo    
 and invSum.InvoiceType='Invoice'     
 and invDet.InvoiceType like '%TUITION%'    

 ----Process GP integration
 exec [sp_ProcessGP_UniformInvoice] @invoiceno,@DestinationDB
    
 select 0 result  
 end TRY  
 begin catch  
   
 select -1 result  
 end catch  
  
END  
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveInvoiceType]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveInvoiceType]
	@LoginUserId int
	,@InvoiceTypeId bigint
	,@InvoiceTypeName nvarchar(200)
	,@ReceivableAccount nvarchar(200)
	,@AdvanceAccount nvarchar(200)
	,@ReceivableAccountRemarks nvarchar(400)
	,@AdvanceAccountRemarks nvarchar(400)
	,@IsActive bit
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblInvoiceTypeMaster WHERE InvoiceTypeName = @InvoiceTypeName
			AND InvoiceTypeId <> @InvoiceTypeId AND IsActive = 1)
	BEGIN
		SELECT -2 AS Result, 'Invoice Type already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@InvoiceTypeId = 0)
			BEGIN
				INSERT INTO tblInvoiceTypeMaster
					   (InvoiceTypeName	
					   ,ReceivableAccount
					   ,AdvanceAccount
					   ,ReceivableAccountRemarks
					   ,AdvanceAccountRemarks
					   ,IsActive
					   ,IsDeleted
					   ,UpdateDate
					   ,UpdateBy)
				VALUES
					   (@InvoiceTypeName
					    ,@ReceivableAccount
					   ,@AdvanceAccount
					   ,@ReceivableAccountRemarks
					   ,@AdvanceAccountRemarks
					   ,@IsActive	
					   ,0
					   ,GETDATE()
					   ,@LoginUserId)
			END
			ELSE
			BEGIN
				UPDATE tblInvoiceTypeMaster
						SET InvoiceTypeName = @InvoiceTypeName	
						,ReceivableAccount = @ReceivableAccount
					        ,AdvanceAccount = @AdvanceAccount
							,ReceivableAccountRemarks = @ReceivableAccountRemarks   
					        ,AdvanceAccountRemarks = @AdvanceAccountRemarks
							,IsActive = @IsActive						
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE InvoiceTypeId = @InvoiceTypeId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveNotification]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveNotification]
	@LoginUserId int
	,@ActionTable nvarchar(200)
	,@NotificationAction nvarchar(200)
	,@TableRecordId bigint
	,@OldValueJson nvarchar(1000)
	,@NewValueJson nvarchar(1000)
	,@TableRecordColumnName nvarchar(200)=null
AS
BEGIN 
	SET NOCOUNT ON;
	DECLARE @NotificationGroupId int=0
	DECLARE @NotificationTypeId int
	BEGIN TRY
		BEGIN TRANSACTION TRANS2
		--Create or Increase Notification Group Count
		BEGIN
			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable=@ActionTable
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=@NotificationAction
			IF (@NotificationGroupId=0)
			BEGIN
				INSERT INTO tblNotificationGroup (NotificationTypeId,NotificationCount,NotificationAction)
				VALUES (@NotificationTypeId,0,@NotificationAction)
				SET @NotificationGroupId=SCOPE_IDENTITY();
			END
			UPDATE tblNotificationGroup SET NotificationCount=NotificationCount+1 WHERE NotificationGroupId=@NotificationGroupId
		END
		--Insert Notification
		BEGIN
			INSERT INTO tblNotificationGroupDetail
					(NotificationGroupId
					,NotificationTypeId
					,NotificationAction
					,TableRecordId
					,OldValueJson
					,NewValueJson
					,TableRecordColumnName
					,CreatedBy)
			VALUES
					(@NotificationGroupId											  
					,@NotificationTypeId	
					,@NotificationAction
					,@TableRecordId
					,@OldValueJson
					,@NewValueJson
					,@TableRecordColumnName
					,@LoginUserId)
		END		
		COMMIT TRAN TRANS2
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS2
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveOpenApply]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_SaveOpenApply]  
	@LoginUserId int  
	,@OpenApplyId bigint  
	,@GrantType nvarchar(200)  
	,@ClientId nvarchar(200)  
	,@ClientSecret nvarchar(200)  
	,@Audience nvarchar(200)  
	,@OpenApplyJobPath nvarchar(200)  
	,@IsActive bit  
AS  
BEGIN  
 SET NOCOUNT ON;  
 
 BEGIN TRY  
  BEGIN TRANSACTION TRANS1  
   IF(@OpenApplyId = 0)  
   BEGIN  
    INSERT INTO [tblOpenApplyMaster]  
        (
			GrantType
			,ClientId
			,ClientSecret
			,Audience
			,OpenApplyJobPath

			,IsActive  
			,IsDeleted  
			,UpdateDate  
			,UpdateBy
		)  
    VALUES  
        (
			 @GrantType
			,@ClientId
			,@ClientSecret
			,@Audience
			,@OpenApplyJobPath

			,@IsActive   
			,0  
			,GETDATE()  
			,@LoginUserId
		)  

		--SET @OpenApplyId=SCOPE_IDENTITY();
		--SELECT @OpenApplyId AS Result, 'Saved' AS Response
		SELECT 0 AS Result, 'Saved' AS Response  
   END  
   ELSE  
   BEGIN  
    UPDATE [tblOpenApplyMaster]  
      SET 
		GrantType = @GrantType
		,ClientId = @ClientId
		,ClientSecret = @ClientSecret
		,Audience = @Audience
		,OpenApplyJobPath = @OpenApplyJobPath

       ,IsActive = @IsActive        
       ,UpdateDate = GETDATE()  
       ,UpdateBy = @LoginUserId  
    WHERE OpenApplyId = @OpenApplyId  
   END      
  COMMIT TRAN TRANS1  
  SELECT 0 AS Result, 'Saved' AS Response  
 END TRY  
  
 BEGIN CATCH  
   ROLLBACK TRAN TRANS1  
   SELECT -1 AS Result, 'Error!' AS Response  
   EXEC usp_SaveErrorDetail  
   RETURN  
 END CATCH  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveOtherDiscountDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveOtherDiscountDetail]	@LoginUserId int,	@StudentOtherDiscountDetailId bigint,    @StudentId bigint,   	@AcademicYearId int,    @DiscountName nvarchar(250),    @DiscountAmount decimal(18, 4)ASBEGIN    SET NOCOUNT ON;	    BEGIN TRY        BEGIN
		TRANSACTION TRANS1		DECLARE @FeeTypeId INT =3;		DECLARE @GradeId int=0;		SELECT TOP 1  @FeeTypeId=ISNULL(FeeTypeId,3) FROM tblFeeTypeMaster WHERE  FeeTypeName LIKE '%TUITION%'					SELECT TOP 1  @GradeId=ISNULL(GradeId,0) FROM tblStudent WHERE  StudentId=@StudentId	       		--DECLARE @FeeStatementType NVARCHAR(50)=@DiscountName +' Discount Applied'		IF(@StudentOtherDiscountDetailId = 0)        BEGIN			INSERT INTO [dbo].[tblStudentOtherDiscountDetail]			([StudentId],[AcademicYearId],[GradeId],[FeeTypeId],[DiscountName],[DiscountAmount],[DiscountStatus],[IsActive],[IsDeleted],[UpdateDate],[UpdateBy])			 VALUES			(@StudentId,@AcademicYearId,@GradeId,@FeeTypeId,@DiscountName,Convert(DECIMAL(18,4),@DiscountAmount),1,1,0,GETDATE(),@LoginUserId )	        END        ELSE        BEGIN            UPDATE tblStudentOtherDiscountDetail                SET DiscountAmount = Convert(DECIMAL(18,4),@DiscountAmount),					DiscountName = @DiscountName,                    UpdateDate = GETDATE(),                    UpdateBy = @LoginUserId -- Replace '1' with a valid user ID or use @LoginUserId if available            WHERE StudentOtherDiscountDetailId = @StudentOtherDiscountDetailId        END        COMMIT TRAN TRANS1    
 
   SELECT 0 AS Result, 'Saved' AS Response    END TRY    BEGIN CATCH        ROLLBACK TRAN TRANS1        SELECT -1 AS Result, 'Error!' AS Response        EXEC usp_SaveErrorDetail        RETURN;    END CATCHEND
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveParent]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_SaveParent]
	@LoginUserId int
	,@ParentId bigint
	,@ParentCode nvarchar(50)
	,@ParentImage nvarchar(500)=NULL
	,@FatherName nvarchar(200)
	,@FatherArabicName nvarchar(200) = NULL
	,@FatherNationalityId int
	,@FatherMobile nvarchar(20)
	,@FatherEmail nvarchar(200)
	,@FatherIqamaNo nvarchar(50)
	,@IsFatherStaff	bit
	,@MotherName nvarchar(200)
	,@MotherArabicName nvarchar(200) = NULL
	,@MotherNationalityId int
	,@MotherMobile nvarchar(20) = NULL
	,@MotherEmail nvarchar(200) = NULL
	,@MotherIqamaNo nvarchar(50) = NULL
	,@IsMotherStaff bit
	,@FPassword nvarchar(500) = NULL
	,@IsActive bit
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblParent WHERE  ParentCode = @ParentCode
			AND ParentId <> @ParentId AND IsActive = 1)
	BEGIN
		SELECT -2 AS Result, 'Parent already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@ParentId = 0)
			BEGIN
			    
				INSERT INTO tblParent
					   (ParentCode
					    ,ParentImage
						,FatherName
						,FatherArabicName
						,FatherNationalityId
						,FatherMobile
						,FatherEmail
						,FatherIqamaNo
						,IsFatherStaff
						,MotherName
						,MotherArabicName
						,MotherNationalityId
						,MotherMobile
						,MotherEmail
						,MotherIqamaNo
						,IsMotherStaff
						,IsActive
					   ,IsDeleted
					   ,UpdateDate
					   ,UpdateBy)
				VALUES
					   (@ParentCode
					   ,CASE WHEN LEN(ISNULL(@ParentImage,0))>0 THEN @ParentImage ELSE '' END
						,@FatherName
						,@FatherArabicName
						,@FatherNationalityId
						,@FatherMobile
						,@FatherEmail
						,@FatherIqamaNo
						,@IsFatherStaff
						,@MotherName
						,@MotherArabicName
						,@MotherNationalityId
						,@MotherMobile
						,@MotherEmail
						,@MotherIqamaNo
						,@IsMotherStaff
						,@IsActive
					   ,0
					   ,GETDATE()
					   ,@LoginUserId);

				SET @ParentId=SCOPE_IDENTITY();
				--DECLARE @ParentCode VARCHAR(50) =  (SELECT CONCAT(@ParentPrefix, (right('000000'+convert(nvarchar(10),@ParentId),6))));

				--UPDATE tblParent SET ParentCode = @ParentCode WHERE ParentId= @ParentId

				EXEC sp_SaveUser @LoginUserId=@LoginUserId,@UserId=0,@UserName=@FatherName,@UserArabicName=@FatherArabicName,@UserEmail=@FatherEmail
				,@UserPhone=@FatherMobile,@UserPass=@FPassword,@RoleId=3,@IsActive=1,@IsApprover=0 
				SELECT @ParentId AS Result, 'Saved' AS Response
			END
			ELSE
			BEGIN
				UPDATE tblParent
						SET FatherName = @FatherName
						,ParentCode = @ParentCode
						,ParentImage=CASE WHEN LEN(ISNULL(@ParentImage,0))>0 THEN ParentImage ELSE @ParentImage END
						,FatherArabicName= @FatherArabicName
						,FatherNationalityId= @FatherNationalityId
						,FatherMobile= @FatherMobile
						,FatherEmail= @FatherEmail
						,FatherIqamaNo=@FatherIqamaNo
						,IsFatherStaff= @IsFatherStaff
						,MotherName= @MotherName
						,MotherArabicName= @MotherArabicName
						,MotherNationalityId= @MotherNationalityId
						,MotherMobile= @MotherMobile
						,MotherEmail= @MotherEmail
						,MotherIqamaNo=@MotherIqamaNo
						,IsMotherStaff= @IsMotherStaff
						,IsActive = @IsActive				
						,UpdateDate = GETDATE()
						,UpdateBy = @LoginUserId
				WHERE ParentId = @ParentId
				SELECT @ParentId AS Result, 'Saved' AS Response
			END				
		COMMIT TRAN TRANS1
		
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveParentAccount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveParentAccount] 
	@LoginUserId int
	,@ParentId bigint
	,@ReceivableAccount nvarchar(200)
	,@AdvanceAccount nvarchar(200)=NULL
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		IF NOT EXISTS(SELECT 1 FROM tblParentAccount WHERE ParentId = @ParentId)
		BEGIN
			INSERT INTO tblParentAccount(ParentId
					,ReceivableAccount
					,AdvanceAccount
					,IsActive
					,IsDeleted
					,UpdateDate
					,UpdateBy)
			VALUES(@ParentId,@ReceivableAccount,@AdvanceAccount,1,0,GETDATE(),@LoginUserId)
			SELECT 0 AS Result, 'Saved' AS Response
		END
		ELSE 
		BEGIN			
			UPDATE tblParentAccount
				SET ReceivableAccount = @ReceivableAccount
					,AdvanceAccount = @AdvanceAccount
					,UpdateBy = @LoginUserId
					,UpdateDate = GETDATE()
			WHERE ParentId = @ParentId		
			SELECT 0 AS Result, 'Saved' AS Response
		END
		COMMIT TRAN TRANS1
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SavePaymentMethod]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SavePaymentMethod]
	@PaymentMethodId bigint
	,@PaymentMethodCategoryId bigint
	,@PaymentMethodName nvarchar(200)
	,@DebitAccount nvarchar(200)
	,@CreditAccount nvarchar(200)
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblPaymentMethod WHERE PaymentMethodName = @PaymentMethodName
			AND PaymentMethodId <> @PaymentMethodId AND IsActive = 1)
	BEGIN
		SELECT -2 AS Result, 'Payment Method already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@PaymentMethodId = 0)
			BEGIN
				INSERT INTO tblPaymentMethod
					   (PaymentMethodCategoryId
					   ,PaymentMethodName
					   ,DebitAccount
					   ,CreditAccount
						,IsActive
						,IsDeleted
						,UpdateDate
						,UpdateBy)
				VALUES
					   (@PaymentMethodCategoryId
					   ,@PaymentMethodName
					   ,@DebitAccount
					   ,@CreditAccount
					   ,1
					   ,0
					   ,GETDATE()
					   ,1)
					   
			END
			ELSE
			BEGIN
				UPDATE tblPaymentMethod
						SET PaymentMethodCategoryId = @PaymentMethodCategoryId
						, PaymentMethodName = @PaymentMethodName
						,DebitAccount = @DebitAccount
						,CreditAccount = @CreditAccount
							,IsActive = 1		
							,UpdateDate = GETDATE()
							,UpdateBy = 1
				WHERE PaymentMethodId = @PaymentMethodId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SavePaymentMethodCategory]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SavePaymentMethodCategory]
    @PaymentMethodCategoryId bigint,
    @CategoryName nvarchar(200),
    @IsActive bit
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        BEGIN TRANSACTION TRANS1;

        IF EXISTS (SELECT 1 FROM tblPaymentMethodCategory WHERE PaymentMethodCategoryId <> @PaymentMethodCategoryId AND IsActive = 1)
        BEGIN
            IF (@PaymentMethodCategoryId > 0)
            BEGIN
                UPDATE tblPaymentMethodCategory
                SET 
                    CategoryName = @CategoryName,
                    IsActive = @IsActive,
                    UpdateDate = GETDATE(),
                    UpdateBy = 1
                WHERE 
                    PaymentMethodCategoryId = @PaymentMethodCategoryId;
            END
        END

        COMMIT TRANSACTION TRANS1;
        SELECT 0 AS Result, 'Saved' AS Response;
    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION TRANS1;
        SELECT -1 AS Result, 'Error!' AS Response;
        EXEC usp_SaveErrorDetail;
    END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSchool]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveSchool]
	@LoginUserId int
	,@SchoolId bigint
	,@LogoImage nvarchar(500)=NULL
	,@SchoolNameEnglish nvarchar(400)
	,@SchoolNameArabic nvarchar(400)=NULL
	,@BranchId bigint 
	,@CountryId bigint 
	,@City  nvarchar(200) =NULL
	,@Address nvarchar(400) =NULL
	,@Telephone nvarchar(20) =NULL
	,@SchoolEmail nvarchar(200) =NULL
	,@WebsiteUrl nvarchar(400) =NULL
	,@VatNo nvarchar(200) =NULL
	,@IsActive bit
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblSchoolMaster WHERE SchoolNameEnglish = @SchoolNameEnglish
			AND SchoolId <> @SchoolId AND IsActive = 1)
	BEGIN
		SELECT -2 AS Result, 'School already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@SchoolId = 0)
			BEGIN
				INSERT INTO tblSchoolMaster
					   ([SchoolNameEnglish]
					   ,[SchoolNameArabic]
					   ,Logo
					   ,[BranchId]
					   ,[CountryId]
					   ,[City]
					   ,[Address]
					   ,[Telephone]
					   ,[SchoolEmail]
					   ,[WebsiteUrl]
					   ,[VatNo]
					   ,[IsActive]
					   ,[IsDeleted]
					   ,[UpdateDate]
					   ,[UpdateBy])
				VALUES
					  (@SchoolNameEnglish
					   ,@SchoolNameArabic
					   ,CASE WHEN LEN(ISNULL(@LogoImage,0))>0 THEN @LogoImage ELSE '' END
					   ,@BranchId
					   ,@CountryId
					   ,@City
					   ,@Address
					   ,@Telephone
					   ,@SchoolEmail
					   ,@WebsiteUrl
					   ,@VatNo
					   ,@IsActive
					   ,0
					   ,GETDATE()
					   ,@LoginUserId)
					   SET @SchoolId=SCOPE_IDENTITY();
					   SELECT @SchoolId AS Result, 'Saved' AS Response
			END
			ELSE
			BEGIN
				UPDATE tblSchoolMaster
						SET SchoolNameEnglish= @SchoolNameEnglish
						   ,SchoolNameArabic=@SchoolNameArabic
						   	,Logo=CASE WHEN LEN(ISNULL(@LogoImage,0))>0 THEN Logo ELSE @LogoImage END
						   ,BranchId=@BranchId
						   ,CountryId=@CountryId
						   ,City=@City
						   ,[Address]=@Address
						   ,Telephone=@Telephone
						   ,SchoolEmail=@SchoolEmail
						   ,WebsiteUrl=@WebsiteUrl
						   ,VatNo=@VatNo
						   ,IsActive=@IsActive						
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE SchoolId = @SchoolId
			END				
		COMMIT TRAN TRANS1
		SELECT @SchoolId AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSchoolAcademic]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveSchoolAcademic]  
	@LoginUserId int  
	,@SchoolAcademicId int  
	,@AcademicYear nvarchar(200)    
	,@PeriodFrom datetime  
	,@PeriodTo datetime  
	,@DebitAccount nvarchar(200)  
	,@CreditAccount nvarchar(200)  
	,@IsActive bit  
AS  
BEGIN  
 SET NOCOUNT ON;  
 IF EXISTS(SELECT 1 FROM tblSchoolAcademic WHERE AcademicYear = @AcademicYear  
	AND SchoolAcademicId <> @SchoolAcademicId AND IsActive = 1
		AND 
		(   
			(cast( @PeriodFrom as date) between cast( PeriodFrom as date) AND cast(PeriodTo as date))
		OR
			(cast( @PeriodTo as date) between cast( PeriodFrom as date) AND cast(PeriodTo as date))
		)
	)  
 BEGIN  
  SELECT -2 AS Result, 'Academic year already exists!' AS Response  
  RETURN;  
 END 
 
 IF EXISTS(SELECT 1 FROM tblSchoolAcademic WHERE SchoolAcademicId <> @SchoolAcademicId AND IsActive = 1
		AND 
		(   
			(cast( @PeriodFrom as date) between cast( PeriodFrom as date) AND cast(PeriodTo as date))
		OR
			(cast( @PeriodTo as date) between cast( PeriodFrom as date) AND cast(PeriodTo as date))
		)
	)  
 BEGIN  
  SELECT -4 AS Result, 'Academic year already exists!' AS Response  
  RETURN;  
 END 

 BEGIN TRY  
  BEGIN TRANSACTION TRANS1  
   IF(@SchoolAcademicId = 0)  
   BEGIN  
    INSERT INTO tblSchoolAcademic  
        (AcademicYear  
      ,PeriodFrom  
      ,PeriodTo  
	  ,DebitAccount
		,CreditAccount
        ,IsActive  
        ,IsDeleted  
        ,UpdateDate  
        ,UpdateBy)  
    VALUES  
        (@AcademicYear  
        --,dbo.GetDateTimeFromTimeStamp(@PeriodFrom)  
        --,dbo.GetDateTimeFromTimeStamp(@PeriodTo) 
		,@PeriodFrom
        ,@PeriodTo
		,@DebitAccount
		,@CreditAccount
        ,@IsActive   
        ,0  
        ,GETDATE()  
        ,@LoginUserId)  
   END  
   ELSE  
   BEGIN  
    UPDATE tblSchoolAcademic  
      SET 
       AcademicYear = @AcademicYear  
       --,PeriodFrom = dbo.GetDateTimeFromTimeStamp(@PeriodFrom)        
       --,PeriodTo = dbo.GetDateTimeFromTimeStamp(@PeriodTo)
	   ,PeriodFrom = @PeriodFrom       
       ,PeriodTo =@PeriodTo
	    ,DebitAccount = @DebitAccount
		,CreditAccount = @CreditAccount
       ,IsActive = @IsActive        
       ,UpdateDate = GETDATE()  
       ,UpdateBy = @LoginUserId  
    WHERE SchoolAcademicId = @SchoolAcademicId  
   END      
  COMMIT TRAN TRANS1  
  SELECT 0 AS Result, 'Saved' AS Response  
 END TRY  
  
 BEGIN CATCH  
   ROLLBACK TRAN TRANS1  
   SELECT -1 AS Result, 'Error!' AS Response  
   EXEC usp_SaveErrorDetail  
   RETURN  
 END CATCH  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSchoolAccountInfo]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveSchoolAccountInfo]  
	@LoginUserId int  
	,@SchoolAccountIId bigint  
	,@SchoolId bigint  
	,@ReceivableAccount nvarchar(50)  
	,@AdvanceAccount nvarchar(50)  
	,@CodeDescription nvarchar(200)  
AS  
BEGIN  
 SET NOCOUNT ON;  
 IF EXISTS(SELECT 1 FROM tblSchoolAccountInfo WHERE CodeDescription = @CodeDescription AND SchoolId=@SchoolId  
   AND SchoolAccountIId <> @SchoolAccountIId AND IsActive = 1)  

 BEGIN  
  SELECT -2 AS Result, 'Account description already exists!' AS Response  
  RETURN;  
 END  
 BEGIN TRY  
  BEGIN TRANSACTION TRANS1  
   IF(@SchoolAccountIId = 0)  
   BEGIN  
    INSERT INTO tblSchoolAccountInfo  
        (SchoolId  
        ,ReceivableAccount
		 ,AdvanceAccount
        ,CodeDescription  
        ,IsActive  
        ,IsDeleted  
        ,UpdateDate  
        ,UpdateBy)  
    VALUES  
        (@SchoolId  
        ,@ReceivableAccount
		,@AdvanceAccount
        ,@CodeDescription           
        ,1   
        ,0  
        ,GETDATE()  
        ,@LoginUserId)  
   END  
   ELSE  
   BEGIN  
    UPDATE tblSchoolAccountInfo  
      SET SchoolId = @SchoolId  
       ,ReceivableAccount = @ReceivableAccount  
	   ,AdvanceAccount=@AdvanceAccount
       ,CodeDescription = @CodeDescription    
       ,UpdateDate = GETDATE()  
       ,UpdateBy = @LoginUserId  
    WHERE SchoolAccountIId = @SchoolAccountIId  
   END      
  COMMIT TRAN TRANS1  
  SELECT 0 AS Result, 'Saved' AS Response  
 END TRY  
  
 BEGIN CATCH  
   ROLLBACK TRAN TRANS1  
   SELECT -1 AS Result, 'Error!' AS Response  
   EXEC usp_SaveErrorDetail  
   RETURN  
 END CATCH  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSchoolTermAcademic]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- *** SqlDbx Personal Edition ***
-- !!! Not licensed for commercial use beyound 90 days evaluation period !!!
-- For version limitations please check http://www.sqldbx.com/personal_edition.htm
-- Number of queries executed: 15, number of rows retrieved: 48

CREATE PROCEDURE [dbo].[sp_SaveSchoolTermAcademic]      
 @LoginUserId int      
 ,@SchoolTermAcademicId int      
 ,@SchoolAcademicId int      
 ,@TermName nvarchar(100)      
 ,@StartDate datetime      
 ,@EndDate datetime          
AS      
BEGIN      
 SET NOCOUNT ON;      
 IF EXISTS(SELECT 1 FROM tblSchoolTermAcademic WHERE SchoolAcademicId = @SchoolAcademicId AND TermName=@TermName       
   AND SchoolTermAcademicId <> @SchoolTermAcademicId AND IsDeleted = 0)      
 BEGIN      
  SELECT -2 AS Result, 'Term Academic year already exists!' AS Response      
  RETURN;      
 END      
 IF EXISTS(SELECT 1 FROM tblSchoolAcademic sa      
    WHERE sa.SchoolAcademicId = @SchoolAcademicId AND sa.IsActive = 1      
    AND CONVERT(date,@StartDate)<CONVERT(date,sa.PeriodFrom))      
 BEGIN      
  SELECT -4 AS Result, 'Term Start Date can not be less then acadmic start date!' AS Response      
  RETURN;      
 END      
 IF EXISTS(SELECT 1 FROM tblSchoolAcademic sa      
    WHERE sa.SchoolAcademicId = @SchoolAcademicId AND sa.IsActive = 1      
    AND  CONVERT(date,@EndDate)>CONVERT(date,sa.PeriodTo))      
 BEGIN      
  SELECT -5 AS Result, 'Term End Date can not be greater then acadmic end date!' AS Response      
  RETURN;      
 END      
 IF @SchoolTermAcademicId=0      
 BEGIN       
  IF EXISTS(SELECT 1 FROM tblSchoolTermAcademic sta          
     WHERE  SchoolAcademicId = @SchoolAcademicId  AND sta.IsDeleted = 0    
     AND (CONVERT(date,@StartDate) BETWEEN CONVERT(date,sta.StartDate) AND CONVERT(date,sta.EndDate)      
     OR CONVERT(date,@EndDate) BETWEEN CONVERT(date,sta.StartDate) AND CONVERT(date,sta.EndDate)      
     ))      
  BEGIN      
   SELECT -5 AS Result, 'Term already exists' AS Response      
   RETURN;      
  END      
 END      
 BEGIN TRY      
  BEGIN TRANSACTION TRANS1      
   IF(@SchoolTermAcademicId = 0)      
   BEGIN      
    INSERT INTO tblSchoolTermAcademic      
        (      
      SchoolAcademicId      
      ,TermName             
      ,StartDate       
      ,EndDate    
	   ,IsApproved     
        ,IsRejected   
        ,IsDeleted      
        ,UpdateDate      
        ,UpdateBy)      
    VALUES      
        (@SchoolAcademicId      
        ,@TermName       
        ,@StartDate      
        ,@EndDate 
		,1
		,0   
        ,0      
        ,GETDATE()      
        ,@LoginUserId)      
   END      
   ELSE      
   BEGIN      
    UPDATE tblSchoolTermAcademic      
      SET SchoolAcademicId = @SchoolAcademicId      
       ,TermName = @TermName         
       ,StartDate = @StartDate         
       ,EndDate = @EndDate   
       ,UpdateDate = GETDATE()      
       ,UpdateBy = @LoginUserId      
    WHERE SchoolTermAcademicId = @SchoolTermAcademicId      
   END          
  COMMIT TRAN TRANS1      
  SELECT 0 AS Result, 'Saved' AS Response      
 END TRY      
      
 BEGIN CATCH      
   ROLLBACK TRAN TRANS1      
   SELECT -1 AS Result, 'Error!' AS Response      
   EXEC usp_SaveErrorDetail      
   RETURN      
 END CATCH      
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSection]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_SaveSection]
	@LoginUserId int
	,@SectionId int
	,@SectionName nvarchar(200)
	,@IsActive bit
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblSection WHERE SectionName = @SectionName 
			AND SectionId <> @SectionId AND IsActive = 1)
	BEGIN
		SELECT -2 AS Result, 'Section already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1		
			IF(@SectionId = 0)
			BEGIN
				INSERT INTO tblSection
					   (SectionName			  
					   ,IsActive
					   ,IsDeleted
					   ,UpdateDate
					   ,UpdateBy)
				VALUES
					   (@SectionName
					   ,@IsActive	
					   ,0
					   ,GETDATE()
					   ,@LoginUserId);				
			END
			ELSE
			BEGIN
				UPDATE tblSection
						SET SectionName = @SectionName
							,IsActive = @IsActive						
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE SectionId = @SectionId				  
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveSiblingDiscount]
	@LoginUserId int
	,@DiscountId int
	,@ChildrenNo int
	,@DiscountPercent decimal(5,2)
AS
BEGIN
	--DiscountId	ChildrenNo	DiscountPercent	IsActive	IsDeleted	UpdateDate	UpdateBy
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblSiblingDiscountMaster WHERE ChildrenNo = @ChildrenNo AND IsActive = 1 AND IsDeleted=0 AND @DiscountId=0)
	BEGIN
		SELECT -2 AS Result, 'Discount already exists for this children!' AS Response
		RETURN;
	END	
	IF EXISTS(SELECT 1 FROM tblSiblingDiscountMaster WHERE ChildrenNo = @ChildrenNo AND DiscountPercent = @DiscountPercent AND IsActive = 1 
	AND IsDeleted=0 AND @DiscountId>0)
	BEGIN
		SELECT -2 AS Result, 'Discount already exists for this children!' AS Response
		RETURN;
	END	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@DiscountId = 0)
			BEGIN
				INSERT INTO tblSiblingDiscountMaster
					   (ChildrenNo
					   ,DiscountPercent
						,IsActive
						,IsDeleted
						,UpdateDate
						,UpdateBy)
				VALUES
					   (@ChildrenNo	
					   ,@DiscountPercent
					   ,1	
					   ,0
					   ,GETDATE()
					   ,@LoginUserId)
			END
			ELSE
			BEGIN
				UPDATE tblSiblingDiscountMaster
						SET ChildrenNo = @ChildrenNo
							,DiscountPercent=@DiscountPercent
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE DiscountId = @DiscountId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END

GO
/****** Object:  StoredProcedure [dbo].[sp_SaveSiblingDiscountDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveSiblingDiscountDetail]	@LoginUserId int,	@StudentSiblingDiscountDetailId bigint,    @StudentId bigint,   	@AcademicYearId int,    @DiscountPercent decimal(5, 2)ASBEGIN	SET NOCOUNT ON;		BEGIN TRY	BEGIN
		TRANSACTION TRANS1		DECLARE @FeeTypeId INT =3;		DECLARE @GradeId int=0;		SELECT TOP 1  @FeeTypeId=ISNULL(FeeTypeId,3) FROM tblFeeTypeMaster WHERE  FeeTypeName LIKE '%TUITION%'					SELECT TOP 1  @GradeId=ISNULL(GradeId,0) FROM tblStudent WHERE  StudentId=@StudentId		IF(@StudentSiblingDiscountDetailId = 0)		BEGIN			IF EXISTS(SELECT 1 FROM tblStudentSiblingDiscountDetail 					WHERE StudentId=@StudentId 						AND AcademicYearId=@AcademicYearId AND GradeId=@GradeId AND FeeTypeId=@FeeTypeId						AND DiscountStatus<>6						AND IsDeleted=0 AND IsActive=1)			BEGIN				SELECT -2 AS Result, 'Data already exists' AS Response				COMMIT TRAN TRANS1 				RETURN;			END			INSERT INTO [dbo].[tblStudentSiblingDiscountDetail]			([StudentId],[AcademicYearId],[GradeId],[FeeTypeId],[DiscountPercent],[DiscountStatus],[IsActive],[IsDeleted],[UpdateDate],[UpdateBy])			VALUES			(@StudentId,@AcademicYearId,@GradeId,@FeeTypeId,@DiscountPercent,1,1,0,GETDATE(),@LoginUserId )		END		ELSE		BEGIN			UPDATE tblStudentSiblingDiscountDetail			SET DiscountPercent = @DiscountPercent,			UpdateDate = GETDATE(),			UpdateBy = @LoginUserId			WHERE StudentSiblingDiscountDetailId = @StudentSiblingDiscountDetailId		END		COMMIT TRAN TRANS1 
		SELECT 0 AS Result, 'Saved' AS Response	END TRY	BEGIN CATCH		ROLLBACK TRAN TRANS1		SELECT -1 AS Result, 'Error!' AS Response		EXEC usp_SaveErrorDetail		RETURN;	END CATCHEND
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveStudent]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_SaveStudent]  
 @LoginUserId int  
 ,@StudentId bigint  
 ,@ParentId int  
 ,@StudentCode nvarchar(50)  
 ,@StudentName nvarchar(200)  
 ,@StudentImage nvarchar(500)=NULL  
 ,@StudentEmail nvarchar(200)=NULL  
 ,@StudentArabicName nvarchar(200) =NULL  
 ,@DOB datetime  
 ,@IqamaNo nvarchar(100)  
 ,@NationalityId int  
 ,@GenderId int  
 ,@AdmissionDate datetime = NULL  
 ,@GradeId int  
 ,@CostCenterId int  
 ,@SectionId int  
 ,@PassportNo nvarchar(50)=NULL  
 ,@PassportExpiry datetime=NULL  
 ,@Mobile nvarchar(20)=NULL  
 ,@StudentAddress nvarchar(400)  
 ,@StudentStatusId int  
 ,@WithdrawDate datetime =NULL  
 ,@WithdrawAt int=null  
 ,@WithdrawYear nvarchar(20)=NULL  
 ,@Fees decimal(12,2)=NULL  
 ,@IsGPIntegration bit  
 ,@TermId int  
 ,@AdmissionYear nvarchar(20) = NULL  
 ,@PrinceAccount bit  
 ,@UserPass nvarchar(500)= NULL  
 ,@IsActive bit  
AS  
BEGIN  
 SET NOCOUNT ON;  
 IF EXISTS(SELECT 1 FROM tblStudent WHERE StudentCode = @StudentCode  
   AND StudentId <> @StudentId AND IsActive = 1)  
 BEGIN  
  SELECT -2 AS Result, 'Student already exists!' AS Response  
  RETURN;  
 END  
 BEGIN TRY  
  BEGIN TRANSACTION TRANS1  
   IF(@StudentId = 0)  
   BEGIN  
         
    INSERT INTO tblStudent  
                  ([StudentCode]  
           ,[StudentImage]  
           ,[ParentId]  
           ,[StudentName]  
           ,[StudentArabicName]  
           ,[StudentEmail]  
           ,[DOB]  
           ,[IqamaNo]  
           ,[NationalityId]  
           ,[GenderId]  
           ,[AdmissionDate]  
           ,[GradeId]  
           ,[CostCenterId]  
           ,[SectionId]  
           ,[PassportNo]  
           ,[PassportExpiry]  
           ,[Mobile]  
           ,[StudentAddress]  
           ,[StudentStatusId]  
           ,[WithdrawDate]  
           ,[WithdrawAt]  
           ,[WithdrawYear]  
           ,[Fees]  
           ,[IsGPIntegration]  
           ,[TermId]  
           ,[AdmissionYear]  
           ,[PrinceAccount]  
           ,[IsActive]  
           ,[IsDeleted]  
           ,[UpdateDate]  
           ,[UpdateBy])  
    VALUES      
        (@StudentCode        
      ,CASE WHEN LEN(ISNULL(@StudentImage,0))>0 THEN @StudentImage ELSE '' END  
      ,@ParentId  
      ,@StudentName  
      ,@StudentArabicName  
      ,@StudentEmail  
      ,@DOB  
      ,@IqamaNo  
      ,@NationalityId  
      ,@GenderId  
      ,CASE WHEN @AdmissionDate IS NULL THEN NULL ELSE  @AdmissionDate END  
      ,@GradeId  
      ,@CostCenterId  
      ,@SectionId  
      ,@PassportNo  
      ,CASE WHEN @PassportExpiry IS NULL THEN NULL ELSE @PassportExpiry END  
      ,@Mobile  
      ,@StudentAddress  
      ,@StudentStatusId  
      ,CASE WHEN @WithdrawDate IS NULL THEN NULL ELSE @WithdrawDate END  
      ,@WithdrawAt  
      ,@WithdrawYear  
      ,@Fees  
      ,@IsGPIntegration  
      ,@TermId  
      ,@AdmissionYear  
      ,@PrinceAccount  
      ,@IsActive  
        ,0  
        ,GETDATE()  
        ,@LoginUserId);  
  
    SET @StudentId=SCOPE_IDENTITY();  
      
    EXEC sp_SaveUser @LoginUserId=@LoginUserId,@UserId=0,@UserName=@StudentName,@UserArabicName=@StudentArabicName,@UserEmail=@StudentEmail  
    ,@UserPhone=@Mobile,@UserPass=@UserPass,@RoleId=2,@IsActive=1 ,@IsApprover=0 
    SELECT @StudentId AS Result, 'Saved' AS Response  
   END  
   ELSE  
   BEGIN  
    UPDATE tblStudent  
      SET   
      ParentId=@ParentId  
      ,StudentCode = @StudentCode  
      ,StudentName=@StudentName  
      ,StudentArabicName=@StudentArabicName  
      ,StudentImage=CASE WHEN LEN(ISNULL(@StudentImage,0))>0 THEN StudentImage ELSE @StudentImage END       
      ,StudentEmail=@StudentEmail  
      ,DOB=@DOB  
      ,IqamaNo=@IqamaNo  
      ,NationalityId=@NationalityId  
      ,GenderId=@GenderId  
      ,AdmissionDate=CASE WHEN @AdmissionDate IS NULL THEN NULL ELSE @AdmissionDate END   
      ,GradeId=@GradeId  
      ,CostCenterId=@CostCenterId  
      ,SectionId=@SectionId  
      ,PassportNo=@PassportNo  
      ,PassportExpiry=CASE WHEN @PassportExpiry IS NULL THEN NULL ELSE @PassportExpiry END  
      ,Mobile=@Mobile  
      ,StudentAddress=@StudentAddress  
      ,StudentStatusId=@StudentStatusId  
      ,WithdrawDate=CASE WHEN @WithdrawDate IS NULL THEN NULL ELSE @WithdrawDate END  
      ,WithdrawAt=@WithdrawAt  
      ,WithdrawYear=@WithdrawYear  
      ,Fees=@Fees  
      ,IsGPIntegration=@IsGPIntegration  
      ,TermId=@TermId  
      ,AdmissionYear=@AdmissionYear  
      ,PrinceAccount=@PrinceAccount  
      ,IsActive=@IsActive     
      ,UpdateDate = GETDATE()  
      ,UpdateBy = @LoginUserId  
    WHERE StudentId = @StudentId  
    SELECT @StudentId AS Result, 'Saved' AS Response  
   END      
  COMMIT TRAN TRANS1  
    
 END TRY  
  
 BEGIN CATCH  
   ROLLBACK TRAN TRANS1     
   SELECT -1 AS Result, 'Error!' AS Response  
   EXEC usp_SaveErrorDetail  
   RETURN  
 END CATCH  
END 
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveStudentFeeDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveStudentFeeDetail]  
	@LoginUserId int  
	,@StudentFeeDetailId bigint
	,@StudentId bigint  
	,@AcademicYearId bigint
	,@GradeId bigint
	,@FeeTypeId bigint
	,@FeeAmount decimal(18,2)
AS  
BEGIN  
	SET NOCOUNT ON;  
	IF EXISTS(	SELECT 1 FROM tblStudentFeeDetail 
				WHERE StudentId = @StudentId 
					AND AcademicYearId=@AcademicYearId AND GradeId=@GradeId
					AND FeeTypeId =@FeeTypeId
					AND StudentFeeDetailId <> @StudentFeeDetailId 
					AND IsActive = 1 AND IsDeleted = 0)  
	BEGIN  
		SELECT -2 AS Result, 'Fee already exists!' AS Response  
		RETURN;  
	END 
	IF EXISTS(	SELECT 1 FROM tblFeeStatement 
				WHERE StudentId = @StudentId 
					AND AcademicYearId=@AcademicYearId AND GradeId=@GradeId					
					AND IsActive = 1 AND IsDeleted = 0
					AND FeeStatementType='Discount Applied')  
	BEGIN  
		SELECT -3 AS Result, 'Discount already applied!' AS Response  
		RETURN;  
	END 			SELECT TOP 1  @FeeTypeId=ISNULL(FeeTypeId,3) FROM tblFeeTypeMaster WHERE  FeeTypeName LIKE '%TUITION%'					SELECT TOP 1  @GradeId=ISNULL(GradeId,0) FROM tblStudent WHERE  StudentId=@StudentId	       	   DECLARE @FeeStatementType NVARCHAR(50)='Fee Applied'
	BEGIN TRY  
	BEGIN TRANSACTION TRANS1  
		IF(@StudentFeeDetailId = 0)  
		BEGIN  
			INSERT INTO tblStudentFeeDetail  
				(StudentId  
				,AcademicYearId  
				,GradeId  
				,FeeTypeId
				,FeeAmount
				,IsActive  
				,IsDeleted  
				,UpdateDate  
				,UpdateBy)  
			VALUES  
				(@StudentId
				,@AcademicYearId
				,@GradeId
				,@FeeTypeId
				,@FeeAmount
				,1   
				,0  
				,GETDATE()  
				,@LoginUserId)  

				--Insert discount Applied entry in statement					INSERT INTO [dbo].[tblFeeStatement]			(				[FeeStatementType],[FeeType],[FeeAmount],[PaidAmount],[StudentId],[ParentId],[StudentName],[ParentName],[AcademicYearId],[GradeId]				,[IsActive],[IsDeleted],[UpdateDate],[UpdateBy]			)			SELECT top 1				FeeStatementType=@FeeStatementType 						,FeeType=@FeeTypeId				,FeeAmount=FeeAmount				,PaidAmount=0				,StudentId=stu.StudentId				,ParentId=stu.ParentId				,StudentName=stu.StudentName				,ParentName=par.ParentId				
				,AcademicYearId=@AcademicYearId				,GradeId=@GradeId				,IsActive=1				,IsDeleted=0				,UpdateDate=GETDATE()				,UpdateBy=0			FROM tblStudentFeeDetail sfd					JOIN tblStudent stu on stu.StudentId=sfd.StudentId			JOIN tblParent par on stu.ParentId=par.ParentId			WHERE sfd.StudentId=@StudentId AND sfd.AcademicYearId=@AcademicYearId AND sfd.FeeTypeId=@FeeTypeId
		END  
		ELSE  
		BEGIN  
			UPDATE tblStudentFeeDetail  
				SET FeeAmount = @FeeAmount
					,UpdateDate = GETDATE()  
					,UpdateBy = @LoginUserId  
			WHERE StudentFeeDetailId = @StudentFeeDetailId  


			UPDATE  fee	SET FeeAmount=@FeeAmount			FROM tblFeeStatement fee						WHERE FeeStatementType=@FeeStatementType			AND StudentId=@StudentId			AND AcademicYearId= @AcademicYearId			AND GradeId = @GradeId
		END      
	COMMIT TRAN TRANS1  
	SELECT 0 AS Result, 'Saved' AS Response  
	END TRY
	BEGIN CATCH  
		ROLLBACK TRAN TRANS1  
		SELECT -1 AS Result, 'Error!' AS Response  
		EXEC usp_SaveErrorDetail  
		RETURN  
	END CATCH  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveStudentStatus]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveStudentStatus]
	@LoginUserId int
	,@StudentStatusId bigint
	,@StatusName nvarchar(200)
	,@IsActive bit
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblStudentStatus WHERE StatusName = @StatusName
			AND StudentStatusId <> @StudentStatusId AND IsActive = 1)
	BEGIN
		SELECT -2 AS Result, 'Student Status already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@StudentStatusId = 0)
			BEGIN
				INSERT INTO tblStudentStatus
					   (StatusName						  
					   ,IsActive
					   ,IsDeleted
					   ,UpdateDate
					   ,UpdateBy)
				VALUES
					   (@StatusName							  
					   ,@IsActive	
					   ,0
					   ,GETDATE()
					   ,@LoginUserId)
			END
			ELSE
			BEGIN
				UPDATE tblStudentStatus
						SET StatusName = @StatusName
							,IsActive = @IsActive						
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE StudentStatusId = @StudentStatusId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveUploadDocument]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_SaveUploadDocument]
	@LoginUserId int
	,@UploadedDocId bigint
	,@DocFor nvarchar(50)
	,@DocType int
	,@DocForId bigint
	,@DocNo nvarchar(50)
	,@DocPath nvarchar(400) = NULL
	,@IsActive bit
AS
BEGIN
	SET NOCOUNT ON;
		BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@UploadedDocId = 0)
			BEGIN
			    
			
INSERT INTO [dbo].[tblUploadDocument]([DocFor],[DocType],[DocForId],[DocNo],[DocPath]
           ,[IsActive],[IsDeleted],[UpdateDate],[UpdateBy])
     VALUES (
		   @DocFor,@DocType,@DocForId,@DocNo,@DocPath
           ,@IsActive,0 ,GETDATE(),@LoginUserId)

			

			END
			ELSE
			BEGIN
				UPDATE tblUploadDocument
						SET [DocFor] = @DocFor
						,[DocType]= @DocType
						,[DocForId]= @DocForId
						,[DocNo]= @DocNo
						,[DocPath]= @DocPath
						,[IsActive]= @IsActive
						,UpdateDate = GETDATE()
						,UpdateBy = @LoginUserId
				WHERE UploadedDocId = @UploadedDocId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveUser]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SaveUser]
	@LoginUserId int
	,@UserId int
	,@UserName nvarchar(200)
	,@UserArabicName nvarchar(500)
	,@UserEmail nvarchar(200)
	,@UserPhone nvarchar(20) = NULL
	,@UserPass nvarchar(500) = NULL
	,@RoleId int
	,@IsActive bit
	,@IsApprover bit
AS
BEGIN
	SET NOCOUNT ON;
	IF EXISTS(SELECT 1 FROM tblUser WHERE UserEmail = @UserEmail 
			AND UserId <> @UserId AND IsActive = 1)
	BEGIN
		SELECT -2 AS Result, 'User already exists!' AS Response
		RETURN;
	END
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
			IF(@UserId = 0)
			BEGIN
				INSERT INTO tblUser
					   (UserName
					   ,UserArabicName
					   ,UserEmail
					   ,UserPhone
					   ,UserPass
					   ,RoleId					  
					   ,IsApprover				  
					   ,IsActive
					   ,IsDeleted
					   ,UpdateDate
					   ,UpdateBy)
				VALUES
					   (@UserName
					   ,@UserArabicName
					   ,@UserEmail
					   ,@UserPhone		  
					   ,@UserPass
					   ,@RoleId					  
					   ,@IsApprover				  
					   ,@IsActive	
					   ,0
					   ,GETDATE()
					   ,@LoginUserId)
			END
			ELSE
			BEGIN
				UPDATE tblUser
						SET UserName = @UserName
							,UserArabicName = @UserArabicName
							,UserEmail = @UserEmail
							,UserPhone = @UserPhone
							,UserPass = @UserPass
							,RoleId = @RoleId						
							,IsApprover = @IsApprover						
							,IsActive = @IsActive					
							,UpdateDate = GETDATE()
							,UpdateBy = @LoginUserId
				WHERE UserId = @UserId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END


GO
/****** Object:  StoredProcedure [dbo].[sp_SaveUserImage]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_SaveUserImage] 
	@LoginUserId int
	,@UserId int
	,@ImgPath nvarchar(500)
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		UPDATE tblUser
			SET ProfileImg = @ImgPath
				,UpdateBy = @LoginUserId
				,UpdateDate = GETDATE()
		WHERE UserId = @UserId
					
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SaveVat]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--alter table tblVatMaster drop column GLAccount
--alter table tblVatMaster add DebitAccount nvarchar(200)
--alter table tblVatMaster add CreditAccount nvarchar(200)

CREATE PROCEDURE [dbo].[sp_SaveVat]  
 @LoginUserId int  
 ,@VatId bigint  
 ,@FeeTypeId bigint  
 ,@VatTaxPercent decimal(18,2)  
 ,@DebitAccount nvarchar(200)  
  ,@CreditAccount nvarchar(200)  
AS  
BEGIN  
 SET NOCOUNT ON;  
 IF EXISTS(SELECT 1 FROM tblVatMaster WHERE FeeTypeId=@FeeTypeId and VatId<>@VatId AND IsActive = 1 AND IsDeleted=0)  
 BEGIN  
  SELECT -2 AS Result, 'Vat already exists!' AS Response  
  RETURN;  
 END  
 BEGIN TRY  
  BEGIN TRANSACTION TRANS1  
   IF(@VatId = 0)  
   BEGIN  
    INSERT INTO tblVatMaster  
        (  
        FeeTypeId  
        ,VatTaxPercent  
        ,DebitAccount  
		,CreditAccount  
        ,IsActive  
        ,IsDeleted  
        ,UpdateDate  
        ,UpdateBy)  
    VALUES  
        (  
        @FeeTypeId  
        ,@VatTaxPercent                
        ,@DebitAccount   
		,@CreditAccount   
        ,1  
        ,0  
        ,GETDATE()  
        ,@LoginUserId)  
   END  
   ELSE  
   BEGIN  
    UPDATE tblVatMaster  
      SET FeeTypeId = @FeeTypeId  
       ,VatTaxPercent = @VatTaxPercent  
       ,DebitAccount  = @DebitAccount    
	   ,CreditAccount  = @CreditAccount    
       ,UpdateDate = GETDATE()  
       ,UpdateBy = @LoginUserId  
    WHERE VatId = @VatId  
   END      
  COMMIT TRAN TRANS1  
  SELECT 0 AS Result, 'Saved' AS Response  
 END TRY  
  
 BEGIN CATCH  
   ROLLBACK TRAN TRANS1  
   SELECT -1 AS Result, 'Error!' AS Response  
   EXEC usp_SaveErrorDetail  
   RETURN  
 END CATCH  
END
GO
/****** Object:  StoredProcedure [dbo].[SP_TotalRevenueReport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROC [dbo].[SP_TotalRevenueReport] 
(
  @ParentId int=0
 ,@ParentName nvarchar(250)=null
 ,@FatherIqama nvarchar(250)=null
 ,@StudentName nvarchar(250)=null
 ,@AcademicYear int=0
 ,@InvoiceNo BigInt=0
 ,@StartDate datetime=null
 ,@EndDate datetime=null
)
AS
BEGIN

    SELECT 
        ParentId,
        ParentName,
        FatherMobile,
        IqamaNumber,
        StudentId,
        StudentName,
        GradeName,
        AcademicYear,
        IsStaff,
        TaxableAmount = SUM(TaxableAmount),
        TaxAmount = SUM(TaxAmount),
        ItemSubtotal = SUM(ItemSubtotal),
        InvoiceType,
        InvoiceDate,
        InvoiceNo,
        PaymentMethod,
        PaymentReferenceNumber
    FROM
    (
        SELECT 
            ParentId = ISNULL(invDet.ParentId, 0),
            invDet.ParentName,
            invDet.FatherMobile,
            StudentId = ISNULL(invDet.StudentId, 0),
            StudentName = ISNULL(invDet.StudentName, ''),
            tgm.GradeName,
            tsa.AcademicYear,
            invDet.IqamaNumber,
            invDet.IsStaff,
            invDet.TaxableAmount, 
            invDet.TaxAmount, 
            invDet.ItemSubtotal,
            invDet.InvoiceType,
            invSum.InvoiceNo,
            invSum.InvoiceDate,
            invPay.PaymentMethod,
             invPay.PaymentReferenceNumber
        FROM INV_InvoiceSummary invSum
        JOIN INV_InvoiceDetail invDet ON invSum.InvoiceNo = invDet.InvoiceNo
        JOIN tblGradeMaster tgm ON invDet.GradeId = tgm.GradeId
        JOIN tblSchoolAcademic tsa ON invDet.AcademicYear = tsa.SchoolAcademicId
        JOIN INV_InvoicePayment invPay ON invDet.InvoiceNo = invPay.InvoiceNo
        WHERE 
        invSum.ParentId = CASE WHEN @ParentId > 0 THEN @ParentId ELSE invSum.ParentId END  
		AND invDet.ParentName LIKE '%'+ CASE WHEN len(@ParentName) > 0 THEN @ParentName ELSE invDet.ParentName  END + '%'  
		AND invDet.IqamaNumber LIKE '%'+ CASE WHEN len(@FatherIqama) > 0 THEN @FatherIqama ELSE invDet.IqamaNumber  END + '%' 
		AND invDet.StudentName LIKE '%'+ CASE WHEN len(@StudentName) > 0 THEN @StudentName ELSE invDet.StudentName  END + '%' 
		AND invDet.AcademicYear = CASE WHEN @ParentId > 0 THEN @AcademicYear ELSE invDet.AcademicYear END  
		AND invDet.InvoiceNo = CASE WHEN @InvoiceNo > 0 THEN @InvoiceNo ELSE invDet.InvoiceNo END  
		--AND (@StartDate IS NULL OR cast(invSum.InvoiceDate as date) >= cast(@StartDate as date))              
		--AND (@EndDate IS NULL OR cast(invSum.InvoiceDate as date) <= cast(@EndDate as date))    
    ) t
    GROUP BY  
        ParentId,
        ParentName,
        FatherMobile,
        IqamaNumber,
        StudentId,
        StudentName,
        GradeName,
        AcademicYear,
        IsStaff,
        InvoiceType,
        InvoiceDate,
        InvoiceNo,
        PaymentMethod,
        PaymentReferenceNumber
END
GO
/****** Object:  StoredProcedure [dbo].[SP_TuitionFeeReport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_TuitionFeeReport]
(
  @ParentId int=0
 ,@ParentName nvarchar(250)=null
 ,@FatherIqama nvarchar(250)=null
 ,@StudentName nvarchar(250)=null
 ,@AcademicYear int=0
 ,@InvoiceNo BigInt=0
 ,@StartDate datetime=null
 ,@EndDate datetime=null
)
as
begin
	select 
	 ParentId
	,ParentName
	,FatherMobile
	,IqamaNumber
	,StudentId
	,StudentName
	,GradeName
	,CostCenter=CostCenterName
	,AcademicYear
	,IsStaff
	,TaxableAmount=sum(TaxableAmount)
	,TaxAmount=sum(TaxAmount)
	,ItemSubtotal=sum(ItemSubtotal)
	,InvoiceType
	,InvoiceDate
	,InvoiceNo
	,PaymentMethod
	,PaymentReferenceNumber
	INTO #TutionTbl
	from
	(
		select 
			 ParentId=isnull(tp.ParentCode,0)
             ,invDet.ParentName
			,invDet.FatherMobile
			,StudentId = isnull(ts.StudentCode,0)
			,StudentName=isnull(invDet.StudentName,'')
			,tgm.GradeName     
			,tsa.AcademicYear
			,invDet.IqamaNumber
			,IsStaff=CASE WHEN invDet.IsStaff=1 THEN 'Yes' ELSE 'No' END 
			,invDet.TaxableAmount	
			,invDet.TaxAmount	
			,invDet.ItemSubtotal
			,invDet.InvoiceType
			,invSum.InvoiceNo
			,invSum.InvoiceDate
			,invPay.PaymentMethod
			,invPay.PaymentReferenceNumber
			,tcc.CostCenterName
		from INV_InvoiceSummary invSum
		join INV_InvoiceDetail invDet on invSum.InvoiceNo=invDet.InvoiceNo
		join tblGradeMaster as tgm on invDet.GradeId = tgm.GradeId
		join tblSchoolAcademic as tsa on invDet.AcademicYear = tsa.SchoolAcademicId
		join INV_InvoicePayment as invPay on invDet.InvoiceNo = invPay.InvoiceNo
		LEFT JOIN tblParent tp on tp.ParentId=invDet.ParentId
		LEFT JOIN tblStudent ts ON ts.StudentId=invDet.StudentId
		LEFT JOIN tblCostCenterMaster tcc ON tcc.CostCenterId=ts.CostCenterId
		where invDet.InvoiceType = 'Tuition Fee'
		AND invSum.ParentId = CASE WHEN @ParentId > 0 THEN @ParentId ELSE invSum.ParentId END  
		AND invDet.ParentName LIKE '%'+ CASE WHEN len(@ParentName) > 0 THEN @ParentName ELSE invDet.ParentName  END + '%'  
		AND invDet.IqamaNumber LIKE '%'+ CASE WHEN len(@FatherIqama) > 0 THEN @FatherIqama ELSE invDet.IqamaNumber  END + '%' 
		AND invDet.StudentName LIKE '%'+ CASE WHEN len(@StudentName) > 0 THEN @StudentName ELSE invDet.StudentName  END + '%' 
		AND invDet.AcademicYear = CASE WHEN @ParentId > 0 THEN @AcademicYear ELSE invDet.AcademicYear END  
		AND invDet.InvoiceNo = CASE WHEN @InvoiceNo > 0 THEN @InvoiceNo ELSE invDet.InvoiceNo END  
		AND (@StartDate IS NULL OR cast(invSum.InvoiceDate as date) >= cast(@StartDate as date))              
		AND (@EndDate IS NULL OR cast(invSum.InvoiceDate as date) <= cast(@EndDate as date))         
	)t
	group by  ParentId,
        ParentName,
        FatherMobile,
        IqamaNumber,
		StudentId,
        StudentName,
        GradeName,
        AcademicYear,
        IsStaff,
         InvoiceType
		,InvoiceDate
		,InvoiceNo
		,PaymentMethod
		,PaymentReferenceNumber
		,CostCenterName

SELECT ParentId
	,ParentName
	,IqamaNumber
	,StudentId
	,StudentName
	,GradeName
	,CostCenter
	,AcademicYear
	,FatherMobile
	,IsStaff=CAST(IsStaff AS NVARCHAR(10)) 
	,InvoiceType
	,InvoiceNo=CAST(InvoiceNo AS NVARCHAR(100)) 
	,InvoiceDate=CONVERT(NVARCHAR(20),InvoiceDate,103) 
	,TaxableAmount=FORMAT(TaxableAmount,'#,0.00')
	,TaxAmount=FORMAT(TaxAmount,'#,0.00')
	,ItemSubtotal=FORMAT(ItemSubtotal,'#,0.00')
	,PaymentMethod
	,PaymentReferenceNumber
	FROM #TutionTbl
	UNION ALL
	SELECT ParentId=' '
			,ParentName=' '
			,IqamaNumber=' '
			,StudentId=' '
			,StudentName=' '
			,GradeName=' '
			,CostCenter=' '
			,AcademicYear=' '
			,FatherMobile=' '
			,IsStaff=''
			,InvoiceType=' '
			,InvoiceNo=' '
			,InvoiceDate='Total'
			,TaxableAmount=FORMAT(SUM(TaxableAmount),'#,0.00')
			,TaxAmount=FORMAT(SUM(TaxAmount),'#,0.00')
			,ItemSubtotal=FORMAT(SUM(ItemSubtotal),'#,0.00')
			,PaymentMethod=' '
			,PaymentReferenceNumber=' '
	FROM #TutionTbl

	DROP TABLE IF EXISTS #TutionTbl; 

end
GO
/****** Object:  StoredProcedure [dbo].[SP_UniformSalesReport]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_UniformSalesReport]
(
    @ItemCode nvarchar(100)=null
   ,@InvoiceNo bigint = 0
   ,@ParentName nvarchar(100)=null
   ,@FatherMobile nvarchar(100)=null
   ,@PaymentMethod nvarchar(100)=null
   ,@PaymentReferenceNumber nvarchar(100)=null
   ,@StartDate datetime=null
   ,@EndDate datetime=null
)
as
begin


	SELECT 
		 ItemCode
		,[Description]
		,InvoiceType
		,InvoiceNo
		,InvoiceDate
		,ParentName
		,FatherMobile
		,Quantity
		,UnitPrice
		,TaxableAmount=sum(TaxableAmount)
		,TaxAmount=sum(TaxAmount)
		,ItemSubtotal=sum(ItemSubtotal)
		,PaymentMethod
		,PaymentReferenceNumber
	INTO #UniformTbl
	FROM
	(
		SELECT 
			 ItemCode = isnull(invDet.ItemCode, '')
			,[Description] = isnull(invDet.[Description], '')
			,invDet.InvoiceType
			,invDet.InvoiceNo
			,invSum.InvoiceDate
            ,invDet.ParentName
			,invDet.FatherMobile
			,invDet.Quantity
			,invDet.UnitPrice   
			,invDet.TaxableAmount	
			,invDet.TaxAmount	
			,invDet.ItemSubtotal
			,invPay.PaymentMethod
			,invPay.PaymentReferenceNumber
		from INV_InvoiceSummary invSum
		join INV_InvoiceDetail invDet on invSum.InvoiceNo=invDet.InvoiceNo
		join INV_InvoicePayment as invPay on invDet.InvoiceNo = invPay.InvoiceNo
		where 
		invDet.InvoiceType = 'Uniform Fee' 
		AND invDet.ItemCode LIKE '%' + CASE WHEN len(@ItemCode) > 0 THEN @ItemCode ELSE invDet.ItemCode END + '%'
		AND invDet.InvoiceNo = CASE WHEN @InvoiceNo > 0 THEN @InvoiceNo ELSE invDet.InvoiceNo END
		AND invDet.ParentName LIKE '%'+ CASE WHEN len(@ParentName) > 0 THEN @ParentName ELSE invDet.ParentName  END + '%'  
		AND invDet.FatherMobile LIKE '%'+ CASE WHEN len(@FatherMobile) > 0 THEN @FatherMobile ELSE invDet.FatherMobile  END + '%'
		AND invPay.PaymentMethod LIKE '%'+ CASE WHEN len(@PaymentMethod) > 0 THEN @PaymentMethod ELSE invPay.PaymentMethod  END + '%'    
		AND invPay.PaymentReferenceNumber LIKE '%'+ CASE WHEN len(@PaymentReferenceNumber) > 0 THEN @PaymentReferenceNumber ELSE invPay.PaymentReferenceNumber  END + '%'     
		AND (@StartDate IS NULL OR cast(invSum.InvoiceDate as date) >= cast(@StartDate as date))              
		AND (@EndDate IS NULL OR cast(invSum.InvoiceDate as date) <= cast(@EndDate as date))  
	)t
	group by
	    ItemCode,
		[Description],
		UnitPrice,
		Quantity,
        ParentName,
        FatherMobile,
         InvoiceType
		,InvoiceDate
		,InvoiceNo
		,PaymentMethod
		,PaymentReferenceNumber

	SELECT  ItemCode
		,[Description]
		,InvoiceType
		,InvoiceNo
		,InvoiceDate=CONVERT(NVARCHAR(20),InvoiceDate,103) 
		,ParentName
		,FatherMobile
		,Quantity
		,UnitPrice
		,TaxableAmount=FORMAT(TaxableAmount,'#,0.00')
		,TaxAmount=FORMAT(TaxAmount,'#,0.00')
		,ItemSubtotal=FORMAT(ItemSubtotal,'#,0.00')
		,PaymentMethod
		,PaymentReferenceNumber 
	FROM #UniformTbl
	UNION ALL
	SELECT ItemCode=' '
		,[Description]=' '
		,InvoiceType=' '
		,InvoiceNo=NULL
		,InvoiceDate=' '
		,ParentName='Total'
		,FatherMobile=' '
		,Quantity=NULL
		,UnitPrice=NULL
		,TaxableAmount=FORMAT(SUM(TaxableAmount),'#,0.00')
		,TaxAmount=FORMAT(SUM(TaxAmount),'#,0.00')
		,ItemSubtotal=FORMAT(SUM(ItemSubtotal),'#,0.00')
		,PaymentMethod=''
		,PaymentReferenceNumber =''
	FROM #UniformTbl

	DROP TABLE IF EXISTS #UniformTbl; 
end
GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateGenerateFee]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_UpdateGenerateFee]
	@LoginUserId int
	,@FeeGenerateId int	
	,@ActionId int --2 Applied-Pending for Approval,3 Applied,4 Rejected,6 Deleted
AS
BEGIN
	--1	Generate
	--2	Applied-Pending for Approval
	--3	Applied
	--4	Rejected
	--5	Regenerate
	--6 Deleted
	SET NOCOUNT ON;	
	DECLARE @NotificationGroupId int=0
	DECLARE @NotificationTypeId int
	BEGIN TRY
	BEGIN TRANSACTION TRANS1
		IF(@ActionId=2)
		BEGIN
			UPDATE tblFeeGenerate SET GenerateStatus=2 WHERE FeeGenerateId=@FeeGenerateId 

			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblFeeGenerate'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=1
			IF (@NotificationGroupId=0)
			BEGIN
				INSERT INTO tblNotificationGroup (NotificationTypeId,NotificationCount,NotificationAction)
				VALUES (@NotificationTypeId,0,1)
				SET @NotificationGroupId=SCOPE_IDENTITY();
			END
			UPDATE tblNotificationGroup SET NotificationCount=NotificationCount+1 WHERE NotificationGroupId=@NotificationGroupId
		END
		ELSE IF(@ActionId=3)
		BEGIN
			 UPDATE tblFeeGenerate SET GenerateStatus=3 WHERE FeeGenerateId=@FeeGenerateId 
			-- Copy tblFeeGenerateDetail date to student fee table 		
			 --Synchronize the target table with refreshed data from source table
			MERGE [tblStudentFeeDetail] AS TARGET
			USING tblFeeGenerateDetail AS SOURCE 
			ON (TARGET.StudentId = SOURCE.StudentId AND TARGET.AcademicYearId = SOURCE.SchoolAcademicId 
			AND TARGET.GradeId = SOURCE.GradeId
			AND TARGET.FeeTypeId = SOURCE.FeeTypeId) 
			--When records are matched, update the records if there is any change
			WHEN MATCHED 
			THEN UPDATE SET 
				TARGET.FeeAmount = SOURCE.FeeAmount,
				TARGET.IsActive =1,
				TARGET.IsDeleted =0,
				TARGET.UpdateDate =GETDATE(),
				TARGET.UpdateBy =@LoginUserId
			--When no records are matched, insert the incoming records from source table to target table
			WHEN NOT MATCHED BY TARGET 
			THEN INSERT (	StudentId,AcademicYearId,GradeId,FeeTypeId,FeeAmount,
			IsActive,IsDeleted,UpdateDate,UpdateBy) 
			VALUES (SOURCE.StudentId,SOURCE.SchoolAcademicId,SOURCE.GradeId,SOURCE.FeeTypeId,SOURCE.FeeAmount,
			1,0,GETDATE(),@LoginUserId)
			--When there is a row that exists in target and same record does not exist in source then delete this record target
			WHEN NOT MATCHED BY SOURCE 
			THEN DELETE;
			
			DECLARE @FeeTypeId INT =3;
			DECLARE @GradeId int=0;
			SELECT TOP 1  @FeeTypeId=ISNULL(FeeTypeId,3) FROM tblFeeTypeMaster WHERE  FeeTypeName LIKE '%TUITION%'	
			DECLARE @FeeStatementType NVARCHAR(50)='Fee Applied'		

			INSERT INTO [dbo].[tblFeeStatement]
			(
				[FeeStatementType],[FeeType],[FeeAmount],[PaidAmount],[StudentId],[ParentId],[StudentName],[ParentName],[AcademicYearId],[GradeId]
				,[IsActive],[IsDeleted],[UpdateDate],[UpdateBy]
			)
			SELECT
				FeeStatementType=@FeeStatementType 		
				,FeeType=@FeeTypeId
				,FeeAmount=fgd.FeeAmount
				,PaidAmount=0
				,StudentId=stu.StudentId
				,ParentId=stu.ParentId
				,StudentName=stu.StudentName
				,ParentName=par.ParentId
				,AcademicYearId=sfd.AcademicYearId
				,GradeId=sfd.GradeId
				,IsActive=1
				,IsDeleted=0
				,UpdateDate=GETDATE()
				,UpdateBy=0
			FROM tblStudentFeeDetail sfd	
			join tblFeeGenerateDetail fgd  
			on sfd.StudentId=fgd.StudentId and sfd.AcademicYearId=fgd.SchoolAcademicId and sfd.GradeId=fgd.GradeId
			JOIN tblStudent stu on stu.StudentId=sfd.StudentId
			JOIN tblParent par on stu.ParentId=par.ParentId
			WHERE fgd.FeeGenerateId=@FeeGenerateId

			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblFeeGenerate'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=1
			UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1
			WHERE NotificationGroupId=@NotificationGroupId

		END
		ELSE IF(@ActionId=4)
		BEGIN
			UPDATE tblFeeGenerate SET GenerateStatus=4 WHERE FeeGenerateId=@FeeGenerateId 
			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblFeeGenerate'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=1
			UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1
			WHERE NotificationGroupId=@NotificationGroupId
		END
		ELSE IF(@ActionId=6)
		BEGIN
			DELETE FROM tblFeeGenerate WHERE FeeGenerateId=@FeeGenerateId
			DELETE FROM tblFeeGenerateDetail WHERE FeeGenerateId=@FeeGenerateId
		END
	COMMIT TRAN TRANS1
	SELECT 0 AS Result, 'Saved' AS Response
	END TRY
	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateGenerateSiblingDiscount]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_UpdateGenerateSiblingDiscount]
	@LoginUserId int
	,@SiblingDiscountId int	
	,@ActionId int --2 Applied-Pending for Approval,3 Applied,4 Rejected,6 Deleted
AS
BEGIN
	--1	Generate
	--2	Applied-Pending for Approval
	--3	Applied
	--4	Rejected
	--5	Regenerate
	--6 Deleted
	SET NOCOUNT ON;	
	DECLARE @NotificationGroupId int=0
	DECLARE @NotificationTypeId int
	BEGIN TRY
	BEGIN TRANSACTION TRANS1
		IF(@ActionId=2)
		BEGIN
			UPDATE tblSiblingDiscount SET GenerateStatus=2 WHERE SiblingDiscountId=@SiblingDiscountId 

			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblSiblingDiscount'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=1
			IF (@NotificationGroupId=0)
			BEGIN
				INSERT INTO tblNotificationGroup (NotificationTypeId,NotificationCount,NotificationAction)
				VALUES (@NotificationTypeId,0,1)
				SET @NotificationGroupId=SCOPE_IDENTITY();
			END
			UPDATE tblNotificationGroup SET NotificationCount=NotificationCount+1 WHERE NotificationGroupId=@NotificationGroupId
		END
		ELSE IF(@ActionId=3)
		BEGIN
			 UPDATE tblSiblingDiscount SET GenerateStatus=3 WHERE SiblingDiscountId=@SiblingDiscountId 
			-- Copy tblFeeGenerateDetail date to student fee table 		
			 --Synchronize the target table with refreshed data from source table
			MERGE tblStudentSiblingDiscountDetail AS TARGET
			USING tblSiblingDiscountDetail AS SOURCE 
			ON (TARGET.StudentId = SOURCE.StudentId AND TARGET.AcademicYearId = SOURCE.SchoolAcademicId 
			AND TARGET.GradeId = SOURCE.GradeId
			AND TARGET.FeeTypeId = SOURCE.FeeTypeId 
			AND SOURCE.SiblingDiscountId=@SiblingDiscountId )
			--When records are matched, update the records if there is any change
			WHEN MATCHED 
			THEN UPDATE SET 
				TARGET.DiscountPercent = SOURCE.DiscountPercent,
				TARGET.IsActive =1,
				TARGET.IsDeleted =0,
				TARGET.UpdateDate =GETDATE(),
				TARGET.UpdateBy =@LoginUserId
			--When no records are matched, insert the incoming records from source table to target table
			WHEN NOT MATCHED BY TARGET 
			THEN INSERT (StudentId,AcademicYearId,GradeId,FeeTypeId,DiscountPercent,
			IsActive,IsDeleted,UpdateDate,UpdateBy) 
			VALUES (SOURCE.StudentId,SOURCE.SchoolAcademicId,SOURCE.GradeId,SOURCE.FeeTypeId,SOURCE.DiscountPercent,
			1,0,GETDATE(),@LoginUserId)
			--When there is a row that exists in target and same record does not exist in source then delete this record target
			WHEN NOT MATCHED BY SOURCE 
			THEN DELETE;
			
			DECLARE @FeeTypeId INT =3;			DECLARE @GradeId int=0;			SELECT TOP 1  @FeeTypeId=ISNULL(FeeTypeId,3) FROM tblFeeTypeMaster WHERE  FeeTypeName LIKE '%TUITION%'	
			DECLARE @FeeStatementType NVARCHAR(50)='Sibling Discount Applied'					INSERT INTO [dbo].[tblFeeStatement]			(				[FeeStatementType],[FeeType],[FeeAmount],[PaidAmount],[StudentId],[ParentId],[StudentName],[ParentName],[AcademicYearId],[GradeId]				,[IsActive],[IsDeleted],[UpdateDate],[UpdateBy]			)			SELECT				FeeStatementType=@FeeStatementType 						,FeeType=@FeeTypeId				,FeeAmount=0				,PaidAmount=Convert(decimal(18,4),(sfd.FeeAmount*sblDiscount.DiscountPercent)/100)				,StudentId=stu.StudentId				,ParentId=stu.ParentId				,StudentName=stu.StudentName				,ParentName=par.FatherName					,AcademicYearId=sfd.AcademicYearId				,GradeId=sfd.GradeId				,IsActive=1				,IsDeleted=0				,UpdateDate=GETDATE()				,UpdateBy=0			FROM tblStudentFeeDetail sfd				join tblSiblingDiscountDetail sblDiscount  			on sfd.StudentId=sblDiscount.StudentId and sfd.AcademicYearId=sblDiscount.SchoolAcademicId and sfd.GradeId=sblDiscount.GradeId			JOIN tblStudent stu on stu.StudentId=sfd.StudentId			JOIN tblParent par on stu.ParentId=par.ParentId			WHERE sblDiscount.SiblingDiscountId=@SiblingDiscountId AND sblDiscount.DiscountPercent>0			--WHERE sfd.StudentId=@StudentId AND sfd.AcademicYearId=@AcademicYearId AND sfd.FeeTypeId=@FeeTypeId NAD SiblingDiscountId=@SiblingDiscountId

			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblSiblingDiscount'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=1
			UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1
			WHERE NotificationGroupId=@NotificationGroupId
		END
		ELSE IF(@ActionId=4)
		BEGIN
			UPDATE tblSiblingDiscount SET GenerateStatus=4 WHERE SiblingDiscountId=@SiblingDiscountId 
			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblSiblingDiscount'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=1
			UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1
			WHERE NotificationGroupId=@NotificationGroupId
		END
		ELSE IF(@ActionId=6)
		BEGIN
			DELETE FROM tblSiblingDiscount WHERE SiblingDiscountId=@SiblingDiscountId
			DELETE FROM tblSiblingDiscountDetail WHERE SiblingDiscountId=@SiblingDiscountId
		END
	COMMIT TRAN TRANS1
	SELECT 0 AS Result, 'Saved' AS Response
	END TRY
	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END

GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateOtherDiscountStatus]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_UpdateOtherDiscountStatus]
	@LoginUserId int
	,@StudentOtherDiscountDetailId bigint	
	,@ActionId int
AS
BEGIN
	--1- Added
	--2- Pending for Approval
	--3- Approved (Discount Applied)
	--4- Rejected
	--5- Discount Cancel (Pending for Approval)
	--6- Discount Canceled
	--7- Discount Cancel: Rejected

	
	SET NOCOUNT ON;	
	DECLARE @NotificationGroupId int=0
	DECLARE @NotificationTypeId int
	BEGIN TRY
	BEGIN TRANSACTION TRANS1
		IF (@ActionId=3)
		BEGIN
			SELECT  @ActionId= CASE WHEN DiscountStatus=2 THEN 3  WHEN  DiscountStatus=5 THEN 6 END
			FROM tblStudentOtherDiscountDetail
			WHERE StudentOtherDiscountDetailId=@StudentOtherDiscountDetailId 
		END
		IF (@ActionId=4)
		BEGIN
			SELECT  @ActionId= CASE WHEN DiscountStatus=2 THEN 4  WHEN  DiscountStatus=5 THEN 7 END
			FROM tblStudentOtherDiscountDetail
			WHERE StudentOtherDiscountDetailId=@StudentOtherDiscountDetailId 
		END

		IF(@ActionId=2)
		BEGIN
			UPDATE tblStudentOtherDiscountDetail SET DiscountStatus=2 WHERE StudentOtherDiscountDetailId=@StudentOtherDiscountDetailId 

			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblStudentOtherDiscountDetail'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=1
			IF (@NotificationGroupId=0)
			BEGIN
				INSERT INTO tblNotificationGroup (NotificationTypeId,NotificationCount,NotificationAction)
				VALUES (@NotificationTypeId,0,1)
				SET @NotificationGroupId=SCOPE_IDENTITY();
			END
			UPDATE tblNotificationGroup SET NotificationCount=NotificationCount+1 WHERE NotificationGroupId=@NotificationGroupId
		END
		ELSE IF(@ActionId=3)
		BEGIN
			UPDATE tblStudentOtherDiscountDetail SET DiscountStatus=3 WHERE StudentOtherDiscountDetailId=@StudentOtherDiscountDetailId  
			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblStudentOtherDiscountDetail'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=1
			UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1
			WHERE NotificationGroupId=@NotificationGroupId

			--Insert discount Applied entry in statement				INSERT INTO [dbo].[tblFeeStatement]			(				[FeeStatementType],[FeeType],[FeeAmount],[PaidAmount],[StudentId],[ParentId],[StudentName],[ParentName],[AcademicYearId],[GradeId]				,[IsActive],[IsDeleted],[UpdateDate],[UpdateBy]			)			SELECT top 1				FeeStatementType=sodd.DiscountName +' Discount Applied' 						,FeeType=sodd.FeeTypeId				,FeeAmount=0				,PaidAmount=Convert(DECIMAL(18,2),sodd.DiscountAmount)				,StudentId=stu.StudentId				,ParentId=stu.ParentId				,StudentName=stu.StudentName				,ParentName=par.FatherName					
				,AcademicYearId=sodd.AcademicYearId				,GradeId=sodd.GradeId				,IsActive=1				,IsDeleted=0				,UpdateDate=GETDATE()				,UpdateBy=0			FROM tblStudentOtherDiscountDetail sodd			INNER JOIN tblStudent stu				ON sodd.StudentId=stu.StudentId			INNER JOIN tblParent par 				ON stu.ParentId=par.ParentId			WHERE StudentOtherDiscountDetailId=@StudentOtherDiscountDetailId
			
		END
		ELSE IF(@ActionId=4)
		BEGIN
			UPDATE tblStudentOtherDiscountDetail SET DiscountStatus=4 WHERE StudentOtherDiscountDetailId=@StudentOtherDiscountDetailId 
			
			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblStudentOtherDiscountDetail'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=1
			UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1
			WHERE NotificationGroupId=@NotificationGroupId
		END
		IF(@ActionId=5)
		BEGIN
			UPDATE tblStudentOtherDiscountDetail SET DiscountStatus=5 WHERE StudentOtherDiscountDetailId=@StudentOtherDiscountDetailId 

			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblStudentOtherDiscountDetail'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=5
			IF (@NotificationGroupId=0)
			BEGIN
				INSERT INTO tblNotificationGroup (NotificationTypeId,NotificationCount,NotificationAction)
				VALUES (@NotificationTypeId,0,5)
				SET @NotificationGroupId=SCOPE_IDENTITY();
			END
			UPDATE tblNotificationGroup SET NotificationCount=NotificationCount+1 WHERE NotificationGroupId=@NotificationGroupId
		END

		ELSE IF(@ActionId=6)
		BEGIN
			UPDATE tblStudentOtherDiscountDetail SET DiscountStatus=6 WHERE StudentOtherDiscountDetailId=@StudentOtherDiscountDetailId 			
			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblStudentOtherDiscountDetail'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=5
			UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1
			WHERE NotificationGroupId=@NotificationGroupId

			--Insert discount Applied entry in statement				INSERT INTO [dbo].[tblFeeStatement]			(				[FeeStatementType],[FeeType],[FeeAmount],[PaidAmount],[StudentId],[ParentId],[StudentName],[ParentName],[AcademicYearId],[GradeId]				,[IsActive],[IsDeleted],[UpdateDate],[UpdateBy]			)			SELECT top 1				FeeStatementType=sodd.DiscountName +' Discount Cancelled' 						,FeeType=sodd.FeeTypeId				,FeeAmount=0				,PaidAmount=Convert(DECIMAL(18,2),sodd.DiscountAmount)*-1				,StudentId=stu.StudentId				,ParentId=stu.ParentId				,StudentName=stu.StudentName				,ParentName=par.FatherName				
				,AcademicYearId=sodd.AcademicYearId				,GradeId=sodd.GradeId				,IsActive=1				,IsDeleted=0				,UpdateDate=GETDATE()				,UpdateBy=0			FROM tblStudentOtherDiscountDetail sodd			INNER JOIN tblStudent stu				ON sodd.StudentId=stu.StudentId			INNER JOIN tblParent par 				ON stu.ParentId=par.ParentId			WHERE StudentOtherDiscountDetailId=@StudentOtherDiscountDetailId

		END
		ELSE IF(@ActionId=7)
		BEGIN
			UPDATE tblStudentOtherDiscountDetail SET DiscountStatus=7 WHERE StudentOtherDiscountDetailId=@StudentOtherDiscountDetailId 
			
			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblStudentOtherDiscountDetail'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=5
			UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1
			WHERE NotificationGroupId=@NotificationGroupId
		END
	COMMIT TRAN TRANS1
	SELECT 0 AS Result, 'Saved' AS Response
	END TRY
	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END

GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateParentImage]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_UpdateParentImage]
	@LoginUserId int
	,@ParentId bigint
	,@ImageUrl nvarchar(500)
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		
			BEGIN
				UPDATE tblParent
						SET ParentImage= @ImageUrl		
						,UpdateDate = GETDATE()
						,UpdateBy = @LoginUserId
				WHERE ParentId = @ParentId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateSchoolLogoImage]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_UpdateSchoolLogoImage]  
 @LoginUserId int  
 ,@SchoolId bigint  
 ,@ImageUrl nvarchar(500)  
 ,@LogoName nvarchar(200)
AS  
BEGIN  
 SET NOCOUNT ON;  
   
 BEGIN TRY  
  BEGIN TRANSACTION TRANS1      
  BEGIN 
   --DECLARE @LogoName NVARCHAR(50)='logo_'   
   --SELECT @LogoName=@LogoName+CAST((COUNT(SchoolId)+1) AS nvarchar) FROM tblSchoolLogo WHERE SchoolId=@SchoolId AND IsActive=1 AND IsDeleted=0
   INSERT INTO [dbo].[tblSchoolLogo]
           ([SchoolId]
           ,[LogoName]
           ,[LogoPath]
           ,[IsActive]
           ,[IsDeleted]
           ,[UpdateDate]
           ,[UpdateBy])
     VALUES
           (@SchoolId
           ,@LogoName
           ,@ImageUrl  
           ,1
           ,0
           ,GETDATE() 
           ,@LoginUserId)   
   END      
  COMMIT TRAN TRANS1  
  SELECT 0 AS Result, 'Saved' AS Response  
 END TRY  
  
 BEGIN CATCH  
   ROLLBACK TRAN TRANS1  
   SELECT -1 AS Result, 'Error!' AS Response  
   EXEC usp_SaveErrorDetail  
   RETURN  
 END CATCH  
END
GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateSiblingDiscountStatus]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_UpdateSiblingDiscountStatus]
	@LoginUserId int
	,@StudentSiblingDiscountDetailId bigint	
	,@ActionId int
AS
BEGIN
	--1- Added
	--2- Pending for Approval
	--3- Approved (Discount Applied)
	--4- Rejected
	--5- Discount Cancel (Pending for Approval)
	--6- Discount Cancelled
	--7- Discount Cancel: Rejected	

	SET NOCOUNT ON;	
	DECLARE @NotificationGroupId int=0
	DECLARE @NotificationTypeId int
	BEGIN TRY
	BEGIN TRANSACTION TRANS1
		IF (@ActionId=3)
		BEGIN
			SELECT  @ActionId= CASE WHEN DiscountStatus=2 THEN 3  WHEN  DiscountStatus=5 THEN 6 END
			FROM tblStudentSiblingDiscountDetail
			WHERE StudentSiblingDiscountDetailId=@StudentSiblingDiscountDetailId 
		END
		IF (@ActionId=4)
		BEGIN
			SELECT  @ActionId= CASE WHEN DiscountStatus=2 THEN 4  WHEN  DiscountStatus=5 THEN 7 END
			FROM tblStudentSiblingDiscountDetail
			WHERE StudentSiblingDiscountDetailId=@StudentSiblingDiscountDetailId 
		END

		IF(@ActionId=2)
		BEGIN
			UPDATE tblStudentSiblingDiscountDetail SET DiscountStatus=2 WHERE StudentSiblingDiscountDetailId=@StudentSiblingDiscountDetailId 

			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblStudentSiblingDiscountDetail'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=1
			IF (@NotificationGroupId=0)
			BEGIN
				INSERT INTO tblNotificationGroup (NotificationTypeId,NotificationCount,NotificationAction)
				VALUES (@NotificationTypeId,0,1)
				SET @NotificationGroupId=SCOPE_IDENTITY();
			END
			UPDATE tblNotificationGroup SET NotificationCount=NotificationCount+1 WHERE NotificationGroupId=@NotificationGroupId
		END
		ELSE IF(@ActionId=3)
		BEGIN
			UPDATE tblStudentSiblingDiscountDetail SET DiscountStatus=3 WHERE StudentSiblingDiscountDetailId=@StudentSiblingDiscountDetailId  
			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblStudentSiblingDiscountDetail'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=1
			UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1
			WHERE NotificationGroupId=@NotificationGroupId

			--Insert discount Applied entry in statement				INSERT INTO [dbo].[tblFeeStatement]			(				[FeeStatementType],[FeeType],[FeeAmount],[PaidAmount],[StudentId],[ParentId],[StudentName],[ParentName],[AcademicYearId],[GradeId]				,[IsActive],[IsDeleted],[UpdateDate],[UpdateBy]			)			SELECT top 1				FeeStatementType='Sibling Discount Applied' 						,FeeType=sodd.FeeTypeId				,FeeAmount=0				,PaidAmount=Convert(decimal(18,4),(sfd.FeeAmount*sodd.DiscountPercent)/100)				,StudentId=stu.StudentId				,ParentId=stu.ParentId				,StudentName=stu.StudentName				,ParentName=par.FatherName				
				,AcademicYearId=sodd.AcademicYearId				,GradeId=sodd.GradeId				,IsActive=1				,IsDeleted=0				,UpdateDate=GETDATE()				,UpdateBy=0			FROM tblStudentSiblingDiscountDetail sodd			INNER JOIN tblStudentFeeDetail sfd				ON sodd.StudentId=sodd.StudentId			INNER JOIN tblStudent stu				ON sodd.StudentId=stu.StudentId			INNER JOIN tblParent par 				ON stu.ParentId=par.ParentId			WHERE StudentSiblingDiscountDetailId=@StudentSiblingDiscountDetailId
			
		END
		ELSE IF(@ActionId=4)
		BEGIN
			UPDATE tblStudentSiblingDiscountDetail SET DiscountStatus=4 WHERE StudentSiblingDiscountDetailId=@StudentSiblingDiscountDetailId 
			
			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblStudentSiblingDiscountDetail'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=1
			UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1
			WHERE NotificationGroupId=@NotificationGroupId
		END
		IF(@ActionId=5)
		BEGIN
			UPDATE tblStudentSiblingDiscountDetail SET DiscountStatus=5 WHERE StudentSiblingDiscountDetailId=@StudentSiblingDiscountDetailId 

			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblStudentSiblingDiscountDetail'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=5
			IF (@NotificationGroupId=0)
			BEGIN
				INSERT INTO tblNotificationGroup (NotificationTypeId,NotificationCount,NotificationAction)
				VALUES (@NotificationTypeId,0,5)
				SET @NotificationGroupId=SCOPE_IDENTITY();
			END
			UPDATE tblNotificationGroup SET NotificationCount=NotificationCount+1 WHERE NotificationGroupId=@NotificationGroupId
		END

		ELSE IF(@ActionId=6)
		BEGIN
			UPDATE tblStudentSiblingDiscountDetail SET DiscountStatus=6 WHERE StudentSiblingDiscountDetailId=@StudentSiblingDiscountDetailId 			
			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblStudentSiblingDiscountDetail'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=5
			UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1
			WHERE NotificationGroupId=@NotificationGroupId

			--Insert discount Applied entry in statement				INSERT INTO [dbo].[tblFeeStatement]			(				[FeeStatementType],[FeeType],[FeeAmount],[PaidAmount],[StudentId],[ParentId],[StudentName],[ParentName],[AcademicYearId],[GradeId]				,[IsActive],[IsDeleted],[UpdateDate],[UpdateBy]			)			SELECT top 1				FeeStatementType='Sibling Discount Cancelled' 						,FeeType=sodd.FeeTypeId				,FeeAmount=0				,PaidAmount=Convert(decimal(18,4),(sfd.FeeAmount*sodd.DiscountPercent)/100)*-1				,StudentId=stu.StudentId				,ParentId=stu.ParentId				,StudentName=stu.StudentName				,ParentName=par.FatherName					
				,AcademicYearId=sodd.AcademicYearId				,GradeId=sodd.GradeId				,IsActive=1				,IsDeleted=0				,UpdateDate=GETDATE()				,UpdateBy=0			FROM tblStudentSiblingDiscountDetail sodd			INNER JOIN tblStudentFeeDetail sfd				ON sodd.StudentId=sodd.StudentId			INNER JOIN tblStudent stu				ON sodd.StudentId=stu.StudentId			INNER JOIN tblParent par 				ON stu.ParentId=par.ParentId			WHERE StudentSiblingDiscountDetailId=@StudentSiblingDiscountDetailId

		END
		ELSE IF(@ActionId=7)
		BEGIN
			UPDATE tblStudentSiblingDiscountDetail SET DiscountStatus=7 WHERE StudentSiblingDiscountDetailId=@StudentSiblingDiscountDetailId 
			
			SELECT @NotificationTypeId=NotificationTypeId  FROM tblNotificationTypeMaster WHERE ActionTable='tblStudentSiblingDiscountDetail'
			SELECT @NotificationGroupId=NotificationGroupId FROM tblNotificationGroup WHERE NotificationTypeId =@NotificationTypeId AND NotificationAction=5
			UPDATE tblNotificationGroup SET NotificationCount = NotificationCount-1
			WHERE NotificationGroupId=@NotificationGroupId
		END
	COMMIT TRAN TRANS1
	SELECT 0 AS Result, 'Saved' AS Response
	END TRY
	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END

GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateStudentImage]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_UpdateStudentImage]
	@LoginUserId int
	,@StudentId bigint
	,@ImageUrl nvarchar(500)
AS
BEGIN
	SET NOCOUNT ON;
	
	BEGIN TRY
		BEGIN TRANSACTION TRANS1
		
			BEGIN
				UPDATE tblStudent
						SET StudentImage= @ImageUrl		
						,UpdateDate = GETDATE()
						,UpdateBy = @LoginUserId
				WHERE StudentId = @StudentId
			END				
		COMMIT TRAN TRANS1
		SELECT 0 AS Result, 'Saved' AS Response
	END TRY

	BEGIN CATCH
			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN
	END CATCH
END
GO
/****** Object:  StoredProcedure [dbo].[sp_VatExemptedNationMapping]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_VatExemptedNationMapping] 	@LoginUserId int	,@VatId bigint	,@MultiSelectLeft nvarchar(1000) = NULL	,@MultiSelectRight nvarchar(1000) = NULLASBEGIN	SET NOCOUNT ON;	BEGIN TRY		BEGIN TRANSACTION TRANS1			DECLARE @FilterDataTable TABLE(CountryId INT)			INSERT INTO @FilterDataTable			SELECT CountryId							FROM tblCountryMaster tcm			WHERE tcm.CountryId IN(SELECT * FROM SplitString(@MultiSelectRight,','))			UPDATE tblVatCountryExclusionMap				SET IsActive = 0, IsDeleted = 1, UpdateBy = @LoginUserId, UpdateDate = GETDATE()			WHERE VatId = @VatId AND CountryId NOT IN (SELECT CountryId FROM @FilterDataTable)			DELETE FROM @FilterDataTable			WHERE CountryId 					IN (SELECT CountryId FROM tblVatCountryExclusionMap 						WHERE VatId = @VatId AND IsDeleted = 0)			INSERT INTO tblVatCountryExclusionMap 					(VatId					,CountryId					,[IsActive]					,[IsDeleted]					,[UpdateDate]					,[UpdateBy])			SELECT @VatId,CountryId,1,0,GETDATE(),@LoginUserId			FROM @FilterDataTable		COMMIT TRAN TRANS1		SELECT 0 AS Result, 'Saved' AS Response	END TRY	BEGIN CATCH			ROLLBACK TRAN TRANS1
			SELECT -1 AS Result, 'Error!' AS Response
			EXEC usp_SaveErrorDetail
			RETURN	END CATCHEND
GO
/****** Object:  StoredProcedure [dbo].[usp_SaveErrorDetail]    Script Date: 9/9/2024 9:27:58 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[usp_SaveErrorDetail]
AS
BEGIN
	SET NOCOUNT ON;	
	INSERT INTO tblErrors
	(	
	[ERROR_NUMBER]
	,[ERROR_SEVERITY]
	,[ERROR_STATE]
	,[ERROR_PROCEDURE]
	,[ERROR_LINE]
	,[ERROR_MESSAGE]
	)
	SELECT	ERROR_NUMBER()
	,ERROR_SEVERITY()
	,ERROR_STATE()
	,ERROR_PROCEDURE()
	,ERROR_LINE()
	,ERROR_MESSAGE()
END
GO
